!function(t,n){"object"==typeof exports&&"undefined"!=typeof module?n(exports):"function"==typeof define&&define.amd?define(["exports"],n):n((t=t||self).MusicKit={})}(this,(function(t){"use strict";var n=void 0!==typeof self?self:this,extendStatics=function(t,n){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,n){t.__proto__=n}||function(t,n){for(var l in n)n.hasOwnProperty(l)&&(t[l]=n[l])})(t,n)};
/*! *****************************************************************************
    Copyright (c) Microsoft Corporation. All rights reserved.
    Licensed under the Apache License, Version 2.0 (the "License"); you may not use
    this file except in compliance with the License. You may obtain a copy of the
    License at http://www.apache.org/licenses/LICENSE-2.0

    THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
    KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
    WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
    MERCHANTABLITY OR NON-INFRINGEMENT.

    See the Apache Version 2.0 License for specific language governing permissions
    and limitations under the License.
    ***************************************************************************** */function __extends(t,n){function __(){this.constructor=t}extendStatics(t,n),t.prototype=null===n?Object.create(n):(__.prototype=n.prototype,new __)}var l,d,__assign=function(){return(__assign=Object.assign||function(t){for(var n,l=1,d=arguments.length;l<d;l++)for(var p in n=arguments[l])Object.prototype.hasOwnProperty.call(n,p)&&(t[p]=n[p]);return t}).apply(this,arguments)};function __decorate(t,n,l,d){var p,h=arguments.length,f=h<3?n:null===d?d=Object.getOwnPropertyDescriptor(n,l):d;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)f=Reflect.decorate(t,n,l,d);else for(var y=t.length-1;y>=0;y--)(p=t[y])&&(f=(h<3?p(f):h>3?p(n,l,f):p(n,l))||f);return h>3&&f&&Object.defineProperty(n,l,f),f}function __metadata(t,n){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(t,n)}function __awaiter(t,n,l,d){return new(l||(l=Promise))((function(p,h){function fulfilled(t){try{step(d.next(t))}catch(e){h(e)}}function rejected(t){try{step(d.throw(t))}catch(e){h(e)}}function step(t){var n;t.done?p(t.value):(n=t.value,n instanceof l?n:new l((function(t){t(n)}))).then(fulfilled,rejected)}step((d=d.apply(t,n||[])).next())}))}function __generator(t,n){var l,d,p,h,f={label:0,sent:function(){if(1&p[0])throw p[1];return p[1]},trys:[],ops:[]};return h={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(h[Symbol.iterator]=function(){return this}),h;function verb(h){return function(y){return function(h){if(l)throw new TypeError("Generator is already executing.");for(;f;)try{if(l=1,d&&(p=2&h[0]?d.return:h[0]?d.throw||((p=d.return)&&p.call(d),0):d.next)&&!(p=p.call(d,h[1])).done)return p;switch(d=0,p&&(h=[2&h[0],p.value]),h[0]){case 0:case 1:p=h;break;case 4:return f.label++,{value:h[1],done:!1};case 5:f.label++,d=h[1],h=[0];continue;case 7:h=f.ops.pop(),f.trys.pop();continue;default:if(!(p=f.trys,(p=p.length>0&&p[p.length-1])||6!==h[0]&&2!==h[0])){f=0;continue}if(3===h[0]&&(!p||h[1]>p[0]&&h[1]<p[3])){f.label=h[1];break}if(6===h[0]&&f.label<p[1]){f.label=p[1],p=h;break}if(p&&f.label<p[2]){f.label=p[2],f.ops.push(h);break}p[2]&&f.ops.pop(),f.trys.pop();continue}h=n.call(t,f)}catch(e){h=[6,e],d=0}finally{l=p=0}if(5&h[0])throw h[1];return{value:h[0]?h[1]:void 0,done:!0}}([h,y])}}}function __read(t,n){var l="function"==typeof Symbol&&t[Symbol.iterator];if(!l)return t;var d,p,h=l.call(t),f=[];try{for(;(void 0===n||n-- >0)&&!(d=h.next()).done;)f.push(d.value)}catch(error){p={error:error}}finally{try{d&&!d.done&&(l=h.return)&&l.call(h)}finally{if(p)throw p.error}}return f}function __spread(){for(var t=[],n=0;n<arguments.length;n++)t=t.concat(__read(arguments[n]));return t}function formatArtworkURL(t,n,l){return n=n||t.height||100,l=l||t.width||100,window.devicePixelRatio>=1.5&&(l*=2,n*=2),t.url.replace("{h}",""+n).replace("{w}",""+l).replace("{f}","jpeg")}(l=t.PlaybackType||(t.PlaybackType={}))[l.none=0]="none",l[l.preview=1]="preview",l[l.unencryptedFull=2]="unencryptedFull",l[l.encryptedFull=3]="encryptedFull",function(t){t[t.none=0]="none",t[t.loading=1]="loading",t[t.ready=2]="ready",t[t.playing=3]="playing",t[t.ended=4]="ended",t[t.unavailable=5]="unavailable",t[t.restricted=6]="restricted",t[t.error=7]="error",t[t.unsupported=8]="unsupported"}(d||(d={}));var p="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:void 0!==n?n:"undefined"!=typeof self?self:{};function unwrapExports(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}function createCommonjsModule(t,n){return t(n={exports:{}},n.exports),n.exports}var h=createCommonjsModule((function(t){var n=t.exports="undefined"!=typeof window&&window.Math==Math?window:"undefined"!=typeof self&&self.Math==Math?self:Function("return this")();"number"==typeof __g&&(__g=n)})),f=createCommonjsModule((function(t){var n=t.exports={version:"2.6.11"};"number"==typeof __e&&(__e=n)})),y=(f.version,function(t){return"object"==typeof t?null!==t:"function"==typeof t}),_anObject=function(t){if(!y(t))throw TypeError(t+" is not an object!");return t},_fails=function(t){try{return!!t()}catch(e){return!0}},v=!_fails((function(){return 7!=Object.defineProperty({},"a",{get:function(){return 7}}).a})),_=h.document,g=y(_)&&y(_.createElement),m=!v&&!_fails((function(){return 7!=Object.defineProperty((t="div",g?_.createElement(t):{}),"a",{get:function(){return 7}}).a;var t})),b=Object.defineProperty,P={f:v?Object.defineProperty:function(t,n,l){if(_anObject(t),n=function(t,n){if(!y(t))return t;var l,d;if(n&&"function"==typeof(l=t.toString)&&!y(d=l.call(t)))return d;if("function"==typeof(l=t.valueOf)&&!y(d=l.call(t)))return d;if(!n&&"function"==typeof(l=t.toString)&&!y(d=l.call(t)))return d;throw TypeError("Can't convert object to primitive value")}(n,!0),_anObject(l),m)try{return b(t,n,l)}catch(e){}if("get"in l||"set"in l)throw TypeError("Accessors not supported!");return"value"in l&&(t[n]=l.value),t}},T=v?function(t,n,l){return P.f(t,n,function(t,n){return{enumerable:!(1&t),configurable:!(2&t),writable:!(4&t),value:n}}(1,l))}:function(t,n,l){return t[n]=l,t},S={}.hasOwnProperty,_has=function(t,n){return S.call(t,n)},k=0,A=Math.random(),_uid=function(t){return"Symbol(".concat(void 0===t?"":t,")_",(++k+A).toString(36))},I=createCommonjsModule((function(t){var n=h["__core-js_shared__"]||(h["__core-js_shared__"]={});(t.exports=function(t,l){return n[t]||(n[t]=void 0!==l?l:{})})("versions",[]).push({version:f.version,mode:"global",copyright:"Â© 2019 Denis Pushkarev (zloirock.ru)"})})),E=I("native-function-to-string",Function.toString),w=createCommonjsModule((function(t){var n=_uid("src"),l=(""+E).split("toString");f.inspectSource=function(t){return E.call(t)},(t.exports=function(t,d,p,f){var y="function"==typeof p;y&&(_has(p,"name")||T(p,"name",d)),t[d]!==p&&(y&&(_has(p,n)||T(p,n,t[d]?""+t[d]:l.join(String(d)))),t===h?t[d]=p:f?t[d]?t[d]=p:T(t,d,p):(delete t[d],T(t,d,p)))})(Function.prototype,"toString",(function(){return"function"==typeof this&&this[n]||E.call(this)}))})),_ctx=function(t,n,l){if(function(t){if("function"!=typeof t)throw TypeError(t+" is not a function!")}(t),void 0===n)return t;switch(l){case 1:return function(l){return t.call(n,l)};case 2:return function(l,d){return t.call(n,l,d)};case 3:return function(l,d,p){return t.call(n,l,d,p)}}return function(){return t.apply(n,arguments)}},$export=function(t,n,l){var d,p,y,v,_=t&$export.F,g=t&$export.G,m=t&$export.S,b=t&$export.P,P=t&$export.B,S=g?h:m?h[n]||(h[n]={}):(h[n]||{}).prototype,k=g?f:f[n]||(f[n]={}),A=k.prototype||(k.prototype={});for(d in g&&(l=n),l)y=((p=!_&&S&&void 0!==S[d])?S:l)[d],v=P&&p?_ctx(y,h):b&&"function"==typeof y?_ctx(Function.call,y):y,S&&w(S,d,y,t&$export.U),k[d]!=y&&T(k,d,v),b&&A[d]!=y&&(A[d]=y)};h.core=f,$export.F=1,$export.G=2,$export.S=4,$export.P=8,$export.B=16,$export.W=32,$export.U=64,$export.R=128;var O,R,C=$export,M={}.toString,N=Object("z").propertyIsEnumerable(0)?Object:function(t){return"String"==function(t){return M.call(t).slice(8,-1)}(t)?t.split(""):Object(t)},_defined=function(t){if(null==t)throw TypeError("Can't call method on  "+t);return t},_toIobject=function(t){return N(_defined(t))},D=Math.ceil,L=Math.floor,_toInteger=function(t){return isNaN(t=+t)?0:(t>0?L:D)(t)},U=Math.min,B=Math.max,j=Math.min,F=I("keys"),V=(O=!1,function(t,n,l){var d,p,h=_toIobject(t),f=(d=h.length)>0?U(_toInteger(d),9007199254740991):0,y=function(t,n){return(t=_toInteger(t))<0?B(t+n,0):j(t,n)}(l,f);if(O&&n!=n){for(;f>y;)if((p=h[y++])!=p)return!0}else for(;f>y;y++)if((O||y in h)&&h[y]===n)return O||y||0;return!O&&-1}),$=F[R="IE_PROTO"]||(F[R]=_uid(R)),Y="constructor,hasOwnProperty,isPrototypeOf,propertyIsEnumerable,toLocaleString,toString,valueOf".split(","),H=Object.keys||function(t){return function(t,n){var l,d=_toIobject(t),p=0,h=[];for(l in d)l!=$&&_has(d,l)&&h.push(l);for(;n.length>p;)_has(d,l=n[p++])&&(~V(h,l)||h.push(l));return h}(t,Y)},W={f:Object.getOwnPropertySymbols},z={f:{}.propertyIsEnumerable},_toObject=function(t){return Object(_defined(t))},G=Object.assign,q=!G||_fails((function(){var t={},n={},l=Symbol(),d="abcdefghijklmnopqrst";return t[l]=7,d.split("").forEach((function(t){n[t]=t})),7!=G({},t)[l]||Object.keys(G({},n)).join("")!=d}))?function(t,n){for(var l=_toObject(t),d=arguments.length,p=1,h=W.f,f=z.f;d>p;)for(var y,_=N(arguments[p++]),g=h?H(_).concat(h(_)):H(_),m=g.length,b=0;m>b;)y=g[b++],v&&!f.call(_,y)||(l[y]=_[y]);return l}:G;C(C.S+C.F,"Object",{assign:q});f.Object.assign;var Q="URLSearchParams"in self,J="Symbol"in self&&"iterator"in Symbol,X="FileReader"in self&&"Blob"in self&&function(){try{return new Blob,!0}catch(e){return!1}}(),Z="FormData"in self,ee="ArrayBuffer"in self;if(ee)var te=["[object Int8Array]","[object Uint8Array]","[object Uint8ClampedArray]","[object Int16Array]","[object Uint16Array]","[object Int32Array]","[object Uint32Array]","[object Float32Array]","[object Float64Array]"],re=ArrayBuffer.isView||function(t){return t&&te.indexOf(Object.prototype.toString.call(t))>-1};function normalizeName(t){if("string"!=typeof t&&(t=String(t)),/[^a-z0-9\-#$%&'*+.^_`|~]/i.test(t))throw new TypeError("Invalid character in header field name");return t.toLowerCase()}function normalizeValue(t){return"string"!=typeof t&&(t=String(t)),t}function iteratorFor(t){var n={next:function(){var n=t.shift();return{done:void 0===n,value:n}}};return J&&(n[Symbol.iterator]=function(){return n}),n}function Headers$1(t){this.map={},t instanceof Headers$1?t.forEach((function(t,n){this.append(n,t)}),this):Array.isArray(t)?t.forEach((function(t){this.append(t[0],t[1])}),this):t&&Object.getOwnPropertyNames(t).forEach((function(n){this.append(n,t[n])}),this)}function consumed(t){if(t.bodyUsed)return Promise.reject(new TypeError("Already read"));t.bodyUsed=!0}function fileReaderReady(t){return new Promise((function(n,l){t.onload=function(){n(t.result)},t.onerror=function(){l(t.error)}}))}function readBlobAsArrayBuffer(t){var n=new FileReader,l=fileReaderReady(n);return n.readAsArrayBuffer(t),l}function bufferClone(t){if(t.slice)return t.slice(0);var n=new Uint8Array(t.byteLength);return n.set(new Uint8Array(t)),n.buffer}function Body(){return this.bodyUsed=!1,this._initBody=function(t){var n;this._bodyInit=t,t?"string"==typeof t?this._bodyText=t:X&&Blob.prototype.isPrototypeOf(t)?this._bodyBlob=t:Z&&FormData.prototype.isPrototypeOf(t)?this._bodyFormData=t:Q&&URLSearchParams.prototype.isPrototypeOf(t)?this._bodyText=t.toString():ee&&X&&((n=t)&&DataView.prototype.isPrototypeOf(n))?(this._bodyArrayBuffer=bufferClone(t.buffer),this._bodyInit=new Blob([this._bodyArrayBuffer])):ee&&(ArrayBuffer.prototype.isPrototypeOf(t)||re(t))?this._bodyArrayBuffer=bufferClone(t):this._bodyText=t=Object.prototype.toString.call(t):this._bodyText="",this.headers.get("content-type")||("string"==typeof t?this.headers.set("content-type","text/plain;charset=UTF-8"):this._bodyBlob&&this._bodyBlob.type?this.headers.set("content-type",this._bodyBlob.type):Q&&URLSearchParams.prototype.isPrototypeOf(t)&&this.headers.set("content-type","application/x-www-form-urlencoded;charset=UTF-8"))},X&&(this.blob=function(){var t=consumed(this);if(t)return t;if(this._bodyBlob)return Promise.resolve(this._bodyBlob);if(this._bodyArrayBuffer)return Promise.resolve(new Blob([this._bodyArrayBuffer]));if(this._bodyFormData)throw new Error("could not read FormData body as blob");return Promise.resolve(new Blob([this._bodyText]))},this.arrayBuffer=function(){return this._bodyArrayBuffer?consumed(this)||Promise.resolve(this._bodyArrayBuffer):this.blob().then(readBlobAsArrayBuffer)}),this.text=function(){var t,n,l,d=consumed(this);if(d)return d;if(this._bodyBlob)return t=this._bodyBlob,n=new FileReader,l=fileReaderReady(n),n.readAsText(t),l;if(this._bodyArrayBuffer)return Promise.resolve(function(t){for(var n=new Uint8Array(t),l=new Array(n.length),d=0;d<n.length;d++)l[d]=String.fromCharCode(n[d]);return l.join("")}(this._bodyArrayBuffer));if(this._bodyFormData)throw new Error("could not read FormData body as text");return Promise.resolve(this._bodyText)},Z&&(this.formData=function(){return this.text().then(decode)}),this.json=function(){return this.text().then(JSON.parse)},this}Headers$1.prototype.append=function(t,n){t=normalizeName(t),n=normalizeValue(n);var l=this.map[t];this.map[t]=l?l+", "+n:n},Headers$1.prototype.delete=function(t){delete this.map[normalizeName(t)]},Headers$1.prototype.get=function(t){return t=normalizeName(t),this.has(t)?this.map[t]:null},Headers$1.prototype.has=function(t){return this.map.hasOwnProperty(normalizeName(t))},Headers$1.prototype.set=function(t,n){this.map[normalizeName(t)]=normalizeValue(n)},Headers$1.prototype.forEach=function(t,n){for(var l in this.map)this.map.hasOwnProperty(l)&&t.call(n,this.map[l],l,this)},Headers$1.prototype.keys=function(){var t=[];return this.forEach((function(n,l){t.push(l)})),iteratorFor(t)},Headers$1.prototype.values=function(){var t=[];return this.forEach((function(n){t.push(n)})),iteratorFor(t)},Headers$1.prototype.entries=function(){var t=[];return this.forEach((function(n,l){t.push([l,n])})),iteratorFor(t)},J&&(Headers$1.prototype[Symbol.iterator]=Headers$1.prototype.entries);var ie=["DELETE","GET","HEAD","OPTIONS","POST","PUT"];function Request(t,n){var l,d,p=(n=n||{}).body;if(t instanceof Request){if(t.bodyUsed)throw new TypeError("Already read");this.url=t.url,this.credentials=t.credentials,n.headers||(this.headers=new Headers$1(t.headers)),this.method=t.method,this.mode=t.mode,this.signal=t.signal,p||null==t._bodyInit||(p=t._bodyInit,t.bodyUsed=!0)}else this.url=String(t);if(this.credentials=n.credentials||this.credentials||"same-origin",!n.headers&&this.headers||(this.headers=new Headers$1(n.headers)),this.method=(l=n.method||this.method||"GET",d=l.toUpperCase(),ie.indexOf(d)>-1?d:l),this.mode=n.mode||this.mode||null,this.signal=n.signal||this.signal,this.referrer=null,("GET"===this.method||"HEAD"===this.method)&&p)throw new TypeError("Body not allowed for GET or HEAD requests");this._initBody(p)}function decode(t){var n=new FormData;return t.trim().split("&").forEach((function(t){if(t){var l=t.split("="),d=l.shift().replace(/\+/g," "),p=l.join("=").replace(/\+/g," ");n.append(decodeURIComponent(d),decodeURIComponent(p))}})),n}function Response(t,n){n||(n={}),this.type="default",this.status=void 0===n.status?200:n.status,this.ok=this.status>=200&&this.status<300,this.statusText="statusText"in n?n.statusText:"OK",this.headers=new Headers$1(n.headers),this.url=n.url||"",this._initBody(t)}Request.prototype.clone=function(){return new Request(this,{body:this._bodyInit})},Body.call(Request.prototype),Body.call(Response.prototype),Response.prototype.clone=function(){return new Response(this._bodyInit,{status:this.status,statusText:this.statusText,headers:new Headers$1(this.headers),url:this.url})},Response.error=function(){var t=new Response(null,{status:0,statusText:""});return t.type="error",t};var ne=[301,302,303,307,308];Response.redirect=function(t,n){if(-1===ne.indexOf(n))throw new RangeError("Invalid status code");return new Response(null,{status:n,headers:{location:t}})};var oe=self.DOMException;try{new oe}catch(ad){(oe=function(t,n){this.message=t,this.name=n;var l=Error(t);this.stack=l.stack}).prototype=Object.create(Error.prototype),oe.prototype.constructor=oe}function fetch$1(t,n){return new Promise((function(l,d){var p=new Request(t,n);if(p.signal&&p.signal.aborted)return d(new oe("Aborted","AbortError"));var h=new XMLHttpRequest;function abortXhr(){h.abort()}h.onload=function(){var t,n,d={status:h.status,statusText:h.statusText,headers:(t=h.getAllResponseHeaders()||"",n=new Headers$1,t.replace(/\r?\n[\t ]+/g," ").split(/\r?\n/).forEach((function(t){var l=t.split(":"),d=l.shift().trim();if(d){var p=l.join(":").trim();n.append(d,p)}})),n)};d.url="responseURL"in h?h.responseURL:d.headers.get("X-Request-URL");var p="response"in h?h.response:h.responseText;l(new Response(p,d))},h.onerror=function(){d(new TypeError("Network request failed"))},h.ontimeout=function(){d(new TypeError("Network request failed"))},h.onabort=function(){d(new oe("Aborted","AbortError"))},h.open(p.method,p.url,!0),"include"===p.credentials?h.withCredentials=!0:"omit"===p.credentials&&(h.withCredentials=!1),"responseType"in h&&X&&(h.responseType="blob"),p.headers.forEach((function(t,n){h.setRequestHeader(n,t)})),p.signal&&(p.signal.addEventListener("abort",abortXhr),h.onreadystatechange=function(){4===h.readyState&&p.signal.removeEventListener("abort",abortXhr)}),h.send(void 0===p._bodyInit?null:p._bodyInit)}))}fetch$1.polyfill=!0,self.fetch||(self.fetch=fetch$1,self.Headers=Headers$1,self.Request=Request,self.Response=Response)
/*! *****************************************************************************
    Copyright (c) Microsoft Corporation. All rights reserved.
    Licensed under the Apache License, Version 2.0 (the "License"); you may not use
    this file except in compliance with the License. You may obtain a copy of the
    License at http://www.apache.org/licenses/LICENSE-2.0

    THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
    KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
    WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
    MERCHANTABLITY OR NON-INFRINGEMENT.

    See the Apache Version 2.0 License for specific language governing permissions
    and limitations under the License.
    ***************************************************************************** */;var ae=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,n){t.__proto__=n}||function(t,n){for(var l in n)n.hasOwnProperty(l)&&(t[l]=n[l])};function __extends$1(t,n){function __(){this.constructor=t}ae(t,n),t.prototype=null===n?Object.create(n):(__.prototype=n.prototype,new __)}var se=Object.assign||function(t){for(var n,l=1,d=arguments.length;l<d;l++)for(var p in n=arguments[l])Object.prototype.hasOwnProperty.call(n,p)&&(t[p]=n[p]);return t};function __awaiter$1(t,n,l,d){return new(l||(l=Promise))((function(p,h){function fulfilled(t){try{step(d.next(t))}catch(e){h(e)}}function rejected(t){try{step(d.throw(t))}catch(e){h(e)}}function step(t){t.done?p(t.value):new l((function(n){n(t.value)})).then(fulfilled,rejected)}step((d=d.apply(t,n||[])).next())}))}function __generator$1(t,n){var l,d,p,h,f={label:0,sent:function(){if(1&p[0])throw p[1];return p[1]},trys:[],ops:[]};return h={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(h[Symbol.iterator]=function(){return this}),h;function verb(h){return function(y){return function(h){if(l)throw new TypeError("Generator is already executing.");for(;f;)try{if(l=1,d&&(p=d[2&h[0]?"return":h[0]?"throw":"next"])&&!(p=p.call(d,h[1])).done)return p;switch(d=0,p&&(h=[0,p.value]),h[0]){case 0:case 1:p=h;break;case 4:return f.label++,{value:h[1],done:!1};case 5:f.label++,d=h[1],h=[0];continue;case 7:h=f.ops.pop(),f.trys.pop();continue;default:if(!(p=f.trys,(p=p.length>0&&p[p.length-1])||6!==h[0]&&2!==h[0])){f=0;continue}if(3===h[0]&&(!p||h[1]>p[0]&&h[1]<p[3])){f.label=h[1];break}if(6===h[0]&&f.label<p[1]){f.label=p[1],p=h;break}if(p&&f.label<p[2]){f.label=p[2],f.ops.push(h);break}p[2]&&f.ops.pop(),f.trys.pop();continue}h=n.call(t,f)}catch(e){h=[6,e],d=0}finally{l=p=0}if(5&h[0])throw h[1];return{value:h[0]?h[1]:void 0,done:!0}}([h,y])}}}function __read$1(t,n){var l="function"==typeof Symbol&&t[Symbol.iterator];if(!l)return t;var d,p,h=l.call(t),f=[];try{for(;(void 0===n||n-- >0)&&!(d=h.next()).done;)f.push(d.value)}catch(error){p={error:error}}finally{try{d&&!d.done&&(l=h.return)&&l.call(h)}finally{if(p)throw p.error}}return f}function __spread$1(){for(var t=[],n=0;n<arguments.length;n++)t=t.concat(__read$1(arguments[n]));return t}var ue="undefined"!=typeof FastBoot?FastBoot.require("buffer").Buffer:"undefined"!=typeof process&&null!==process.versions&&null!==process.versions.node?Buffer:window.Buffer;function memoize(t){return function(){for(var n=[],l=0;l<arguments.length;l++)n[l]=arguments[l];for(var d="",p=n.length;p--;){var h=n[p];d+=h===Object(h)?JSON.stringify(h):h,t._memoized||(t._memoized={})}return d in t._memoized?t._memoized[d]:t._memoized[d]=t.apply(void 0,n)}}function isObject(t){return!!t&&"object"==typeof t&&!Array.isArray(t)}function generateUUID(){for(var t=strRandomizer()+strRandomizer();t.length<16;)t+=strRandomizer();return t.slice(0,16)}function strRandomizer(){return Math.random().toString(16).substring(2)}var ce=memoize((function(t){return/^[a|i|l|p]{1}\.[a-zA-Z0-9]+$/.test(t)})),le=memoize((function(t){return/^(a\.)?[a-zA-Z0-9]+$/.test(t)}));function isNodeEnvironment(t){var isDefined=function(t){return null!=t};return 0===arguments.length&&"undefined"!=typeof process&&(t=process),isDefined(t)&&isDefined(t.versions)&&isDefined(t.versions.node)||"undefined"!=typeof FastBoot}var de=memoize(isNodeEnvironment()?function(t){return ue.from(t,"base64").toString("binary")}:function(t){return window.atob(t)});memoize(isNodeEnvironment()?function(t){return ue.from(t).toString("base64")}:function(t){return window.btoa(t)});var exceptFields=function(t){for(var n=[],l=1;l<arguments.length;l++)n[l-1]=arguments[l];var d={};return Object.keys(t).forEach((function(l){n.includes(l)||(d[l]=t[l])})),d},arrayEquals=function(t,n){return!!t&&!!n&&[].every.call(t,(function(t,l){return t===n[l]}))},pe=isNodeEnvironment(),he=function(){function Browser(t){var n;t||(t="undefined"!=typeof window&&(null===(n=null===window||void 0===window?void 0:window.navigator)||void 0===n?void 0:n.userAgent)?window.navigator.userAgent:"");var l=t.toLowerCase();this.isEdge=/\sedge\//.test(l),this.isChrome=!this.isEdge&&/chrome/.test(l),this.isSafari=!this.isEdge&&!this.isChrome&&/safari/.test(l),this.isFirefox=!this.isEdge&&!this.isChrome&&!this.isSafari&&/firefox/.test(l),this.isIE=!this.isEdge&&!this.isChrome&&!this.isSafari&&!this.isFirefox&&/trident|msie/.test(l),this.isMobile=/mobile/.test(l),this.isAndroid=this.isMobile&&/android/.test(l),this.isiOS=this.isMobile&&/iphone|ipad|ipod/.test(l),this.isWebView=/(webview|(iphone|ipod|ipad)(?!.*safari\/)|android.*(wv|\.0\.0\.0)|\bfb[\w_]+\/(?:messenger)?|\binstagram|\btwitter)/.test(l),this.isEdge?this.engineVersion=l.match(/(?:edge).(\d+)/):(this.version=l.match(/(?:chrome|version|firefox|msie|rv).(\d+)\.(\d+)/),this.engineVersion=l.match(/(?:applewebkit|gecko|trident).(\d+)/)),this.version&&(this.majorVersion=parseInt(this.version[1],10),this.minorVersion=parseInt(this.version[2],10)),this.engineVersion&&(this.engineMajorVersion=parseInt(this.engineVersion[1],10))}return Browser.supportsEs6=function(){if("undefined"==typeof Symbol)return!1;try{new Function('"use strict";class Foo {}')(),new Function('"use strict";var bar = (x) => x+1')()}catch(e){return!1}return!0},Browser}(),fe=new he,addPathToURL=function(t,n){return void 0===t||""===t?n||"":void 0===n?t:(t.endsWith("/")&&(t=t.slice(0,-1)),n.startsWith("/")&&(n=n.slice(1)),t+"/"+n)},addQueryParamsToURL=function(t,n){var l=urlEncodeParameters(n);return""===l?t:t.endsWith("&")||t.endsWith("?")?""+t+l:t.includes("?")?t+"&"+l:t+"?"+l},ye="undefined"!=typeof Headers,headersToDict=function(t){var n,l={};return n=t,ye&&n instanceof Headers?t.forEach((function(t,n){return l[n]=t})):Array.isArray(t)?t.forEach((function(t){var n=__read$1(t,2),d=n[0],p=n[1];return l[d]=p})):l=t,l},mergeFetchOptions=function(t,n){var l,d;if(t||n)return(null==t?void 0:t.headers)&&(null==n?void 0:n.headers)?se(se(se({},t),n),{headers:(l=t.headers,d=n.headers,void 0===l&&(l={}),void 0===d&&(d={}),se(se({},headersToDict(l)),headersToDict(d)))}):se(se({},t),n)};function parseQueryParams(t){var n;if(!t||t.startsWith("http")&&!t.includes("?"))return{};try{return parseParams(null!==(n=t.split("?")[1])&&void 0!==n?n:t,"&",decodeURIComponent)}catch(Si){return{}}}function parseParams(t,n,l){return void 0===n&&(n="&"),void 0===l&&(l=function(t){return t}),"string"!=typeof t?{}:t.split(n).map((function(t){return t.trim().split("=",2)})).reduce((function(t,n){var d=__read$1(n,2),p=d[0],h=d[1];return""===p&&void 0===h||(t[l(p)]=l(h),void 0===h&&(t[l(p)]=void 0)),t}),{})}function getMaxAgeFromHeaders(t){var n=function(t,n){if(void 0!==n)return ye&&n instanceof Headers?n.get(t):n[t]}("cache-control",t);if(n)return function(t){var n=Number(t);if(Number.isFinite(n))return n}(parseParams(n,",")["max-age"])}function rewriteLastUrlPath(t,n){var l=t.split("/");return l.pop(),l.push(n),l.join("/")}var recursiveEncodeParameters=function(t,n){return Object.keys(t).reduce((function(l,d){var p=t[d],h=n?n+"["+encodeURIComponent(d)+"]":encodeURIComponent(d);return l+(l?"&":"")+(isObject(p)?recursiveEncodeParameters(p,h):h+"="+encodeURIComponent(""+p))}),"")};function urlEncodeParameters(t){return t?recursiveEncodeParameters(t):""}var AsyncDebounce=function(t,n){return void 0===t&&(t=100),function(l,d,p){var h=p.value,f=asyncDebounce(h,t,n);p.value=f}},asyncDebounce=function(t,n,l){var d,p;function fulfill(t){return l.hasOwnProperty("cancelledValue")?null==t?void 0:t.resolve(l.cancelledValue):null==t?void 0:t.reject(new Error("cancelled"))}void 0===n&&(n=250),void 0===l&&(l={isImmediate:!1});var clearLastPromise=function(){d&&(d.resolved||(fulfill(d),d.timeoutId&&clearTimeout(d.timeoutId)),d=void 0)},invokeFn=function(n,l,p,h){t.apply(n,h).then((function(t){l(t),d&&(d.resolved=!0)})).catch(p)};return l.isImmediate?function(){for(var t=[],l=0;l<arguments.length;l++)t[l]=arguments[l];var h=Date.now(),f=this;return p&&h>=p&&clearLastPromise(),p=Date.now()+n,d?fulfill(Promise):new Promise((function(n,l){d={resolve:n,reject:l},invokeFn(f,n,l,t)}))}:function(){for(var t=[],l=0;l<arguments.length;l++)t[l]=arguments[l];var p=this;return d&&clearLastPromise(),new Promise((function(l,h){var f=setTimeout(invokeFn.bind(void 0,p,l,h,t),n);d={resolve:l,reject:h,timeoutId:f}}))}};function isLive(t){return!!t&&!!t.attributes&&!!t.attributes.isLive}function isStream(t){var n,l;return"stream"===(null===(l=null===(n=null==t?void 0:t.attributes)||void 0===n?void 0:n.playParams)||void 0===l?void 0:l.format)}function isLiveRadioStation(t){return isLive(t)&&isStream(t)}function isBroadcastRadio(t){return isLive(t)&&isStream(t)&&void 0!==t.attributes.stationProviderName&&"Shoutcast"===t.attributes.streamingRadioSubType}function getFilterFromFlags(t){var n=t.includes("radio-live"),l=t.includes("radio-aod"),d=t.includes("radio-broadcast");return function(t){return(!n||n&&!isLiveRadioStation(t))&&(!l||l&&!function(t){return!isLive(t)&&isStream(t)&&"Episode"===t.attributes.streamingRadioSubType}(t))&&(!d||d&&!isBroadcastRadio(t))}}var ve={album:"albums",albums:"albums",artist:"artists",artists:"artists",song:"songs",songs:"songs"};var _e={AFG:"143610",AGO:"143564",AIA:"143538",ALB:"143575",AND:"143611",ARE:"143481",ARG:"143505",ARM:"143524",ATG:"143540",AUS:"143460",AUT:"143445",AZE:"143568",BEL:"143446",BEN:"143576",BFA:"143578",BGD:"143490",BGR:"143526",BHR:"143559",BHS:"143539",BIH:"143612",BLR:"143565",BLZ:"143555",BMU:"143542",BOL:"143556",BRA:"143503",BRB:"143541",BRN:"143560",BTN:"143577",BWA:"143525",CAF:"143623",CAN:"143455",CHE:"143459",CHL:"143483",CHN:"143465",CIV:"143527",CMR:"143574",COD:"143613",COG:"143582",COL:"143501",CPV:"143580",CRI:"143495",CYM:"143544",CYP:"143557",CZE:"143489",DEU:"143443",DMA:"143545",DNK:"143458",DOM:"143508",DZA:"143563",ECU:"143509",EGY:"143516",ESP:"143454",EST:"143518",ETH:"143569",FIN:"143447",FJI:"143583",FRA:"143442",FSM:"143591",GAB:"143614",GBR:"143444",GEO:"143615",GHA:"143573",GIN:"143616",GMB:"143584",GNB:"143585",GRC:"143448",GRD:"143546",GTM:"143504",GUY:"143553",HKG:"143463",HND:"143510",HRV:"143494",HUN:"143482",IDN:"143476",IND:"143467",IRL:"143449",IRQ:"143617",ISL:"143558",ISR:"143491",ITA:"143450",JAM:"143511",JOR:"143528",JPN:"143462",KAZ:"143517",KEN:"143529",KGZ:"143586",KHM:"143579",KNA:"143548",KOR:"143466",KWT:"143493",LAO:"143587",LBN:"143497",LBR:"143588",LBY:"143567",LCA:"143549",LIE:"143522",LKA:"143486",LTU:"143520",LUX:"143451",LVA:"143519",MAC:"143515",MAR:"143620",MCO:"143618",MDA:"143523",MDG:"143531",MDV:"143488",MEX:"143468",MKD:"143530",MLI:"143532",MLT:"143521",MMR:"143570",MNE:"143619",MNG:"143592",MOZ:"143593",MRT:"143590",MSR:"143547",MUS:"143533",MWI:"143589",MYS:"143473",NAM:"143594",NER:"143534",NGA:"143561",NIC:"143512",NLD:"143452",NOR:"143457",NPL:"143484",NRU:"143606",NZL:"143461",OMN:"143562",PAK:"143477",PAN:"143485",PER:"143507",PHL:"143474",PLW:"143595",PNG:"143597",POL:"143478",PRT:"143453",PRY:"143513",PSE:"143596",QAT:"143498",ROU:"143487",RUS:"143469",RWA:"143621",SAU:"143479",SEN:"143535",SGP:"143464",SLB:"143601",SLE:"143600",SLV:"143506",SRB:"143500",STP:"143598",SUR:"143554",SVK:"143496",SVN:"143499",SWE:"143456",SWZ:"143602",SYC:"143599",TCA:"143552",TCD:"143581",THA:"143475",TJK:"143603",TKM:"143604",TON:"143608",TTO:"143551",TUN:"143536",TUR:"143480",TWN:"143470",TZA:"143572",UGA:"143537",UKR:"143492",URY:"143514",USA:"143441",UZB:"143566",VCT:"143550",VEN:"143502",VGB:"143543",VNM:"143471",VUT:"143609",WSM:"143607",XKX:"143624",YEM:"143571",ZAF:"143472",ZMB:"143622",ZWE:"143605"},ge=memoize((function(t){for(var n=new Uint16Array(t),l=n.length,d="",p=0;p<l;p++)d+=String.fromCharCode(n[p]);return d})),me=memoize((function(t){var n=de(t);return be(n)}));function ensureArray(t){return void 0===t&&(t=[]),Array.isArray(t)?t:[t]}var be=memoize((function(t){for(var n=t.length,l=new ArrayBuffer(n),d=new Uint8Array(l),p=0;p<n;p++)d[p]=t.charCodeAt(p);return d})),Pe=memoize((function(t){for(var n=t.length,l=new ArrayBuffer(2*n),d=new Uint16Array(l),p=0;p<n;p++)d[p]=t.charCodeAt(p);return d})),Te=memoize((function(t){for(var n,l,d,p,h,f,y,v=0,_="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",g="";v<t.length;)p=(n=t[v++])>>2,h=(3&n)<<4|(l=v<t.length?t[v++]:Number.NaN)>>4,f=(15&l)<<2|(d=v<t.length?t[v++]:Number.NaN)>>6,y=63&d,isNaN(l)?f=y=64:isNaN(d)&&(y=64),g+=_.charAt(p)+_.charAt(h)+_.charAt(f)+_.charAt(y);return g})),Se=Object.prototype.hasOwnProperty;function isEmpty(t){if("object"!=typeof t)throw new TypeError("Source is not an Object");for(var n in t)if(Se.call(t,n))return!1;return!0}function transform(t,n,l){return void 0===l&&(l=!1),l&&(t=Object.keys(t).reduce((function(n,l){return n[t[l]]=l,n}),{})),Object.keys(t).reduce((function(l,d){var p,h=t[d];return(p="function"==typeof h?h():function(t,n){return n.split(".").reduce((function(t,n){if(void 0!==t)return t[n]}),t)}(n,h))&&function(t,n,l){n.split(".").reduce((function(n,d,p,h){var f=p===h.length-1,y=n.hasOwnProperty(d),v=n[d]instanceof Object,_=null===n[d];if(!f&&y&&(!v||_))throw new TypeError("Value at "+h.slice(0,p+1).join(".")+" in keypath is not an Object.");return f?(n[d]=l,t):y?n[d]:n[d]={}}),t)}(l,d,p),l}),{})}function transformKeys(t,n){return Object.keys(t).reduce((function(l,d){return l[n(d)]=t[d],l}),{})}var ke=function(){function Notifications(t,n){var l=this;void 0===t&&(t=[]),this._eventRegistry={},t.forEach((function(t){l._eventRegistry[t]=[]})),n&&n.namespace&&(this.dispatchNamespace="com.apple."+n.namespace),this.shouldStorageDispatch&&(this._handleGlobalStorageEvent=this._handleGlobalStorageEvent.bind(this),window.addEventListener("storage",this._handleGlobalStorageEvent))}return Object.defineProperty(Notifications.prototype,"shouldStorageDispatch",{get:function(){return"undefined"!=typeof window&&"undefined"!=typeof sessionStorage&&this.dispatchNamespace},enumerable:!0,configurable:!0}),Notifications.prototype.addEventListener=function(t,n){Array.isArray(this._eventRegistry[t])&&this._eventRegistry[t].push(n)},Notifications.prototype.dispatchEvent=function(t,n){Array.isArray(this._eventRegistry[t])&&this._eventRegistry[t].forEach((function(t){return t(n)}))},Notifications.prototype.dispatchDistributedEvent=function(t,n){if(this.dispatchEvent(t,n),this.shouldStorageDispatch){var l=this.dispatchNamespace+":"+t;sessionStorage.setItem(l,JSON.stringify(n))}},Notifications.prototype.removeEventListener=function(t,n){if(Array.isArray(this._eventRegistry[t])){var l=this._eventRegistry[t].indexOf(n);this._eventRegistry[t].splice(l,1)}},Notifications.prototype._handleGlobalStorageEvent=function(t){var n;if(this.dispatchNamespace&&(null===(n=t.key)||void 0===n?void 0:n.startsWith(this.dispatchNamespace+":"))){var l=t.key.substring(this.dispatchNamespace.length+1);this.dispatchEvent(l,JSON.parse(t.newValue))}},Notifications}(),isMergeableObject=function(t){return function(t){return!!t&&"object"==typeof t}(t)&&!function(t){var n=Object.prototype.toString.call(t);return"[object RegExp]"===n||"[object Date]"===n||function(t){return t.$$typeof===Ie}(t)}(t)};var Ae,Ie="function"==typeof Symbol&&Symbol.for?Symbol.for("react.element"):60103;function cloneUnlessOtherwiseSpecified(t,n){return!1!==n.clone&&n.isMergeableObject(t)?deepmerge((l=t,Array.isArray(l)?[]:{}),t,n):t;var l}function defaultArrayMerge(t,n,l){return t.concat(n).map((function(t){return cloneUnlessOtherwiseSpecified(t,l)}))}function getKeys(t){return Object.keys(t).concat(function(t){return Object.getOwnPropertySymbols?Object.getOwnPropertySymbols(t).filter((function(n){return t.propertyIsEnumerable(n)})):[]}(t))}function mergeObject(t,n,l){var d={};return l.isMergeableObject(t)&&getKeys(t).forEach((function(n){d[n]=cloneUnlessOtherwiseSpecified(t[n],l)})),getKeys(n).forEach((function(p){l.isMergeableObject(n[p])&&t[p]?d[p]=function(t,n){if(!n.customMerge)return deepmerge;var l=n.customMerge(t);return"function"==typeof l?l:deepmerge}(p,l)(t[p],n[p],l):d[p]=cloneUnlessOtherwiseSpecified(n[p],l)})),d}function deepmerge(t,n,l){(l=l||{}).arrayMerge=l.arrayMerge||defaultArrayMerge,l.isMergeableObject=l.isMergeableObject||isMergeableObject;var d=Array.isArray(n);return d===Array.isArray(t)?d?l.arrayMerge(t,n,l):mergeObject(t,n,l):cloneUnlessOtherwiseSpecified(n,l)}deepmerge.all=function(t,n){if(!Array.isArray(t))throw new Error("first argument should be an array");return t.reduce((function(t,l){return deepmerge(t,l,n)}),{})},function(t){t.dataRecordDidDelete="dataRecordDidDelete",t.dataRecordWillDelete="dataRecordWillDelete",t.dataRecordDidMaterialize="dataRecordDidMaterialize",t.dataRecordDidPopulate="dataRecordDidPopulate",t.dataRecordWillPopulate="dataRecordWillPopulate"}(Ae||(Ae={}));var isDataRecord=function(t){return!(!t||"function"!=typeof t.hasAttributes||"function"!=typeof t.hasRelationships||"function"!=typeof t.hasViews||"function"!=typeof t.serialize)},Ee=function(){function DataRecord(t,n,l){void 0===l&&(l={}),this.type=t,this.id=n,this._mjs={attributes:[],relationships:[],views:[]},this._meta={},this._mjs=se(se({},this._mjs),l)}return DataRecord.prototype.hasProperties=function(t){return!t||(t.attributes||t.relationships||t.views?!(t.attributes&&!this.hasAttributes(t.attributes))&&(!(t.relationships&&!this.hasRelationships(t.relationships))&&!(t.views&&!this.hasViews(t.views))):this.hasAttributes()||this.hasRelationships()||this.hasViews())},DataRecord.prototype.hasAttributes=function(t){return this._hasProperties(this._mjs.attributes,t)},DataRecord.prototype.hasRelationships=function(t){return this._hasProperties(this._mjs.relationships,t)},DataRecord.prototype.hasViews=function(t){return this._hasProperties(this._mjs.views,t)},DataRecord.prototype.meta=function(t){return t?this._meta[t]:this._meta},DataRecord.prototype.serialize=function(t,n,l){var d=this;void 0===t&&(t=!0),void 0===n&&(n={}),void 0===l&&(l={});var p={id:this.id,type:this.type};return n[this.type+"-"+this.id]?p:(n[this.type+"-"+this.id]=!0,this.hasAttributes()&&(p.attributes=this._mjs.attributes.reduce((function(t,n){return t[n]=d[n],t}),{})),this._mjs.relationships.length>0&&(p.relationships=this._serializeRelatedData(this._mjs.relationships,n,l)),this._mjs.views.length>0&&(p.views=this._serializeRelatedData(this._mjs.views,n,l)),t?{data:p}:p)},DataRecord.prototype.setProperty=function(t,n,l,d){function isMergeableObject(t){return!(!t||"object"!=typeof t||t instanceof DataRecord)}void 0===l&&(l="attributes"),void 0===d&&(d={}),this.hasOwnProperty(t)||(this._mjs[l]||(this._mjs[l]=[]),this._mjs[l].push(t));var setDescriptor=function(t){return{value:t,writable:!0,configurable:!0,enumerable:!0}};this[t]&&n&&"object"==typeof this[t]&&"object"==typeof n?"attributes"===l?Object.defineProperty(this,t,setDescriptor(deepmerge(this[t],n,{arrayMerge:function(t,n,l){return n},isMergeableObject:isMergeableObject}))):"relationships"===l&&Array.isArray(this[t])&&d.extendRelationships?Object.defineProperty(this,t,setDescriptor(deepmerge(this[t],n,{isMergeableObject:isMergeableObject}))):Object.defineProperty(this,t,setDescriptor(n)):Object.defineProperty(this,t,setDescriptor(n))},DataRecord.prototype.removeRelative=function(t,n){this[t]&&(Array.isArray(this[t])?this[t]=this[t].filter((function(t){return t.id!==n})):delete this[t])},DataRecord.prototype.setParent=function(t){var n=this._mjs.parents,l=n&&n.length>0;this._mjs.parents=l?n.concat(t):t},DataRecord.prototype._hasProperties=function(t,n){return!!t&&(n?ensureArray(n).every((function(n){return t.includes(n)})):t.length>0)},DataRecord.prototype._serializeRelatedData=function(t,n,l){var d=this;return void 0===n&&(n={}),void 0===l&&(l={}),t.reduce((function(t,p){if(l.excludeRelationships&&l.excludeRelationships.has(p))return t;if(l.includeRelationships&&!l.includeRelationships.has(p))return t;var h=d[p];return Array.isArray(h)?t[p]={data:h.map((function(t){return"function"==typeof t.serialize?t.serialize(!1,n,l):t}))}:t[p]=h&&"function"==typeof h.serialize?h.serialize(!1,n,l):h,t}),{})},DataRecord}(),we=function(t){function DataStore(n){void 0===n&&(n={});var l=t.call(this,[Ae.dataRecordDidDelete,Ae.dataRecordWillDelete,Ae.dataRecordDidMaterialize,Ae.dataRecordWillPopulate,Ae.dataRecordDidPopulate])||this;return l._removeOnExpiration=!1,l._shouldDisableRecordReuse=!0,l._records={},l._expiryRecords=new Set,l._removeOnExpiration=!!n.removeOnExpiration,l._mapping=n.mapping,l._shouldDisableRecordReuse=!!n.shouldDisableRecordReuse,l.filter=n.filter,l}return __extends$1(DataStore,t),Object.defineProperty(DataStore.prototype,"mapping",{get:function(){return this._mapping},set:function(t){this._mapping=t},enumerable:!0,configurable:!0}),DataStore.prototype.clear=function(){this._records={},this._expiryRecords=new Set},DataStore.prototype.peek=function(t,n,l){var d=this;if(this._checkForExpiredRecords(),!this._records[t])return n?null:[];if(!n)return Object.values(this._records[t]);if(Array.isArray(n))return n.map((function(n){var p=d._records[t][n];if(p&&p.hasProperties(l))return p}));var p=this._records[t][n];return p&&p.hasProperties(l)?p:null},DataStore.prototype.populateDataRecords=function(t,n,l){var d=this;if(void 0===n&&(n={}),void 0===l&&(l={}),!t.data)return[];if(!Array.isArray(t.data))return this.populateDataRecord(t.data,n,l);var p=[];return t.data.forEach((function(t,h){var f=se(se({},l),{parents:l.parents?[se(se({},l.parents[0]),{position:h})]:[]});l.parents&&(l.parents[0].position=h);var y=d.populateDataRecord(t,n,f);p.push(y)})),p},DataStore.prototype.populateDataRecord=function(t,n,l){var d=this;void 0===n&&(n={});var p=l.filter||this.filter,h=l.mapping||this.mapping;if(!p||p(t)){if(h){var f="function"==typeof h?h(t):transform(h,t);Object.assign(t,f)}this._shouldDisableRecordReuse&&(n={});var y=this._materializeRecord(n,se({id:t.id,type:t.type},l));return t.meta&&(y._meta=t.meta),t.attributes&&t.attributes.cachingPolicy&&t.attributes.cachingPolicy.maxAge&&(y._mjs.expiration=Date.now()+1e3*t.attributes.cachingPolicy.maxAge,this._removeOnExpiration&&this._expiryRecords.add(y)),this._populateDataAttributes(t,y),"object"==typeof t.relationships&&Object.keys(t.relationships).forEach((function(p){var f=t.relationships[p];f&&"data"in f&&(f=d.populateDataRecords(f,n,{mapping:h,parents:[{relationshipName:p,parentType:y.type,parentId:y.id}]}),y.setProperty(p,f,"relationships",l))})),"object"==typeof t.views&&Object.keys(t.views).forEach((function(l){var p=t.views[l];if(p.attributes||p.data){var f=new Ee("view",l);if(d._populateDataAttributes(p,f),p.data){var v=d.populateDataRecords(p,n,h);f.setProperty("data",v,"relationships")}y.setProperty(l,f,"views")}})),y}},DataStore.prototype.query=function(t,n){this._checkForExpiredRecords();var includeRecord=function(t){return!1};return"string"==typeof t&&n?includeRecord=function(l){return(null==l?void 0:l[t])===n}:"function"==typeof t?includeRecord=function(n){try{return t(n)}catch(e){return!1}}:"object"==typeof t&&(includeRecord=function(n){var l=Object.keys(t),d=0;return l.forEach((function(l){(null==n?void 0:n[l])===t[l]&&d++})),l.length===d}),Object.values(this._records).reduce((function(t,n){return Object.values(n).forEach((function(n){includeRecord(n)&&t.push(n)})),t}),[])},DataStore.prototype.remove=function(t,n){var l=this;if(setTimeout(this._checkForExpiredRecords.bind(this),0),this._records.hasOwnProperty(t)){var d=this.peek(t,n);d&&(this.dispatchEvent(Ae.dataRecordWillDelete,[t,n]),d._mjs.parents&&d._mjs.parents.length>0&&d._mjs.parents.forEach((function(t){var n=t.relationshipName,p=t.parentType,h=t.parentId;l.peek(p,h).removeRelative(n,d.id)})),delete this._records[t][n],this.dispatchEvent(Ae.dataRecordDidDelete,[t,n]))}},DataStore.prototype.save=function(t,n){return void 0===n&&(n={}),setTimeout(this._checkForExpiredRecords.bind(this),0),this.populateDataRecords(t,this._records,n)},DataStore.prototype._populateDataAttributes=function(t,n){"object"==typeof t.attributes&&(this.dispatchEvent(Ae.dataRecordWillPopulate,[n.type,n.id]),Object.keys(t.attributes).forEach((function(l){n.setProperty(l,t.attributes[l],"attributes")})),this.dispatchEvent(Ae.dataRecordDidPopulate,[n.type,n.id]))},DataStore.prototype._materializeRecord=function(t,n){var l=n.type,d=n.id,p=function(t,n){var l={};for(var d in t)Object.prototype.hasOwnProperty.call(t,d)&&n.indexOf(d)<0&&(l[d]=t[d]);if(null!=t&&"function"==typeof Object.getOwnPropertySymbols){var p=0;for(d=Object.getOwnPropertySymbols(t);p<d.length;p++)n.indexOf(d[p])<0&&(l[d[p]]=t[d[p]])}return l}(n,["type","id"]);return t[l]=t[l]||{},t[l][d]?t[l][d].setParent(p.parents||[]):t[l][d]=new Ee(l,d,p),this.dispatchEvent(Ae.dataRecordDidMaterialize,[l,d]),t[l][d]},DataStore.prototype._checkForExpiredRecords=function(){var t=this,n=[];this._expiryRecords.forEach((function(l){Date.now()>l._mjs.expiration&&(n.push([l.type,l.id]),t._expiryRecords.delete(l))})),n.forEach((function(n){t.remove.apply(t,__spread$1(n))}))},DataStore}(ke),Oe=["trace","debug","info","warn","error"],isTopicLog=function(t){return"object"==typeof t&&null!==t&&"string"==typeof t.topic},Nonsole=function(){};Oe.forEach((function(t){Nonsole.prototype[t]=function(){}}));var Re=new Nonsole,getConsole=function(){return"undefined"==typeof console?Re:console},Ce="undefined"==typeof localStorage?void 0:localStorage,getConfiguredLevel=function(t,n){return void 0===t&&(t="mk-debug"),void 0===n&&(n=Oe.length),parseInt(Me(t,n),10)},Me=memoize((function(t,n){var l,d;return null!==(d=null===(l=null==Ce?void 0:Ce.getItem)||void 0===l?void 0:l.call(Ce,t))&&void 0!==d?d:""+n})),canLogLevel=function(t,n){return-1!==getAllowedLevels(getConfiguredLevel(n)).indexOf(t)},getAllowedLevels=function(t){return isNaN(t)||t<0?[]:Oe.slice(t)},canLogTopic=function(t,n){var l,d,p=(void 0===(l=n)&&(l="mk-debug-topic"),void 0===d&&(d="*"),Me(l,d));return Ne(p).some((function(n){return n.test(t)}))},Ne=memoize((function(t){return t.split(/[\s,]+/).map((function(t){var n=t.replace(/\*/g,".*?");return new RegExp("^"+n+"$")}))})),trace=function(t){for(var n=[],l=1;l<arguments.length;l++)n[l-1]=arguments[l];return logMessage.apply(void 0,__spread$1([se({level:"trace"},t)],n))},debug=function(t){for(var n=[],l=1;l<arguments.length;l++)n[l-1]=arguments[l];return logMessage.apply(void 0,__spread$1([se({level:"debug"},t)],n))},warn=function(t){for(var n=[],l=1;l<arguments.length;l++)n[l-1]=arguments[l];return logMessage.apply(void 0,__spread$1([se({level:"warn"},t)],n))},error=function(t){for(var n=[],l=1;l<arguments.length;l++)n[l-1]=arguments[l];return logMessage.apply(void 0,__spread$1([se({level:"error"},t)],n))},log=function(t){for(var n=[],l=1;l<arguments.length;l++)n[l-1]=arguments[l];return logMessage.apply(void 0,__spread$1([t],n))},logMessage=function(t){for(var n=[],l=1;l<arguments.length;l++)n[l-1]=arguments[l];var d=t.level,p=t.levelKey,h=t.topic,f=t.topicKey;if(canLogLevel(d=null!=d?d:"debug",p)&&canLogTopic(h,f)){var y=getConsole();if("function"==typeof y[d]){var v=__read$1(n),_=v[0],g=v.slice(1);void 0!==h&&(_=h+": "+_),y[d].apply(y,__spread$1([_],g))}}},De=function(){function Logger(t){var n,l,d,p;this._levelFilterKey="mk-debug","string"==typeof t?(this._levelFilterKey=t,this.level=getConfiguredLevel(this._levelFilterKey,5)):"object"==typeof t?(this._levelFilterKey=null!==(n=t.levelFilterStorageKey)&&void 0!==n?n:this._levelFilterKey,this._topicFilterKey=null!==(l=t.topicFilterStorageKey)&&void 0!==l?l:this.generateDefaultTopicFilterStorageKey(this._levelFilterKey),this.topic=t.topic,this.level=null!==(d=t.level)&&void 0!==d?d:getConfiguredLevel(this._levelFilterKey,5)):this.level=null!=t?t:getConfiguredLevel(this._levelFilterKey,5),this._topicFilterKey=null!==(p=this._topicFilterKey)&&void 0!==p?p:this.generateDefaultTopicFilterStorageKey(this._levelFilterKey)}return Object.defineProperty(Logger.prototype,"enabled",{get:function(){return this.level<5},set:function(t){this.level=t?1:5},enumerable:!0,configurable:!0}),Logger.prototype.debug=function(t){for(var n=[],l=1;l<arguments.length;l++)n[l-1]=arguments[l];this.callLogMethod.apply(this,__spread$1([debug,t],n))},Logger.prototype.error=function(t){for(var n=[],l=1;l<arguments.length;l++)n[l-1]=arguments[l];this.callLogMethod.apply(this,__spread$1([error,t],n))},Logger.prototype.log=function(t){for(var n=[],l=1;l<arguments.length;l++)n[l-1]=arguments[l];this.callLogMethod.apply(this,__spread$1([log,t],n))},Logger.prototype.trace=function(t){for(var n=[],l=1;l<arguments.length;l++)n[l-1]=arguments[l];this.callLogMethod.apply(this,__spread$1([trace,t],n))},Logger.prototype.warn=function(t){for(var n=[],l=1;l<arguments.length;l++)n[l-1]=arguments[l];this.callLogMethod.apply(this,__spread$1([warn,t],n))},Logger.prototype.callLogMethod=function(t,n){for(var l,d,p=[],h=2;h<arguments.length;h++)p[h-2]=arguments[h];var f={levelKey:this._levelFilterKey,topicKey:this._topicFilterKey,topic:this.topic},y=n;isTopicLog(n)&&(f.topic=null!==(l=n.topic)&&void 0!==l?l:f.topic,y=null!==(d=n.message)&&void 0!==d?d:p.shift()),t.apply(void 0,__spread$1([f,y],p))},Logger.prototype.generateDefaultTopicFilterStorageKey=function(t){return t+"-topic"},Logger}(),Le=new De,logDeprecation=function(t,n){if(void 0===n&&(n={}),Le&&Le.enabled){var l=[];l.push("Deprecation warning:"),l.push(n.message||t+" has been deprecated."),void 0!==n.until&&l.push(t+" will be removed in version "+n.until+"."),Le.warn(l.join(" "))}},xe={400:"REQUEST_ERROR",401:"UNAUTHORIZED_ERROR",403:"ACCESS_DENIED",404:"NOT_FOUND",405:"NOT_FOUND",413:"REQUEST_ERROR",414:"REQUEST_ERROR",429:"QUOTA_EXCEEDED",500:"SERVER_ERROR",501:"NOT_FOUND",503:"SERVICE_UNAVAILABLE"},Ue={"-1004":"DEVICE_LIMIT",1010:xe[404],2002:"AUTHORIZATION_ERROR",2034:"TOKEN_EXPIRED",3059:"DEVICE_LIMIT",3063:"SUBSCRIPTION_ERROR",3076:"CONTENT_UNAVAILABLE",3082:"CONTENT_RESTRICTED",3084:"STREAM_UPSELL",5002:xe[500],180202:"PLAYREADY_CBC_ENCRYPTION_ERROR"},Be=[],je=new Set(["UNSUPPORTED_ERROR","CONTENT_EQUIVALENT","CONTENT_UNAVAILABLE","CONTENT_UNSUPPORTED","SERVER_ERROR","SUBSCRIPTION_ERROR"]),Fe=function(t){function MKError(n,l){var d=t.call(this)||this;return d.errorCode="UNKNOWN_ERROR",n&&je.has(n)?(d.name=d.errorCode=n,d.message=d.description=l||n):l||"string"!=typeof n?(d.name=d.errorCode=n||"UNKNOWN_ERROR",l&&(d.message=d.description=l)):(d.name=d.errorCode="UNKNOWN_ERROR",d.message=d.description=n),Be.push(d),Error.captureStackTrace&&Error.captureStackTrace(d,MKError),d}return __extends$1(MKError,t),Object.defineProperty(MKError,"errors",{get:function(){return Be},enumerable:!0,configurable:!0}),MKError.playActivityError=function(t){return new this("PLAY_ACTIVITY",t)},MKError.parseError=function(t){return new this("PARSE_ERROR",t)},MKError.responseError=function(t){var n=t.status,l=t.statusText,d=new this(xe[n]||"NETWORK_ERROR",l||""+n);return d.data=t,d},MKError.serverError=function(t){var n=t.status,l=t.dialog,d=t.failureType,p=t.customerMessage,h=t.errorMessage,f=t.message;l&&(f=l.message||l.customerMessage||l.errorMessage,l.message=f);var y=Ue[d]||Ue[n]||"UNKNOWN_ERROR",v=new this(y,f||p||h);return"STREAM_UPSELL"===y&&l&&l.okButtonAction&&l.okButtonAction.url&&(l.okButtonAction.url=l.okButtonAction.url.replace(/\&(?:challenge|key-system|uri|user-initiated)=[^\&]+/gim,"")),v.dialog=l,v},MKError.internalError=function(t){return new this(MKError.INTERNAL_ERROR,t)},MKError.ACCESS_DENIED=xe[403],MKError.AGE_VERIFICATION="AGE_VERIFICATION",MKError.AUTHORIZATION_ERROR=Ue[2002],MKError.CONFIGURATION_ERROR="CONFIGURATION_ERROR",MKError.CONTENT_EQUIVALENT="CONTENT_EQUIVALENT",MKError.CONTENT_RESTRICTED=Ue[3082],MKError.CONTENT_UNAVAILABLE=Ue[3076],MKError.CONTENT_UNSUPPORTED="CONTENT_UNSUPPORTED",MKError.DEVICE_LIMIT=Ue[3059],MKError.INVALID_ARGUMENTS="INVALID_ARGUMENTS",MKError.PLAYREADY_CBC_ENCRYPTION_ERROR="PLAYREADY_CBC_ENCRYPTION_ERROR",MKError.MEDIA_CERTIFICATE="MEDIA_CERTIFICATE",MKError.MEDIA_DESCRIPTOR="MEDIA_DESCRIPTOR",MKError.MEDIA_LICENSE="MEDIA_LICENSE",MKError.MEDIA_KEY="MEDIA_KEY",MKError.MEDIA_PLAYBACK="MEDIA_PLAYBACK",MKError.MEDIA_SESSION="MEDIA_SESSION",MKError.NETWORK_ERROR="NETWORK_ERROR",MKError.NOT_FOUND=Ue[1010],MKError.PARSE_ERROR="PARSE_ERROR",MKError.PLAY_ACTIVITY="PLAY_ACTIVITY",MKError.QUOTA_EXCEEDED=xe[429],MKError.REQUEST_ERROR=xe[400],MKError.SERVER_ERROR=Ue[5002],MKError.SERVICE_UNAVAILABLE=xe[503],MKError.STREAM_UPSELL=Ue[3084],MKError.SUBSCRIPTION_ERROR=Ue[3063],MKError.TOKEN_EXPIRED=Ue[2034],MKError.UNAUTHORIZED_ERROR=xe[401],MKError.UNKNOWN_ERROR="UNKNOWN_ERROR",MKError.UNSUPPORTED_ERROR="UNSUPPORTED_ERROR",MKError.INTERNAL_ERROR="INTERNAL_ERROR",MKError.OUTPUT_RESTRICTED="OUTPUT_RESTRICTED",MKError}(Error);var Ke,Ve,$e,Ye,He,We,ze,Ge,qe,Qe={AW:"ABW",AF:"AFG",AO:"AGO",AI:"AIA",AX:"ALA",AL:"ALB",AD:"AND",AE:"ARE",AR:"ARG",AM:"ARM",AS:"ASM",AQ:"ATA",TF:"ATF",AG:"ATG",AU:"AUS",AT:"AUT",AZ:"AZE",BI:"BDI",BE:"BEL",BJ:"BEN",BQ:"BES",BF:"BFA",BD:"BGD",BG:"BGR",BH:"BHR",BS:"BHS",BA:"BIH",BL:"BLM",BY:"BLR",BZ:"BLZ",BM:"BMU",BO:"BOL",BR:"BRA",BB:"BRB",BN:"BRN",BT:"BTN",BV:"BVT",BW:"BWA",CF:"CAF",CA:"CAN",CC:"CCK",CH:"CHE",CL:"CHL",CN:"CHN",CI:"CIV",CM:"CMR",CD:"COD",CG:"COG",CK:"COK",CO:"COL",KM:"COM",CV:"CPV",CR:"CRI",CU:"CUB",CW:"CUW",CX:"CXR",KY:"CYM",CY:"CYP",CZ:"CZE",DE:"DEU",DJ:"DJI",DM:"DMA",DK:"DNK",DO:"DOM",DZ:"DZA",EC:"ECU",EG:"EGY",ER:"ERI",EH:"ESH",ES:"ESP",EE:"EST",ET:"ETH",FI:"FIN",FJ:"FJI",FK:"FLK",FR:"FRA",FO:"FRO",FM:"FSM",GA:"GAB",GB:"GBR",GE:"GEO",GG:"GGY",GH:"GHA",GI:"GIB",GN:"GIN",GP:"GLP",GM:"GMB",GW:"GNB",GQ:"GNQ",GR:"GRC",GD:"GRD",GL:"GRL",GT:"GTM",GF:"GUF",GU:"GUM",GY:"GUY",HK:"HKG",HM:"HMD",HN:"HND",HR:"HRV",HT:"HTI",HU:"HUN",ID:"IDN",IM:"IMN",IN:"IND",IO:"IOT",IE:"IRL",IR:"IRN",IQ:"IRQ",IS:"ISL",IL:"ISR",IT:"ITA",JM:"JAM",JE:"JEY",JO:"JOR",JP:"JPN",KZ:"KAZ",KE:"KEN",KG:"KGZ",KH:"KHM",KI:"KIR",KN:"KNA",KR:"KOR",KW:"KWT",LA:"LAO",LB:"LBN",LR:"LBR",LY:"LBY",LC:"LCA",LI:"LIE",LK:"LKA",LS:"LSO",LT:"LTU",LU:"LUX",LV:"LVA",MO:"MAC",MF:"MAF",MA:"MAR",MC:"MCO",MD:"MDA",MG:"MDG",MV:"MDV",MX:"MEX",MH:"MHL",MK:"MKD",ML:"MLI",MT:"MLT",MM:"MMR",ME:"MNE",MN:"MNG",MP:"MNP",MZ:"MOZ",MR:"MRT",MS:"MSR",MQ:"MTQ",MU:"MUS",MW:"MWI",MY:"MYS",YT:"MYT",NA:"NAM",NC:"NCL",NE:"NER",NF:"NFK",NG:"NGA",NI:"NIC",NU:"NIU",NL:"NLD",NO:"NOR",NP:"NPL",NR:"NRU",NZ:"NZL",OM:"OMN",PK:"PAK",PA:"PAN",PN:"PCN",PE:"PER",PH:"PHL",PW:"PLW",PG:"PNG",PL:"POL",PR:"PRI",KP:"PRK",PT:"PRT",PY:"PRY",PS:"PSE",PF:"PYF",QA:"QAT",RE:"REU",RO:"ROU",RU:"RUS",RW:"RWA",SA:"SAU",SD:"SDN",SN:"SEN",SG:"SGP",GS:"SGS",SH:"SHN",SJ:"SJM",SB:"SLB",SL:"SLE",SV:"SLV",SM:"SMR",SO:"SOM",PM:"SPM",RS:"SRB",SS:"SSD",ST:"STP",SR:"SUR",SK:"SVK",SI:"SVN",SE:"SWE",SZ:"SWZ",SX:"SXM",SC:"SYC",SY:"SYR",TC:"TCA",TD:"TCD",TG:"TGO",TH:"THA",TJ:"TJK",TK:"TKL",TM:"TKM",TL:"TLS",TO:"TON",TT:"TTO",TN:"TUN",TR:"TUR",TV:"TUV",TW:"TWN",TZ:"TZA",UG:"UGA",UA:"UKR",UM:"UMI",UY:"URY",US:"USA",UZ:"UZB",VA:"VAT",VC:"VCT",VE:"VEN",VG:"VGB",VI:"VIR",VN:"VNM",VU:"VUT",WF:"WLF",WS:"WSM",XK:"XKX",YE:"YEM",ZA:"ZAF",ZM:"ZMB",ZW:"ZWE"},Je=function(){function PubSub(){this.events={}}return PubSub.prototype.publish=function(t,n){var l=this.getSubscribersForType(t);void 0!==l&&l.forEach((function(l){l(t,n)}))},PubSub.prototype.subscribe=function(t,n){this.getSubscribersForType(t,!0).push(n)},PubSub.prototype.subscribeOnce=function(t,n){var l=this,onceCallback=function(t,d){l.unsubscribe(t,onceCallback),n(t,d)};this.subscribe(t,onceCallback)},PubSub.prototype.unsubscribe=function(t,n){var l=this.getSubscribersForType(t);if(void 0!==l)for(var d in l)if(l[d]===n){delete l[d];break}},PubSub.prototype.clear=function(t){void 0===t?this.events={}:delete this.events[t]},PubSub.prototype.getSubscribersForType=function(t,n){return void 0===n&&(n=!1),!this.events.hasOwnProperty(t)&&n&&(this.events[t]=[]),this.events[t]},PubSub}(),Xe={},getPromiseForKey=function(t){var n=Xe[t];return n||(n=Promise.resolve(),Xe[t]=n),n},SerialAsync=function(t){var n=Promise.resolve();return function(l,d,p){var h=p.value;return p.value=function(){for(var l=[],d=0;d<arguments.length;d++)l[d]=arguments[d];return __awaiter$1(this,void 0,void 0,(function(){var d=this;return __generator$1(this,(function(p){return t&&(n=getPromiseForKey(t)),n=n.catch((function(){})).then((function(){return h.apply(d,l)})),t&&(Xe[t]=n),[2,n]}))}))},p}};(Ke=t.PlaybackBitrate||(t.PlaybackBitrate={}))[Ke.STANDARD=64]="STANDARD",Ke[Ke.HIGH=256]="HIGH",function(t){t.apiStorefrontChanged="apiStorefrontChanged",t.hlsLevelUpdated="hlsLevelUpdated",t.mediaContentComplete="mediaContentComplete",t.playbackPause="playbackPause",t.playbackPlay="playbackPlay",t.playbackScrub="playbackScrub",t.playbackSeek="playbackSeek",t.playbackSkip="playbackSkip",t.playbackStop="playbackStop",t.playerActivate="playerActivate",t.playerExit="playerExit",t.queueModified="queueModified",t.userActivityIntent="userActivityIntent",t.applicationActivityIntent="applicationActivityIntent"}(Ve||(Ve={})),function(t){t.MUSICKIT="music_kit-integration",t.OTHER="other",t.MINI="mini",t.SONG="song",t.ALBUM="album",t.ALBUM_CLASSICAL="album-classical",t.ARTIST="artist",t.COMPILATION="compilation",t.COMPILATION_CLASSICAL="compilation-classical",t.PLAYLIST="playlist",t.PLAYLIST_CLASSICAL="playlist-classical",t.SEARCH="search",t.STATION="station"}($e||($e={})),function(t){t[t.UNKNOWN=0]="UNKNOWN",t[t.RADIO=1]="RADIO",t[t.PLAYLIST=2]="PLAYLIST",t[t.ALBUM=3]="ALBUM",t[t.ARTIST=4]="ARTIST"}(Ye||(Ye={})),function(t){t[t.NOT_APPLICABLE=0]="NOT_APPLICABLE",t[t.OTHER=1]="OTHER",t[t.TRACK_SKIPPED_FORWARDS=2]="TRACK_SKIPPED_FORWARDS",t[t.PLAYBACK_MANUALLY_PAUSED=3]="PLAYBACK_MANUALLY_PAUSED",t[t.PLAYBACK_SUSPENDED=4]="PLAYBACK_SUSPENDED",t[t.MANUALLY_SELECTED_PLAYBACK_OF_A_DIFF_ITEM=5]="MANUALLY_SELECTED_PLAYBACK_OF_A_DIFF_ITEM",t[t.PLAYBACK_PAUSED_DUE_TO_INACTIVITY=6]="PLAYBACK_PAUSED_DUE_TO_INACTIVITY",t[t.NATURAL_END_OF_TRACK=7]="NATURAL_END_OF_TRACK",t[t.PLAYBACK_STOPPED_DUE_TO_SESSION_TIMEOUT=8]="PLAYBACK_STOPPED_DUE_TO_SESSION_TIMEOUT",t[t.TRACK_BANNED=9]="TRACK_BANNED",t[t.FAILED_TO_LOAD=10]="FAILED_TO_LOAD",t[t.PAUSED_ON_TIMEOUT=11]="PAUSED_ON_TIMEOUT",t[t.SCRUB_BEGIN=12]="SCRUB_BEGIN",t[t.SCRUB_END=13]="SCRUB_END",t[t.TRACK_SKIPPED_BACKWARDS=14]="TRACK_SKIPPED_BACKWARDS",t[t.NOT_SUPPORTED_BY_CLIENT=15]="NOT_SUPPORTED_BY_CLIENT",t[t.QUICK_PLAY=16]="QUICK_PLAY",t[t.EXITED_APPLICATION=17]="EXITED_APPLICATION"}(He||(He={})),(We=t.SeekReasonType||(t.SeekReasonType={}))[We.Manual=0]="Manual",We[We.Interval=1]="Interval",We[We.SkipIntro=2]="SkipIntro",function(t){t[t.UNKNOWN=0]="UNKNOWN",t[t.NO_RIGHTS=1]="NO_RIGHTS",t[t.PURCHASED=2]="PURCHASED",t[t.UPLOADED=3]="UPLOADED",t[t.MATCHED=4]="MATCHED",t[t.ADDED=5]="ADDED",t[t.SUBSCRIBED=6]="SUBSCRIBED",t[t.NOT_SUPPORTED=7]="NOT_SUPPORTED"}(ze||(ze={})),function(t){t[t.NO_SELECTION_PLAY=0]="NO_SELECTION_PLAY",t[t.RESUME_LAST_PLAYED_SONG=1]="RESUME_LAST_PLAYED_SONG",t[t.RESUME_CURRENT_DEVICE_POSITION=2]="RESUME_CURRENT_DEVICE_POSITION"}(Ge||(Ge={})),function(t){t[t.NOT_APPLICABLE=0]="NOT_APPLICABLE",t[t.SIMILARITIES=1]="SIMILARITIES",t[t.ESSENTIALS=2]="ESSENTIALS",t[t.USER_LIBRARY=3]="USER_LIBRARY",t[t.ALGO_HEATSEEKER=4]="ALGO_HEATSEEKER",t[t.SEED_TRACK=5]="SEED_TRACK",t[t.GN_1M_TEMPORARY=6]="GN_1M_TEMPORARY",t[t.VECTOR=8]="VECTOR",t[t.ARTIST_SIMILARITIES=9]="ARTIST_SIMILARITIES",t[t.STORY_ALBUM_LISTENERS_ALSO_BOUGHT=10]="STORY_ALBUM_LISTENERS_ALSO_BOUGHT",t[t.STORY_ALBUM_SALES_LEADER=11]="STORY_ALBUM_SALES_LEADER",t[t.STORY_BILLBOARD=12]="STORY_BILLBOARD",t[t.STORY_COMPLETE_MY_ALBUM=13]="STORY_COMPLETE_MY_ALBUM",t[t.STORY_CRITICAL_PICK=14]="STORY_CRITICAL_PICK",t[t.STORY_ITUNES_ESSENTIAL=15]="STORY_ITUNES_ESSENTIAL",t[t.STORY_HEATSEEKER=16]="STORY_HEATSEEKER",t[t.STORY_IDENTITY=17]="STORY_IDENTITY",t[t.STORY_POWER_SONG=18]="STORY_POWER_SONG",t[t.STORY_SONG_SALES_LEADER=20]="STORY_SONG_SALES_LEADER",t[t.GENRE_SIMILARITIES=21]="GENRE_SIMILARITIES",t[t.STORY_IMIX=22]="STORY_IMIX",t[t.STORY_OTHER_MIX=23]="STORY_OTHER_MIX",t[t.EDITORIAL=24]="EDITORIAL",t[t.TOP_SONGS=25]="TOP_SONGS",t[t.SUBFORMAT_SONGS=26]="SUBFORMAT_SONGS",t[t.CRITICAL_PICKS=27]="CRITICAL_PICKS",t[t.US_ARTIST_SIMS=28]="US_ARTIST_SIMS",t[t.HEAVY_ROTATION=29]="HEAVY_ROTATION",t[t.STORY_FORMAT_STATION_HEAVY_ROTATION=30]="STORY_FORMAT_STATION_HEAVY_ROTATION",t[t.ARTIST_BASED_CORE_SIMILAR_ARTISTS=31]="ARTIST_BASED_CORE_SIMILAR_ARTISTS",t[t.ARTIST_BASED_FAMILIAR_SIMILAR_ARTISTS=32]="ARTIST_BASED_FAMILIAR_SIMILAR_ARTISTS",t[t.ARTIST_BASED_DISCOVERIES=33]="ARTIST_BASED_DISCOVERIES",t[t.ARTIST_BASED_HOT_SONGS=34]="ARTIST_BASED_HOT_SONGS",t[t.ARTIST_BASED_SEED_ARTIST=35]="ARTIST_BASED_SEED_ARTIST",t[t.ARTIST_BASED_COMPOSER=36]="ARTIST_BASED_COMPOSER",t[t.EDITORIAL_STATION_INTRO=37]="EDITORIAL_STATION_INTRO",t[t.EDITORIAL_RELATIVE_REPEAT=38]="EDITORIAL_RELATIVE_REPEAT",t[t.EDITORIAL_ABSOLUTE_REPEAT=39]="EDITORIAL_ABSOLUTE_REPEAT",t[t.EDITORIAL_SCHEDULED=40]="EDITORIAL_SCHEDULED",t[t.EDITORIAL_SUGGESTED_ARTIST=41]="EDITORIAL_SUGGESTED_ARTIST",t[t.FOR_YOU_FAMILIAR=42]="FOR_YOU_FAMILIAR",t[t.FOR_YOU_RECOMMENDED=43]="FOR_YOU_RECOMMENDED",t[t.FOR_YOU_FAVORITE_ARTIST=44]="FOR_YOU_FAVORITE_ARTIST",t[t.FOR_YOU_RECOMMENDED_ARTIST=45]="FOR_YOU_RECOMMENDED_ARTIST",t[t.EDITORIAL_POSITIONAL=46]="EDITORIAL_POSITIONAL",t[t.SIMILAR_SONGS=47]="SIMILAR_SONGS",t[t.SONG_ATTRIBUTE_FAVORITE_ARTIST=48]="SONG_ATTRIBUTE_FAVORITE_ARTIST",t[t.SONG_ATTRIBUTE_FAVORITE_ARTIST_DERIVED=49]="SONG_ATTRIBUTE_FAVORITE_ARTIST_DERIVED",t[t.SONG_ATTRIBUTE_FAVORITE_ARTIST_EDITORIAL=50]="SONG_ATTRIBUTE_FAVORITE_ARTIST_EDITORIAL",t[t.SONG_ATTRIBUTE_RECOMMENDED=51]="SONG_ATTRIBUTE_RECOMMENDED",t[t.SONG_ATTRIBUTE_RECOMMENDED_DERIVED=52]="SONG_ATTRIBUTE_RECOMMENDED_DERIVED",t[t.SONG_ATTRIBUTE_RECOMMENDED_EDITORIAL=53]="SONG_ATTRIBUTE_RECOMMENDED_EDITORIAL",t[t.SONG_ATTRIBUTE_NON_PERSONALIZED=54]="SONG_ATTRIBUTE_NON_PERSONALIZED",t[t.SONG_ATTRIBUTE_NON_PERSONALIZED_DERIVED=55]="SONG_ATTRIBUTE_NON_PERSONALIZED_DERIVED",t[t.SONG_ATTRIBUTE_NON_PERSONALIZED_EDITORIAL=56]="SONG_ATTRIBUTE_NON_PERSONALIZED_EDITORIAL",t[t.PERSONAL_STATION=57]="PERSONAL_STATION",t[t.PERSONAL_STATION_FAVORITE_ARTIST=58]="PERSONAL_STATION_FAVORITE_ARTIST",t[t.PERSONAL_STATION_RECOMMENDED=59]="PERSONAL_STATION_RECOMMENDED",t[t.NEW_MUSIC_STATION=60]="NEW_MUSIC_STATION",t[t.NEW_MUSIC_STATION_FAVORITE_ARTIST=61]="NEW_MUSIC_STATION_FAVORITE_ARTIST",t[t.NEW_MUSIC_STATION_RECOMMENDED=62]="NEW_MUSIC_STATION_RECOMMENDED"}(qe||(qe={}));var Ze,et,tt,rt,it,nt,ot,at,st,ut,ct;!function(t){t[t.UNSPECIFIED=0]="UNSPECIFIED",t[t.STATIC=1]="STATIC",t[t.TIME_SYNCED=2]="TIME_SYNCED"}(Ze||(Ze={})),function(t){t[t.REPEAT_UNKNOWN=0]="REPEAT_UNKNOWN",t[t.REPEAT_OFF=1]="REPEAT_OFF",t[t.REPEAT_ONE=2]="REPEAT_ONE",t[t.REPEAT_ALL=3]="REPEAT_ALL"}(et||(et={})),function(t){t[t.SHUFFLE_UNKNOWN=0]="SHUFFLE_UNKNOWN",t[t.SHUFFLE_OFF=1]="SHUFFLE_OFF",t[t.SHUFFLE_ON=2]="SHUFFLE_ON"}(tt||(tt={})),function(t){t[t.AUTO_UNKNOWN=0]="AUTO_UNKNOWN",t[t.AUTO_OFF=1]="AUTO_OFF",t[t.AUTO_ON=2]="AUTO_ON",t[t.AUTO_ON_CONTENT_UNSUPPORTED=3]="AUTO_ON_CONTENT_UNSUPPORTED"}(rt||(rt={})),function(t){t[t.NOT_SPECIFIED=0]="NOT_SPECIFIED",t[t.CONTAINER_CHANGED=1]="CONTAINER_CHANGED"}(it||(it={})),function(t){t[t.PLAY_END=0]="PLAY_END",t[t.PLAY_START=1]="PLAY_START",t[t.LYRIC_DISPLAY=2]="LYRIC_DISPLAY"}(nt||(nt={})),function(t){t[t.INVALID=0]="INVALID",t[t.ITUNES_STORE_CONTENT=1]="ITUNES_STORE_CONTENT",t[t.NON_SONG_CLIP=2]="NON_SONG_CLIP",t[t.AD=3]="AD",t[t.STREAM=4]="STREAM",t[t.AUDIO_AD=5]="AUDIO_AD",t[t.VIDEO_AD=6]="VIDEO_AD",t[t.TIMED_METADATA_PING=7]="TIMED_METADATA_PING",t[t.ARTIST_UPLOADED_CONTENT=8]="ARTIST_UPLOADED_CONTENT",t[t.AGGREGATE_NON_CATALOG_PLAY_TIME=9]="AGGREGATE_NON_CATALOG_PLAY_TIME",t[t.ORIGINAL_CONTENT_MOVIES=10]="ORIGINAL_CONTENT_MOVIES",t[t.ORIGINAL_CONTENT_SHOWS=11]="ORIGINAL_CONTENT_SHOWS"}(ot||(ot={})),function(t){t[t.AUDIO=0]="AUDIO",t[t.VIDEO=1]="VIDEO"}(at||(at={})),function(t){t[t.AUTO=0]="AUTO",t[t.MANUAL=1]="MANUAL"}(st||(st={})),function(t){t[t.WEBPLAYER=8]="WEBPLAYER",t[t.MUSICKIT=10]="MUSICKIT",t[t.THIRD_PARTY_TV=18]="THIRD_PARTY_TV"}(ut||(ut={})),function(t){t[t.EPISODE=1]="EPISODE",t[t.SHOUTCAST=2]="SHOUTCAST"}(ct||(ct={}));
/*! *****************************************************************************
    Copyright (c) Microsoft Corporation. All rights reserved.
    Licensed under the Apache License, Version 2.0 (the "License"); you may not use
    this file except in compliance with the License. You may obtain a copy of the
    License at http://www.apache.org/licenses/LICENSE-2.0

    THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
    KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
    WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
    MERCHANTABLITY OR NON-INFRINGEMENT.

    See the Apache Version 2.0 License for specific language governing permissions
    and limitations under the License.
    ***************************************************************************** */
var extendStatics$2=function(t,n){return(extendStatics$2=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,n){t.__proto__=n}||function(t,n){for(var l in n)n.hasOwnProperty(l)&&(t[l]=n[l])})(t,n)};function __extends$2(t,n){function __(){this.constructor=t}extendStatics$2(t,n),t.prototype=null===n?Object.create(n):(__.prototype=n.prototype,new __)}var lt,__assign$2=function(){return(__assign$2=Object.assign||function(t){for(var n,l=1,d=arguments.length;l<d;l++)for(var p in n=arguments[l])Object.prototype.hasOwnProperty.call(n,p)&&(t[p]=n[p]);return t}).apply(this,arguments)};function __rest$1(t,n){var l={};for(var d in t)Object.prototype.hasOwnProperty.call(t,d)&&n.indexOf(d)<0&&(l[d]=t[d]);if(null!=t&&"function"==typeof Object.getOwnPropertySymbols){var p=0;for(d=Object.getOwnPropertySymbols(t);p<d.length;p++)n.indexOf(d[p])<0&&Object.prototype.propertyIsEnumerable.call(t,d[p])&&(l[d[p]]=t[d[p]])}return l}function __decorate$1(t,n,l,d){var p,h=arguments.length,f=h<3?n:null===d?d=Object.getOwnPropertyDescriptor(n,l):d;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)f=Reflect.decorate(t,n,l,d);else for(var y=t.length-1;y>=0;y--)(p=t[y])&&(f=(h<3?p(f):h>3?p(n,l,f):p(n,l))||f);return h>3&&f&&Object.defineProperty(n,l,f),f}function __metadata$1(t,n){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(t,n)}function __awaiter$2(t,n,l,d){return new(l||(l=Promise))((function(p,h){function fulfilled(t){try{step(d.next(t))}catch(e){h(e)}}function rejected(t){try{step(d.throw(t))}catch(e){h(e)}}function step(t){t.done?p(t.value):new l((function(n){n(t.value)})).then(fulfilled,rejected)}step((d=d.apply(t,n||[])).next())}))}function __generator$2(t,n){var l,d,p,h,f={label:0,sent:function(){if(1&p[0])throw p[1];return p[1]},trys:[],ops:[]};return h={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(h[Symbol.iterator]=function(){return this}),h;function verb(h){return function(y){return function(h){if(l)throw new TypeError("Generator is already executing.");for(;f;)try{if(l=1,d&&(p=2&h[0]?d.return:h[0]?d.throw||((p=d.return)&&p.call(d),0):d.next)&&!(p=p.call(d,h[1])).done)return p;switch(d=0,p&&(h=[2&h[0],p.value]),h[0]){case 0:case 1:p=h;break;case 4:return f.label++,{value:h[1],done:!1};case 5:f.label++,d=h[1],h=[0];continue;case 7:h=f.ops.pop(),f.trys.pop();continue;default:if(!(p=f.trys,(p=p.length>0&&p[p.length-1])||6!==h[0]&&2!==h[0])){f=0;continue}if(3===h[0]&&(!p||h[1]>p[0]&&h[1]<p[3])){f.label=h[1];break}if(6===h[0]&&f.label<p[1]){f.label=p[1],p=h;break}if(p&&f.label<p[2]){f.label=p[2],f.ops.push(h);break}p[2]&&f.ops.pop(),f.trys.pop();continue}h=n.call(t,f)}catch(e){h=[6,e],d=0}finally{l=p=0}if(5&h[0])throw h[1];return{value:h[0]?h[1]:void 0,done:!0}}([h,y])}}}function __values$1(t){var n="function"==typeof Symbol&&t[Symbol.iterator],l=0;return n?n.call(t):{next:function(){return t&&l>=t.length&&(t=void 0),{value:t&&t[l++],done:!t}}}}function __read$2(t,n){var l="function"==typeof Symbol&&t[Symbol.iterator];if(!l)return t;var d,p,h=l.call(t),f=[];try{for(;(void 0===n||n-- >0)&&!(d=h.next()).done;)f.push(d.value)}catch(error){p={error:error}}finally{try{d&&!d.done&&(l=h.return)&&l.call(h)}finally{if(p)throw p.error}}return f}function __spread$2(){for(var t=[],n=0;n<arguments.length;n++)t=t.concat(__read$2(arguments[n]));return t}
/*! *****************************************************************************
    Copyright (c) Microsoft Corporation. All rights reserved.
    Licensed under the Apache License, Version 2.0 (the "License"); you may not use
    this file except in compliance with the License. You may obtain a copy of the
    License at http://www.apache.org/licenses/LICENSE-2.0

    THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
    KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
    WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
    MERCHANTABLITY OR NON-INFRINGEMENT.

    See the Apache Version 2.0 License for specific language governing permissions
    and limitations under the License.
    ***************************************************************************** */!function(t){t[t.NotStarted=0]="NotStarted",t[t.Running=1]="Running",t[t.Stopped=2]="Stopped"}(lt||(lt={}));var dt={type:"xstate.init"};function e(t){return void 0===t?[]:[].concat(t)}function r(t){return{type:"xstate.assign",assignment:t}}function i(t,n){return"string"==typeof(t="string"==typeof t&&n&&n[t]?n[t]:t)?{type:t}:"function"==typeof t?{type:t.name,exec:t}:t}function o(t){return function(n){return t===n}}function a(t){return"string"==typeof t?{type:t}:t}function u(t,n){return{value:t,context:n,actions:[],changed:!1,matches:o(t)}}function c(t,n){void 0===n&&(n={});var l={config:t,_options:n,initialState:{value:t.initial,actions:e(t.states[t.initial].entry).map((function(t){return i(t,n.actions)})),context:t.context,matches:o(t.initial)},transition:function(n,d){var p,h,f="string"==typeof n?{value:n,context:t.context}:n,y=f.value,v=f.context,_=a(d),g=t.states[y];if(g.on){var m=e(g.on[_.type]),x=function(n){if(void 0===n)return{value:u(y,v)};var d="string"==typeof n?{target:n}:n,p=d.target,h=void 0===p?y:p,f=d.actions,m=void 0===f?[]:f,b=d.cond,P=v;if((void 0===b?function(){return!0}:b)(v,_)){var T=t.states[h],S=!1,k=[].concat(g.exit,m,T.entry).filter((function(t){return t})).map((function(t){return i(t,l._options.actions)})).filter((function(t){if("xstate.assign"===t.type){S=!0;var n=Object.assign({},P);return"function"==typeof t.assignment?n=t.assignment(P,_):Object.keys(t.assignment).forEach((function(l){n[l]="function"==typeof t.assignment[l]?t.assignment[l](P,_):t.assignment[l]})),P=n,!1}return!0}));return{value:{value:h,context:P,actions:k,changed:h!==y||k.length>0||S,matches:o(h)}}}};try{for(var b=function(t){var n="function"==typeof Symbol&&t[Symbol.iterator],l=0;return n?n.call(t):{next:function(){return t&&l>=t.length&&(t=void 0),{value:t&&t[l++],done:!t}}}}(m),P=b.next();!P.done;P=b.next()){var T=x(P.value);if("object"==typeof T)return T.value}}catch(t){p={error:t}}finally{try{P&&!P.done&&(h=b.return)&&h.call(b)}finally{if(p)throw p.error}}}return u(y,v)}};return l}var s=function(t,n){return t.actions.forEach((function(l){var d=l.exec;return d&&d(t.context,n)}))};function f$3(t){var n=t.initialState,l=lt.NotStarted,d=new Set,p={_machine:t,send:function(p){l===lt.Running&&(n=t.transition(n,p),s(n,a(p)),d.forEach((function(t){return t(n)})))},subscribe:function(t){return d.add(t),t(n),{unsubscribe:function(){return d.delete(t)}}},start:function(){return l=lt.Running,s(n,dt),p},stop:function(){return l=lt.Stopped,d.clear(),p},get state(){return n},get status(){return l}};return p}function invoke(t){return void 0===t||function(t){return"function"!=typeof t}(t)?t:t()}var pt=/(?:st|ra)\.([0-9]+)/,ht=/st\.([0-9]+)/,ft=function(){function PlayActivitySender(t){var n,l,d,p;this.mode=st.AUTO,this._isQA=!1,this._logInfo=!1,this._preferDSID=!1,this._accessToken=t.accessToken,this._clientId=t.clientId,this._eventType=t.eventType,this._fetch=null!==(n=t.fetch)&&void 0!==n?n:fetch,this._fetchOptions=null!==(l=t.fetchOptions)&&void 0!==l?l:{},this._headersClass=null!==(d=t.headersClass)&&void 0!==d?d:Headers,this._isQA=null!==(p=t.isQA)&&void 0!==p&&p,this._logInfo=t.logInfo||this._isQA,this._musicUserToken=t.musicUserToken,this._preferDSID=t.preferDSID,this._sourceType=t.sourceType,this._traceTag=t.traceTag}return Object.defineProperty(PlayActivitySender.prototype,"accessToken",{get:function(){return invoke(this._accessToken)},enumerable:!0,configurable:!0}),Object.defineProperty(PlayActivitySender.prototype,"musicUserToken",{get:function(){return invoke(this._musicUserToken)},enumerable:!0,configurable:!0}),Object.defineProperty(PlayActivitySender.prototype,"url",{get:function(){return this._isQA?"https://universal-activity-service.itunes.apple.com/qa/play":"https://universal-activity-service.itunes.apple.com/play"},enumerable:!0,configurable:!0}),PlayActivitySender.prototype.send=function(t){return __awaiter$2(this,void 0,void 0,(function(){var n,l;return __generator$2(this,(function(d){switch(d.label){case 0:if(0===(n={client_id:this._clientId,event_type:this._eventType,data:ensureArray(t)}).data.length)throw new Error("send() called without any data");return l=this._generateFetchOptions({method:"POST",body:JSON.stringify(n),headers:this.headers()}),[4,this._fetch(this.url,l)];case 1:return[4,d.sent().text()];case 2:return d.sent(),this._logInfo&&console.info("play activity:",13===this._sourceType?JSON.stringify(n):n),[2,n]}}))}))},PlayActivitySender.prototype.baseHeaders=function(){var t,n,l=null!==(n=null===(t=this._fetchOptions)||void 0===t?void 0:t.headers)&&void 0!==n?n:{};return l instanceof this._headersClass?new this._headersClass(Array.from(l.entries())):new this._headersClass(l)},PlayActivitySender.prototype.headers=function(){var t=this._preferDSID?"X-Dsid":"media-user-token",n=this.baseHeaders();return n.set("Authorization","Bearer "+this.accessToken),n.set("Content-Type","application/json"),n.set(t,""+this.musicUserToken),this._isQA&&void 0!==this._traceTag&&n.set("Data-Trace-Tag",this._traceTag),n},PlayActivitySender.prototype._generateFetchOptions=function(t){return __assign$2(__assign$2({},this._fetchOptions),t)},PlayActivitySender}(),conditionalObject=function(t,n,l){var d;return t?((d={})[n]=l,d):{}},buildObject=function(t,n){return conditionalObject(void 0!==n,t,n)};var fullAppId=function(t,n){return void 0===(null==n?void 0:n.name)?"MusicKitApp/1.0":void 0!==t?t:function(t){return t.toLowerCase().replace(/[-_]+/g," ").replace(/[^\w\s]/g,"").replace(/\b./g,(function(t){return t.toUpperCase()})).replace(/\s/g,"")}(n.name)+"/"+((null==n?void 0:n.version)||"1.0")},os=function(t){var n,l,d,p,h=t.toLowerCase(),f="Unidentified OS",y=/mobile/.test(h);return y&&/android|adr/.test(h)?(f="Android",p=h.match(/(?:android|adr)\ ((\d+[._])+\d+)/)):y&&/iphone|ipad|ipod/.test(h)?(f="iOS",p=h.match(/os\ ((\d+[._])+\d+)\ like\ mac\ os\ x/)):/tizen/.test(h)?(f="Tizen",p=h.match(/tizen (.*)/)):/web0s|webos/.test(h)?(f="WebOS",p=h.match(/[web0s|webos] (.*)/)):!y&&/cros/.test(h)?f="ChromeOS":!y&&/macintosh/.test(h)?(f="macOS",p=h.match(/os\ x\ ((\d+[._])+\d+)\b/)):!y&&/linux/.test(h)?f="Linux":!y&&/windows/.test(h)&&(f="Windows",p=h.match(/windows ([^\)]*)/)),f+"/"+(null!==(d=null===(l=null===(n=null==p?void 0:p[1])||void 0===n?void 0:n.replace)||void 0===l?void 0:l.call(n,/_/g,"."))&&void 0!==d?d:"0.0")},model=function(t){return"model/"+((null==t?void 0:t.platform)||"Unavailable")},build=function(t){var n=null==t?void 0:t.build;return void 0===n||""===n?"build/0.0.0":"build/"+n},yt={platform:"",userAgent:""},vt=function(){function PlayActivityBase(t,n,l,d){var p,h,f;this._accessToken=t,this._musicUserToken=n,this.storefrontId=l,this.privateEnabled=!1,this.siriInitiated=!1,this.clientId="JSCLIENT",this.eventType="JSPLAY",this.internalBuild=!1,this.preferDSID=!1,this.sourceType=ut.MUSICKIT,this._utcOffset=(new Date).getTimezoneOffset(),this._userIsSubscribed=!0,d&&(this._appInfo=d.app,this._navigator=d.navigator,this._userAgent=d.userAgent,d.hasOwnProperty("utcOffset")&&isNaN(d.utcOffset)?this._utcOffsetInSeconds=-1:d.hasOwnProperty("utcOffset")&&(this._utcOffset=d.utcOffset),this.clientId=d.clientId||"JSCLIENT",this._deviceName=d.deviceName,this.guid=d.guid,this.metricsClientId=d.metricsClientId,this.preferDSID=null!==(p=d.preferDSID)&&void 0!==p&&p,this.sourceType=d.sourceType&&"number"==typeof d.sourceType?d.sourceType:ut.MUSICKIT,this._userIsSubscribed=null===(h=d.userIsSubscribed)||void 0===h||h),this.buildVersion=function(t,n,l,d){return[fullAppId(t,n),os(d),model(l),build(n)].join(" ")}(this._appId,this._appInfo,this.navigator,this.userAgent),this.sender=new ft({accessToken:this._accessToken,clientId:this.clientId,eventType:this.eventType,fetch:null==d?void 0:d.fetch,fetchOptions:null==d?void 0:d.fetchOptions,headersClass:null===(f=null==d?void 0:d.fetch)||void 0===f?void 0:f.Headers,isQA:null==d?void 0:d.isQA,logInfo:null==d?void 0:d.logInfo,musicUserToken:this._musicUserToken,preferDSID:this.preferDSID,sourceType:this.sourceType,traceTag:null==d?void 0:d.traceTag})}return Object.defineProperty(PlayActivityBase.prototype,"accessToken",{get:function(){return invoke(this._accessToken)},enumerable:!0,configurable:!0}),Object.defineProperty(PlayActivityBase.prototype,"appID",{get:function(){return void 0===this._appId&&(this._appId=fullAppId(this._appId,this._appInfo)),this._appId},enumerable:!0,configurable:!0}),Object.defineProperty(PlayActivityBase.prototype,"deviceName",{get:function(){return this._deviceName},enumerable:!0,configurable:!0}),Object.defineProperty(PlayActivityBase.prototype,"musicUserToken",{get:function(){return invoke(this._musicUserToken)},enumerable:!0,configurable:!0}),Object.defineProperty(PlayActivityBase.prototype,"navigator",{get:function(){var t;return null!==(t=this._navigator)&&void 0!==t?t:"undefined"==typeof navigator?yt:navigator},enumerable:!0,configurable:!0}),Object.defineProperty(PlayActivityBase.prototype,"userAgent",{get:function(){var t;return null!==(t=this._userAgent)&&void 0!==t?t:this.navigator.userAgent},enumerable:!0,configurable:!0}),Object.defineProperty(PlayActivityBase.prototype,"userIsSubscribed",{get:function(){return invoke(this._userIsSubscribed)},enumerable:!0,configurable:!0}),Object.defineProperty(PlayActivityBase.prototype,"utcOffsetInSeconds",{get:function(){if(void 0===this._utcOffsetInSeconds&&void 0!==this._utcOffset&&!isNaN(this._utcOffset)){var t=60*this._utcOffset;this._utcOffsetInSeconds=t<=0?Math.abs(t):-t}return void 0===this._utcOffsetInSeconds||isNaN(this._utcOffsetInSeconds)?-1:this._utcOffsetInSeconds},enumerable:!0,configurable:!0}),PlayActivityBase.prototype.send=function(t){return __awaiter$2(this,void 0,void 0,(function(){return __generator$2(this,(function(n){return[2,this.sender.send(t)]}))}))},PlayActivityBase.prototype.buildDescriptorForPlayParams=function(t,n,l,d,p){var h="stream"===t.format?ot.STREAM:ot.ITUNES_STORE_CONTENT;return __assign$2(__assign$2(__assign$2({},t),{container:l,duration:null!=d?d:0,eventType:n,itemType:h}),p)},PlayActivityBase.prototype.buildForPlayParams=function(t,n,l,d,p,h){return void 0===d&&(d=0),void 0===p&&(p={}),void 0===h&&(h=!1),this.build(this.buildDescriptorForPlayParams(t,n,l,d,p),h)},PlayActivityBase.prototype.generateBaseActivityData=function(){return __assign$2(__assign$2(__assign$2(__assign$2({"build-version":this.buildVersion,"container-type":Ye.UNKNOWN,"developer-token":this.accessToken,"internal-build":this.internalBuild,offline:!1,"persistent-id":generateUUID(),"private-enabled":this.privateEnabled,"sb-enabled":this.userIsSubscribed,"siri-initiated":this.siriInitiated,"source-type":this.sourceType,"store-front":this.storefrontId,"user-agent":this.userAgent,"utc-offset-in-seconds":this.utcOffsetInSeconds},conditionalObject(!this.preferDSID,"user-token",this.musicUserToken)),buildObject("device-name",this._deviceName)),buildObject("guid",this.guid)),buildObject("metrics-client-id",this.metricsClientId))},PlayActivityBase}(),pipe=function(t){for(var n=[],l=1;l<arguments.length;l++)n[l-1]=arguments[l];return n.reduce((function(t,n){return n(t)}),t)},_t=["uploadedVideo","uploadedAudio","uploaded-videos","uploaded-audios"],isAUC=function(t){return void 0!==t&&_t.includes(t)},isLiveStream=function(t){return function(t){return t.itemType===ot.STREAM}(t)&&!function(t){return t.descriptor.streamingKind===ct.EPISODE}(t)},updatedDataByEventType=function(t,n){switch(n["event-type"]){case nt.PLAY_START:return function(t){var n={};return isLiveStream(t)&&(n["start-position-in-milliseconds"]=0),!1===t.previous&&t.isAlexa?n["event-reason-hint-type"]=it.NOT_SPECIFIED:n["event-reason-hint-type"]=t.containerChanged?it.CONTAINER_CHANGED:it.NOT_SPECIFIED,n}(t);case nt.PLAY_END:return function(t,n){var l,d=t.descriptor,p=d.endPositionInMilliseconds,h=d.startPositionInMilliseconds,f=t.previous;if(f&&void 0===f.position)return{};var y=n["start-position-in-milliseconds"],v={"end-position-in-milliseconds":p||y,"end-reason-type":t.endReasonType};if(isLiveStream(t))return __assign$2(__assign$2({},v),{"media-duration-in-milliseconds":0,"start-position-in-milliseconds":0});var _=y>n["media-duration-in-milliseconds"],g=f&&void 0!==f.position?Math.round(1e3*f.position):0;return __assign$2(__assign$2(__assign$2({},v),buildObject("media-duration-in-milliseconds",_?y:void 0)),{"start-position-in-milliseconds":null!==(l=null!=h?h:g)&&void 0!==l?l:0})}(t,n);default:return{}}},byEventType=function(t){var n=t.state,l=t.data;return{state:n,data:__assign$2(__assign$2({},l),updatedDataByEventType(n,l))}},byItemType=function(t){var n=t.data,l=t.state,d=l.itemType,p=__assign$2({},n);return isLiveStream(l)&&(p["media-duration-in-milliseconds"]=0),d===ot.AGGREGATE_NON_CATALOG_PLAY_TIME&&(p["start-position-in-milliseconds"]=0,p["utc-offset-in-seconds"]=0,delete p.ids,delete p["container-ids"],delete p["container-type"],delete p["reco-data"],delete p["feature-name"],p["play-mode"]&&(p["play-mode"]={"auto-play-mode":rt.AUTO_UNKNOWN,"repeat-play-mode":et.REPEAT_UNKNOWN,"shuffle-play-mode":tt.SHUFFLE_UNKNOWN})),{state:l,data:p}},buildContainerIds=function(t,n){switch(t){case Ye.ALBUM:return function(t){var n={};return n["container-ids"]=ce(t.id)?{"cloud-album-id":t.id}:{"album-adam-id":t.id},n}(n);case Ye.PLAYLIST:return function(t){var n={};return t.isLibrary&&(t.catalogId||t.globalId)?(n["container-ids"]={"global-playlist-id":t.catalogId||t.globalId},void 0!==t.id&&""!==t.id&&(n["container-ids"]["universal-library-id"]=t.id)):n["container-ids"]=ce(t.id)?{"universal-library-id":t.id}:{"global-playlist-id":t.id},void 0!==t.versionHash&&""!==t.versionHash&&(n["container-ids"]["playlist-version-hash"]=t.versionHash),n}(n);case Ye.RADIO:return function(t){var n={};return n["container-ids"]={"station-id":t.id},ht.test(t.id)&&(n["container-ids"]["station-personalized-id"]=parseInt(t.id.replace(ht,"$1"),10)),void 0!==t.stationHash&&""!==t.stationHash&&(n["container-ids"]["station-hash"]=t.stationHash),n}(n);default:return{}}},buildDataByType=function(t){var n=function(t){var n=t.type;if("number"==typeof n)return n;switch(n){case"album":case"albums":case"library-albums":return Ye.ALBUM;case"artist":case"artists":case"library-artists":return Ye.ARTIST;case"playlist":case"playlists":case"library-playlists":return Ye.PLAYLIST;case"radio":case"radioStation":case"station":case"stations":return Ye.RADIO;default:return Ye.UNKNOWN}}(t);return 0===n?{}:__assign$2({"container-type":n},buildContainerIds(n,t))},updatedDataFromContainer=function(t){var n=t.descriptor.container;return void 0===n?{}:__assign$2({"feature-name":""+(n.name||$e.MUSICKIT)},buildDataByType(n))},buildDataFromContainer=function(t){var n=t.data,l=t.state;return{state:l,data:__assign$2(__assign$2({},n),updatedDataFromContainer(l))}},gt=He,mt={exit:gt.EXITED_APPLICATION,next:gt.TRACK_SKIPPED_FORWARDS,pause:gt.PLAYBACK_MANUALLY_PAUSED,playbackfinished:gt.NATURAL_END_OF_TRACK,playbackstopped:gt.PLAYBACK_MANUALLY_PAUSED,previous:gt.TRACK_SKIPPED_BACKWARDS,scrub_begin:gt.SCRUB_BEGIN,scrub_end:gt.SCRUB_END,stop:gt.NATURAL_END_OF_TRACK},convertEventString=function(t,n){var l=function(t){return t.toLowerCase()}(t);return __assign$2(__assign$2({},function(t){return{eventType:"play"===t||"playbackstarted"===t?nt.PLAY_START:nt.PLAY_END}}(l)),buildObject("endReasonType",function(t,n){return null!=n?n:mt[t]}(l,n)))},bt=function(){function DeveloperToken(t){if(this.token=t,!t||!/^[a-z0-9\-\_]{16,}\.[a-z0-9\-\_]{16,}\.[a-z0-9\-\_]{16,}/i.test(t))throw new Error("Invalid token.");var n=__read$1(t.split("."),2),l=n[0],d=n[1],p=this._decode(d),h=p.exp,f=p.iss;if(this.expiration=1e3*h,this.isExpired)throw new Error("Initialized with an expired token.");this.teamId=f;var y=this._decode(l).kid;this.keyId=y}return Object.defineProperty(DeveloperToken.prototype,"isExpired",{get:function(){return this.expiration<Date.now()},enumerable:!0,configurable:!0}),DeveloperToken.prototype._decode=function(t){return JSON.parse(de(t))},DeveloperToken}(),Pt=function(){function GenericStorage(t){void 0===t&&(t={}),this.data=t}return Object.defineProperty(GenericStorage.prototype,"data",{get:function(){return this._data},set:function(t){this._data=t},enumerable:!0,configurable:!0}),Object.defineProperty(GenericStorage.prototype,"length",{get:function(){return this.keys.length},enumerable:!0,configurable:!0}),Object.defineProperty(GenericStorage.prototype,"keys",{get:function(){return Object.keys(this.data)},enumerable:!0,configurable:!0}),GenericStorage.prototype.getItem=function(t){return this.data[t]||null},GenericStorage.prototype.setItem=function(t,n){this.data[t]=n},GenericStorage.prototype.removeItem=function(t){delete this.data[t]},GenericStorage.prototype.clear=function(){var t=this;this.keys.forEach((function(n){return t.removeItem(n)}))},GenericStorage.prototype.key=function(t){return this.keys[t]||null},GenericStorage}();function getCookie(t,n){void 0===t&&(t=""),void 0===n&&(n=document.cookie);var l=n.match(new RegExp("(?:^|;\\s*)"+t+"=([^;]*)"));if(l)return l[1]}function setCookie(t,n,l,d,p,h){void 0===l&&(l=""),void 0===d&&(d=14);var f=new Date;p=null!=p?p:window;var y=(h=null!=h?h:/\./.test(p.location.hostname)?p.location.hostname:"").length>0?"domain="+h+"; ":"";f.setTime(f.getTime()+24*d*60*60*1e3);var v="";"https:"===p.location.protocol&&(v="; secure"),p.document.cookie=t+"="+n+"; expires="+f.toUTCString()+"; "+y+"path="+l+v}function removeCookie(t,n,l){setCookie(t,"","/",0,n,l)}var Tt,DEFAULT_CACHE_KEY_FUNCTION=function(t,n){return""+n+t},St=function(){function NetworkCache(t){void 0===t&&(t={}),this.storage=t.storage||new Pt,this.prefix=t.prefix||"ï£¿",this.ttl=t.ttl||3e5,this.cacheKeyFunction=t.cacheKeyFunction||DEFAULT_CACHE_KEY_FUNCTION}return NetworkCache.prototype.getItem=function(t){var n=this.cacheKeyForPath(t),l=this.storage.getItem(n);if(null!==l){var d=JSON.parse(l),p=d.x,h=d.d;if(p>Date.now())return h;this.storage.removeItem(n)}},NetworkCache.prototype.setItem=function(t,n,l){void 0===l&&(l=this.ttl);var d=this.cacheKeyForPath(t);this.storage.setItem(d,JSON.stringify({x:Date.now()+l,d:n}))},NetworkCache.prototype.removeItem=function(t){var n=this.cacheKeyForPath(t);this.storage.removeItem(n)},NetworkCache.prototype.removeItemsMatching=function(t,n){void 0===n&&(n=!0);var l=this.cacheKeyForPath(t);this.removeItemsMatchingCacheKey(l,n)},NetworkCache.prototype.clear=function(){this.removeItemsMatchingCacheKey(this.prefix,!1)},NetworkCache.prototype.removeItemsMatchingCacheKey=function(t,n){var l=this,d=new RegExp("^"+t+(n?"$":""));(this.storage instanceof Pt?this.storage.keys:Object.keys(this.storage)).forEach((function(t){t&&d.test(t)&&l.storage.removeItem(t)}))},NetworkCache.prototype.cacheKeyForPath=function(t){return this.cacheKeyFunction(t,this.prefix)},NetworkCache}();!function(t){t.JSON="application/json",t.FORM="application/x-www-form-urlencoded"}(Tt||(Tt={}));var kt,At=function(){function URLSession(t,n){var l;if(this.prefix="ï£¿",this.method="GET",this.url=t,(n=n||{}).storage&&n.underlyingStorage)throw new Error("only pass storage OR underlyingStorage in sessionOptions to URLSession");var d=n.underlyingStorage||{};if(this.storage=n.storage||new Pt(d),this.networkCache=new St({storage:this.storage,prefix:this.prefix,cacheKeyFunction:this._key.bind(this)}),this.ttl=n.ttl||3e5,this._fetchOptions=se({},n.fetchOptions),"function"!=typeof n.fetch&&"function"!=typeof fetch)throw new Error("window.fetch is not defined");this._fetchFunction=null!==(l=n.fetch)&&void 0!==l?l:fetch.bind(window),this.headers=this._fetchOptions.headers||new Headers,delete this._fetchOptions.headers}return URLSession.prototype.clearCacheForRequest=function(t,n){"object"==typeof t&&(n=t,t=void 0);var l=this.constructURL(t,n);this.networkCache.removeItemsMatching(l)},URLSession.prototype.request=function(t,n,l){var d;return __awaiter$1(this,void 0,void 0,(function(){var p,h,f,y,v,_,g,m,b,P,T;return __generator$1(this,(function(S){switch(S.label){case 0:return l||"object"!=typeof t||(l=n||{},n=t,t=void 0),l=se(se({method:this.method,headers:this.headers,reload:!1},this._fetchOptions),l),p={},"object"==typeof l.queryParameters?(p=l.queryParameters,delete l.queryParameters):"GET"===l.method&&(p=n),h=this.constructURL(t,p),f=l.method,y=l.reload,v=void 0!==y&&y,_=l.useRawResponse,l.headers=this.buildHeaders(l),delete l.reload,delete l.useRawResponse,"GET"===f&&!v&&(g=this.getCacheItem(h))?[2,Promise.resolve(g)]:(n&&Object.keys(n).length&&("POST"===f||"PUT"===f)&&(l.body=l.body||n,l.contentType===Tt.FORM?(l.body=urlEncodeParameters(l.body),l.headers.set("Content-Type",Tt.FORM)):(l.body=JSON.stringify(l.body),l.headers.set("Content-Type",Tt.JSON))),[4,this._fetchFunction(h,l)]);case 1:if(!(m=S.sent()).ok)return[2,Promise.reject(m)];S.label=2;case 2:return S.trys.push([2,4,,5]),[4,m.json()];case 3:return b=S.sent(),[3,5];case 4:return S.sent(),b={},[3,5];case 5:return b.errors?[2,Promise.reject(b.errors)]:(P=_?b:b.results||b.data||b,"GET"===f&&(T=null!==(d=getMaxAgeFromHeaders(m.headers))&&void 0!==d?d:this.ttl,this.setCacheItem(h,P,T)),[2,P])}}))}))},URLSession.prototype.buildHeaders=function(t){var n=void 0===t?{}:t,l=n.headers,d=n.reload,p=void 0!==d&&d;void 0===l&&(l=this.headers);var h=function(t){return new t.constructor(t)}(l);return p&&h.set("Cache-Control","no-cache"),h},URLSession.prototype.constructURL=function(t,n){return function(t,n,l){return addQueryParamsToURL(addPathToURL(t,n),l)}(this.url,t,n)},URLSession.prototype.getCacheItem=function(t){var n=this.networkCache.storage,l=""+this.prefix+this.prefix+"cache-mut",d=n.getItem(l)||null,p=this.headers.get("Music-User-Token")||this.headers.get("Media-User-Token")||null;return p!==d&&(this.networkCache.clear(),null===p?n.removeItem(l):n.setItem(l,p)),this.networkCache.getItem(t)},URLSession.prototype.setCacheItem=function(t,n,l){void 0===l&&(l=this.ttl),this.networkCache.setItem(t,n,l)},URLSession.prototype.clearNetworkCache=function(){this.networkCache.clear()},URLSession.prototype._key=function(t,n){var l=function(t){try{var n=__read$1(t.split("?",2),2),l=n[0],d=n[1];if(void 0===d)return l;var p=d.split("&").map((function(t){return t.split("=",2)})),h=__spread$1(Array(p.length).keys());return h.sort((function(t,n){var l=p[t],d=p[n];return l<d?-1:l>d?1:t-n})),l+"?"+h.map((function(t){return p[t]})).map((function(t){var n=__read$1(t,2),l=n[0],d=n[1];return void 0!==d?l+"="+d:l})).join("&")}catch(Si){return t}}(t).toLowerCase().replace(this.url,"");return""+this.prefix+l.replace(/[^-_0-9a-z]{1,}/g,".")},URLSession}(),It=function(t){function TokenSession(n,l,d){var p=t.call(this,n,d)||this;return p._developerToken=new bt(l),p.headers.set("Authorization","Bearer "+p.developerToken),d=d||{},p.userToken=d.userToken,p.userToken&&p.headers.set("Media-User-Token",p.userToken),p}return __extends$1(TokenSession,t),Object.defineProperty(TokenSession.prototype,"developerToken",{get:function(){return this._developerToken.token},enumerable:!0,configurable:!0}),TokenSession}(At),Et=Date.now(),wt=isNodeEnvironment()?function(){var t=__read$1(process.hrtime(),2),n=t[0],l=t[1];return Math.floor(1e3*n+1e-6*l)}:function(){var t,n;return null!==(n=null===(t=null===performance||void 0===performance?void 0:performance.now)||void 0===t?void 0:t.call(performance))&&void 0!==n?n:Date.now()-Et},formatByte=function(t){return("0"+(255&t).toString(16)).slice(-2)},toHexString=function(t,n){if(void 0===n&&(n=8),!(t instanceof Uint8Array))return"";var l=Array.prototype.map.call(t,formatByte).join("");return 0===n?l:l.replace(new RegExp("(.{1,"+n+"})","g"),"$1 ").trim()},defaultCatalogId=function(t){var n=t.catalogId,l=t.container;return n||l&&l.catalogId},defaultMediaType=function(t){var n=t.kind,l=t.mediaType;if("number"==typeof l)return l;var d="string"==typeof l?l:n;return d&&/video/i.test(d)?at.VIDEO:at.AUDIO},defaultPrevious=function(t,n){var l=n;if(!1!==l&&t.eventType===nt.PLAY_END&&void 0===n)throw new Error("Cannot build() for PLAY_END descriptors without previous descriptors");return l},defaultItemType=function(t){var n=t.itemType,l=t.kind;return"stream"===t.format?ot.STREAM:isAUC(l)?ot.ARTIST_UPLOADED_CONTENT:void 0!==n?n:ot.ITUNES_STORE_CONTENT},initialBuildData=function(t,n,l,d){var p=function(t){if(void 0===t)throw new Error("build() called without a play activity descriptor");return"string"!=typeof t.eventType?t:__assign$2(__assign$2({},t),convertEventString(t.eventType,t.endReasonType))}(n),h=function(t,n,l){return{catalogId:defaultCatalogId(t),cloudId:t.cloudId,containerChanged:!1,descriptor:t,endReasonType:t.endReasonType,isAlexa:l,itemType:defaultItemType(t),mediaType:defaultMediaType(t),previous:defaultPrevious(t,n)}}(p,l,d),f=p.eventType,y=void 0===f?nt.PLAY_START:f,v=function(t){var n=t.descriptor,l={},d=__assign$2({},t),p=n.container,h=n.eventType,f=void 0===h?nt.PLAY_START:h,y=n.id,v=n.isLibrary,_=n.purchasedId,g=n.reporting;if("-1"!==y&&(void 0===g||g))pt.test(y)||p&&"radioStation"===p.kind?l["radio-adam-id"]=parseInt(y.replace(pt,"$1"),10):isAUC(n.kind)?l["auc-adam-id"]=n.id:v&&d.catalogId?(l["subscription-adam-id"]=d.catalogId,void 0!==y&&""!==y&&(d.cloudId=y)):v||ce(y)?d.cloudId=y:l["subscription-adam-id"]=y;else switch(f){case nt.PLAY_END:d.endReasonType=He.NOT_APPLICABLE,d.itemType=ot.AGGREGATE_NON_CATALOG_PLAY_TIME;break;case nt.PLAY_START:"-1"===y?d.itemType=ot.INVALID:void 0!==y&&""!==y&&(d.cloudId=y)}return void 0!==d.cloudId&&(l["cloud-id"]=d.cloudId),void 0!==_&&(l["purchased-adam-id"]=_),Object.keys(l).length>0?{ids:l,newState:d}:{newState:d,ids:void 0}}(h),_=v.ids;return(h=v.newState).containerChanged=function(t,n){var l=t.container,d=n.previous;return void 0!==l&&(void 0===l.type&&void 0!==l.kind&&(l.type=l.kind),void 0===d||!1===d||void 0===d.container||d.container.id!==l.id)}(p,h),{data:__assign$2(__assign$2(__assign$2(__assign$2(__assign$2(__assign$2(__assign$2(__assign$2({},t),function(t){var n=t.duration,l=void 0===n?0:n,d=t.position,p=void 0===d?0:d,h=t.timestamp,f=t.startPositionInMilliseconds;return{"media-duration-in-milliseconds":Math.round(1e3*l),"milliseconds-since-play":void 0!==h?Date.now()-h:0,"start-position-in-milliseconds":f||Math.round(1e3*p)}}(h.descriptor)),function(t){var n,l,d,p=invoke(t.playMode);return void 0===p?{}:{"play-mode":{"auto-play-mode":null!==(n=p.autoplayMode)&&void 0!==n?n:0,"repeat-play-mode":null!==(l=p.repeatPlayMode)&&void 0!==l?l:0,"shuffle-play-mode":null!==(d=p.shufflePlayMode)&&void 0!==d?d:0}}}(h.descriptor)),buildObject("guid",h.descriptor.guid)),buildObject("ids",_)),buildObject("reco-data",h.descriptor.recoData)),buildObject("track-info",h.descriptor.trackInfo)),{"event-type":y,"media-type":h.mediaType,type:h.itemType}),state:h}},typeByTimedMetadata=function(t){var n=t.state.descriptor.itemType;return n===ot.TIMED_METADATA_PING?n:ot.STREAM},byTimedMetadata=function(t){var n=t.data,l=t.state,d=l.descriptor.timedMetadata;return void 0===d?{data:n,state:l}:function(t){var n=t.state.descriptor,l=n.eventType;return n.itemType===ot.TIMED_METADATA_PING||l!==nt.LYRIC_DISPLAY}({data:n,state:l})?{state:l,data:__assign$2(__assign$2({},n),{type:typeByTimedMetadata({data:n,state:l}),"timed-metadata":toHexString(d,0)})}:{data:n,state:l}},Ot=[],breadcrumb=function(t){for(var n=[],l=1;l<arguments.length;l++)n[l-1]=arguments[l];Ot.push({methodName:t,args:JSON.stringify(n)})},getBreadcrumbs=function(){return Ot.slice(0)},clearBreadcrumbs=function(){return Ot.length=0},Breadcrumb=function(t,n,l){if("function"!=typeof l.value)return l;var d=l.value;return __assign$2(__assign$2({},l),{value:function(){for(var t=[],l=0;l<arguments.length;l++)t[l]=arguments[l];return breadcrumb.apply(void 0,__spread$2([n],t)),d.apply(this,t)}})},buildPlayActivityData=function(t,n,l,d){if(void 0===d&&(d=!1),void 0===n)throw new Error("called without a play activity descriptor");var p=pipe(initialBuildData(t.generateBaseActivityData(),n,l,d),byEventType,buildDataFromContainer,byItemType,byTimedMetadata);return clearBreadcrumbs(),p},dataFromLyrics=function(t){var n=t.state.descriptor.lyricDescriptor,l=t.data.ids;return void 0===n?{}:__assign$2(__assign$2({"display-type":n.displayType,"end-position-in-milliseconds":n.duration},buildObject("lyric-language",n.language)),{ids:__assign$2(__assign$2({},l),{"lyric-id":n.id})})},forLyrics=function(t){var n=t.state,l=t.data;return{state:n,data:__assign$2(__assign$2({},l),dataFromLyrics({state:n,data:l}))}},buildPlayActivityData$1=function(t,n,l){if(void 0===n)throw new Error("called without a play activity descriptor");return pipe(buildPlayActivityData(t,n,l,!1),(d={"event-type":nt.LYRIC_DISPLAY,"feature-name":"now_playing","media-duration-in-milliseconds":0,"media-type":at.AUDIO,"start-position-in-milliseconds":0,"play-mode":{"auto-play-mode":0,"repeat-play-mode":0,"shuffle-play-mode":0}},function(t){var n=t.state,l=t.data;return{state:n,data:__assign$2(__assign$2({},l),d)}}),function(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];return function(n){var l,d,p=n.state,h=n.data,f=__assign$2({},h);try{for(var y=__values$1(t),v=y.next();!v.done;v=y.next()){delete f[v.value]}}catch(_){l={error:_}}finally{try{v&&!v.done&&(d=y.return)&&d.call(y)}finally{if(l)throw l.error}}return{state:p,data:f}}}("character-display-count","event-reason-hint-type","reco-data"),forLyrics);var d};!function(t){function LyricsPlayActivity(n,l,d,p){var h=t.call(this,n,l,d,p)||this;return h._machine=f$3(c({id:"lpaf",initial:"idle",context:{initialShowTime:-1,duration:-1},states:{idle:{entry:r((function(t){return __assign$2(__assign$2({},t),{initialShowTime:void 0,duration:wt()-t.initialShowTime})})),on:{play:"playing"}},playing:{entry:r((function(t){return __assign$2(__assign$2({},t),{initialShowTime:wt()})})),on:{stop:"idle"}}}})).start(),h}__extends$2(LyricsPlayActivity,t),LyricsPlayActivity.prototype.exit=function(){return __awaiter$2(this,void 0,void 0,(function(){return __generator$2(this,(function(t){return[2]}))}))},LyricsPlayActivity.prototype.play=function(t){return __awaiter$2(this,void 0,void 0,(function(){return __generator$2(this,(function(n){if(this.stateMatches("playing"))throw Error("lyrics are already being displayed. Did you forget to stop them?");return this._previousDescriptor=t,this._machine.send({type:"play"}),[2]}))}))},LyricsPlayActivity.prototype.stop=function(){return __awaiter$2(this,void 0,void 0,(function(){var t,n;return __generator$2(this,(function(l){switch(l.label){case 0:if(this.stateMatches("idle"))throw Error("lyrics are not being displayed. Did you forget to display them?");if(void 0===this._previousDescriptor)throw Error("something went wrong: client can send a stop but there is no previous descriptor");this._machine.send({type:"stop"}),(t=JSON.parse(JSON.stringify(this._previousDescriptor))).lyricDescriptor=__assign$2(__assign$2({},t.lyricDescriptor),{duration:this._machine.state.context.duration}),n=this.build(t,this._previousDescriptor),l.label=1;case 1:return l.trys.push([1,,3,4]),[4,this.send(n)];case 2:return l.sent(),[3,4];case 3:return this._previousDescriptor=t,[7];case 4:return[2]}}))}))},LyricsPlayActivity.prototype.stateMatches=function(t){return this._machine.state.matches(t)},LyricsPlayActivity.prototype.build=function(t,n){return buildPlayActivityData$1(this,t,n).data}}(vt);!function(t){t[t.ALEXA=13]="ALEXA"}(kt||(kt={}));!function(){function PlayActivity(t,n,l){this.accessToken=t,this.storefrontId=n,this.baseVersion=1,this.clientId="JSCLIENT",this.eventType="play",this.sourceType=kt.ALEXA,this.topic="xp_amp_podcasts_play",this.utcOffset=(new Date).getTimezoneOffset(),this._isQA=!1,this._logInfo=!1,this._appInfo=l.app,this._fetch=l.fetch,this._fetchOptions=l.fetchOptions,l.fetch&&l.fetch.Headers&&(this._headersClass=l.fetch.Headers),this._isQA=l.isQA||!1,this._logInfo=l.logInfo||this._isQA||!1,this._osInfo=l.os,this._userAgent=l.userAgent,void 0!==l.baseVersion&&(this.baseVersion=l.baseVersion),void 0!==l.clientId&&(this.clientId=l.clientId),this.guid=l.guid,this.ipAddress=l.ip,this.sourceType=l.sourceType||kt.ALEXA,this.utcOffset=l.utcOffset}Object.defineProperty(PlayActivity.prototype,"appName",{get:function(){return this._appInfo&&void 0!==this._appInfo.name?this._appInfo.name:"MusicKitApp"},enumerable:!0,configurable:!0}),Object.defineProperty(PlayActivity.prototype,"appVersion",{get:function(){return this._appInfo&&void 0!==this._appInfo.version?this._appInfo.version:"1.0"},enumerable:!0,configurable:!0}),Object.defineProperty(PlayActivity.prototype,"fetch",{get:function(){return this._fetch},enumerable:!0,configurable:!0}),Object.defineProperty(PlayActivity.prototype,"Headers",{get:function(){return this._headersClass},enumerable:!0,configurable:!0}),Object.defineProperty(PlayActivity.prototype,"logInfo",{get:function(){return this._logInfo},enumerable:!0,configurable:!0}),Object.defineProperty(PlayActivity.prototype,"os",{get:function(){return this._osInfo&&void 0!==this._osInfo.name?this._osInfo.name:"Unidentified OS"},enumerable:!0,configurable:!0}),Object.defineProperty(PlayActivity.prototype,"osVersion",{get:function(){return this._osInfo&&void 0!==this._osInfo.version?this._osInfo.version:"0.0"},enumerable:!0,configurable:!0}),Object.defineProperty(PlayActivity.prototype,"url",{get:function(){return(this._isQA?"https://amp-mt-ingestion-service.itunes.apple.com/report/2":"https://xp.apple.com/report/2")+"/"+this.topic},enumerable:!0,configurable:!0}),Object.defineProperty(PlayActivity.prototype,"userAgent",{get:function(){return this._userAgent},enumerable:!0,configurable:!0}),PlayActivity.prototype.buildForPlayParams=function(t,n,l,d,p){if(void 0===d&&(d=0),void 0===p&&(p={}),"play"!==n)throw new Error("buildForPlayParams() only valid on play event");var h={app:this.appName,appVersion:this.appVersion,baseVersion:this.baseVersion,clientId:this.clientId,ip:this.ipAddress,os:this.os,osVersion:this.osVersion,storeFront:this.storefrontId,timezoneOffset:this.utcOffset,topic:this.topic,userAgent:this.userAgent},f=t.actionType,y=t.durationInMilliseconds,v=t.eventTime,_=void 0===v?Date.now():v,g=t.eventVersion,m=void 0===g?"1":g,b=t.feedUrl,P=t.guid,T=t.id,S=t.itemType,k=t.mediaKind,A=t.playbackSpeed,I=t.playEndPosition,E=t.playId,w=t.playStartPosition,O=t.playStartTime,R=t.postTime,C="audio"===k||"video"===k?k:"unknown",M={actionType:f,contentGUID:P,contentId:T,contentLength:y/1e3,eventTime:_||Date.now(),eventType:n,eventVersion:m,itemType:S,language:l.language,mediaType:C,playbackSpeed:A,playDuration:d,playEndPosition:I,playId:E,playStartPosition:w,playStartTime:O,podcastFeedURL:b,podcastId:l.id,podcastState:l.state,postTime:R||_||Date.now()};return __assign$2(__assign$2(__assign$2({},h),M),p)},PlayActivity.prototype.send=function(t){return __awaiter$2(this,void 0,void 0,(function(){var n,l,d,p;return __generator$2(this,(function(h){switch(h.label){case 0:if(n=new this.Headers({Authorization:"Bearer "+this.accessToken,"Content-Type":"application/json"}),l=t.postTime,delete t.postTime,0===(d={postTime:l,events:ensureArray(t)}).events.length)throw new Error("send() called without any data");return p=__assign$2({method:"POST",body:JSON.stringify(d),headers:n},void 0!==this._fetchOptions&&this._fetchOptions),[4,this.fetch(this.url,p)];case 1:return[4,h.sent().text()];case 2:return h.sent(),this._logInfo&&console.info("play activity:",this.sourceType===kt.ALEXA?JSON.stringify(d):d),[2,d]}}))}))}}();var createHelper=function(t,n){return function(l,d,p){var h=p.cache.helpers;return t in h||(h[t]=n(l,d,p)),h[t]}};function buildObject$1(t,n){var l;if(void 0!==n)return(l={})[t]=n,l}var returnAsField=function(t,n){return function(){for(var l=[],d=0;d<arguments.length;d++)l[d]=arguments[d];return buildObject$1(t,n.apply(void 0,__spread$2(l)))}},createFieldFn=function(t,n){return function(l,d,p){var h,f=p.cache.fields;return t in f||(p.cache.fields=__assign$2(__assign$2({},f),((h={})[t]=function(n){var l;return null==n?void 0:((l={})[t]=n,l)}(n(l,d,p)),h))),p.cache.fields[t]}},createClientFieldFn=function(t,n){return createFieldFn(t,(function(t,l,d){return d.client[n]}))},Rt=createClientFieldFn("build-version","buildVersion"),Ct=["play","playbackstarted"],Mt=createFieldFn("event-type",(function(t,n,l){var d=t.eventType;if(void 0===d)return nt.PLAY_START;if(t.itemType===ot.TIMED_METADATA_PING&&void 0!==t.timedMetadata)return nt.PLAY_END;if("string"!=typeof d)return null!=d?d:nt.PLAY_START;var p=d.toLowerCase();return Ct.includes(p)?nt.PLAY_START:nt.PLAY_END})),Nt=["uploadedVideo","uploadedAudio","uploaded-videos","uploaded-audios"],Dt=createHelper("is-auc",(function(t){var n=t.kind;return void 0!==n&&Nt.includes(n)})),Lt=createHelper("should-send-timed-metadata",(function(t){var n=t.endReasonType,l=t.eventType,d=t.itemType;return void 0!==t.timedMetadata&&(d===ot.TIMED_METADATA_PING||l===nt.PLAY_START||n===He.PLAYBACK_MANUALLY_PAUSED)})),xt=createFieldFn("type",(function(t,n,l){var d,p=t.id,h=t.reporting;if("-1"===p||!h)switch(null===(d=Mt(t,n,l))||void 0===d?void 0:d["event-type"]){case nt.PLAY_END:return ot.AGGREGATE_NON_CATALOG_PLAY_TIME;case nt.PLAY_START:if("-1"===p)return ot.INVALID}var f=t.format,y=t.itemType;return Lt(t,n,l)?y===ot.TIMED_METADATA_PING?y:ot.STREAM:"stream"===f?ot.STREAM:Dt(t,n,l)?ot.ARTIST_UPLOADED_CONTENT:null!=y?y:ot.ITUNES_STORE_CONTENT})),Ut=createFieldFn("container-type",(function(t,n,l){var d,p;if((null===(d=xt(t,n,l))||void 0===d?void 0:d.type)!==ot.AGGREGATE_NON_CATALOG_PLAY_TIME){var h=t.container;if(void 0===h)return Ye.UNKNOWN;var f=null!==(p=h.type)&&void 0!==p?p:h.kind;if("number"==typeof f)return f;switch(f){case"album":case"albums":case"library-albums":return Ye.ALBUM;case"artist":case"artists":case"library-artists":return Ye.ARTIST;case"playlist":case"playlists":case"library-playlists":return Ye.PLAYLIST;case"radio":case"radioStation":case"station":case"stations":return Ye.RADIO;default:return Ye.UNKNOWN}}})),Bt=[returnAsField("album-adam-id",(function(t,n,l){var d;if((null===(d=Ut(t,n,l))||void 0===d?void 0:d["container-type"])===Ye.ALBUM){var p=t.container,h=null==p?void 0:p.id;if(void 0!==h&&!ce(h))return h}})),returnAsField("cloud-album-id",(function(t,n,l){var d;if((null===(d=Ut(t,n,l))||void 0===d?void 0:d["container-type"])===Ye.ALBUM){var p=t.container,h=null==p?void 0:p.id;if(void 0!==h&&ce(h))return h}})),returnAsField("global-playlist-id",(function(t,n,l){var d,p;if((null===(d=Ut(t,n,l))||void 0===d?void 0:d["container-type"])===Ye.PLAYLIST){var h=t.container,f=null!==(p=null==h?void 0:h.catalogId)&&void 0!==p?p:null==h?void 0:h.globalId;return(null==h?void 0:h.isLibrary)&&f?f:ce(null==h?void 0:h.id)||null==h?void 0:h.id}})),returnAsField("playlist-version-hash",(function(t,n,l){var d;if((null===(d=Ut(t,n,l))||void 0===d?void 0:d["container-type"])===Ye.PLAYLIST){var p=t.container,h=null==p?void 0:p.versionHash;if(void 0!==h&&""!==h)return h}})),returnAsField("station-hash",(function(t,n,l){var d,p;if((null===(d=Ut(t,n,l))||void 0===d?void 0:d["container-type"])===Ye.RADIO){var h=null===(p=t.container)||void 0===p?void 0:p.stationHash;if(void 0!==h&&""!==h)return h}})),returnAsField("station-id",(function(t,n,l){var d,p;if((null===(d=Ut(t,n,l))||void 0===d?void 0:d["container-type"])===Ye.RADIO)return null===(p=t.container)||void 0===p?void 0:p.id})),returnAsField("station-personalized-id",(function(t,n,l){var d,p;if((null===(d=Ut(t,n,l))||void 0===d?void 0:d["container-type"])===Ye.RADIO){var h=null===(p=t.container)||void 0===p?void 0:p.id;if(void 0!==h)return ht.test(h)?parseInt(h.replace(ht,"$1"),10):void 0}})),returnAsField("universal-library-id",(function(t,n,l){var d,p;if((null===(d=Ut(t,n,l))||void 0===d?void 0:d["container-type"])===Ye.PLAYLIST){var h=t.container,f=null!==(p=null==h?void 0:h.catalogId)&&void 0!==p?p:null==h?void 0:h.globalId,y=null==h?void 0:h.id;if(void 0!==y)if((null==h?void 0:h.isLibrary)&&f){if(""!==y)return y}else if(ce(y))return y}}))],jt=createFieldFn("container-ids",(function(t,n,l){var d;if((null===(d=xt(t,n,l))||void 0===d?void 0:d.type)!==ot.AGGREGATE_NON_CATALOG_PLAY_TIME){var p=Bt.reduce((function(d,p){return __assign$2(__assign$2({},d),p(t,n,l))}),Object.create(null));if(!isEmpty(p))return p}})),Ft=createClientFieldFn("developer-token","accessToken"),Kt=createClientFieldFn("device-name","deviceName"),Vt=createHelper("initial-start-position-in-milliseconds",(function(t){var n=t.position,l=void 0===n?0:n;return t.startPositionInMilliseconds||Math.round(1e3*l)})),$t=createFieldFn("end-position-in-milliseconds",(function(t,n,l){var d;switch(null===(d=Mt(t,n,l))||void 0===d?void 0:d["event-type"]){case nt.LYRIC_DISPLAY:return t.duration;case nt.PLAY_START:return;default:if(n&&void 0===n.position)return;return t.endPositionInMilliseconds||Vt(t,n,l)}})),Yt=createHelper("is-private",(function(t){var n=t.id,l=t.reporting;return"-1"===n||!l})),Ht=He,Wt={exit:Ht.EXITED_APPLICATION,next:Ht.TRACK_SKIPPED_FORWARDS,pause:Ht.PLAYBACK_MANUALLY_PAUSED,playbackfinished:Ht.NATURAL_END_OF_TRACK,playbackstopped:Ht.PLAYBACK_MANUALLY_PAUSED,previous:Ht.TRACK_SKIPPED_BACKWARDS,scrub_begin:Ht.SCRUB_BEGIN,scrub_end:Ht.SCRUB_END,stop:Ht.NATURAL_END_OF_TRACK},zt=createFieldFn("end-reason-type",(function(t,n,l){var d,p=t.eventType,h=t.endReasonType,f=t.timedMetadata;if(!n||void 0!==n.position){if((null===(d=xt(t,n,l))||void 0===d?void 0:d.type)===ot.TIMED_METADATA_PING&&void 0!==f)return He.NOT_APPLICABLE;if(Yt(t,n,l)&&p===nt.PLAY_END)return He.NOT_APPLICABLE;if(void 0!==h||"string"!=typeof p)return h;var y=p.toLowerCase();return Wt[y]}})),Gt=it.CONTAINER_CHANGED,qt=it.NOT_SPECIFIED,Qt=createFieldFn("event-reason-hint-type",(function(t,n,l){var d,p;if((null===(d=Mt(t,n,l))||void 0===d?void 0:d["event-type"])===nt.PLAY_START){var h=t.container;return void 0===h?qt:!1===n?l.isAlexa?qt:Gt:(null===(p=null==n?void 0:n.container)||void 0===p?void 0:p.id)!==h.id?Gt:qt}})),Jt=createFieldFn("feature-name",(function(t,n,l){var d,p,h,f;if((null===(d=xt(t,n,l))||void 0===d?void 0:d.type)!==ot.AGGREGATE_NON_CATALOG_PLAY_TIME){if((null===(p=Mt(t,n,l))||void 0===p?void 0:p["event-type"])===nt.LYRIC_DISPLAY)return"now_playing";var y=null!==(f=null===(h=t.container)||void 0===h?void 0:h.name)&&void 0!==f?f:$e.MUSICKIT;return"string"==typeof y?y:""+y}})),Xt=createClientFieldFn("guid","guid"),Zt=createHelper("should-have-auc-adam-id",Dt),er=createHelper("should-have-radio-adam-id",(function(t){var n=t.id,l=t.container;return pt.test(n)||"radioStation"===(null==l?void 0:l.kind)})),tr=createHelper("is-library-item-or-library-type",(function(t,n,l){var d=t.id;return t.isLibrary||ce(d)})),rr=createHelper("catalog-id",(function(t){var n=t.catalogId,l=t.container;return null!=n?n:null==l?void 0:l.catalogId})),ir=createHelper("is-library-item-with-catalog-id",(function(t,n,l){return t.isLibrary&&!!rr(t,n,l)})),nr=[returnAsField("auc-adam-id",(function(t,n,l){var d;if((null===(d=Mt(t,n,l))||void 0===d?void 0:d["event-type"])!==nt.LYRIC_DISPLAY&&!Yt(t,n,l)&&!er(t,n,l))return Zt(t,n,l)?t.id:void 0})),returnAsField("cloud-id",(function(t,n,l){var d,p;if((null===(d=Mt(t,n,l))||void 0===d?void 0:d["event-type"])===nt.LYRIC_DISPLAY)return t.cloudId;var h=t.id,f=void 0!==h&&""!==h;return Yt(t,n,l)&&(null===(p=Mt(t,n,l))||void 0===p?void 0:p["event-type"])===nt.PLAY_START&&f&&"-1"!==h?h:er(t,n,l)||Zt(t,n,l)?t.cloudId:ir(t,n,l)&&f||tr(t,n,l)?h:t.cloudId})),returnAsField("lyric-id",(function(t,n,l){var d,p;if((null===(d=Mt(t,n,l))||void 0===d?void 0:d["event-type"])===nt.LYRIC_DISPLAY)return null===(p=t.lyricDescriptor)||void 0===p?void 0:p.id})),returnAsField("purchased-adam-id",(function(t,n,l){var d;if((null===(d=Mt(t,n,l))||void 0===d?void 0:d["event-type"])!==nt.LYRIC_DISPLAY)return t.purchasedId})),returnAsField("radio-adam-id",(function(t,n,l){var d;if((null===(d=Mt(t,n,l))||void 0===d?void 0:d["event-type"])!==nt.LYRIC_DISPLAY&&!Yt(t,n,l)){var p=t.id;return pt.test(p)?parseInt(p.replace(pt,"$1"),10):void 0}})),returnAsField("subscription-adam-id",(function(t,n,l){var d;if(!((null===(d=Mt(t,n,l))||void 0===d?void 0:d["event-type"])===nt.LYRIC_DISPLAY||Yt(t,n,l)||er(t,n,l)||Zt(t,n,l))){if(ir(t,n,l))return rr(t,n,l);if(!tr(t,n,l))return t.id}}))],or=createFieldFn("ids",(function(t,n,l){var d;if((null===(d=xt(t,n,l))||void 0===d?void 0:d.type)!==ot.AGGREGATE_NON_CATALOG_PLAY_TIME){var p=nr.reduce((function(d,p){return __assign$2(__assign$2({},d),p(t,n,l))}),Object.create(null));if(!isEmpty(p))return p}})),ar=createClientFieldFn("internal-build","internalBuild"),sr=createHelper("has-episode-streaming-kind",(function(t,n,l){return t.streamingKind===ct.EPISODE})),ur=createHelper("is-stream",(function(t,n,l){var d;return(null===(d=xt(t,n,l))||void 0===d?void 0:d.type)===ot.STREAM})),cr=createHelper("is-live-stream",(function(t,n,l){return ur(t,n,l)&&!sr(t,n,l)})),lr=createFieldFn("media-duration-in-milliseconds",(function(t,n,l){var d,p,h,f=null===(d=Mt(t,n,l))||void 0===d?void 0:d["event-type"];if(f===nt.LYRIC_DISPLAY)return 0;if(cr(t,n,l))return 0;var y=1e3*t.duration;if(f===nt.PLAY_START)return y;var v=null!==(p=t.startPositionInMilliseconds)&&void 0!==p?p:Math.round(1e3*(null!==(h=t.position)&&void 0!==h?h:0));return v>1e3*t.duration?v:y})),dr=at.AUDIO,pr=at.VIDEO,hr=createFieldFn("media-type",(function(t,n,l){var d;if((null===(d=Mt(t,n,l))||void 0===d?void 0:d["event-type"])===nt.LYRIC_DISPLAY)return dr;var p=t.kind,h=t.mediaType;if("number"==typeof h)return h;var f="string"==typeof h?h:p;return f&&/video/i.test(f)?pr:dr})),fr=createClientFieldFn("metrics-client-id","metricsClientId"),yr=createFieldFn("milliseconds-since-play",(function(t,n,l){var d=t.timestamp;return void 0===d?0:Date.now()-d})),vr=createFieldFn("offline",(function(){return!1})),_r=createFieldFn("persistent-id",(function(){return generateUUID()})),gr=createFieldFn("play-mode",(function(t,n,l){var d,p,h,f,y,v,_,g;if((null===(d=Mt(t,n,l))||void 0===d?void 0:d["event-type"])===nt.LYRIC_DISPLAY||(null===(p=xt(t,n,l))||void 0===p?void 0:p.type)===ot.AGGREGATE_NON_CATALOG_PLAY_TIME)return{"auto-play-mode":null!==(h=gr.autoplayMode)&&void 0!==h?h:0,"repeat-play-mode":null!==(f=gr.repeatPlayMode)&&void 0!==f?f:0,"shuffle-play-mode":null!==(y=gr.shufflePlayMode)&&void 0!==y?y:0};var m=invoke(t.playMode);return void 0!==m?{"auto-play-mode":null!==(v=m.autoplayMode)&&void 0!==v?v:0,"repeat-play-mode":null!==(_=m.repeatPlayMode)&&void 0!==_?_:0,"shuffle-play-mode":null!==(g=m.shufflePlayMode)&&void 0!==g?g:0}:void 0})),mr=createClientFieldFn("private-enabled","privateEnabled"),br=createFieldFn("reco-data",(function(t,n,l){var d,p;if((null===(d=Mt(t,n,l))||void 0===d?void 0:d["event-type"])!==nt.LYRIC_DISPLAY&&(null===(p=xt(t,n,l))||void 0===p?void 0:p.type)!==ot.AGGREGATE_NON_CATALOG_PLAY_TIME)return t.recoData})),Pr=createClientFieldFn("sb-enabled","userIsSubscribed"),Tr=createClientFieldFn("siri-initiated","siriInitiated"),Sr=createClientFieldFn("source-type","sourceType"),kr=createFieldFn("start-position-in-milliseconds",(function(t,n,l){var d,p,h,f,y=null===(d=Mt(t,n,l))||void 0===d?void 0:d["event-type"];return y===nt.LYRIC_DISPLAY||(null===(p=xt(t,n,l))||void 0===p?void 0:p.type)===ot.AGGREGATE_NON_CATALOG_PLAY_TIME||cr(t,n,l)?0:y===nt.PLAY_START?Vt(t,n,l):null!==(f=null!==(h=t.startPositionInMilliseconds)&&void 0!==h?h:previousPosition(n))&&void 0!==f?f:0})),previousPosition=function(t){return t&&void 0!==t.position?Math.round(1e3*t.position):0},Ar=createClientFieldFn("store-front","storefrontId"),Ir=createFieldFn("timed-metadata",(function(t,n,l){var d=t.timedMetadata;if(void 0!==d&&shouldSendTimedMetadata$2(t,n,l))return toHexString(d,0)})),shouldSendTimedMetadata$2=function(t,n,l){var d,p;return(null===(d=xt(t,n,l))||void 0===d?void 0:d.type)===ot.TIMED_METADATA_PING||(null===(p=Mt(t,n,l))||void 0===p?void 0:p["event-type"])!==nt.LYRIC_DISPLAY},Er=createClientFieldFn("user-agent","userAgent"),wr=createFieldFn("user-token",(function(t,n,l){var d=l.client;if(!d.preferDSID)return d.musicUserToken})),Or=createFieldFn("utc-offset-in-seconds",(function(t,n,l){var d;return(null===(d=xt(t,n,l))||void 0===d?void 0:d.type)===ot.AGGREGATE_NON_CATALOG_PLAY_TIME?0:l.client.utcOffsetInSeconds})),Rr={"build-version":Rt,"container-ids":jt,"container-type":Ut,"developer-token":Ft,"device-name":Kt,"end-position-in-milliseconds":$t,"end-reason-type":zt,"event-reason-hint-type":Qt,"event-type":Mt,"feature-name":Jt,guid:Xt,ids:or,"internal-build":ar,"media-duration-in-milliseconds":lr,"media-type":hr,"metrics-client-id":fr,"milliseconds-since-play":yr,offline:vr,"persistent-id":_r,"play-mode":gr,"private-enabled":mr,"reco-data":br,"sb-enabled":Pr,"siri-initiated":Tr,"source-type":Sr,"start-position-in-milliseconds":kr,"store-front":Ar,"timed-metadata":Ir,type:xt,"user-agent":Er,"user-token":wr,"utc-offset-in-seconds":Or},Cr=0,buildPlayActivityData$2=function(t,n,l,d){if(void 0===d&&(d=!1),void 0===n)throw new Error("called without a play activity descriptor");var p=function(t){for(var n=[],l=1;l<arguments.length;l++)n[l-1]=arguments[l];return __assign$2(__assign$2(__assign$2({},t),Object.assign.apply(Object,__spread$2([{}],n))),{cache:{fields:Object.assign.apply(Object,__spread$2([{}],n.map((function(t){var n;return null===(n=null==t?void 0:t.cache)||void 0===n?void 0:n.fields})))),helpers:Object.assign.apply(Object,__spread$2([{}],n.map((function(t){var n;return null===(n=null==t?void 0:t.cache)||void 0===n?void 0:n.helpers}))))}})}("boolean"==typeof d?function(t,n){return void 0===t&&(t={}),__assign$2({id:(Cr++).toFixed(0),client:n,isAlexa:!1},t)}({isAlexa:d},t):__assign$2(__assign$2({},d),{client:t}));Object.assign(n,function(t){var n,l;return{eventType:null!==(n=t.eventType)&&void 0!==n?n:nt.PLAY_START,reporting:null===(l=t.reporting)||void 0===l||l}}(n));var h={state:{},data:__assign$2({},Object.assign.apply(Object,__spread$2([Object.create(null)],Object.values(Rr).map((function(t){return null==t?void 0:t(n,l,p)})))))};return clearBreadcrumbs(),h},compareValue=function(t,n){return!!Object.is(t,n)||"object"==typeof t&&null!==t&&"object"==typeof n&&null!==n&&function(t,n){var l=Object.keys(t);return l.length===Object.keys(n).length&&l.every((function(l){return compareValue(t[l],n[l])}))}(t,n)},Mr=["persistent-id","milliseconds-since-play"],Nr=[],report=function(t,n){console.group("PAF differences report"),function(t){console.group("PAF stacktrace"),t.forEach((function(t){var n=t.methodName,l=t.args;console.log(n,l)})),console.groupEnd()}(n),function(t){console.group("Differences ("+t.length+")"),t.forEach((function(t){var n=t.type,l=__rest$1(t,["type"]);console.log(n,l)})),console.groupEnd()}(t),console.groupEnd()},reportIfNeeded=function(t,n,l){var d=function(t,n,l){void 0===l&&(l=[]);var d=[];return __spread$2(Object.keys(t),l).forEach((function(l){var p=l in t,h=l in n;p&&h?compareValue(t[l],n[l])||Mr.includes(l)||d.push({field:l,type:"field-does-not-match",original:JSON.stringify(t[l]),experimental:JSON.stringify(n[l])}):p&&!h?d.push({field:l,type:"field-should-appear",original:JSON.stringify(t[l])}):!p&&h&&d.push({field:l,type:"field-should-not-appear",experimental:JSON.stringify(n[l])})})),d}(t,n);if(0!==d.length){report(d,l);var p=generateCopyableReport(d,l);console.log("PAF report failed. Run `copyPafReport("+p+")` and open new radar with its content.")}},diffToString=function(t){switch(t.type){case"field-should-appear":return"Field "+t.field+' should be present in the new system with value "'+t.original+'"';case"field-should-not-appear":return"Field "+t.field+' should not be present in the new system (currently present with value "'+t.experimental+'")';case"field-does-not-match":return"Field "+t.field+' has different values in the system. Value in old system: "'+t.original+'", value in new system "'+t.experimental+'"'}},diffToMiniString=function(t){switch(t.type){case"field-should-appear":return"-"+t.field;case"field-should-not-appear":return"+"+t.field;case"field-does-not-match":return"!"+t.field}},generateCopyableReport=function(t,n){return Nr.push("\n  Title: [PAF Refactor] "+t.map(diffToMiniString).join(", ")+"\n\n  Some issues found:\n  "+t.map(diffToString).join("\n")+"\n\n  Stacktrace:\n  "+n.map((function(t){return t.methodName+"("+t.args+")"})).join("\n")+"\n  ")-1};window.copyPafReport=function(t){t<Nr.length&&copy(Nr[t])};var createCookieJar=function(t){switch(void 0===t&&(t="browser"),t){case"browser":return{get:getCookie,set:setCookie};case"memory":return void 0===n&&(n={}),{get:function(t){if(void 0!==t)return n[t]},set:function(t,l){n[t]=l}};default:return t}var n},empty=function(t,n){return write(t,n,[],"/",0)},read=function(t,n){var l=t.get(n);return void 0===l||""===l?[]:ensureArray(JSON.parse(atob(l)))},write=function(t,n,l,d,p,h){return t.set(n,btoa(JSON.stringify(l)),d,p,h)},Dr=st.AUTO,Lr=function(){function PlayActivityBatchableSender(t,n){this.sender=t,this.jar=n,this.mode=Dr}return PlayActivityBatchableSender.prototype.flush=function(){return __awaiter$2(this,void 0,void 0,(function(){var t,n,l;return __generator$2(this,(function(d){switch(d.label){case 0:if(void 0===(t=read(this.jar,"amupaee"))||0===t.length)return[2];d.label=1;case 1:return d.trys.push([1,3,,4]),[4,this.sender.send(t)];case 2:return d.sent(),empty(this.jar,"amupaee"),[3,4];case 3:throw n=d.sent(),l=n.message,new Error("flush: "+l);case 4:return[2]}}))}))},PlayActivityBatchableSender.prototype.send=function(t){return __awaiter$2(this,void 0,void 0,(function(){return __generator$2(this,(function(n){return this.mode!==Dr||!Array.isArray(t)&&t["end-reason-type"]===He.EXITED_APPLICATION?(function(t,n,l,d,p,h){write(t,n,__spread$2(read(t,n),[l]),d,p,h)}(this.jar,"amupaee",t,"/"),[2]):[2,this.sender.send(t)]}))}))},PlayActivityBatchableSender}(),xr=function(){function Timeline(){this._events={},this._keys=[]}return Object.defineProperty(Timeline.prototype,"events",{get:function(){return this._events},enumerable:!0,configurable:!0}),Object.defineProperty(Timeline.prototype,"first",{get:function(){return this.at(0)},enumerable:!0,configurable:!0}),Object.defineProperty(Timeline.prototype,"keys",{get:function(){return this._keys},enumerable:!0,configurable:!0}),Object.defineProperty(Timeline.prototype,"last",{get:function(){return this.at(this.length-1)},enumerable:!0,configurable:!0}),Object.defineProperty(Timeline.prototype,"length",{get:function(){return this._keys.length},enumerable:!0,configurable:!0}),Object.defineProperty(Timeline.prototype,"second",{get:function(){return this.at(1)},enumerable:!0,configurable:!0}),Timeline.prototype.at=function(t){if(t>this.length-1)throw new Error("Invalid timeline index");var n=this._keys[t];return this._events[n]},Timeline.prototype.before=function(t){if("number"!=typeof t){var n=[];for(var l in this._events)this._events.hasOwnProperty(l)&&n.push(this._events[l]);t=this._keys[n.indexOf(t)]}var d=this._keys.indexOf(t);if(-1===d)throw new Error("Key not found");if(d>0)return this._events[this._keys[d-1]]},Timeline.prototype.drain=function(){var t=this,n=this._keys.map((function(n){return t._events[n]}));return this.reset(),n},Timeline.prototype.reset=function(){this._events={},this._keys=[]},Timeline.prototype.pop=function(){return __awaiter$2(this,void 0,void 0,(function(){var t,n;return __generator$2(this,(function(l){return void 0===(t=this._keys.pop())?[2,Promise.reject("TIMELINE IS EMPTY")]:(n=this._events[t],delete this._events[t],[2,Promise.resolve(n)])}))}))},Timeline.prototype.add=function(t,n){return __awaiter$2(this,void 0,void 0,(function(){return __generator$2(this,(function(l){return[2,this.push(t,n)]}))}))},Timeline.prototype.push=function(t,n){return void 0===n&&(n=Date.now()),__awaiter$2(this,void 0,void 0,(function(){return __generator$2(this,(function(l){for(;-1!==this._keys.indexOf(n);)n++;return this._events[n]=t,this._keys.push(n),[2,Promise.resolve(n)]}))}))},Timeline.prototype.shift=function(){return __awaiter$2(this,void 0,void 0,(function(){var t,n;return __generator$2(this,(function(l){return void 0===(t=this._keys.shift())?[2,Promise.reject("TIMELINE IS EMPTY")]:(n=this._events[t],delete this._events[t],[2,Promise.resolve(n)])}))}))},Timeline.prototype.unshift=function(t,n){return void 0===n&&(n=Date.now()),__awaiter$2(this,void 0,void 0,(function(){return __generator$2(this,(function(l){for(;-1!==this._keys.indexOf(n);)n++;return this._events[n]=t,this._keys.unshift(n),[2,Promise.resolve(n)]}))}))},Timeline}(),Ur=new De,Br=function(){function TimedMetadataTracker(t,n){this.client=t,this._currentValue=n}return Object.defineProperty(TimedMetadataTracker.prototype,"currentValue",{get:function(){return this._currentValue},enumerable:!0,configurable:!0}),TimedMetadataTracker.prototype.clear=function(){this._currentValue=void 0},TimedMetadataTracker.prototype.ping=function(t,n){return __awaiter$2(this,void 0,void 0,(function(){return __generator$2(this,(function(l){switch(l.label){case 0:return this.timedMetadataChanged(t)?void 0===this._currentValue?[3,2]:[4,this.client.pingTimedMetadata(n,this._currentValue)]:[3,3];case 1:l.sent(),l.label=2;case 2:this._currentValue=void 0===t?void 0:t.slice(0),l.label=3;case 3:return[2]}}))}))},TimedMetadataTracker.prototype.timedMetadataChanged=function(t){var n=this._currentValue;return void 0===n?void 0!==t:void 0===t||(t.length!==n.length||n.some((function(n,l){return n!==t[l]})))},TimedMetadataTracker}(),fieldGetter=function(t,n){return function(l){return n in l?l[n]:l[t]}},jr=fieldGetter("eventType","event-type"),Fr=fieldGetter("endReasonType","end-reason-type"),Kr=fieldGetter("itemType","type"),Vr=function(){function MPAFStateMachine(){this.machine=c({id:"mpaf",initial:"idle",context:{},states:{error:{},idle:{on:{play:"playing",scrubBegin:{target:"scrubbing",actions:r((function(t){return __assign$2(__assign$2({},t),{stateBeforeScrub:"idle"})}))},scrubEnd:{target:"error",actions:["clearStateBeforeScrub","setScrubEndError"]}}},playing:{on:{scrubBegin:{target:"scrubbing",actions:r((function(t){return __assign$2(__assign$2({},t),{stateBeforeScrub:"playing"})}))},stop:"idle",scrubEnd:{target:"error",actions:["clearStateBeforeScrub","setScrubEndError"]}}},scrubbing:{on:{scrubEnd:[{target:"idle",cond:function(t){return"idle"===t.stateBeforeScrub},actions:["clearStateBeforeScrub"]},{target:"playing",actions:["clearStateBeforeScrub"]}]}}}},{actions:{clearStateBeforeScrub:r((function(t){return t.stateBeforeScrub,__rest$1(t,["stateBeforeScrub"])})),setScrubEndError:r((function(t){return __assign$2(__assign$2({},t),{errorMessage:"The scrub() method was called with the SCRUB_END action without a previous SCRUB_START descriptor"})}))}}),this.machineService=f$3(this.machine).start()}return MPAFStateMachine.prototype.canSendEvent=function(t){var n;return null!==(n=this.machine.transition(this.machineService.state,t).changed)&&void 0!==n&&n},MPAFStateMachine.prototype.matches=function(t){return this.machineService.state.matches(t)},MPAFStateMachine.prototype.send=function(t){var n=function(t){var n=jr(t),l=Fr(t);if(Kr(t)===ot.TIMED_METADATA_PING)return!1;switch(n){case nt.PLAY_START:return"play";case nt.PLAY_END:switch(l){case He.SCRUB_BEGIN:return"scrubBegin";case He.SCRUB_END:return"scrubEnd";case He.EXITED_APPLICATION:return!1;default:return"stop"}default:return"stop"}}(t);if(!1!==n&&(this.canSendEvent({type:n})&&this.machineService.send({type:n}),this.matches("error")))throw new Error(this.machineService.state.context.errorMessage)},MPAFStateMachine}(),$r=function(){var t;return"undefined"==typeof localStorage?"old":"transition"===(null===(t=localStorage.getItem("mk-paf-system"))||void 0===t?void 0:t.toLocaleLowerCase())?"transition":"old"}(),Yr=function(t){function StatelessPlayActivity(n,l,d,p){var h,f=t.call(this,n,l,d,p)||this;return f.system=null!==(h=null==p?void 0:p.builderSystem)&&void 0!==h?h:$r,f}return __extends$2(StatelessPlayActivity,t),StatelessPlayActivity.prototype.build=function(t,n){switch(this.system){case"old":return buildPlayActivityData(this,t,n,"JSCLIENT"!==this.clientId).data;case"new":return buildPlayActivityData$2(this,t,n,"JSCLIENT"!==this.clientId).data;case"transition":return function(t,n,l,d){void 0===d&&(d=!1);var p=getBreadcrumbs();clearBreadcrumbs();var h=buildPlayActivityData(t,n,l,d),f=buildPlayActivityData$2(t,n,l,d);return setTimeout((function(){reportIfNeeded(h.data,f.data,p)}),0),h}(this,t,n,"JSCLIENT"!==this.clientId).data}},StatelessPlayActivity}(vt),Hr=function(){function PlayActivity(t,n,l,d){this.timeline=new xr,this._paf=new Yr(t,n,l,d),this._cookieJar=createCookieJar(null==d?void 0:d.cookieJar),this.sender=new Lr(this._paf.sender,this._cookieJar),this._machine=new Vr,this._timedMetadataTracker=new Br(this)}return Object.defineProperty(PlayActivity.prototype,"mode",{get:function(){return this.sender.mode},set:function(t){this.sender.mode=t},enumerable:!0,configurable:!0}),Object.defineProperty(PlayActivity.prototype,"privateEnabled",{get:function(){return this._paf.privateEnabled},set:function(t){this._paf.privateEnabled=t},enumerable:!0,configurable:!0}),Object.defineProperty(PlayActivity.prototype,"timedMetadata",{get:function(){return this._timedMetadataTracker.currentValue},enumerable:!0,configurable:!0}),PlayActivity.prototype.clearTimedMetadata=function(){return this._timedMetadataTracker.clear()},PlayActivity.prototype.setTimedMetadata=function(t,n){return this._timedMetadataTracker.ping(t,n)},PlayActivity.prototype.activate=function(t){return void 0===t&&(t=!1),__awaiter$2(this,void 0,void 0,(function(){var n,l;return __generator$2(this,(function(d){switch(d.label){case 0:if(!t)return[3,4];d.label=1;case 1:return d.trys.push([1,3,,4]),[4,this.flush()];case 2:return d.sent(),[3,4];case 3:if(n=d.sent(),!function(t){switch(typeof t){case"string":return t;case"object":return t.message?"string"!=typeof t.message?"":t.message:"";default:return""}}(n).includes("send() called without any data"))throw n;return[3,4];case 4:return(l=this.timeline.last)&&l.endReasonType===He.EXITED_APPLICATION?[2,this.timeline.pop()]:[2]}}))}))},PlayActivity.prototype.exit=function(t){return void 0===t&&(t=0),__awaiter$2(this,void 0,void 0,(function(){return __generator$2(this,(function(n){return[2,this.stop(t,He.EXITED_APPLICATION)]}))}))},PlayActivity.prototype.pause=function(t){return void 0===t&&(t=0),__awaiter$2(this,void 0,void 0,(function(){return __generator$2(this,(function(n){return[2,this.stop(t,He.PLAYBACK_MANUALLY_PAUSED)]}))}))},PlayActivity.prototype.pingTimedMetadata=function(t,n,l){return void 0===l&&(l=this._previousDescriptor()),__awaiter$2(this,void 0,void 0,(function(){return __generator$2(this,(function(d){switch(d.label){case 0:return[4,this._addToTimeline(__assign$2(__assign$2({},l),{position:t,endReasonType:He.NOT_APPLICABLE,eventType:nt.PLAY_END,itemType:ot.TIMED_METADATA_PING,timedMetadata:n}))];case 1:return d.sent(),[2]}}))}))},PlayActivity.prototype.play=function(t,n){return void 0===n&&(n=0),__awaiter$2(this,void 0,void 0,(function(){var l,d,p,h;return __generator$2(this,(function(f){switch(f.label){case 0:return l=this.timeline.length>0,void 0===t?l?((d=this._previousDescriptor()).eventType===nt.PLAY_END&&delete d.endReasonType,p=__assign$2(__assign$2({},this.sanitizePreviousDescriptor(d)),{eventType:nt.PLAY_START}),[2,this._addToTimeline(p)]):[2]:l?(d=this._previousDescriptor(),this._machine.matches("playing")?(p=__assign$2(__assign$2({},this.sanitizePreviousDescriptor(d)),{eventType:nt.PLAY_END,endReasonType:He.MANUALLY_SELECTED_PLAYBACK_OF_A_DIFF_ITEM,position:n}),[4,this._addToTimeline(p)]):[3,2]):[3,2];case 1:f.sent(),n=0,f.label=2;case 2:return h=__assign$2(__assign$2({},t),{eventType:nt.PLAY_START,position:n}),[2,this._addToTimeline(h)]}}))}))},PlayActivity.prototype.scrub=function(t,n){return void 0===t&&(t=0),void 0===n&&(n=He.SCRUB_BEGIN),__awaiter$2(this,void 0,void 0,(function(){var l,d;return __generator$2(this,(function(p){return l=this._previousDescriptor(),d=__assign$2(__assign$2({},this.sanitizePreviousDescriptor(l)),{eventType:nt.PLAY_END,endReasonType:n,position:t}),[2,this._addToTimeline(d)]}))}))},PlayActivity.prototype.skip=function(t,n,l){return void 0===n&&(n=He.TRACK_SKIPPED_FORWARDS),void 0===l&&(l=0),__awaiter$2(this,void 0,void 0,(function(){return __generator$2(this,(function(d){switch(d.label){case 0:return[4,this.stop(l,n)];case 1:return d.sent(),[2,this.play(t)]}}))}))},PlayActivity.prototype.stop=function(t,n){return void 0===t&&(t=0),void 0===n&&(n=He.NATURAL_END_OF_TRACK),__awaiter$2(this,void 0,void 0,(function(){var l,d;return __generator$2(this,(function(p){switch(p.label){case 0:return(l=this._previousDescriptor()).endReasonType!==He.EXITED_APPLICATION?[3,2]:[4,this.timeline.pop()];case 1:p.sent(),empty(this._cookieJar,"amupaee"),l=this._previousDescriptor(),p.label=2;case 2:return this._machine.matches("playing")?(d=__assign$2(__assign$2({},this.sanitizePreviousDescriptor(l)),{eventType:nt.PLAY_END,endReasonType:n,position:t,timedMetadata:this._timedMetadataTracker.currentValue}),[2,this._addToTimeline(d)]):[2,Promise.reject(new Error("A play stop() method was called without a previous play() descriptor"))]}}))}))},PlayActivity.prototype.build=function(t,n){if(void 0===t&&void 0===n&&Ur.warn("You are calling build() from a stateful PAF client. Please, use a stateless client or exit(), pause(), play(), scrub(), skip() or stop() instead."),void 0===t){if(0===this.timeline.length)throw new Error("build() called without a play activity descriptor");t=this.timeline.last}if(void 0===n){if(void 0===(n=this.timeline.before(t))&&t.eventType===nt.PLAY_END)throw new Error("Cannot build() for PLAY_END descriptors without previous descriptors");n=null!=n&&n}return this._paf.build(__assign$2(__assign$2({},t),{timedMetadata:this.timedMetadata}),n)},PlayActivity.prototype.addForPlayParams=function(t,n,l,d,p){void 0===d&&(d=0),void 0===p&&(p={});var h=this.buildDescriptorForPlayParams(t,n,l,d,p);return this._addToTimeline(h)},PlayActivity.prototype.buildDescriptorForPlayParams=function(t,n,l,d,p){void 0===d&&(d=0),void 0===p&&(p={});var h="stream"===t.format?ot.STREAM:ot.ITUNES_STORE_CONTENT;return __assign$2(__assign$2(__assign$2({},t),{container:l,duration:d,eventType:n,itemType:h}),p)},PlayActivity.prototype.flush=function(){return this.sender.flush()},PlayActivity.prototype._addToTimeline=function(t){return __awaiter$2(this,void 0,void 0,(function(){var n,l,d;return __generator$2(this,(function(p){switch(p.label){case 0:return n=__assign$2(__assign$2({},t),{timestamp:Date.now()}),l=this.timeline.length>0&&this.timeline.last,[4,this.timeline.add(n)];case 1:return p.sent(),d=this.build(n,l),[4,this.send(d)];case 2:return p.sent(),[2]}}))}))},PlayActivity.prototype._previousDescriptor=function(){var t=this.timeline.last;if(void 0===t)throw new Error("A method was called without a previous descriptor");return exceptFields(t,"timestamp")},PlayActivity.prototype.buildForPlayParams=function(t,n,l,d,p,h){return void 0===d&&(d=0),void 0===p&&(p={}),void 0===h&&(h=!1),Ur.warn("You are using buildsForPlayParams from a stateful PlayActivity. Please, use StatelessPlayActivity instead"),this._paf.buildForPlayParams(t,n,l,d,p,h)},PlayActivity.prototype.send=function(t){var n=this,l=ensureArray(t);return l.forEach((function(t){return n._machine.send(t)})),this.sender.send(l)},PlayActivity.prototype.sanitizePreviousDescriptor=function(t){var n=function deepClone(t){if("object"!=typeof t||null===t)throw new TypeError("Source is not an Object");var n=Array.isArray(t)?[]:{};for(var l in t)Se.call(t,l)&&("object"==typeof t[l]&&null!==t[l]?n[l]=deepClone(t[l]):n[l]=t[l]);return n}(t);return n.itemType===ot.TIMED_METADATA_PING&&(n=exceptFields(n,"itemType")),n},__decorate$1([Breadcrumb,__metadata$1("design:type",Function),__metadata$1("design:paramtypes",[Object]),__metadata$1("design:returntype",Promise)],PlayActivity.prototype,"exit",null),__decorate$1([Breadcrumb,__metadata$1("design:type",Function),__metadata$1("design:paramtypes",[Object]),__metadata$1("design:returntype",Promise)],PlayActivity.prototype,"pause",null),__decorate$1([Breadcrumb,__metadata$1("design:type",Function),__metadata$1("design:paramtypes",[Number,Uint8Array,Object]),__metadata$1("design:returntype",Promise)],PlayActivity.prototype,"pingTimedMetadata",null),__decorate$1([Breadcrumb,__metadata$1("design:type",Function),__metadata$1("design:paramtypes",[Object,Object]),__metadata$1("design:returntype",Promise)],PlayActivity.prototype,"play",null),__decorate$1([Breadcrumb,__metadata$1("design:type",Function),__metadata$1("design:paramtypes",[Object,Number]),__metadata$1("design:returntype",Promise)],PlayActivity.prototype,"scrub",null),__decorate$1([Breadcrumb,__metadata$1("design:type",Function),__metadata$1("design:paramtypes",[Object,Number,Object]),__metadata$1("design:returntype",Promise)],PlayActivity.prototype,"skip",null),__decorate$1([Breadcrumb,__metadata$1("design:type",Function),__metadata$1("design:paramtypes",[Object,Number]),__metadata$1("design:returntype",Promise)],PlayActivity.prototype,"stop",null),__decorate$1([Breadcrumb,__metadata$1("design:type",Function),__metadata$1("design:paramtypes",[Object,Object]),__metadata$1("design:returntype",Object)],PlayActivity.prototype,"build",null),__decorate$1([Breadcrumb,__metadata$1("design:type",Function),__metadata$1("design:paramtypes",[Object,String,Object,Object,Object]),__metadata$1("design:returntype",Promise)],PlayActivity.prototype,"addForPlayParams",null),__decorate$1([Breadcrumb,__metadata$1("design:type",Function),__metadata$1("design:paramtypes",[Object,String,Object,Object,Object]),__metadata$1("design:returntype",Object)],PlayActivity.prototype,"buildDescriptorForPlayParams",null),__decorate$1([Breadcrumb,__metadata$1("design:type",Function),__metadata$1("design:paramtypes",[Object,String,Object,Object,Object,Object]),__metadata$1("design:returntype",void 0)],PlayActivity.prototype,"buildForPlayParams",null),PlayActivity}();t.version="2.2124.8";var Wr=t.version.split("."),zr=Wr[0],Gr=Wr[Wr.length-1];Wr[0]="3",Wr[Wr.length-1]=Gr+"-prerelease",Wr[0]=zr,Wr[Wr.length-1]=Gr,t.version=Wr.join(".");var Bind=function(){return function(t,n,l){if(void 0===l||"function"!=typeof l.value)throw new TypeError("Only methods can be decorated with @Bind, but "+n+" is not a method.");return{configurable:!0,get:function(){var t=l.value.bind(this);return Object.defineProperty(this,n,{value:t,configurable:!0,writable:!0}),t}}}},K=function(){},asAsync=function(t){t.then(K,K)},qr=K,Qr=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,n){t.__proto__=n}||function(t,n){for(var l in n)n.hasOwnProperty(l)&&(t[l]=n[l])};var Jr,Xr=Object.assign||function(t){for(var n,l=1,d=arguments.length;l<d;l++)for(var p in n=arguments[l])Object.prototype.hasOwnProperty.call(n,p)&&(t[p]=n[p]);return t},Zr=["contributors","Episode","modalities","Movie","musicVideo","podcast-episodes","radioStation","Show","song","uploaded-audios","uploadedAudio","uploaded-videos","uploadedVideo","Vod","workouts","workout-programs"],ei={"uploaded-videos":!0,uploadedVideo:!0,"uploaded-audios":!0,uploadedAudio:!0,"podcast-episodes":!0},ti="mediaItemStateDidChange",ri="mediaItemStateWillChange",ii=new De,ni=d.none,oi=d.loading,ai=d.ready,si=d.playing,ui=d.ended,ci=d.unavailable,li=d.restricted,di=d.error,pi=d.unsupported,hi=((Jr={})[ni]={allowed:[oi],unknown:[ui,ci,li,di,pi]},Jr[oi]={allowed:[ai,li,di,pi],unknown:[]},Jr[ai]={allowed:[si],unknown:[di]},Jr[si]={allowed:[ui,di],unknown:[ci,li,pi]},Jr[ui]={allowed:[],unknown:[]},Jr[ci]={allowed:[],unknown:[]},Jr[li]={allowed:[],unknown:[]},Jr[di]={allowed:[],unknown:[]},Jr[pi]={allowed:[],unknown:[]},Jr),toName=function(t){return d[t]},createMediaItemStateGuard=function(t){void 0===t&&(t=ni);var n={current:t,set:function(t){var l=n.current;if(!function(t,n){return hi[t].allowed.includes(n)}(l,t)){var d=function(t,n){return hi[t].unknown.includes(n)}(l,t);ii.debug("MediaItem.state was changed from "+toName(l)+" to "+toName(t),d?"but it is unknown whether it should be allowed or not.":"and it should not be happening")}n.current=t}};return n};function isStringNotEmpty(t){return!function(t){return void 0===t||""===t.trim()}(t)}function transform$1(t){return transform({"attributes.albumName":"metadata.playlistName","attributes.artistName":"metadata.artistName","attributes.artwork":function(){var n=null==t?void 0:t.artworkURL;if(n)return function(t){var n=t.split("/").pop(),l=__read$1(!!n&&n.match(/\d+/g)||["100","100"],2),d=l[0],p=l[1];return{width:parseInt(d,10),height:parseInt(p,10),url:t.replace(d+"x"+p,"{w}x{h}")}}(n)},"attributes.composerName":"metadata.composerName","attributes.contentRating":function(){var n;if(1===(null===(n=null==t?void 0:t.metadata)||void 0===n?void 0:n.explicit))return"explicit"},"attributes.discNumber":function(){var n;return(null===(n=null==t?void 0:t.metadata)||void 0===n?void 0:n.discNumber)||1},"attributes.durationInMillis":"metadata.duration","attributes.genreNames":function(){var n;return[null===(n=null==t?void 0:t.metadata)||void 0===n?void 0:n.genre]},"attributes.isrc":function(){var n,l=null===(n=null==t?void 0:t.metadata)||void 0===n?void 0:n.xid;if(l)return l.replace(/^([^:]+):isrc:/,"$1")},"attributes.name":"metadata.itemName","attributes.playParams.id":"metadata.itemId","attributes.playParams.kind":"metadata.kind","attributes.previews":function(){return[{url:null==t?void 0:t.previewURL}]},"attributes.releaseDate":"metadata.releaseDate","attributes.trackNumber":"metadata.trackNumber",assetURL:"URL",albumId:function(){var n;return""+(null===(n=null==t?void 0:t.metadata)||void 0===n?void 0:n.playlistId)},artistId:function(){var n;return""+(null===(n=null==t?void 0:t.metadata)||void 0===n?void 0:n.artistId)},cloudId:"metadata.cloud-id",id:function(){var n;return""+(null===(n=null==t?void 0:t.metadata)||void 0===n?void 0:n.itemId)},flavor:"flavor",type:"metadata.kind"},t)}var fi=ti,yi=ri,vi={isEntitledToPlay:!0},_i=function(n){function MediaItem(l){void 0===l&&(l={});var d=n.call(this,[fi,yi])||this;d.bingeWatching=!1,d.hlsMetadata={},d.playbackType=t.PlaybackType.none,d._assets=[],d._state=createMediaItemStateGuard(),ii.debug("media-item: creating Media Item with options:",l);return l.id&&l.attributes?(Object.keys(l).forEach((function(t){vi.hasOwnProperty(t)||(d[t]=l[t])})),d.type=d.playParams&&d.playParams.kind?d.playParams.kind:d.type||"song"):(d.id=l.id||generateUUID(),d.type=l.type||"song",d.attributes={playParams:{id:d.id,kind:d.type}}),d._context=l.context||{},l.container?d._container=l.container:l.containerId&&l.containerType&&(d._container={id:l.containerId,type:l.containerType}),d}return function(t,n){function __(){this.constructor=t}Qr(t,n),t.prototype=null===n?Object.create(n):(__.prototype=n.prototype,new __)}(MediaItem,n),Object.defineProperty(MediaItem.prototype,"albumInfo",{get:function(){var t=this.albumName,n=this.artistName,l=[];return n&&l.push(n),t&&l.push(t),l.join(" - ")},enumerable:!0,configurable:!0}),Object.defineProperty(MediaItem.prototype,"albumName",{get:function(){return this.attributes.albumName},enumerable:!0,configurable:!0}),Object.defineProperty(MediaItem.prototype,"artistName",{get:function(){return this.attributes.genreNames&&this.attributes.genreNames.indexOf("Classical")>-1&&this.attributes.composerName?this.attributes.composerName:this.attributes.artistName},enumerable:!0,configurable:!0}),Object.defineProperty(MediaItem.prototype,"artwork",{get:function(){var t,n;return null!==(t=this.attributes.artwork)&&void 0!==t?t:null===(n=this.attributes.images)||void 0===n?void 0:n.coverArt16X9},enumerable:!0,configurable:!0}),Object.defineProperty(MediaItem.prototype,"artworkURL",{get:function(){if(this.artwork&&this.artwork.url)return this.artwork.url},enumerable:!0,configurable:!0}),Object.defineProperty(MediaItem.prototype,"assets",{get:function(){return this._assets},enumerable:!0,configurable:!0}),Object.defineProperty(MediaItem.prototype,"canPlay",{get:function(){return this.isPlayable&&this.isReady},enumerable:!0,configurable:!0}),Object.defineProperty(MediaItem.prototype,"container",{get:function(){return this._container},set:function(t){this._container=t},enumerable:!0,configurable:!0}),Object.defineProperty(MediaItem.prototype,"contentRating",{get:function(){return this.attributes.contentRating},enumerable:!0,configurable:!0}),Object.defineProperty(MediaItem.prototype,"context",{get:function(){return this._context},set:function(t){this._context=t},enumerable:!0,configurable:!0}),Object.defineProperty(MediaItem.prototype,"discNumber",{get:function(){return this.attributes.discNumber},enumerable:!0,configurable:!0}),Object.defineProperty(MediaItem.prototype,"hasContainerArtwork",{get:function(){return this.container&&this.container.attributes&&this.container.attributes.artwork&&this.container.attributes.artwork.url},enumerable:!0,configurable:!0}),Object.defineProperty(MediaItem.prototype,"hasPlaylistContainer",{get:function(){return this.container&&"playlists"===this.container.type&&this.container.attributes},enumerable:!0,configurable:!0}),Object.defineProperty(MediaItem.prototype,"isEntitledToPlay",{get:function(){var t,n,l=this.attributes,d=this.playables;return null!==(n=l.isEntitledToPlay||(null===(t=null==d?void 0:d[0])||void 0===t?void 0:t.isEntitledToPlay))&&void 0!==n&&n},enumerable:!0,configurable:!0}),Object.defineProperty(MediaItem.prototype,"isLiveRadioStation",{get:function(){return isLiveRadioStation(this)},enumerable:!0,configurable:!0}),Object.defineProperty(MediaItem.prototype,"isSong",{get:function(){return"song"===this.type},enumerable:!0,configurable:!0}),Object.defineProperty(MediaItem.prototype,"info",{get:function(){return this.title+" - "+this.albumInfo},enumerable:!0,configurable:!0}),Object.defineProperty(MediaItem.prototype,"isCloudItem",{get:function(){return this.playParams&&this.playParams.isLibrary||ce(this.id)},enumerable:!0,configurable:!0}),Object.defineProperty(MediaItem.prototype,"isCloudUpload",{get:function(){return-1===this._songId},enumerable:!0,configurable:!0}),Object.defineProperty(MediaItem.prototype,"isExplicitItem",{get:function(){return"explicit"===this.contentRating},enumerable:!0,configurable:!0}),Object.defineProperty(MediaItem.prototype,"isLoading",{get:function(){return this.state===d.loading},enumerable:!0,configurable:!0}),Object.defineProperty(MediaItem.prototype,"isPlayableMediaType",{get:function(){return-1!==Zr.indexOf(this.type)},enumerable:!0,configurable:!0}),Object.defineProperty(MediaItem.prototype,"isPlayable",{get:function(){var t;return!!this.isPlayableMediaType&&(!(!this.isLiveRadioStation&&!this.hasOffersHlsUrl)||(this.needsPlayParams?!!this.playParams:this.isUTS?this.isEntitledToPlay:!!this.attributes.assetUrl||!!(null===(t=this.attributes.previews)||void 0===t?void 0:t.length)))},enumerable:!0,configurable:!0}),Object.defineProperty(MediaItem.prototype,"isPlaying",{get:function(){return this.state===d.playing},enumerable:!0,configurable:!0}),Object.defineProperty(MediaItem.prototype,"isPreparedToPlay",{get:function(){if("song"===this.type)return!!this._assets&&!!this.keyURLs&&!!this._songId;if(this.isUTS){var t=isStringNotEmpty(this.assetURL),n=!!(this.keyURLs&&isStringNotEmpty(this.keyURLs["hls-key-cert-url"])&&isStringNotEmpty(this.keyURLs["hls-key-server-url"])&&isStringNotEmpty(this.keyURLs["widevine-cert-url"]));return t&&n}return!!isStringNotEmpty(this.assetURL)||this.playRawAssetURL&&!!isStringNotEmpty(this.attributes.assetUrl)},enumerable:!0,configurable:!0}),Object.defineProperty(MediaItem.prototype,"isrc",{get:function(){return this.attributes.isrc},enumerable:!0,configurable:!0}),Object.defineProperty(MediaItem.prototype,"isReady",{get:function(){return this.state===d.ready},enumerable:!0,configurable:!0}),Object.defineProperty(MediaItem.prototype,"isRestricted",{get:function(){return this.state===d.restricted},enumerable:!0,configurable:!0}),Object.defineProperty(MediaItem.prototype,"isUTS",{get:function(){return["Episode","Movie","MusicMovie","Show","Vod"].includes(this.type)},enumerable:!0,configurable:!0}),Object.defineProperty(MediaItem.prototype,"isUnavailable",{get:function(){return this.state===d.unavailable},enumerable:!0,configurable:!0}),Object.defineProperty(MediaItem.prototype,"needsPlayParams",{get:function(){return["musicVideo","song"].includes(this.type)},enumerable:!0,configurable:!0}),Object.defineProperty(MediaItem.prototype,"normalizedType",{get:function(){return t=this.type,(n=ve[t])||(n=t.replace(/_|[A-Z]/g,(function(t,n){return"_"===t?"-":(t=t.toLowerCase(),0===n?t:"-"+t)})),t.endsWith("y")?n=n.substring(0,n.length-1)+"ies":n.endsWith("s")||(n+="s"),ve[t]=n,n);var t,n},enumerable:!0,configurable:!0}),Object.defineProperty(MediaItem.prototype,"offers",{get:function(){return this.attributes.offers},enumerable:!0,configurable:!0}),Object.defineProperty(MediaItem.prototype,"offersHlsUrl",{get:function(){var t=this.offers,n=null==t?void 0:t.find((function(t){var n;return!!(null===(n=t.hlsUrl)||void 0===n?void 0:n.length)}));return null==n?void 0:n.hlsUrl},enumerable:!0,configurable:!0}),Object.defineProperty(MediaItem.prototype,"hasOffersHlsUrl",{get:function(){return isStringNotEmpty(this.offersHlsUrl)},enumerable:!0,configurable:!0}),Object.defineProperty(MediaItem.prototype,"playbackData",{set:function(t){if(void 0!==t){this.previewURL&&(t.previewURL=this.previewURL);var n=transform$1(t);this.artwork&&n.artwork&&delete n.artwork,n.id!==this.id&&delete n.id,this.playParams&&n.attributes.playParams&&(n.attributes.playParams=this.playParams),Object.assign(this,n),ii.debug("media-item: item merged with playbackData",this),this.state=d.ready}},enumerable:!0,configurable:!0}),Object.defineProperty(MediaItem.prototype,"playbackDuration",{get:function(){return this.attributes.durationInMillis||this.attributes.durationInMilliseconds},enumerable:!0,configurable:!0}),Object.defineProperty(MediaItem.prototype,"playlistArtworkURL",{get:function(){var t,n,l;return this.hasPlaylistContainer&&this.hasContainerArtwork?null===(l=null===(n=null===(t=this.container)||void 0===t?void 0:t.attributes)||void 0===n?void 0:n.artwork)||void 0===l?void 0:l.url:this.artworkURL},enumerable:!0,configurable:!0}),Object.defineProperty(MediaItem.prototype,"playlistName",{get:function(){var t,n;return this.hasPlaylistContainer?null===(n=null===(t=this.container)||void 0===t?void 0:t.attributes)||void 0===n?void 0:n.name:this.albumName},enumerable:!0,configurable:!0}),Object.defineProperty(MediaItem.prototype,"playParams",{get:function(){return this.attributes.playParams},enumerable:!0,configurable:!0}),Object.defineProperty(MediaItem.prototype,"playRawAssetURL",{get:function(){return!this.hasOffersHlsUrl&&!(!this.isCloudUpload&&!ei[this.type])},enumerable:!0,configurable:!0}),Object.defineProperty(MediaItem.prototype,"previewURL",{get:function(){var t,n,l,d,p,h,f,y,v,_,g,m,b,P,T;return(null===(l=null===(n=null===(t=this.attributes)||void 0===t?void 0:t.previews)||void 0===n?void 0:n[0])||void 0===l?void 0:l.url)||(null===(h=null===(p=null===(d=this.attributes)||void 0===d?void 0:d.previews)||void 0===p?void 0:p[0])||void 0===h?void 0:h.hlsUrl)||(null===(_=null===(v=null===(y=null===(f=this.attributes)||void 0===f?void 0:f.trailers)||void 0===y?void 0:y[0])||void 0===v?void 0:v.assets)||void 0===_?void 0:_.hlsUrl)||(null===(b=null===(m=null===(g=this.attributes)||void 0===g?void 0:g.movieClips)||void 0===m?void 0:m[0])||void 0===b?void 0:b.hlsUrl)||(null===(T=null===(P=this.attributes)||void 0===P?void 0:P.video)||void 0===T?void 0:T.hlsUrl)},enumerable:!0,configurable:!0}),Object.defineProperty(MediaItem.prototype,"rating",{get:function(){return this.attributes.rating},enumerable:!0,configurable:!0}),Object.defineProperty(MediaItem.prototype,"releaseDate",{get:function(){if(this._releaseDate)return this._releaseDate;if(this.attributes&&(this.attributes.releaseDate||this.attributes.releaseDateTime)){var t=this.attributes.releaseDate||this.attributes.releaseDateTime;return this._releaseDate=/^\d{4}-\d{1,2}-\d{1,2}/.test(t)?new Date(t):void 0,this._releaseDate}},enumerable:!0,configurable:!0}),Object.defineProperty(MediaItem.prototype,"songId",{get:function(){return this._songId&&-1!==this._songId?this._songId:this.id},enumerable:!0,configurable:!0}),Object.defineProperty(MediaItem.prototype,"state",{get:function(){return this._state.current},set:function(t){var n={oldState:this._state.current,state:t};this._stateWillChange&&this._stateWillChange(this),this.dispatchEvent(yi,n),this._state.set(t),this._stateDidChange&&this._stateDidChange(this),this.dispatchEvent(fi,n)},enumerable:!0,configurable:!0}),Object.defineProperty(MediaItem.prototype,"title",{get:function(){return this.attributes.name||this.attributes.title},enumerable:!0,configurable:!0}),Object.defineProperty(MediaItem.prototype,"trackNumber",{get:function(){return this.attributes.trackNumber},enumerable:!0,configurable:!0}),MediaItem.prototype.beginMonitoringStateDidChange=function(t){this._stateDidChange=t},MediaItem.prototype.beginMonitoringStateWillChange=function(t){this._stateWillChange=t},MediaItem.prototype.endMonitoringStateDidChange=function(){this._stateDidChange=void 0},MediaItem.prototype.endMonitoringStateWillChange=function(){this._stateWillChange=void 0},MediaItem.prototype.isEqual=function(t){return this.id===t.id&&this.type===t.type&&this.attributes===t.attributes},MediaItem.prototype.resetState=function(){this.endMonitoringStateWillChange(),this.endMonitoringStateDidChange(),this.state=d.none},MediaItem.prototype.restrict=function(){this.isExplicitItem&&(this.state=d.restricted,this._removePlayableData())},MediaItem.prototype.notSupported=function(){this.state=d.unsupported,this._removePlayableData()},MediaItem.prototype.updateFromLoadError=function(t){switch(t.errorCode){case Fe.CONTENT_RESTRICTED:this.state=d.restricted;break;case Fe.CONTENT_UNAVAILABLE:this.state=d.unavailable;break;default:this.state=d.error}},MediaItem.prototype.updateFromSongList=function(t){"musicVideo"===this.type?this.updateWithLoadedAssets(void 0,t["hls-playlist-url"]):this.updateWithLoadedAssets(t.assets),this._songId=t.songId,this.updateWithLoadedKeys({"hls-key-cert-url":t["hls-key-cert-url"],"hls-key-server-url":t["hls-key-server-url"],"widevine-cert-url":t["widevine-cert-url"]})},MediaItem.prototype.updateWithLoadedKeys=function(t,n){this.keyURLs=t,n&&(this.keyServerQueryParameters=n)},MediaItem.prototype.updateWithLoadedAssets=function(t,n){t&&(this._assets=t),n&&(this.assetURL=n)},MediaItem.prototype._removePlayableData=function(){var t,n,l;null===(t=this.attributes)||void 0===t||delete t.playParams,null===(n=this.attributes)||void 0===n||delete n.previews,null===(l=this.attributes)||void 0===l||delete l.trailers},MediaItem}(ke),extendStatics$4=function(t,n){return(extendStatics$4=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,n){t.__proto__=n}||function(t,n){for(var l in n)n.hasOwnProperty(l)&&(t[l]=n[l])})(t,n)};function __extends$4(t,n){function __(){this.constructor=t}extendStatics$4(t,n),t.prototype=null===n?Object.create(n):(__.prototype=n.prototype,new __)}var __assign$4=function(){return(__assign$4=Object.assign||function(t){for(var n,l=1,d=arguments.length;l<d;l++)for(var p in n=arguments[l])Object.prototype.hasOwnProperty.call(n,p)&&(t[p]=n[p]);return t}).apply(this,arguments)};function __metadata$2(t,n){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(t,n)}function __awaiter$3(t,n,l,d){return new(l||(l=Promise))((function(p,h){function fulfilled(t){try{step(d.next(t))}catch(e){h(e)}}function rejected(t){try{step(d.throw(t))}catch(e){h(e)}}function step(t){t.done?p(t.value):new l((function(n){n(t.value)})).then(fulfilled,rejected)}step((d=d.apply(t,n||[])).next())}))}function __generator$3(t,n){var l,d,p,h,f={label:0,sent:function(){if(1&p[0])throw p[1];return p[1]},trys:[],ops:[]};return h={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(h[Symbol.iterator]=function(){return this}),h;function verb(h){return function(y){return function(h){if(l)throw new TypeError("Generator is already executing.");for(;f;)try{if(l=1,d&&(p=2&h[0]?d.return:h[0]?d.throw||((p=d.return)&&p.call(d),0):d.next)&&!(p=p.call(d,h[1])).done)return p;switch(d=0,p&&(h=[2&h[0],p.value]),h[0]){case 0:case 1:p=h;break;case 4:return f.label++,{value:h[1],done:!1};case 5:f.label++,d=h[1],h=[0];continue;case 7:h=f.ops.pop(),f.trys.pop();continue;default:if(!(p=f.trys,(p=p.length>0&&p[p.length-1])||6!==h[0]&&2!==h[0])){f=0;continue}if(3===h[0]&&(!p||h[1]>p[0]&&h[1]<p[3])){f.label=h[1];break}if(6===h[0]&&f.label<p[1]){f.label=p[1],p=h;break}if(p&&f.label<p[2]){f.label=p[2],f.ops.push(h);break}p[2]&&f.ops.pop(),f.trys.pop();continue}h=n.call(t,f)}catch(e){h=[6,e],d=0}finally{l=p=0}if(5&h[0])throw h[1];return{value:h[0]?h[1]:void 0,done:!0}}([h,y])}}}function __read$3(t,n){var l="function"==typeof Symbol&&t[Symbol.iterator];if(!l)return t;var d,p,h=l.call(t),f=[];try{for(;(void 0===n||n-- >0)&&!(d=h.next()).done;)f.push(d.value)}catch(error){p={error:error}}finally{try{d&&!d.done&&(l=h.return)&&l.call(h)}finally{if(p)throw p.error}}return f}var gi={af:48,sq:1,ar:34,eu:1,bg:49,be:1,ca:42,zh:19,"zh-tw":18,"zh-cn":19,"zh-hk":45,"zh-sg":19,hr:41,cs:22,da:11,nl:10,"nl-be":65,en:1,"en-us":1,"en-eg":26,"en-au":27,"en-gb":2,"en-ca":6,"en-nz":27,"en-ie":26,"en-za":26,"en-jm":26,"en-bz":26,"en-tt":26,"en-001":26,et:30,fo:1,fa:59,fi:12,fr:3,"fr-ca":5,gd:2,de:4,"de-ch":57,el:23,he:36,hi:50,hu:21,is:31,id:37,it:7,ja:9,ko:13,lv:33,lt:32,mk:1,mt:1,no:14,nb:14,nn:14,pl:20,"pt-br":15,pt:24,rm:1,ro:39,ru:16,sr:1,sk:40,sl:52,es:8,"es-mx":28,"es-419":44,sv:17,th:35,ts:1,tn:1,tr:25,uk:29,ur:55,ve:1,vi:43,xh:1,yi:1,zu:56,ms:38,iw:36,lo:46,tl:47,kk:51,ta:53,te:54,bn:58,ga:60,ht:61,la:62,pa:63,sa:64};function getLanguages(){if("undefined"==typeof navigator)return[];if(navigator.languages)return navigator.languages;var t=navigator.language||navigator.userLanguage;return t?[t]:[]}var mi=new RegExp("^https://([a-z0-9]+-)?"+"js-cdn.music.apple.com/musickit/v2/".replace(/[\.\/]/g,"\\$&"),"i"),bi=/^([a-z]+:)?\/\//;function findScript(t){return isNodeEnvironment()||!t?null:document.querySelector('script[src*="'+t+'"]')}function determineCdnBasePrefix(){var t,n;try{for(var l=function(t){var n="function"==typeof Symbol&&t[Symbol.iterator],l=0;return n?n.call(t):{next:function(){return t&&l>=t.length&&(t=void 0),{value:t&&t[l++],done:!t}}}}("undefined"!=typeof document&&document.querySelectorAll?Array.from(document.querySelectorAll("script[src]")):[]),d=l.next();!d.done;d=l.next()){var p=d.value,h=mi.exec(p.src);if(h)return h[1]||""}}catch(f){t={error:f}}finally{try{d&&!d.done&&(n=l.return)&&n.call(l)}finally{if(t)throw t.error}}return""}function determineCdnBaseHost(){return isNodeEnvironment()?"":"//"+determineCdnBasePrefix()+"js-cdn.music.apple.com"}function getHlsJsCdnConfig(){var t={hls:"",rtc:""};if(isNodeEnvironment())return t;var n=determineCdnBaseHost(),l="2.15.15";return"undefined"!=typeof localStorage&&(l=localStorage.getItem("mk-hlsjs-version")||l),t.hls="https:"+n+"/hls.js/"+l+"/hls.js/hls.js",t.rtc="https:"+n+"/hls.js/"+l+"/rtc.js/rtc.min.js",t}function loadScript(t,n){return new Promise((function(l,d){if(isNodeEnvironment()&&d("Dynamic script loading is unsupported in Node environments."),findScript(t))return l();var p,h=document.createElement("script");(n&&Object.keys(n).forEach((function(t){h.setAttribute(t,n[t])})),h.onload=function(){l()},h.onerror=function(t){d(t)},bi.test(t))?p=t:p=""+function(t,n){if(void 0===n&&(n=window),isNodeEnvironment())return"";if(n.localStorage.mkCDNBaseURLOverride)return n.localStorage.mkCDNBaseURLOverride;var l=findScript(t);return l?l.getAttribute("src").replace(new RegExp(t+"$"),""):determineCdnBaseHost()+"/musickit/v2/"}(t)+t;h.src=p,document.head.appendChild(h)}))}var Pi,Ti,Si,ki=new De("sk-debug"),Ai=function(){function AuthBridgeBase(){this._targetOrigin="*"}return AuthBridgeBase.prototype.init=function(t,n){var l;this._receiveWindow=t,this._sendWindow=n,this.handleMessage=this.handleMessage.bind(this),null===(l=this._receiveWindow)||void 0===l||l.addEventListener("message",this.handleMessage)},AuthBridgeBase.prototype.sendMessage=function(t,n){var l={action:"mediakit:"+t,data:n};this._sendWindow&&this._sendWindow.postMessage(JSON.stringify(l),this._targetOrigin)},AuthBridgeBase.prototype.handleMessage=function(t){if(this._isOriginAllowed(t.origin)){var n;try{n=JSON.parse(t.data)}catch(e){}if(n&&this._isNamespacedData(n)){"*"===this._targetOrigin&&(this._targetOrigin=t.origin),ki.debug("auth-bridge: handleMessage",n);var l=n.action.replace("mediakit:","");this[l]?this[l](n.data):ki.debug("auth-bridge: unsupported method",l)}}},AuthBridgeBase.prototype._isOriginAllowed=function(t){if(!t)return!1;var n=__read$3(t.split("://"),2),l=n[0],d=n[1],p="";return d&&(p=d.split(":")[0]),"https"===l&&!!p&&p.endsWith(".apple.com")},AuthBridgeBase.prototype._isNamespacedData=function(t){return t.action&&-1!==t.action.indexOf("mediakit:")},AuthBridgeBase}(),Ii=function(t){function AuthBridgeApp(){var n=t.call(this)||this;return n.whenFrameInited=new Promise((function(t){return n._frameInitResolve=t})),n.whenAuthCompleted=new Promise((function(t){return n._authUpdateResolve=t})),n.frame=document.createElement("iframe"),n.frame.src=n._getIframeSrc(),n.frame.style.display="none",document.body.appendChild(n.frame),n.init(window,n.frame.contentWindow),n}return __extends$4(AuthBridgeApp,t),AuthBridgeApp.prototype.requestAuthUpdate=function(){var t=this;this.whenFrameInited.then((function(){return t.sendMessage("requestAuthUpdate")}))},AuthBridgeApp.prototype.setCookieItem=function(t,n){var l=this;this.whenFrameInited.then((function(){return l.sendMessage("setCookieItem",{name:t,value:n})}))},AuthBridgeApp.prototype.clearAuth=function(){var t=this;this.whenFrameInited.then((function(){return t.sendMessage("clearAuth")}))},AuthBridgeApp.prototype.frameInit=function(){var t;null===(t=this._frameInitResolve)||void 0===t||t.call(this),this.requestAuthUpdate()},AuthBridgeApp.prototype.updateAuth=function(t){if((null==t?void 0:t.enabled)&&(null==t?void 0:t.cookies)){var n=t.cookies;Object.keys(n).forEach((function(t){var l,d=null!==(l=n[t])&&void 0!==l?l:"";d?setCookie(t,d,"/",7):removeCookie(t)}))}this._authUpdateResolve&&(this._authUpdateResolve(),this._authUpdateResolve=void 0)},AuthBridgeApp.prototype.authClearedFromOtherFrame=function(){ki.warn("Override auth-bridge/app's authClearedFromOtherFrame to trigger app-specific sign out behavior")},AuthBridgeApp.prototype._getIframeSrc=function(){var t=determineCdnBasePrefix();return t&&(t="?env="+t.substring(0,t.length-1)),"https://mediaauth.apple.com/auth-bridge/"+t},AuthBridgeApp}(Ai),Ei=new Set(["apps","books","music","podcasts","tv"]),wi=/\.apple\.com$/;function getCommerceHostname(t,n){!n&&"undefined"!=typeof location&&location.hostname&&(n=location);var l=t+".itunes.apple.com";if(!n)return l;var d=function(t){if(t&&wi.test(t)){var n=t.split("."),l=n[n.length-3],d=l;if(l&&l.includes("-")){var p=l.split("-");l=p[p.length-1]}if(Ei.has(l))return d}}(n.hostname);return d&&(l=t+"."+d+".apple.com"),l}function buildQueryParams(t){return void 0===t&&(t={app:Pi.APP,p:Pi.P}),void 0===t.app&&(t.app=Pi.APP),void 0===t.p&&(t.p=Pi.P),Object.keys(t).map((function(n){return encodeURIComponent(n)+"="+encodeURIComponent(t[n])})).join("&")}!function(t){t.APP="music",t.P="subscribe"}(Pi||(Pi={}));var Oi,Ri=((Ti={})[2]="com.apple.onboarding.tvapp",Ti[0]="com.apple.onboarding.applemusic",Ti),Ci=((Si={})[2]="pltvcid",Si[0]="pldfltcid",Si),Mi={"com.apple.onboarding.tvapp":5,"com.apple.onboarding.applemusic":3};!function(t){t[t.ParseError=-32700]="ParseError",t[t.InvalidRequest=-32600]="InvalidRequest",t[t.MethodNotFound=-32601]="MethodNotFound",t[t.InvalidParams=-32602]="InvalidParams",t[t.InternalError=-32603]="InternalError"}(Oi||(Oi={}));var Ni,Di=function(){function Dispatch(t){var n=this;void 0===t&&(t={}),this._registry={},this._sequence=0,this.handle=function(t){t.data&&"2.0"===t.data.jsonrpc&&("*"!==n.origin&&n.origin!==t.origin||(t.data.method&&n.destination?n.handleRequest(t.data).then((function(t){n.send(n.destination,t)})):(t.data.hasOwnProperty("result")||t.data.error)&&n.handleResponse(t.data)))},this.destination=t.destination,this.methods=t.methods||{},this.origin=t.origin||"*",t.source&&(this.source=t.source)}return Object.defineProperty(Dispatch.prototype,"source",{get:function(){return this._source},set:function(t){if(!t&&this._source)return this._source.removeEventListener("message",this.handle),void(this._source=void 0);t.addEventListener("message",this.handle),this._source=t},enumerable:!0,configurable:!0}),Dispatch.prototype.apply=function(t,n){var l=this;if(!this.destination)throw new Error("No destination");var d=this._sequence++,p=new Promise((function(t,n){l._registry[d]={resolve:t,reject:n}}));return this.send(this.destination,{jsonrpc:"2.0",id:d,method:t,params:n}),p},Dispatch.prototype.call=function(t){for(var n=[],l=1;l<arguments.length;l++)n[l-1]=arguments[l];return this.apply(t,n)},Dispatch.prototype.handleRequest=function(t){return __awaiter$1(this,void 0,void 0,(function(){var n,l,d,p;return __generator$1(this,(function(h){switch(h.label){case 0:if(n={jsonrpc:"2.0",id:t.id},!(l=this.methods[t.method]))return[2,Object.assign(n,{error:{code:Oi.MethodNotFound,message:"Method not found"}})];h.label=1;case 1:return h.trys.push([1,3,,4]),[4,l.apply(null,ensureArray(t.params))];case 2:return d=h.sent(),[2,Object.assign(n,{result:d})];case 3:return p=h.sent(),[2,Object.assign(n,{error:{code:p.code||Oi.InternalError,message:p.message}})];case 4:return[2]}}))}))},Dispatch.prototype.handleResponse=function(t){var n=this._registry[t.id];delete this._registry[t.id],n&&(t.error?n.reject(Object.assign(Error(),t.error)):n.resolve(t.result))},Dispatch.prototype.send=function(t,n){t.postMessage(n,t.window===t?this.origin:void 0)},Dispatch}();function validateToken(t){var n;if("string"!=typeof t)return!1;var l=t.match(/[a-zA-Z0-9=\/+]{32,}==$/);return null!==(n=l&&l.length>0)&&void 0!==n&&n}!function(t){t[t.UNAVAILABLE=-1]="UNAVAILABLE",t[t.NOT_DETERMINED=0]="NOT_DETERMINED",t[t.DENIED=1]="DENIED",t[t.RESTRICTED=2]="RESTRICTED",t[t.AUTHORIZED=3]="AUTHORIZED"}(Ni||(Ni={}));var Li,xi="https://"+getCommerceHostname("buy")+"/commerce/account/authenticateMusicKitRequest",Ui="https://authorize.music.apple.com",Bi=/^https?:\/\/(.+\.)*(apple\.com|apps\.mzstatic\.com)(\/[\w\d]+)*$/;!function(t){t[t.AUTHORIZE=0]="AUTHORIZE",t[t.SUBSCRIBE=1]="SUBSCRIBE"}(Li||(Li={}));var ji,Fi=function(){function ServiceSetupView(t,n){void 0===n&&(n={}),this.developerToken=t,this.authenticateMethod="GET",this.target="apple-music-service-view",this.deeplinkParameters=n&&n.deeplinkParameters||{},this.iconURL=n&&n.iconURL,this.authenticateMethod=n&&n.authenticateMethod||"GET",this.isServiceView&&window.opener!==window&&(this.dispatch=new Di({destination:window.opener,origin:"*",source:window}))}return Object.defineProperty(ServiceSetupView.prototype,"isServiceView",{get:function(){return/(authorize\.(.+\.)*apple\.com)/i.test(window.location.hostname)||window&&window.name===this.target||!1},enumerable:!0,configurable:!0}),ServiceSetupView.prototype.focus=function(){this._window&&window.focus&&this._window.focus()},ServiceSetupView.prototype.load=function(t){return void 0===t&&(t={action:Li.AUTHORIZE}),__awaiter$3(this,void 0,void 0,(function(){return __generator$3(this,(function(n){return t.action===Li.SUBSCRIBE?[2,this._subscribeAction(t.parameters)]:[2,this._authorizeAction(t.parameters)]}))}))},ServiceSetupView.prototype.present=function(t,n){void 0===t&&(t="");var l=this._calculateClientDimensions(),d=l.height,p=l.left,h=l.top,f=l.width,y={height:650,menubar:"no",resizable:"no",scrollbars:"no",status:"no",toolbar:"no",width:650},v=__assign$4(__assign$4(__assign$4({},y),{left:f/2-y.width/2+p,top:d/2-y.height/2+h}),n),_=Object.keys(v).map((function(t){return t+"="+v[t]})).join(",");return/trident|msie/i.test(navigator.userAgent)?(this._window=window.open(window.location.href,this.target,_)||void 0,this._window.location.href=t):this._window=window.open(t,this.target,_)||void 0,/\bedge\b/i.test(navigator.userAgent)&&(this._window.opener=self),this.focus(),this._window},ServiceSetupView.prototype._authorizeAction=function(t){var n;return void 0===t&&(t={}),__awaiter$3(this,void 0,void 0,(function(){var l,d,p,h=this;return __generator$3(this,(function(f){return p=(null===(n=window.location)||void 0===n?void 0:n.href)||"","GET"===this.authenticateMethod?d=Ui+"/woa?"+buildQueryParams(__assign$4(__assign$4({},this.deeplinkParameters),{a:btoa(this._thirdPartyInfo()),referrer:p})):(l=this._buildFormElement(xi),document.body.appendChild(l)),[2,new Promise((function(n,p){var f=h.present(d);h.dispatch=new Di({methods:{authorize:function(t,l,d){validateToken(t)?n({restricted:l&&"1"===l,userToken:t,cid:d}):p(Ni.NOT_DETERMINED)},close:function(){},decline:function(){p(Ni.DENIED)},switchUserId:function(){p(Ni.NOT_DETERMINED)},thirdPartyInfo:function(){return h._thirdPartyInfo(h.developerToken,__assign$4(__assign$4({},h.deeplinkParameters),t))},unavailable:function(){p(Ni.UNAVAILABLE)}},origin:Ui,source:window,destination:f}),l&&l.submit()}))]}))}))},ServiceSetupView.prototype._buildFormElement=function(t,n,l){void 0===n&&(n=this.target),void 0===l&&(l=this.developerToken);var d=document.createElement("form");d.setAttribute("method","post"),d.setAttribute("action",t),d.setAttribute("target",n),d.style.display="none";var p=document.createElement("input");p.setAttribute("name","jwtToken"),p.setAttribute("value",l),d.appendChild(p);var h=document.createElement("input");h.setAttribute("name","isWebPlayer"),h.setAttribute("value","true"),d.appendChild(h);var f=document.createElement("input");return f.setAttribute("name","LogoURL"),f.setAttribute("value",""),d.appendChild(f),d},ServiceSetupView.prototype._calculateClientDimensions=function(t){return void 0===t&&(t=window),{height:t.innerHeight?t.innerHeight:document.documentElement.clientHeight?document.documentElement.clientHeight:screen.height,left:t.screenLeft?t.screenLeft:screen.availLeft||screen.left,top:t.screenTop?t.screenTop:screen.availTop||screen.top,width:t.innerWidth?t.innerWidth:document.documentElement.clientWidth?document.documentElement.clientWidth:screen.width}},ServiceSetupView.prototype._subscribeAction=function(t){return void 0===t&&(t={}),__awaiter$3(this,void 0,void 0,(function(){var n=this;return __generator$3(this,(function(l){return Object.assign(t,this.deeplinkParameters),[2,new Promise((function(l,d){var p="https://authorize.music.apple.com/upsell?"+buildQueryParams(t);n.present(p),window.addEventListener("message",(function(t){var n=t.data,p=t.origin,h=(t.source,"string"==typeof n?JSON.parse(n):n),f=(h.closeWindow,h.launchClient);p&&!Bi.test(p)||(f?0===f.supported?d("Unable to subscribe on this platform."):l(f):d("Subscribe action error."))}))}))]}))}))},ServiceSetupView.prototype._thirdPartyInfo=function(t,n){var l;void 0===t&&(t=this.developerToken);var d=this.iconURL,p=window.location.host||document.referrer,h=function(){for(var t=[],n=0;n<arguments.length;n++)t=t.concat(__read$3(arguments[n]));return t}([].slice.call(document.querySelectorAll('link[rel="apple-music-app-icon"]')),[].slice.call(document.querySelectorAll('link[rel="apple-touch-icon-precomposed"]')),[].slice.call(document.querySelectorAll('link[rel="apple-touch-icon"]')));if(h&&h[0]&&h[0].href){var f=h.find((function(t){return!!t.sizes&&"120x120"===t.sizes.value}));d=null!==(l=null==f?void 0:f.href)&&void 0!==l?l:h[0].href}return JSON.stringify({thirdPartyIconURL:d,thirdPartyName:p,thirdPartyParameters:n,thirdPartyToken:t})},ServiceSetupView}();function fetchStorefronts(t,n){return void 0===n&&(n="https://api.music.apple.com/v1"),__awaiter$3(this,void 0,void 0,(function(){var l,d;return __generator$3(this,(function(p){switch(p.label){case 0:return l=new Headers({Authorization:"Bearer "+t}),[4,fetch(n+"/storefronts",{headers:l})];case 1:return[4,p.sent().json()];case 2:return(d=p.sent()).errors?[2,Promise.reject(d.errors)]:[2,d.data]}}))}))}!function(t){t.ID="us",t.LANGUAGE_TAG="en-gb"}(ji||(ji={}));var Ki,Vi,$i=function(){function Storefront(t,n,l){this.id=t,this.attributes=n,this.type="storefronts",this.href=l||"/v1/"+this.type+"/"+t}return Storefront.inferFromLanguages=function(t,n){return void 0===n&&(n=getLanguages()),__awaiter$3(this,void 0,void 0,(function(){var l,d,p,h,f,y;return __generator$3(this,(function(v){switch(v.label){case 0:return[4,fetchStorefronts(t)];case 1:return l=v.sent(),d=l.map((function(t){return t.id})),p=n[0]||"en-US",h=__read$3(p.toLowerCase().split(/-|_/),2),h[0],f=h[1],y=d.includes(f)?f:"us",[2,l.find((function(t){return t.id===y}))]}}))}))},Storefront}();!function(t){t.DEFAULT_CID="pldfltcid",t.TV_CID="pltvcid",t.RESTRICTIONS_ENABLED="itre",t.STOREFRONT_COUNTRY_CODE="itua",t.USER_TOKEN="media-user-token"}(Ki||(Ki={})),function(t){t.authorizationStatusDidChange="authorizationStatusDidChange",t.authorizationStatusWillChange="authorizationStatusWillChange",t.eligibleForSubscribeView="eligibleForSubscribeView",t.needsGDPRDidChange="needsGDPRDidChange",t.storefrontCountryCodeDidChange="storefrontCountryCodeDidChange",t.storefrontIdentifierDidChange="storefrontIdentifierDidChange",t.userTokenDidChange="userTokenDidChange"}(Vi||(Vi={}));Ki.DEFAULT_CID;var Yi,Hi,Wi="https://"+getCommerceHostname("buy"),zi="https://"+getCommerceHostname("play")+"/WebObjects/MZPlay.woa/wa",Gi=function(t){function StoreKit(n,l){var d=t.call(this,[Vi.authorizationStatusDidChange,Vi.authorizationStatusWillChange,Vi.eligibleForSubscribeView,Vi.needsGDPRDidChange,Vi.storefrontCountryCodeDidChange,Vi.userTokenDidChange,Vi.storefrontIdentifierDidChange])||this;d.developerToken=n,d.apiBase="https://api.music.apple.com/v1",d.iTunesBuyBase=Wi,d.persist="localstorage",d.playBase=zi,d.prefix="music",d.realm=0,d.storage=window.localStorage,d._authorizationStatus=Ni.NOT_DETERMINED,d._dispatchedSubscribeView=!1,d._me=null,d._cids={},d._gdprVersion=-1,d._needsGDPR=void 0,d._dynamicUserToken=getCookie(Ki.USER_TOKEN),l&&(l.apiBase&&(d.apiBase=l.apiBase),l.deeplink&&(d.deeplinkParameters=l.deeplink),l.persist&&(d.persist=l.persist),l.prefix&&(d.prefix=l.prefix),void 0!==l.realm&&(d.realm=l.realm),d.bundleId=Ri[d.realm]),d.cidNamespace=Ci[d.realm],d._developerToken=new bt(n),d._serviceSetupView=new Fi(n,{authenticateMethod:l&&l.authenticateMethod,iconURL:l&&l.iconURL,deeplinkParameters:d.deeplinkParameters}),d.storagePrefix=(d.prefix+"."+d._developerToken.teamId).toLocaleLowerCase();var p=d._getStorageItem(Ki.USER_TOKEN);return d.userToken=p||void 0,d.developerToken&&d.userTokenIsValid&&(d._restrictedEnabled=d.restrictedEnabled,d.shouldDisplayPrivacyLink(d.bundleId).catch((function(){}))),d._storefrontCountryCode=d.storefrontCountryCode,d.whenAuthCompleted=Promise.resolve(),isNodeEnvironment()||(d._processLocationHash(window.location.hash),"cookie"!==d.persist||(null==l?void 0:l.disableAuthBridge)||(d.authBridgeApp=new Ii,d.authBridgeApp.authClearedFromOtherFrame=d.revokeUserToken.bind(d),d.whenAuthCompleted=d.authBridgeApp.whenAuthCompleted.then((function(){d.userToken=d._getStorageItem(Ki.USER_TOKEN)||void 0})))),d}var n;return __extends$4(StoreKit,t),Object.defineProperty(StoreKit.prototype,"authorizationStatus",{get:function(){return this._authorizationStatus},set:function(t){this._authorizationStatus!==t&&(this._getIsActiveSubscription.updateCache(void 0),this.dispatchEvent(Vi.authorizationStatusWillChange,{authorizationStatus:this._authorizationStatus,newAuthorizationStatus:t}),this._authorizationStatus=t,this.dispatchEvent(Vi.authorizationStatusDidChange,{authorizationStatus:t}))},enumerable:!0,configurable:!0}),Object.defineProperty(StoreKit.prototype,"cid",{get:function(){if(!this._cids[this.cidNamespace]){var t=this._getStorageItem(this.cidNamespace);this._cids[this.cidNamespace]=t||void 0}return this._cids[this.cidNamespace]},set:function(t){t?this._setStorageItem(this.cidNamespace,t):this._removeStorageItem(this.cidNamespace),this._cids[this.cidNamespace]=t},enumerable:!0,configurable:!0}),StoreKit.prototype.eligibleForSubscribeView=function(){return __awaiter$3(this,void 0,void 0,(function(){var t;return __generator$3(this,(function(n){switch(n.label){case 0:return[4,this.hasMusicSubscription()];case 1:return t=n.sent(),[2,(!this.hasAuthorized||this.hasAuthorized&&!t)&&!this._dispatchedSubscribeView]}}))}))},Object.defineProperty(StoreKit.prototype,"hasAuthorized",{get:function(){return this.authorizationStatus>Ni.DENIED},enumerable:!0,configurable:!0}),Object.defineProperty(StoreKit.prototype,"logoutURL",{get:function(){return this.iTunesBuyBase+"/account/web/logout"},enumerable:!0,configurable:!0}),Object.defineProperty(StoreKit.prototype,"parentalControls",{get:function(){return this._parentalControls},set:function(t){this._parentalControls=t,t&&(0===this.realm?this.restrictedEnabled=t.musicParentalControlsEnabled:2===this.realm&&t.videoContentRestrictions&&(this.authorizationStatus=Ni.RESTRICTED))},enumerable:!0,configurable:!0}),Object.defineProperty(StoreKit.prototype,"_pldfltcid",{get:function(){return this._cids[Ki.DEFAULT_CID]},set:function(t){this._cids[Ki.DEFAULT_CID]=t},enumerable:!0,configurable:!0}),Object.defineProperty(StoreKit.prototype,"privacyAcknowledgements",{get:function(){return this._privacyAcknowledgements},set:function(t){if(this._privacyAcknowledgements=t,!t)return this._gdprVersion=-1,void(this._needsGDPR=void 0);this.bundleId&&(this._gdprVersion=t[this.bundleId]||0,this._needsGDPR=this._gdprVersion<(Mi[this.bundleId]||0),this._needsGDPR&&this.dispatchEvent(Vi.needsGDPRDidChange,{GDPRVersion:this._gdprVersion,needsGDPR:this._needsGDPR}))},enumerable:!0,configurable:!0}),Object.defineProperty(StoreKit.prototype,"restrictedEnabled",{get:function(){if(this.userToken&&"boolean"!=typeof this._restrictedEnabled){var t=this._getStorageItem(Ki.RESTRICTIONS_ENABLED);if(t)this._restrictedEnabled="0"!==t;else if(this._storefrontCountryCode){this._restrictedEnabled=-1!==["br","ch","gt","hu","id","in","it","kr","la","lt","my","ru","sg","tr"].indexOf(this._storefrontCountryCode)||void 0}}return this._restrictedEnabled},set:function(t){this.userToken&&void 0!==t&&this._setStorageItem(Ki.RESTRICTIONS_ENABLED,t?"1":"0"),this._restrictedEnabled=t,t&&(this.authorizationStatus=Ni.RESTRICTED)},enumerable:!0,configurable:!0}),Object.defineProperty(StoreKit.prototype,"storefrontCountryCode",{get:function(){if(!this._storefrontCountryCode){var t=this._getStorageItem(Ki.STOREFRONT_COUNTRY_CODE);this._storefrontCountryCode=(null==t?void 0:t.toLowerCase())||ji.ID}return this._storefrontCountryCode},set:function(t){t&&this.userToken?this._setStorageItem(Ki.STOREFRONT_COUNTRY_CODE,t):this._removeStorageItem(Ki.STOREFRONT_COUNTRY_CODE),this._storefrontCountryCode=t,this.dispatchEvent(Vi.storefrontCountryCodeDidChange,{storefrontCountryCode:t})},enumerable:!0,configurable:!0}),Object.defineProperty(StoreKit.prototype,"storefrontIdentifier",{get:function(){return this._storefrontIdentifier},set:function(t){this._storefrontIdentifier=t,this.dispatchEvent(Vi.storefrontIdentifierDidChange,{storefrontIdentifier:t})},enumerable:!0,configurable:!0}),StoreKit.prototype.runTokenValidations=function(t,n){void 0===n&&(n=!0),t&&validateToken(t)?(n&&this._setStorageItem(Ki.USER_TOKEN,t),this.authorizationStatus=this.restrictedEnabled?Ni.RESTRICTED:Ni.AUTHORIZED):(this._removeStorageItem(Ki.USER_TOKEN),this.authorizationStatus=Ni.NOT_DETERMINED)},StoreKit.prototype.wrapDynamicUserTokenForChanges=function(t,n){var l=this;if(void 0===n&&(n=invoke(t)),"function"!=typeof t)return t;var d=n;return function(){var n=invoke(t);return d!==n&&(d=n,l.runTokenValidations(n,!1),l.dispatchEvent(Vi.userTokenDidChange,{userToken:n})),n||""}},Object.defineProperty(StoreKit.prototype,"dynamicUserToken",{get:function(){return this._dynamicUserToken},set:function(t){var n=invoke(t);this._dynamicUserToken=this.wrapDynamicUserTokenForChanges(t,n),this.runTokenValidations(n,"function"!=typeof t),this.dispatchEvent(Vi.userTokenDidChange,{userToken:n})},enumerable:!0,configurable:!0}),Object.defineProperty(StoreKit.prototype,"userToken",{get:function(){return invoke(this.dynamicUserToken)},set:function(t){this.dynamicUserToken=t},enumerable:!0,configurable:!0}),Object.defineProperty(StoreKit.prototype,"userTokenIsValid",{get:function(){return validateToken(this.userToken)},enumerable:!0,configurable:!0}),StoreKit.prototype.deeplinkURL=function(t){return void 0===t&&(t={}),"https://finance-app.itunes.apple.com/deeplink?"+buildQueryParams(t=__assign$4(__assign$4({},this.deeplinkParameters||{}),t))},StoreKit.prototype.itunesDeeplinkURL=function(t){return void 0===t&&(t={p:"browse"}),"https://itunes.apple.com/deeplink?"+buildQueryParams(t=__assign$4(__assign$4({},this.deeplinkParameters||{}),t))},StoreKit.prototype.pldfltcid=function(){return __awaiter$3(this,void 0,void 0,(function(){return __generator$3(this,(function(t){switch(t.label){case 0:if(this._cids[Ki.DEFAULT_CID])return[3,4];t.label=1;case 1:return t.trys.push([1,3,,4]),[4,this.infoRefresh()];case 2:return t.sent(),[3,4];case 3:return t.sent(),[2,void 0];case 4:return[2,this._cids[Ki.DEFAULT_CID]]}}))}))},StoreKit.prototype.renewUserToken=function(){return __awaiter$3(this,void 0,void 0,(function(){var t,n,l;return __generator$3(this,(function(d){switch(d.label){case 0:return this.userToken?(t=new Headers({Authorization:"Bearer "+this.developerToken,Accept:"application/json","Content-Type":"application/json","X-Apple-Music-User-Token":""+this.userToken}),[4,fetch(this.playBase+"/renewMusicToken",{method:"POST",headers:t})]):[2,this.requestUserToken()];case 1:return 401!==(n=d.sent()).status?[3,3]:[4,this.revokeUserToken()];case 2:return d.sent(),[2,Promise.reject(new Error("Renew token"))];case 3:return[4,n.json()];case 4:return(l=d.sent())["music-token"]&&(this.userToken=l["music-token"]),[2,this.userToken]}}))}))},StoreKit.prototype.requestStorefrontCountryCode=function(){return __awaiter$3(this,void 0,void 0,(function(){var t,n,l,d,p;return __generator$3(this,(function(h){switch(h.label){case 0:return this.authorizationStatus<=Ni.DENIED?[2,Promise.reject("Not authorized: "+this.authorizationStatus)]:(t=new Headers({Authorization:"Bearer "+this.developerToken,"Music-User-Token":this.userToken||""}),[4,fetch(this.apiBase+"/me/storefront",{headers:t})]);case 1:return(n=h.sent())&&!n.ok?(this._reset(),[2,Promise.reject("Storefront Country Code error.")]):[4,n.json()];case 2:return(l=h.sent()).errors?[2,Promise.reject(l.errors)]:(d=__read$3(l.data,1),(p=d[0])&&p.id?(this.storefrontCountryCode=p.id,[2,this.storefrontCountryCode]):[2,Promise.reject("Storefront Country Code error.")])}}))}))},StoreKit.prototype.requestStorefrontIdentifier=function(){return __awaiter$3(this,void 0,void 0,(function(){var t;return __generator$3(this,(function(n){switch(n.label){case 0:return this.storefrontIdentifier?[3,2]:[4,$i.inferFromLanguages(this.developerToken)];case 1:t=n.sent(),this.storefrontIdentifier=t.id,n.label=2;case 2:return[2,this.storefrontIdentifier]}}))}))},StoreKit.prototype.requestUserToken=function(){return __awaiter$3(this,void 0,void 0,(function(){var t,n;return __generator$3(this,(function(l){switch(l.label){case 0:if(this._serviceSetupView.isServiceView)return[2,this.userToken||""];l.label=1;case 1:return l.trys.push([1,3,,4]),[4,this._serviceSetupView.load({action:Li.AUTHORIZE})];case 2:return t=l.sent(),this.cid=t.cid,this.userToken=t.userToken,this.restrictedEnabled=t.restricted,[3,4];case 3:return n=l.sent(),this._reset(),this.authorizationStatus=n,[2,Promise.reject(n)];case 4:return[2,this.userToken]}}))}))},StoreKit.prototype.revokeUserToken=function(){var t;return __awaiter$3(this,void 0,void 0,(function(){return __generator$3(this,(function(n){switch(n.label){case 0:return n.trys.push([0,2,,3]),[4,this._webPlayerLogout()];case 1:return n.sent(),[3,3];case 2:return n.sent(),[3,3];case 3:return null===(t=this.authBridgeApp)||void 0===t||t.clearAuth(),this.dispatchEvent(Vi.authorizationStatusWillChange,{authorizationStatus:this.authorizationStatus,newAuthorizationStatus:Ni.NOT_DETERMINED}),this._reset(),this.dispatchEvent(Vi.authorizationStatusDidChange,{authorizationStatus:this.authorizationStatus}),this.dispatchEvent(Vi.userTokenDidChange,{userToken:this.userToken}),[2]}}))}))},StoreKit.prototype.setCids=function(t){var n=this;this._cids=__assign$4(__assign$4({},this._cids),t),Object.keys(this._cids).forEach((function(t){n._setStorageItem(t,n._cids[t])}))},StoreKit.prototype.shouldDisplayPrivacyLink=function(t){return __awaiter$3(this,void 0,void 0,(function(){return __generator$3(this,(function(n){switch(n.label){case 0:return t||(t=this.bundleId),void 0!==this._needsGDPR?[2,this._needsGDPR]:[4,this.me()];case 1:return n.sent(),[2,this._needsGDPR]}}))}))},StoreKit.prototype.hasMusicSubscription=function(){return __awaiter$3(this,void 0,void 0,(function(){return __generator$3(this,(function(t){return this.hasAuthorized?[2,this._getIsActiveSubscription()]:[2,!1]}))}))},StoreKit.prototype._getIsActiveSubscription=function(){var t;return __awaiter$3(this,void 0,void 0,(function(){var n;return __generator$3(this,(function(l){switch(l.label){case 0:return[4,this.me()];case 1:return n=l.sent(),[2,!!(null===(t=n.subscription)||void 0===t?void 0:t.active)]}}))}))},StoreKit.prototype.resetSubscribeViewEligibility=function(){this._dispatchedSubscribeView=!1},StoreKit.prototype.presentSubscribeViewForEligibleUsers=function(t,n){return void 0===t&&(t={}),void 0===n&&(n=!0),__awaiter$3(this,void 0,void 0,(function(){var l,d;return __generator$3(this,(function(p){switch(p.label){case 0:return[4,this.eligibleForSubscribeView()];case 1:if(l=p.sent(),this._serviceSetupView.isServiceView||!l)return[2];if(!n)return this.dispatchEvent(Vi.eligibleForSubscribeView,t),this._dispatchedSubscribeView=!0,[2];p.label=2;case 2:return p.trys.push([2,4,,5]),[4,this._serviceSetupView.load({action:Li.SUBSCRIBE})];case 3:return d=p.sent(),this._dispatchedSubscribeView=!0,[2,d];case 4:return p.sent(),[2,this.revokeUserToken()];case 5:return[2]}}))}))},StoreKit.prototype.infoRefresh=function(){return __awaiter$3(this,void 0,void 0,(function(){var t,n;return __generator$3(this,(function(l){switch(l.label){case 0:if(this.authorizationStatus<=Ni.DENIED)return[2,Promise.reject("Not authorized: "+this.authorizationStatus)];t=new Headers({Authorization:"Bearer "+this.developerToken,"Music-User-Token":this.userToken||""}),l.label=1;case 1:return l.trys.push([1,4,,5]),[4,fetch(this.iTunesBuyBase+"/account/web/infoRefresh",{credentials:"include",headers:t})];case 2:return[4,l.sent().json()];case 3:return n=l.sent(),this.setCids(n),[3,5];case 4:return l.sent(),[3,5];case 5:return[2]}}))}))},StoreKit.prototype.me=function(){var t=this;return this.authorizationStatus<=Ni.DENIED?Promise.reject("Not authorized: "+this.authorizationStatus):(this._me||(this._me=new Promise((function(n,l){return __awaiter$3(t,void 0,void 0,(function(){var t,d,p,h,f,y,v;return __generator$3(this,(function(_){switch(_.label){case 0:return t=new Headers({Authorization:"Bearer "+this.developerToken,"Music-User-Token":this.userToken||""}),[4,fetch(this.apiBase+"/me/account?meta=subscription",{headers:t})];case 1:return(d=_.sent())&&!d.ok?(2!==this.realm&&this._reset(),[2,l("Account error.")]):[4,d.json()];case 2:if((p=_.sent()).errors)return[2,l(p.errors)];if(h=p.data,!(f=p.meta)||!f.subscription)return[2,l("Account error.")];this.storefrontCountryCode=f.subscription.storefront,y={subscription:f.subscription},h&&h.length&&(y.attributes=h[0].attributes),_.label=3;case 3:return _.trys.push([3,13,,14]),[4,fetch(this.iTunesBuyBase+"/account/web/info",{credentials:"include",headers:t})];case 4:return[4,_.sent().json()];case 5:if(p=_.sent(),this.parentalControls=p.parentalControlsData,this.privacyAcknowledgements=p.privacyAcknowledgement,!isEmpty(this.privacyAcknowledgements||{}))return[3,12];_.label=6;case 6:return _.trys.push([6,8,,9]),[4,this.infoRefresh()];case 7:return _.sent(),[3,9];case 8:return _.sent(),n(y),[3,9];case 9:return[4,fetch(this.iTunesBuyBase+"/account/web/info",{credentials:"include",headers:t})];case 10:return[4,_.sent().json()];case 11:p=_.sent(),this.parentalControls=p.parentalControlsData,this.privacyAcknowledgements=p.privacyAcknowledgement,_.label=12;case 12:return y.info=p,[3,14];case 13:return v=_.sent(),console.warn("Failed to fetch privacyAcknowledgements",v),[3,14];case 14:return[2,n(y)]}}))}))})).then((function(n){var l;return t._getIsActiveSubscription.updateCache((null===(l=n.subscription)||void 0===l?void 0:l.active)||!1),t._me=null,n})).catch((function(n){return t._me=null,Promise.reject(n)}))),this._me)},StoreKit.prototype.musicSubscriptionOffers=function(t,n){return void 0===n&&(n=getLanguages()),__awaiter$3(this,void 0,void 0,(function(){var l,d,p,h,f,y,v;return __generator$3(this,(function(_){switch(_.label){case 0:return this.hasAuthorized?[4,this.me()]:[3,2];case 1:return d=_.sent(),l=d.info.storeFrontISO3A,[3,5];case 2:return t?[3,4]:[4,$i.inferFromLanguages(this.developerToken,n)];case 3:p=_.sent(),t=null==p?void 0:p.id,_.label=4;case 4:l=t&&Qe[t.toUpperCase()]||"USA",_.label=5;case 5:return h=function(t){void 0===t&&(t="en-US");var n=gi[t.toLowerCase()];if(n)return n;if(t.includes("-")){var l=t.split("-")[0],d=gi[l.toLowerCase()];if(d)return d}return gi["en-us"]}(n[0]),f=_e[l],h&&f?(y=new Headers({"X-Apple-Store-Front":f+"-"+h+",8"}),this.userToken&&(y.set("Authorization","Bearer "+this.developerToken),y.set("Music-User-Token",this.userToken)),[4,fetch(this.iTunesBuyBase+"/commerce/web/subscription/offers/music",{headers:y})]):[2,[]];case 6:return(v=_.sent()).ok?[4,v.json()]:[2,Promise.reject(v.status)];case 7:return[2,_.sent().offers]}}))}))},StoreKit.prototype._getStorageItem=function(t){if(t)return"cookie"===this.persist?getCookie(t):"localstorage"===this.persist?this.storage.getItem(this.storagePrefix+"."+t):void 0},StoreKit.prototype._processLocationHash=function(t){var n=/^\#([a-zA-Z0-9+\/]{200,}={0,2})$/;if(n.test(t)){var l=t.replace(n,"$1");try{var d=JSON.parse(atob(l)),p=d.itre,h=d.musicUserToken,f=d.cid;this.restrictedEnabled=p&&"1"===p,this.userToken=h,this.cid=f}catch(Si){}history.replaceState(null,document.title," ")}},StoreKit.prototype._removeStorageItem=function(t){if("cookie"===this.persist)this._removeCookieFromDomains(t);else if("localstorage"===this.persist)return this.storage.removeItem(this.storagePrefix+"."+t)},StoreKit.prototype._removeCookieFromDomains=function(t,n){void 0===n&&(n=window),removeCookie(t);var l=n.location.hostname.split(".");if(l.length&&(l.shift(),l.length>2))for(var d=l.length;d>2;d--){var p=l.join(".");l.shift(),removeCookie(t,n,p)}},StoreKit.prototype._reset=function(t){var n=this;void 0===t&&(t=Ni.NOT_DETERMINED),this._authorizationStatus=t,this._cids={},this._dispatchedSubscribeView=!1,this._restrictedEnabled=void 0,this._storefrontCountryCode=void 0,this._getIsActiveSubscription.updateCache(void 0),Object.keys(Ci).forEach((function(t){n._removeStorageItem(Ci[t])})),this._removeStorageItem(Ki.RESTRICTIONS_ENABLED),this._removeStorageItem(Ki.USER_TOKEN),this._removeStorageItem(Ki.STOREFRONT_COUNTRY_CODE),this._dynamicUserToken=void 0,this._me=null,this.privacyAcknowledgements=void 0},StoreKit.prototype._setStorageItem=function(t,n){var l;return"cookie"===this.persist?(null===(l=this.authBridgeApp)||void 0===l||l.setCookieItem(t,n),setCookie(t,n,"/",180)):"localstorage"===this.persist?this.storage.setItem(this.storagePrefix+"."+t,n):void 0},StoreKit.prototype._webPlayerLogout=function(){return __awaiter$3(this,void 0,void 0,(function(){var t,n;return __generator$3(this,(function(l){switch(l.label){case 0:return(t=new Headers({Authorization:"Bearer "+this.developerToken,Accept:"application/json","Content-Type":"application/json","X-Apple-Music-User-Token":""+this.userToken})).delete("X-Apple-Music-User-Token"),t.append("Music-User-Token",this.userToken||""),[4,fetch(this.logoutURL,{method:"POST",headers:t,credentials:"include"})];case 1:return(n=l.sent())&&!n.ok?[2,Promise.reject(n.status)]:[2,n.json()]}}))}))},function(t,n,l,d){var p,h=arguments.length,f=h<3?n:null===d?d=Object.getOwnPropertyDescriptor(n,l):d;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)f=Reflect.decorate(t,n,l,d);else for(var y=t.length-1;y>=0;y--)(p=t[y])&&(f=(h<3?p(f):h>3?p(n,l,f):p(n,l))||f);h>3&&f&&Object.defineProperty(n,l,f)}([(n=900,void 0===n&&(n=300),function(t,l,d){if(void 0===d||"function"!=typeof d.value)throw new TypeError("Only methods can be decorated with @CachedResult, but "+l+" is not a method.");return{configurable:!0,get:function(){var t,p=d.value,h=1e3*n,f=-1;function cachedResultMethod(){for(var n=[],l=0;l<arguments.length;l++)n[l]=arguments[l];return __awaiter$1(this,void 0,void 0,(function(){var l;return __generator$1(this,(function(d){switch(d.label){case 0:return l=Date.now(),void 0===t||-1===f||f>0&&l>f+h?(f=l,[4,p.apply(this,n)]):[3,2];case 1:t=d.sent(),d.label=2;case 2:return[2,t]}}))}))}return cachedResultMethod.updateCache=function(n){f=Date.now(),t=n},cachedResultMethod.getCachedValue=function(){return t},Object.defineProperty(this,l,{value:cachedResultMethod,configurable:!0,writable:!0}),cachedResultMethod}}}),__metadata$2("design:type",Function),__metadata$2("design:paramtypes",[]),__metadata$2("design:returntype",Promise)],StoreKit.prototype,"_getIsActiveSubscription",null),StoreKit}(ke),qi="audioTrackAdded",Qi="audioTrackChanged",Ji="audioTrackRemoved",Xi="bufferedProgressDidChange",Zi="drmUnsupported",en="forcedTextTrackChanged",tn="mediaCanPlay",rn="mediaElementCreated",nn="mediaPlaybackError",on="nowPlayingItemDidChange",an="nowPlayingItemWillChange",sn="metadataDidChange",un="playbackBitrateDidChange",cn="playbackDurationDidChange",ln="playbackProgressDidChange",dn="playbackRateDidChange",pn="playbackStateDidChange",hn="playbackStateWillChange",fn="playbackTargetAvailableDidChange",yn="playbackTargetIsWirelessDidChange",vn="playbackTimeDidChange",_n="playbackVolumeDidChange",gn="playerTypeDidChange",mn="presentationModeDidChange",bn="primaryPlayerDidChange",Pn="textTrackAdded",Tn="textTrackChanged",Sn="textTrackRemoved",kn="timedMetadataDidChange",An={configured:"musickitconfigured",loaded:"musickitloaded",audioTrackAdded:qi,audioTrackChanged:Qi,audioTrackRemoved:Ji,authorizationStatusDidChange:Vi.authorizationStatusDidChange,authorizationStatusWillChange:Vi.authorizationStatusWillChange,bufferedProgressDidChange:Xi,capabilitiesChanged:"capabilitiesChanged",autoplayEnabledDidChange:"autoplayEnabledDidChange",drmUnsupported:Zi,eligibleForSubscribeView:Vi.eligibleForSubscribeView,forcedTextTrackChanged:en,mediaCanPlay:tn,mediaElementCreated:rn,mediaItemStateDidChange:ti,mediaItemStateWillChange:ri,mediaPlaybackError:nn,mediaSkipAvailable:"mediaSkipAvailable",mediaRollEntered:"mediaRollEntered",mediaUpNext:"mediaUpNext",metadataDidChange:sn,needsGDPRDidChange:"needsGDPRDidChange",nowPlayingItemDidChange:on,nowPlayingItemWillChange:an,playbackBitrateDidChange:un,playbackDurationDidChange:cn,playbackProgressDidChange:ln,playbackRateDidChange:dn,playbackStateDidChange:pn,playbackStateWillChange:hn,playbackTargetAvailableDidChange:fn,playbackTargetIsWirelessDidChange:yn,playbackTimeDidChange:vn,playbackVolumeDidChange:_n,playerTypeDidChange:gn,presentationModeDidChange:mn,primaryPlayerDidChange:bn,queueIsReady:"queueIsReady",queueItemsDidChange:"queueItemsDidChange",queueItemForStartPosition:"queueItemForStartPosition",queuePositionDidChange:"queuePositionDidChange",shuffleModeDidChange:"shuffleModeDidChange",repeatModeDidChange:"repeatModeDidChange",storefrontCountryCodeDidChange:Vi.storefrontCountryCodeDidChange,storefrontIdentifierDidChange:Vi.storefrontIdentifierDidChange,textTrackAdded:Pn,textTrackChanged:Tn,textTrackRemoved:Sn,timedMetadataDidChange:kn,userTokenDidChange:Vi.userTokenDidChange},In="gaplessTransition",En="bufferTimedMetadataDidChange";function formattedSeconds(t){return{hours:Math.floor(t/3600),minutes:Math.floor(t%3600/60)}}(Yi=t.PlaybackStates||(t.PlaybackStates={}))[Yi.none=0]="none",Yi[Yi.loading=1]="loading",Yi[Yi.playing=2]="playing",Yi[Yi.paused=3]="paused",Yi[Yi.stopped=4]="stopped",Yi[Yi.ended=5]="ended",Yi[Yi.seeking=6]="seeking",Yi[Yi.waiting=8]="waiting",Yi[Yi.stalled=9]="stalled",Yi[Yi.completed=10]="completed",(Hi=t.PresentationMode||(t.PresentationMode={}))[Hi.pictureinpicture=0]="pictureinpicture",Hi[Hi.inline=1]="inline";var wn,On,Rn,Cn,Mn,Nn="mk-player-tsid",Dn=["exitFullscreen","webkitExitFullscreen","mozCancelFullScreen","msExitFullscreen"],Ln=["fullscreenElement","webkitFullscreenElement","mozFullScreenElement","msFullscreenElement"],xn=["requestFullscreen","webkitRequestFullscreen","mozRequestFullScreen","msRequestFullscreen"],noop$1=function(){return Promise.resolve()},Un=function(t){if(void 0===t&&(t=HTMLDocument),void 0===t)return function(){return noop$1};var n=Dn.find((function(n){return"function"==typeof t.prototype[n]}));return"string"!=typeof n?noop$1:function(t){return void 0===t&&(t=self.document),null==t?void 0:t[n]()}}(),Bn=function(t){if(void 0===t&&(t=HTMLDocument),void 0===t)return function(){return!1};var n=Ln.find((function(n){return n in t.prototype}));return"string"!=typeof n?function(){return!1}:function(t){return void 0===t&&(t=self.document),!!t[n]}}(),jn=function(t){if(void 0===t&&(t=HTMLElement),void 0===t)return noop$1;var n=xn.find((function(n){return"function"==typeof t.prototype[n]}));return"string"!=typeof n?noop$1:function(t){return null==t?void 0:t[n]()}}(),Fn=function(){function Fullscreen(t){this.player=t}return Fullscreen.prototype.exit=function(){return __awaiter(this,void 0,void 0,(function(){var t=this;return __generator(this,(function(n){return this.isInFullscreen()?[2,this.stopDispatchingEvents((function(){return t.exitFullscreen()}))]:[2]}))}))},Fullscreen.prototype.request=function(t){return __awaiter(this,void 0,void 0,(function(){var n=this;return __generator(this,(function(l){return void 0===t?[2]:[2,this.stopDispatchingEvents((function(){return n.requestFullscreenForElement(t)}))]}))}))},Fullscreen.prototype.stopDispatchingEvents=function(t){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(n){return[2,this.player.windowHandlers.stopListeningToVisibilityChanges(t)]}))}))},Fullscreen.prototype.exitFullscreen=function(){return Un()},Fullscreen.prototype.isInFullscreen=function(){return Bn()},Fullscreen.prototype.requestFullscreenForElement=function(t){return jn(t)},Fullscreen}(),Kn=function(){function UnsupportedSeeker(){this.ended=!1}return UnsupportedSeeker.prototype.start=function(){Le.warn("seeker.start is not supported in this playback method")},UnsupportedSeeker.prototype.end=function(){Le.warn("seeker.end is not supported in this playback method")},UnsupportedSeeker.prototype.seekToTime=function(t){return Le.warn("seekToTime is not supported in this playback method"),Promise.resolve()},UnsupportedSeeker}(),Vn=function(){function PlayerSeeker(t){this._ended=!1,this._lastSeekedTime=-1,this._startTime=-1,Le.debug("seeker: new"),this._player=t}return Object.defineProperty(PlayerSeeker.prototype,"ended",{get:function(){return this._ended},enumerable:!0,configurable:!0}),Object.defineProperty(PlayerSeeker.prototype,"isEngagedInPlayback",{get:function(){return this._player.isEngagedInPlayback},enumerable:!0,configurable:!0}),Object.defineProperty(PlayerSeeker.prototype,"stillPlayingSameItem",{get:function(){return this._currentItem===this._player.nowPlayingItem},enumerable:!0,configurable:!0}),PlayerSeeker.prototype.end=function(){Le.debug("seeker: end"),-1!==this._startTime?this._ended?Le.warn("seeker: Cannot end the same seeker twice."):(this.dispatchStartEvent(),this.dispatchEndEvent()):Le.warn("seeker: Cannot end a seeker before starting it.")},PlayerSeeker.prototype.seekToTime=function(t){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(n){return Le.debug("seeker: seekToTime",t),this.ended?(Le.warn("seeker: Cannot seek once the seeker has ended"),[2]):(this.stillPlayingSameItem||(this._currentItem=this._player.nowPlayingItem,this._startTime=0),this._lastSeekedTime=t,[2,(l=this._player.seekToTime(t),__awaiter$1(void 0,void 0,void 0,(function(){var t;return __generator$1(this,(function(n){switch(n.label){case 0:return n.trys.push([0,2,,3]),[4,l];case 1:return[2,n.sent()];case 2:if("cancelled"!==(t=n.sent()).message)throw t;return[3,3];case 3:return[2]}}))})))]);var l}))}))},PlayerSeeker.prototype.start=function(){Le.debug("seeker: start"),-1===this._startTime?(this._currentItem=this._player.nowPlayingItem,this._startTime=this._player.currentPlaybackTime,this._lastSeekedTime=this._startTime):Le.warn("seeker: Cannot start same seeker twice")},PlayerSeeker.prototype.dispatch=function(t,n){this.isEngagedInPlayback?(Le.debug("seeker: dispatch",t),this._player.dispatch(t,n)):Le.debug("seeker: do not dispatch because isEngagedInPlayback",this.isEngagedInPlayback)},PlayerSeeker.prototype.dispatchStartEvent=function(){this.stillPlayingSameItem||(this._startTime=0,this._lastSeekedTime=0),this.dispatch(Ve.playbackScrub,{position:this._startTime})},PlayerSeeker.prototype.dispatchEndEvent=function(){this._ended=!0,this.dispatch(Ve.playbackScrub,{position:this._lastSeekedTime,endReasonType:He.SCRUB_END})},PlayerSeeker}(),$n=(On="visibilitychange",Rn="visibilityState",void 0!==document.mozHidden?(On="mozvisibilitychange",Rn="mozVisibilityState"):void 0!==document.msHidden?(On="msvisibilitychange",Rn="msVisibilityState"):document.webkitHidden&&(On="webkitvisibilitychange",Rn="webkitVisibilityState"),(wn={visibilityChangeEvent:On,visibilityState:Rn,unloadEventName:"onpagehide"in window?"pagehide":"unload"}).visibilityChangeEvent),Yn=wn.visibilityState,Hn=wn.unloadEventName,Wn=function(){function WindowHandlers(t,n){void 0===n&&(n=fe),this.browser=n,this.dispatchVisibilityChanges=!0,this.player=t}return WindowHandlers.prototype.activate=function(t,n){void 0===t&&(t=self),void 0===n&&(n=self.document),n.addEventListener($n,this.visibilityChanged),t.addEventListener("storage",this.storage,!1),t.addEventListener(Hn,this.windowUnloaded)},WindowHandlers.prototype.deactivate=function(){document.removeEventListener($n,this.visibilityChanged),window.removeEventListener("storage",this.storage),window.addEventListener(Hn,this.windowUnloaded)},WindowHandlers.prototype.stopListeningToVisibilityChanges=function(t){return __awaiter(this,void 0,void 0,(function(){var n;return __generator(this,(function(l){switch(l.label){case 0:return this.dispatchVisibilityChanges=!1,[4,t()];case 1:return n=l.sent(),this.dispatchVisibilityChanges=!0,[2,n]}}))}))},WindowHandlers.prototype.dispatch=function(t,n){void 0===n&&(n={}),this.player.dispatch(t,n)},WindowHandlers.prototype.storage=function(t){var n=t.key,l=t.newValue;n===Nn&&this.player.tsidChanged(l)},WindowHandlers.prototype.visibilityChanged=function(t){var n=t.target[Yn];Le.log("dc visibilityState",n,t,Bn()),this.browser.isiOS&&this.dispatchVisibilityChanges&&("hidden"===n?this.dispatch(Ve.playerExit,{position:this.player.currentPlaybackTime}):"visible"===n&&this.dispatch(Ve.playerActivate))},WindowHandlers.prototype.windowUnloaded=function(){this.player.isPlaying&&this.dispatch(Ve.playerExit,{position:this.player.currentPlaybackTime})},__decorate([Bind(),__metadata("design:type",Function),__metadata("design:paramtypes",[Object]),__metadata("design:returntype",void 0)],WindowHandlers.prototype,"storage",null),__decorate([Bind(),__metadata("design:type",Function),__metadata("design:paramtypes",[Event]),__metadata("design:returntype",void 0)],WindowHandlers.prototype,"visibilityChanged",null),__decorate([Bind(),__metadata("design:type",Function),__metadata("design:paramtypes",[]),__metadata("design:returntype",void 0)],WindowHandlers.prototype,"windowUnloaded",null),WindowHandlers}(),zn=Xi,Gn=tn,qn=rn,Qn=nn,Jn=on,Xn=an,Zn=sn,eo=bn,to=cn,ro=ln,io=pn,no=dn,oo=hn,ao=fn,so=yn,uo=vn,co=_n,lo=["canplay","durationchange","ended","error","loadedmetadata","loadstart","pause","play","playing","progress","ratechange","seeked","seeking","timeupdate","volumechange","waiting"],po=t.PlaybackStates.ended,ho=t.PlaybackStates.loading,fo=t.PlaybackStates.paused,yo=t.PlaybackStates.playing,vo=t.PlaybackStates.seeking,_o=t.PlaybackStates.stopped,go=t.PlaybackStates.waiting,mo=function(){function BasePlayer(n){this.privateEnabled=!1,this.siriInitiated=!1,this.previewOnly=!1,this._currentBufferedProgress=0,this._paused=!1,this._playbackState=t.PlaybackStates.none,this._stopped=!1,this._playbackDidStart=!1,this._currentPlaybackProgress=0,this._hasSmartPlayed=!1,this._isPrimaryPlayer=!0,this._playbackTargetAvailable=!1,this._playbackTargetIsWireless=!1,this._serial=Date.now().toString(),this._isDestroyed=!1,this._dispatcher=n.services.dispatcher,this._timing=n.services.timing,this._context=n.context||{},this.privateEnabled=n.privateEnabled||!1,this.siriInitiated=n.siriInitiated||!1,this._bitrateCalculator=n.services.bitrateCalculator,this.windowHandlers=new Wn(this),this.fullscreen=new Fn(this),localStorage.setItem(Nn,this._serial)}return Object.defineProperty(BasePlayer.prototype,"bitrate",{get:function(){return this._bitrateCalculator.bitrate},enumerable:!0,configurable:!0}),Object.defineProperty(BasePlayer.prototype,"currentBufferedProgress",{get:function(){return this._currentBufferedProgress},set:function(t){this._currentBufferedProgress!==t&&(this._currentBufferedProgress=t,this._dispatcher.publish(zn,{progress:t}))},enumerable:!0,configurable:!0}),Object.defineProperty(BasePlayer.prototype,"_currentDuration",{get:function(){return this._targetElement.duration},enumerable:!0,configurable:!0}),Object.defineProperty(BasePlayer.prototype,"_currentTime",{get:function(){var t,n=this._targetElement.currentTime,l=this._buffer;return n-(null!==(t=null==l?void 0:l.currentTimestampOffset)&&void 0!==t?t:0)},enumerable:!0,configurable:!0}),Object.defineProperty(BasePlayer.prototype,"currentPlaybackDuration",{get:function(){var n=this.nowPlayingItem,l=(null==n?void 0:n.playbackType)===t.PlaybackType.encryptedFull||(null==n?void 0:n.playbackType)===t.PlaybackType.unencryptedFull,d=null==n?void 0:n.playbackDuration;return l&&d?this._timing.time(d/1e3):this._timing.time(this._currentDuration)},enumerable:!0,configurable:!0}),Object.defineProperty(BasePlayer.prototype,"currentPlaybackTime",{get:function(){var t=void 0===this.nowPlayingItem||void 0===this.nowPlayingItem.playEvent||this._hasSmartPlayed?this._currentTime:this.nowPlayingItem.playEvent.playCursorInSeconds;return this._timing.time(t)},enumerable:!0,configurable:!0}),Object.defineProperty(BasePlayer.prototype,"currentPlaybackTimeRemaining",{get:function(){return this.currentPlaybackDuration-this.currentPlaybackTime},enumerable:!0,configurable:!0}),Object.defineProperty(BasePlayer.prototype,"currentPlaybackProgress",{get:function(){return this._currentPlaybackProgress||0},set:function(t){this._currentPlaybackProgress!==t&&(this._currentPlaybackProgress=t,this._dispatcher.publish(ro,{progress:t}))},enumerable:!0,configurable:!0}),Object.defineProperty(BasePlayer.prototype,"formattedCurrentPlaybackDuration",{get:function(){return formattedSeconds(this.currentPlaybackDuration)},enumerable:!0,configurable:!0}),Object.defineProperty(BasePlayer.prototype,"hasMediaElement",{get:function(){return this._targetElement instanceof HTMLElement&&null!==this._targetElement.parentNode},enumerable:!0,configurable:!0}),Object.defineProperty(BasePlayer.prototype,"isEngagedInPlayback",{get:function(){return!this._stopped&&!this.isPaused()},enumerable:!0,configurable:!0}),Object.defineProperty(BasePlayer.prototype,"isPlaying",{get:function(){return this.playbackState===yo},enumerable:!0,configurable:!0}),Object.defineProperty(BasePlayer.prototype,"isPrimaryPlayer",{get:function(){return this._isPrimaryPlayer},set:function(t){t!==this._isPrimaryPlayer&&(this._isPrimaryPlayer=t,this._isPrimaryPlayer?localStorage.setItem(Nn,this._serial):(this._dispatcher.publish(eo,{target:this}),this.pause({userInitiated:!1})))},enumerable:!0,configurable:!0}),Object.defineProperty(BasePlayer.prototype,"isReady",{get:function(){return 0!==this._targetElement.readyState},enumerable:!0,configurable:!0}),Object.defineProperty(BasePlayer.prototype,"nowPlayingItem",{get:function(){return this._nowPlayingItem},set:function(t){this._hasSmartPlayed=!1;var n=this._dispatcher;if(void 0===t)return this._nowPlayingItem=t,void n.publish(Jn,{item:t});var l=this._nowPlayingItem,p=this._buffer;(null==l?void 0:l.isEqual(t))||(n.publish(Xn,{item:t}),this.isPlaying&&(null==p?void 0:p.currentItem)!==t&&this._pauseMedia(),l&&(Le.debug("setting state to ended on ",l.title),l.state=d.ended,l.endMonitoringStateDidChange(),l.endMonitoringStateWillChange()),this._nowPlayingItem=t,Le.debug("setting state to playing on ",t.title),t.state=d.playing,t&&t.info&&this._setTargetElementTitle(t.info),n.publish(Jn,{item:t}),n.publish(to,{currentTarget:this._targetElement,duration:this.currentPlaybackDuration,target:this._targetElement,type:"durationchange"}))},enumerable:!0,configurable:!0}),Object.defineProperty(BasePlayer.prototype,"playbackRate",{get:function(){return this._targetElement.playbackRate},set:function(t){this._targetElement.playbackRate=t},enumerable:!0,configurable:!0}),Object.defineProperty(BasePlayer.prototype,"playbackState",{get:function(){return this._playbackState},set:function(t){if(t!==this._playbackState){var n={oldState:this._playbackState,state:t,nowPlayingItem:this.nowPlayingItem?{id:this.nowPlayingItem.id,type:this.nowPlayingItem.type}:void 0};Le.debug("BasePlayer.playbackState is changing",n),this._dispatcher.publish(oo,n),this._playbackState=t,this._dispatcher.publish(io,n)}},enumerable:!0,configurable:!0}),Object.defineProperty(BasePlayer.prototype,"playbackTargetAvailable",{get:function(){return void 0!==window.WebKitPlaybackTargetAvailabilityEvent&&this._playbackTargetAvailable},set:function(t){t!==this._playbackTargetAvailable&&(this._playbackTargetAvailable=t,this._dispatcher.publish(ao,{available:t}))},enumerable:!0,configurable:!0}),Object.defineProperty(BasePlayer.prototype,"playbackTargetIsWireless",{get:function(){return void 0!==window.WebKitPlaybackTargetAvailabilityEvent&&this._playbackTargetIsWireless},set:function(t){t!==this._playbackTargetIsWireless&&(this._playbackTargetIsWireless=t,this._dispatcher.publish(so,{playing:t}))},enumerable:!0,configurable:!0}),Object.defineProperty(BasePlayer.prototype,"volume",{get:function(){return this._targetElement.volume},set:function(t){this._targetElement.volume=t},enumerable:!0,configurable:!0}),Object.defineProperty(BasePlayer.prototype,"isDestroyed",{get:function(){return this._isDestroyed},enumerable:!0,configurable:!0}),BasePlayer.prototype.initialize=function(){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(t){switch(t.label){case 0:return Le.debug("BasePlayer.initialize"),this.isPlayerSupported()?[4,this.initializeMediaElement()]:(Le.warn("{this.constructor.name} not supported"),[2]);case 1:return t.sent(),[4,this.initializeExtension()];case 2:return t.sent(),this.initializeEventHandlers(),this._dispatcher.publish(qn,this._targetElement),[2]}}))}))},BasePlayer.prototype.initializeEventHandlers=function(){var t=this;if(this.windowHandlers.activate(),this.hasMediaElement){var n=this._targetElement;window.WebKitPlaybackTargetAvailabilityEvent&&(n.addEventListener("webkitplaybacktargetavailabilitychanged",(function(n){t.playbackTargetAvailable="available"===n.availability})),n.addEventListener("webkitcurrentplaybacktargetiswirelesschanged",(function(n){t.playbackTargetIsWireless=n.target===t._targetElement&&!t.playbackTargetIsWireless}))),lo.forEach((function(l){return n.addEventListener(l,t)})),this.dispatch(Ve.playerActivate,{isPlaying:this.isPlaying})}},BasePlayer.prototype.removeEventHandlers=function(){var t=this;lo.forEach((function(n){return t._targetElement.removeEventListener(n,t)})),this.windowHandlers.deactivate()},BasePlayer.prototype.isPaused=function(){return this._paused},BasePlayer.prototype.exitFullscreen=function(){return this.fullscreen.exit()},BasePlayer.prototype.requestFullscreen=function(t){return this.fullscreen.request(t)},BasePlayer.prototype.seekToTime=function(t){return __awaiter(this,void 0,void 0,(function(){var n;return __generator(this,(function(l){switch(l.label){case 0:return(n=this._buffer)?(Le.debug("Doing buffer seek to",t),[4,n.seek(t)]):[3,2];case 1:return l.sent()?[3,3]:[2];case 2:Le.debug("Doing media element seek to",t),this._targetElement.currentTime=t,l.label=3;case 3:return[2]}}))}))},BasePlayer.prototype.newSeeker=function(){var t;return null===(t=this._seeker)||void 0===t||t.end(),this._seeker=new Vn(this),this._seeker},BasePlayer.prototype.stop=function(t){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(n){switch(n.label){case 0:return Le.debug("BasePlayer.stop",t),[4,this._waitForPendingPlay()];case 1:return n.sent(),this.isPlaying&&this.dispatch(Ve.playbackStop,__assign({position:this.currentPlaybackTime,startPosition:this._initialBufferPosition||0},t)),[4,this.stopMediaAndCleanup()];case 2:return n.sent(),[2]}}))}))},BasePlayer.prototype.stopMediaAndCleanup=function(t){return void 0===t&&(t=_o),__awaiter(this,void 0,void 0,(function(){return __generator(this,(function(n){switch(n.label){case 0:return[4,this._stopMediaElement()];case 1:return n.sent(),this._stopped=!0,this.playbackState=t,this.nowPlayingItem=void 0,this._initialBufferPosition=void 0,[2]}}))}))},BasePlayer.prototype._calculatePlaybackProgress=function(){this.currentPlaybackProgress=Math.round(100*(this.currentPlaybackTime/this.currentPlaybackDuration||0))/100},BasePlayer.prototype.destroy=function(){var t,n;if(Le.debug("BasePlayer.destroy"),this._isDestroyed=!0,this.hasMediaElement){var l=this._targetElement;null===(t=this.extension)||void 0===t||t.destroy(l),this.removeEventHandlers(),this.cleanupElement(),null===(n=l.parentNode)||void 0===n||n.removeChild(l)}},BasePlayer.prototype.handleEvent=function(n){return __awaiter(this,void 0,void 0,(function(){var l,d;return __generator(this,(function(p){switch(p.label){case 0:switch("timeupdate"!==n.type&&Le.debug("BasePlayer.handleEvent: ",n.type,n,this.isPaused(),this._stopped),n.type){case"canplay":return[3,1];case"durationchange":return[3,2];case"ended":return[3,3];case"error":return[3,5];case"loadedmetadata":return[3,6];case"loadstart":return[3,7];case"pause":return[3,8];case"play":case"playing":return[3,9];case"progress":return[3,10];case"ratechange":return[3,11];case"seeked":return[3,12];case"seeking":return[3,13];case"timeupdate":return[3,14];case"volumechange":return[3,15];case"waiting":return[3,16]}return[3,17];case 1:return this._dispatcher.publish(Gn,n),this.handleSmartPlay(),this._playbackState!==t.PlaybackStates.waiting||this._targetElement.paused||(this.playbackState=t.PlaybackStates.playing),[3,17];case 2:return this._targetElement.duration!==1/0&&(n.duration=this.currentPlaybackDuration,this._dispatcher.publish(to,n),this._calculatePlaybackProgress()),[3,17];case 3:return Le.debug('media element "ended" event'),this.playbackState=po,this.dispatch(Ve.playbackStop,{endReasonType:He.NATURAL_END_OF_TRACK}),[4,this.stopMediaAndCleanup(po)];case 4:return p.sent(),[3,17];case 5:return Le.error("Playback Error",n),this._dispatcher.publish(Qn,new Fe(Fe.MEDIA_PLAYBACK,"Playback Error")),[3,17];case 6:return this._dispatcher.publish(Zn,n),[3,17];case 7:return this.playbackState=ho,[3,17];case 8:return this.playbackState=this._stopped?_o:fo,[3,17];case 9:return this._paused=!1,this._stopped=!1,this.isPrimaryPlayer=!0,this.playbackState=yo,[3,17];case 10:return l=this._targetElement.buffered,this.handleBufferStart(),1===l.length&&0===l.start(0)&&(this.currentBufferedProgress=Math.round(l.end(0)/this.currentPlaybackDuration*100)),[3,17];case 11:return this._dispatcher.publish(no,n),[3,17];case 12:return this._stopped?this.playbackState=_o:this._paused?this.playbackState=fo:this.playbackState=yo,[3,17];case 13:return this.playbackState===fo?this._paused=!0:this.playbackState===_o&&(this._stopped=!0),this.playbackState=vo,[3,17];case 14:return this._dispatcher.publish(uo,{currentPlaybackDuration:this.currentPlaybackDuration,currentPlaybackTime:this.currentPlaybackTime,currentPlaybackTimeRemaining:this.currentPlaybackTimeRemaining}),this._calculatePlaybackProgress(),(d=this._buffer)&&(d.currentTime=this.currentPlaybackTime),[3,17];case 15:return this._dispatcher.publish(co,n),[3,17];case 16:return this.playbackState=go,[3,17];case 17:return[2]}}))}))},BasePlayer.prototype.handleBufferStart=function(){var t=this._targetElement;void 0!==this._initialBufferPosition||t.paused||0===t.buffered.length||(this._initialBufferPosition=t.buffered.start(0),Le.debug("BasePlayer.handleBufferStart: setting initial buffer position ",this._initialBufferPosition))},BasePlayer.prototype.handleSmartPlay=function(){if(this._targetElement&&this.nowPlayingItem){var t=this.nowPlayingItem;t&&t.playEvent&&!t.playEvent.isDone&&!this._hasSmartPlayed&&(Le.debug("BasePlayer.handleSmartPlay is resuming playCursor"),this._targetElement.currentTime=t.playEvent.playCursorInSeconds),this._hasSmartPlayed=!0}},BasePlayer.prototype.pause=function(t){return void 0===t&&(t={}),__awaiter(this,void 0,void 0,(function(){return __generator(this,(function(n){switch(n.label){case 0:return[4,this._waitForPendingPlay()];case 1:return n.sent(),this.isPlaying?[4,this._pauseMedia()]:[2];case 2:return n.sent(),this._paused=!0,this.dispatch(Ve.playbackPause,__assign({position:this.currentPlaybackTime},t)),[2]}}))}))},BasePlayer.prototype.play=function(t){return void 0===t&&(t=!0),__awaiter(this,void 0,void 0,(function(){var n,l,d=this;return __generator(this,(function(p){switch(p.label){case 0:if(Le.debug("BasePlayer.play()"),!this.nowPlayingItem)return[2];p.label=1;case 1:return p.trys.push([1,3,,4]),n=function(){Le.debug("BasePlayer.play dispatching playbackPlay"),d.dispatch(Ve.playbackPlay,{userInitiated:t,position:d.currentPlaybackTime})},[4,this._playMedia(n)];case 2:return p.sent(),[3,4];case 3:return"NotAllowedError"!==(l=p.sent()).name&&"NotSupportedError"!==l.name||Le.error("BasePlayer.play() rejected due to",l),[2];case 4:return[2]}}))}))},BasePlayer.prototype.preload=function(){return this._loadMedia()},BasePlayer.prototype.showPlaybackTargetPicker=function(){this.playbackTargetAvailable&&this._targetElement.webkitShowPlaybackTargetPicker()},BasePlayer.prototype.dispatch=function(t,n){void 0===n&&(n={}),void 0===n.item&&(n.item=this.nowPlayingItem),void 0===n.position&&(n.position=this.currentPlaybackTime),n.isPlaying=this.isPlaying,this._dispatcher.publish(t,n)},BasePlayer.prototype.tsidChanged=function(t){void 0!==t&&""!==t&&(this.isPrimaryPlayer=t===this._serial)},BasePlayer.prototype._waitForPendingPlay=function(){return __awaiter(this,void 0,void 0,(function(){var t;return __generator(this,(function(n){switch(n.label){case 0:if(!this._playPromise)return[2];n.label=1;case 1:return n.trys.push([1,3,4,5]),[4,this._playPromise];case 2:return n.sent(),[3,5];case 3:return t=n.sent(),Le.error("BasePlayer._waitForPendingPlay playPromise rejected",t),[3,5];case 4:return this._playPromise=void 0,[7];case 5:return[2]}}))}))},BasePlayer.prototype._loadMedia=function(){return Le.debug("BasePlayer._loadMedia",this._targetElement),this._targetElement.load(),Promise.resolve()},BasePlayer.prototype._pauseMedia=function(){return this._targetElement.pause(),Promise.resolve()},BasePlayer.prototype._playAssetURL=function(t,n){Le.debug("BasePlayer._playAssetURL",t),this._targetElement.src=t;var l=this._loadMedia();return n?(Le.debug("BasePlayer.loadOnly"),l):this._playMedia()},BasePlayer.prototype.playItemFromUnencryptedSource=function(t,n,l){return(null==l?void 0:l.startTime)&&(t+="#t="+l.startTime),this._playAssetURL(t,n)},BasePlayer.prototype._playMedia=function(t){return void 0===t&&(t=qr),__awaiter(this,void 0,void 0,(function(){var n,l=this;return __generator(this,(function(d){switch(d.label){case 0:return Le.debug("BasePlayer._playMedia",this._targetElement,this.extension),n=this._targetElement.play().then((function(t){return l._playbackDidStart=!0,t})),this._playPromise=n.then(t),[4,n];case 1:return d.sent(),[2]}}))}))},BasePlayer.prototype._setTargetElementTitle=function(t){this.hasMediaElement&&(this._targetElement.title=t)},BasePlayer.prototype._licenseError=function(){this._playPromise=void 0},BasePlayer.prototype._stopMediaElement=function(){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(t){return this.hasMediaElement&&(this._targetElement.pause(),this.cleanupElement()),[2]}))}))},BasePlayer.prototype.cleanupElement=function(){var t=this._targetElement;t&&(t.currentTime=0,t.removeAttribute("src"),t.removeAttribute("title"))},__decorate([AsyncDebounce(250),__metadata("design:type",Function),__metadata("design:paramtypes",[Number]),__metadata("design:returntype",Promise)],BasePlayer.prototype,"seekToTime",null),BasePlayer}(),bo={app:{},features:{},urls:{}};function restoreSelectedTrack(t,n){Le.debug("MEDIA_TRACKS restoreSelectedTrack");var l=t.getPersistedTrack(),d=t.fields,p=n.currentTrack;if(l)if(p&&trackEquals(p,l,d))Le.debug("MEDIA_TRACKS persisted track is equal to current track, not setting");else{var h=n.tracks;if(h&&h.length)for(var f=0;f<h.length;f++){var y=h[f];if(Le.debug("MEDIA_TRACKS testing track "+y.label+" against persisted track "+JSON.stringify(l)),trackEquals(y,l,d)){Le.debug("MEDIA_TRACKS found matching track "+y.label),n.currentTrack=y;break}}}else Le.debug("MEDIA_TRACKS no persisted track")}function trackEquals(t,n,l){for(var d=!0,p=0;p<l.length;p++){var h=l[p];if(t[h]!==n[h]){d=!1;break}}return d}!function(t){t.playbackLicenseError="playbackLicenseError",t.playbackSessionError="playbackSessionError",t.manifestParsed="manifestParsed",t.audioCodecIdentified="audioCodecIdentified",t.audioTracksSwitched="audioTracksSwitched",t.audioTracksUpdated="audioTracksUpdated",t.textTracksSwitched="textTracksSwitched",t.textTracksUpdated="textTracksUpdated",t.levelUpdated="levelUpdated"}(Cn||(Cn={})),function(t){t.MP4="audio/mp4",t.AVC1="video/mp4"}(Mn||(Mn={}));var Po=function(){function TrackPersistence(t,n){this.storageKey=t,this.fields=n}return TrackPersistence.prototype.getPersistedTrack=function(){if(!window||!window.localStorage)return!1;var t=window.localStorage.getItem(this.storageKey)||"";try{return JSON.parse(t)}catch(e){return Le.warn("MEDIA_TRACK could not parse persisted value "+t),!1}},TrackPersistence.prototype.setPersistedTrack=function(t){if(window&&window.localStorage)if(Le.debug("MEDIA_TRACK setPersistedTrack "+t.language+","+t.label+","+t.kind+" with keys "+this.fields),t){var n=JSON.stringify(this.extractFieldValuesFromTrack(t));Le.debug("MEDIA_TRACK Extracted values "+n),window.localStorage.setItem(this.storageKey,n)}else window.localStorage.setItem(this.storageKey,"")},TrackPersistence.prototype.extractFieldValuesFromTrack=function(t){var n={};return this.fields.forEach((function(l){var d=t[l];null==d&&Le.warn("MEDIA_TRACK No value for field "+l+" on track "+JSON.stringify(t)),n[l]=d})),n},TrackPersistence}(),To=qi,So=Qi,ko=Ji,Ao=Cn.audioTracksSwitched,Io=Cn.audioTracksUpdated,Eo=function(){function AudioTrackManager(t,n,l){if(this.mediaElement=t,this.dispatcher=n,this.extensionTracks=l,this._extensionTracks=[],this.trackPersistence=new Po("mk-audio-track",["label","language","kind"]),this.extensionTracks){Le.debug("MEDIA_TRACK Initializing audio track manager for hls track events"),this.onExtensionAudioTracksUpdated=this.onExtensionAudioTracksUpdated.bind(this),this.onExtensionAudioTrackSwitched=this.onExtensionAudioTrackSwitched.bind(this);var d=this.extensionTracks;d.addEventListener(Io,this.onExtensionAudioTracksUpdated),d.addEventListener(Ao,this.onExtensionAudioTrackSwitched)}else{if(!t.audioTracks)return;Le.debug("MEDIA_TRACK Initializing audio track manager for native track events"),this.onAudioTrackAdded=this.onAudioTrackAdded.bind(this),this.onAudioTrackChanged=this.onAudioTrackChanged.bind(this),this.onAudioTrackRemoved=this.onAudioTrackRemoved.bind(this),t.audioTracks.addEventListener("addtrack",this.onAudioTrackAdded),t.audioTracks.addEventListener("change",this.onAudioTrackChanged),t.audioTracks.addEventListener("removetrack",this.onAudioTrackRemoved)}}return Object.defineProperty(AudioTrackManager.prototype,"currentTrack",{get:function(){return this.tracks.find((function(t){return t.enabled}))},set:function(t){t&&(Le.debug("MEDIA_TRACK Setting audio track "+t.label),this.extensionTracks?(Le.debug("MEDIA_TRACK Setting track on extension "+t.id+"-"+t.label),this.extensionTracks.audioTrack=t):t.enabled=!0,this.trackPersistence.setPersistedTrack(t))},enumerable:!0,configurable:!0}),Object.defineProperty(AudioTrackManager.prototype,"tracks",{get:function(){return this.extensionTracks?this._extensionTracks||this.extensionTracks.audioTracks||[]:Array.from(this.mediaElement.audioTracks)},enumerable:!0,configurable:!0}),AudioTrackManager.prototype.destroy=function(){if(this.extensionTracks){var t=this.extensionTracks;t.removeEventListener(Io,this.onExtensionAudioTracksUpdated),t.removeEventListener(Ao,this.onExtensionAudioTrackSwitched)}else{if(!this.mediaElement.audioTracks)return;this.mediaElement.audioTracks.removeEventListener("addtrack",this.onAudioTrackAdded),this.mediaElement.audioTracks.removeEventListener("change",this.onAudioTrackChanged),this.mediaElement.audioTracks.removeEventListener("removetrack",this.onAudioTrackRemoved)}},AudioTrackManager.prototype.restoreSelectedTrack=function(){return restoreSelectedTrack(this.trackPersistence,this)},AudioTrackManager.prototype.onExtensionAudioTracksUpdated=function(t){Le.debug("MEDIA_TRACK Extension audio tracks updated "+JSON.stringify(t)),this._extensionTracks=t,this.restoreSelectedTrack(),this.dispatcher.publish(To,t)},AudioTrackManager.prototype.onExtensionAudioTrackSwitched=function(t){if(Le.debug("MEDIA_TRACK Extension audio track switched "+JSON.stringify(t)),this._extensionTracks){this._extensionTracks.forEach((function(n){n.enabled=t.selectedId===n.id}))}this.dispatcher.publish(So,t)},AudioTrackManager.prototype.onAudioTrackAdded=function(t){var n,l,d,p;n=t.track,l=this.trackPersistence,d=this,(p=l.getPersistedTrack())&&trackEquals(n,p,l.fields)&&(Le.debug("MEDIA_TRACK onTrackAdded with track that matches persisted track "+n.label),d.currentTrack=n),this.dispatcher.publish(To,t)},AudioTrackManager.prototype.onAudioTrackChanged=function(t){this.dispatcher.publish(So,t)},AudioTrackManager.prototype.onAudioTrackRemoved=function(t){this.dispatcher.publish(ko,t)},AudioTrackManager}(),wo=document.createElement("video"),Oo=[],Ro=[];function deferPlayback(){fillAvailableElements("audio",Ro),fillAvailableElements("video",Oo),Le.debug("dom-helpers: defer playback called.  There are "+Oo.length+" available video elements and "+Ro.length+" available audio elements.")}function fillAvailableElements(t,n){for(var l=100-n.length;l>0;){var d=document.createElement(t);d.load(),n.push(d),l--}}var Co=createCommonjsModule((function(t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.isValidPercentValue=function(t){return"number"==typeof t&&t>=0&&t<=100},n.isValidAlignSetting=function(t){return"string"==typeof t&&["start","center","end","left","right","middle"].includes(t)},n.isValidDirectionSetting=function(t){return"string"==typeof t&&["","rl","lr"].includes(t)},n.isValidLineAndPositionSetting=function(t){return"number"==typeof t||"auto"===t},n.isValidLineAlignSetting=function(t){return"string"==typeof t&&["start","center","end"].includes(t)},n.isValidPositionAlignSetting=function(t){return"string"==typeof t&&["line-left","center","line-right","auto","left","start","middle","end","right"].includes(t)},n.isValidScrollSetting=function(t){return["","up"].includes(t)}}));unwrapExports(Co);Co.isValidPercentValue,Co.isValidAlignSetting,Co.isValidDirectionSetting,Co.isValidLineAndPositionSetting,Co.isValidLineAlignSetting,Co.isValidPositionAlignSetting,Co.isValidScrollSetting;var Mo=createCommonjsModule((function(t,n){Object.defineProperty(n,"__esModule",{value:!0});const l={"&amp;":"&","&lt;":"<","&gt;":">","&lrm;":"â","&rlm;":"â","&nbsp;":"Â "},d={c:"span",i:"i",b:"b",u:"u",ruby:"ruby",rt:"rt",v:"span",lang:"span"},p={v:"title",lang:"lang"},h={rt:"ruby"},f={"text-combine-upright":"-webkit-text-combine:horizontal; text-orientation: mixed;"};class ParserUtility{static parseTimeStamp(t){function computeSeconds(t){const[n,l,d,p]=t.map(t=>t?parseInt(""+t):0);return 3600*n+60*l+d+p/1e3}const n=/^(\d+):(\d{2})(:\d{2})?\.(\d{3})/.exec(t);return n?n[3]?computeSeconds([n[1],n[2],n[3].substring(1),n[4]]):parseInt(n[1])>59?computeSeconds([n[1],n[2],null,n[4]]):computeSeconds([null,n[1],n[2],n[4]]):null}static parseContent(t,n,y){let v=n.text;function nextToken(){if(!v)return null;const t=/^([^<]*)(<[^>]+>?)?/.exec(v);return n=t[1]?t[1]:t[2],v=v.substr(n.length),n;var n}function unescape1(t){return l[t]}function unescape(t){return t.replace(/&(amp|lt|gt|lrm|rlm|nbsp);/g,unescape1)}function shouldAdd(t,n){return!h[n.dataset.localName]||h[n.dataset.localName]===t.dataset.localName}function createElement(n,l,h){const v=d[n];if(!v)return null;const _=t.document.createElement(v);_.dataset.localName=v;const g=p[n];if(g&&h&&(_[g]=h.trim()),l)if(y[l]){const t=function(t){let n="";for(const l in t)n+=f[l]?f[l]:l+":"+t[l]+";";return n}(y[l]);_.setAttribute("style",t)}else console.info(`WebVTT: parseContent: Style referenced, but no style defined for '${l}'!`);return _}const _=t.document.createElement("div"),g=[];let m,b,P=_;for(;null!==(m=nextToken());)if("<"!==m[0])P.appendChild(t.document.createTextNode(unescape(m)));else{if("/"===m[1]){g.length&&g[g.length-1]===m.substr(2).replace(">","")&&(g.pop(),P=P.parentNode);continue}const n=ParserUtility.parseTimeStamp(m.substr(1,m.length-2));let l;if(n){l=t.document.createProcessingInstruction("timestamp",n.toString()),P.appendChild(l);continue}if(b=/^<([^.\s/0-9>]+)(\.[^\s\\>]+)?([^>\\]+)?(\\?)>?$/.exec(m),!b)continue;if(l=createElement(b[1],b[2],b[3]),!l)continue;if(!shouldAdd(P,l))continue;b[2],g.push(b[1]),P.appendChild(l),P=l}return _}}n.default=ParserUtility}));unwrapExports(Mo);var No=createCommonjsModule((function(t,n){var l=p&&p.__decorate||function(t,n,l,d){var p,h=arguments.length,f=h<3?n:null===d?d=Object.getOwnPropertyDescriptor(n,l):d;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)f=Reflect.decorate(t,n,l,d);else for(var y=t.length-1;y>=0;y--)(p=t[y])&&(f=(h<3?p(f):h>3?p(n,l,f):p(n,l))||f);return h>3&&f&&Object.defineProperty(n,l,f),f};Object.defineProperty(n,"__esModule",{value:!0});let d=class{constructor(t,n,l){this._id="",this._pauseOnExit=!1,this._region=null,this._vertical="",this._snapToLines=!0,this._line="auto",this._lineAlign="start",this._position=50,this._positionAlign="center",this._size=50,this._align="center",this.hasBeenReset=!1,this._startTime=t,this._endTime=n,this._text=l}get id(){return this._id}set id(t){this._id=""+t}get pauseOnExit(){return this._pauseOnExit}set pauseOnExit(t){this._pauseOnExit=!!t}get startTime(){return this._startTime}set startTime(t){if("number"!=typeof t)throw new TypeError("Start time must be set to a number: "+t);this._startTime=t,this.hasBeenReset=!0}get endTime(){return this._endTime}set endTime(t){if("number"!=typeof t)throw new TypeError("End time must be set to a number: "+t);this._endTime=t,this.hasBeenReset=!0}get text(){return this._text}set text(t){this._text=""+t,this.hasBeenReset=!0}get region(){return this._region}set region(t){this._region=t,this.hasBeenReset=!0}get vertical(){return this._vertical}set vertical(t){if(!Co.isValidDirectionSetting(t))throw new SyntaxError("An invalid or illegal string was specified for vertical: "+t);this._vertical=t,this.hasBeenReset=!0}get snapToLines(){return this._snapToLines}set snapToLines(t){this._snapToLines=!!t,this.hasBeenReset=!0}get line(){return this._line}set line(t){if(!Co.isValidLineAndPositionSetting(t))throw new SyntaxError("An invalid number or illegal string was specified for line: "+t);this._line=t,this.hasBeenReset=!0}get lineAlign(){return this._lineAlign}set lineAlign(t){if(!Co.isValidLineAlignSetting(t))throw new SyntaxError("An invalid or illegal string was specified for lineAlign: "+t);this._lineAlign=t,this.hasBeenReset=!0}get position(){return this._position}set position(t){if(!Co.isValidLineAndPositionSetting(t))throw new Error("Position must be between 0 and 100 or auto: "+t);this._position=t,this.hasBeenReset=!0}get positionAlign(){return this._positionAlign}set positionAlign(t){if(!Co.isValidPositionAlignSetting(t))throw new SyntaxError("An invalid or illegal string was specified for positionAlign: "+t);this._positionAlign=t,this.hasBeenReset=!0}get size(){return this._size}set size(t){if(t<0||t>100)throw new Error("Size must be between 0 and 100: "+t);this._size=t,this.hasBeenReset=!0}get align(){return this._align}set align(t){if(!Co.isValidAlignSetting(t))throw new SyntaxError("An invalid or illegal string was specified for align: "+t);this._align=t,this.hasBeenReset=!0}getCueAsHTML(){return Mo.default.parseContent(window,this,{})}static create(t){if(!t.hasOwnProperty("startTime")||!t.hasOwnProperty("endTime")||!t.hasOwnProperty("text"))throw new Error("You must at least have start time, end time, and text.");const n=new this(t.startTime,t.endTime,t.text);return Object.keys(t).forEach(l=>{n.hasOwnProperty(l)&&(n[l]=t[l])}),n}static fromJSON(t){return this.create(JSON.parse(t))}toJSON(){const t={};return Object.keys(this).forEach(n=>{this.hasOwnProperty(n)&&"getCueAsHTML"!==n&&"hasBeenReset"!==n&&"displayState"!==n&&(t[n]=this[n])}),t}};d=l([function(t){let n=t;"undefined"!=typeof window&&null!=window.VTTCue&&(n=window.VTTCue,n.create=t.create,n.fromJSON=t.fromJSON,n.prototype.toJSON=t.prototype.toJSON);return n}],d),n.VTTCue=d}));unwrapExports(No);No.VTTCue;var Do=createCommonjsModule((function(t,n){var l=p&&p.__decorate||function(t,n,l,d){var p,h=arguments.length,f=h<3?n:null===d?d=Object.getOwnPropertyDescriptor(n,l):d;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)f=Reflect.decorate(t,n,l,d);else for(var y=t.length-1;y>=0;y--)(p=t[y])&&(f=(h<3?p(f):h>3?p(n,l,f):p(n,l))||f);return h>3&&f&&Object.defineProperty(n,l,f),f};Object.defineProperty(n,"__esModule",{value:!0});let d=class{constructor(){this._id="",this._lines=3,this._regionAnchorX=0,this._regionAnchorY=100,this._scroll="",this._viewportAnchorX=0,this._viewportAnchorY=100,this._width=100}get id(){return this._id}set id(t){if("string"!=typeof t)throw new Error("ID must be a string.");this._id=t}get lines(){return this._lines}set lines(t){if("number"!=typeof t)throw new TypeError("Lines must be set to a number.");this._lines=t}get regionAnchorX(){return this._regionAnchorX}set regionAnchorX(t){if(!Co.isValidPercentValue(t))throw new TypeError("RegionAnchorX must be between 0 and 100.");this._regionAnchorX=t}get regionAnchorY(){return this._regionAnchorY}set regionAnchorY(t){if(!Co.isValidPercentValue(t))throw new TypeError("RegionAnchorY must be between 0 and 100.");this._regionAnchorY=t}get scroll(){return this._scroll}set scroll(t){if("string"==typeof t){const n=t.toLowerCase();if(Co.isValidScrollSetting(n))return void(this._scroll=n)}throw new SyntaxError("An invalid or illegal string was specified.")}get viewportAnchorX(){return this._viewportAnchorX}set viewportAnchorX(t){if(!Co.isValidPercentValue(t))throw new TypeError("ViewportAnchorX must be between 0 and 100.");this._viewportAnchorX=t}get viewportAnchorY(){return this._viewportAnchorY}set viewportAnchorY(t){if(!Co.isValidPercentValue(t))throw new TypeError("ViewportAnchorY must be between 0 and 100.");this._viewportAnchorY=t}get width(){return this._width}set width(t){if(!Co.isValidPercentValue(t))throw new TypeError("Width must be between 0 and 100.");this._lines=t}toJSON(){const t={};return Object.keys(this).forEach(n=>{this.hasOwnProperty(n)&&(t[n]=this[n])}),t}static create(t){const n=new this;return Object.keys(t).forEach(l=>{n.hasOwnProperty(l)&&(n[l]=t[l])}),n}static fromJSON(t){return this.create(JSON.parse(t))}};d=l([function(t){let n=t;"undefined"!=typeof window&&null!=window.VTTRegion&&(n=window.VTTRegion,n.create=t.create,n.fromJSON=t.fromJSON,n.prototype.toJSON=t.prototype.toJSON);return n}],d),n.VTTRegion=d}));unwrapExports(Do);Do.VTTRegion;var Lo=createCommonjsModule((function(t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.VTTCue=No.VTTCue,n.VTTRegion=Do.VTTRegion;class ParsingError extends Error{constructor(t,n){super(),this.name="ParsingError",this.code="number"==typeof t?t:t.code,n?this.message=n:t instanceof ParsingError&&(this.message=t.message)}}n.ParsingError=ParsingError,ParsingError.Errors={BadSignature:new ParsingError(0,"Malformed WebVTT signature."),BadTimeStamp:new ParsingError(1,"Malformed time stamp.")};class Settings{constructor(){this.values={}}set(t,n){this.get(t)||""===n||(this.values[t]=n)}get(t,n,l){return"object"==typeof n&&"string"==typeof l?this.has(t)?this.values[t]:n[l]:this.has(t)?this.values[t]:n}has(t){return t in this.values}alt(t,n,l){for(let d=0;d<l.length;++d)if(n===l[d]){this.set(t,n);break}}integer(t,n){/^-?\d+$/.test(n)&&this.set(t,parseInt(n,10))}percent(t,n){if(n.match(/^([\d]{1,3})(\.[\d]*)?%$/))try{const l=parseFloat(n);if(l>=0&&l<=100)return this.set(t,l),!0}catch(ad){return!1}return!1}}class WebVTTParser{constructor(t,n,l){this.window=t,this.state="INITIAL",this.buffer="",this.decoder=n||new TextDecoder("utf8"),this.regionList=[],this.onStylesParsedCallback=l,this._styles={}}static StringDecoder(){return{decode:t=>{if(!t)return"";if("string"!=typeof t)throw new Error("Error - expected string data.");return decodeURIComponent(encodeURIComponent(t))}}}reportOrThrowError(t){if(!(t instanceof ParsingError&&"function"==typeof this.onparsingerror))throw t;this.onparsingerror(t)}parseOptions(t,n,l,d){const p=d?t.split(d):[t];for(const h of p){if("string"!=typeof h)continue;const t=h.split(l);2===t.length&&n(t[0],t[1])}}parseCue(t,n,l){const d=t,consumeTimeStamp=()=>{const n=Mo.default.parseTimeStamp(t);if(null===n)throw new ParsingError(ParsingError.Errors.BadTimeStamp,"Malformed timestamp: "+d);return t=t.replace(/^[^\sa-zA-Z-]+/,""),n},skipWhitespace=()=>{t=t.replace(/^\s+/,"")};if(skipWhitespace(),n.startTime=consumeTimeStamp(),skipWhitespace(),"--\x3e"!==t.substr(0,3))throw new ParsingError(ParsingError.Errors.BadTimeStamp,"Malformed time stamp (time stamps must be separated by '--\x3e'): "+d);t=t.substr(3),skipWhitespace(),n.endTime=consumeTimeStamp(),skipWhitespace(),((t,n)=>{const d=new Settings;this.parseOptions(t,(t,n)=>{let p,h;switch(t){case"region":for(let p=l.length-1;p>=0;p--)if(l[p].id===n){d.set(t,l[p].region);break}break;case"vertical":d.alt(t,n,["rl","lr"]);break;case"line":p=n.split(","),h=p[0],d.integer(t,h),d.percent(t,h)&&d.set("snapToLines",!1),d.alt(t,h,["auto"]),2===p.length&&d.alt("lineAlign",p[1],["start","center","end"]);break;case"position":if(p=n.split(","),d.percent(t,p[0]),2===p.length){let t=["line-left","line-right","center","auto","left","start","middle","end","right"];d.alt("positionAlign",p[1],t)}break;case"size":d.percent(t,n);break;case"align":let f=["start","center","end","left","right","middle"];d.alt(t,n,f)}},/:/,/\s/),n.region=d.get("region",null),n.vertical=d.get("vertical",""),n.line=d.get("line",void 0===n.line?"auto":n.line),n.lineAlign=d.get("lineAlign","start"),n.snapToLines=d.get("snapToLines",!0),n.size=d.get("size",100);let p=d.get("align","center");n.align="middle"===p?"center":p,n.position=d.get("position","auto");let h=d.get("positionAlign",{start:"start",left:"start",center:"center",right:"end",end:"end"},n.align);n.positionAlign={start:"start","line-left":"start",left:"start",center:"center",middle:"center","line-right":"end",right:"end",end:"end"}[h]})(t,n)}parseRegion(t){const n=new Settings;if(this.parseOptions(t,(t,l)=>{switch(t){case"id":n.set(t,l);break;case"width":n.percent(t,l);break;case"lines":n.integer(t,l);break;case"regionanchor":case"viewportanchor":{const d=l.split(",");if(2!==d.length)break;const p=new Settings;if(p.percent("x",d[0]),p.percent("y",d[1]),!p.has("x")||!p.has("y"))break;n.set(t+"X",p.get("x")),n.set(t+"Y",p.get("y"));break}case"scroll":n.alt(t,l,["up"])}},/=/,/\s/),n.has("id")){const t=new Do.VTTRegion;t.width=n.get("width",100),t.lines=n.get("lines",3),t.regionAnchorX=n.get("regionanchorX",0),t.regionAnchorY=n.get("regionanchorY",100),t.viewportAnchorX=n.get("viewportanchorX",0),t.viewportAnchorY=n.get("viewportanchorY",100),t.scroll=n.get("scroll",""),this.onregion&&this.onregion(t),this.regionList.push({id:n.get("id"),region:t})}}parseStyle(t){const parseStyles=t=>{const n={},l=t.split(";");for(let d=0;d<l.length;d++){const t=l[d].split(":",2),p=t[0].trim(),h=t[1].trim();""!==p&&""!==h&&(n[p]=h)}return n},n=t.replace(" ","").split("}");n.pop();for(const l of n){let t=null,n=null;const d=l.split("{");d[0]&&(t=d[0].trim()),d[1]&&(n=parseStyles(d[1])),t&&n&&(this._styles[t]=n)}this.onStylesParsedCallback&&this.onStylesParsedCallback(this._styles)}parseHeader(t){this.parseOptions(t,(function(t,n){switch(t){case"Region":this.parseRegion(n)}}),/:/)}parse(t){t&&(this.buffer+=this.decoder.decode(t,{stream:!0}));const collectNextLine=()=>{const t=this.buffer;let n=0;const calculateBreakPosition=(t,n)=>{const l={start:-1,length:-1};if("\r"===t[n])l.start=n,l.length=1;else if("\n"===t[n])l.start=n,l.length=1;else if("<"===t[n]&&n+1<t.length&&"b"===t[n+1]&&n+2<t.length&&"r"===t[n+2]){let d=n+2;for(;d<t.length&&">"!==t[d++];);l.start=n,l.length=d-n}return l};let l={start:t.length,length:0};for(;n<t.length;){const d=calculateBreakPosition(t,n);if(d.length>0){l=d;break}++n}const d=t.substr(0,l.start);return this.buffer=t.substr(l.start+l.length),d};try{let t;if(this.styleCollector="","INITIAL"===this.state){if(!/\r\n|\n/.test(this.buffer))return this;t=collectNextLine();const n=/^(Ã¯Â»Â¿)?WEBVTT([ \t].*)?$/.exec(t);if(!n||!n[0])throw new ParsingError(ParsingError.Errors.BadSignature);this.state="HEADER"}let n=!1;for(;this.buffer;){if(!/\r\n|\n/.test(this.buffer))return this;switch(n?n=!1:t=collectNextLine(),this.state){case"HEADER":t.includes(":")?this.parseHeader(t):t||(this.state="ID");continue;case"NOTE":t||(this.state="ID");continue;case"STYLE":t?this.styleCollector+=t:(this.parseStyle(this.styleCollector),this.state="ID",this.styleCollector="");continue;case"ID":if(/^NOTE($|[ \t])/.test(t)){this.state="NOTE";break}if(/^STYLE($|[ \t])/.test(t)){this.state="STYLE";break}if(!t)continue;if(this.cue=new No.VTTCue(0,0,""),this.state="CUE",!t.includes("--\x3e")){this.cue.id=t;continue}case"CUE":try{this.parseCue(t,this.cue,this.regionList)}catch(e){this.reportOrThrowError(e),this.cue=null,this.state="BADCUE";continue}this.state="CUETEXT";continue;case"CUETEXT":{const l=t.includes("--\x3e");if(!t||l){n=!0,this.oncue&&this.oncue(this.cue),this.cue=null,this.state="ID";continue}this.cue.text&&(this.cue.text+="\n"),this.cue.text+=t;continue}case"BADCUE":t||(this.state="ID");continue}}}catch(e){this.reportOrThrowError(e),"CUETEXT"===this.state&&this.cue&&this.oncue&&this.oncue(this.cue),this.cue=null,this.state="INITIAL"===this.state?"BADWEBVTT":"BADCUE"}return this}flush(){try{if(this.buffer+=this.decoder.decode(),(this.cue||"HEADER"===this.state)&&(this.buffer+="\n\n",this.parse()),"INITIAL"===this.state)throw new ParsingError(ParsingError.Errors.BadSignature)}catch(e){this.reportOrThrowError(e)}return this.onflush&&this.onflush(),this}styles(){return this._styles}}n.default=WebVTTParser,n.WebVTTParser=WebVTTParser}));unwrapExports(Lo);Lo.VTTCue,Lo.VTTRegion,Lo.ParsingError,Lo.WebVTTParser;var xo=createCommonjsModule((function(t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.VTTCue=No.VTTCue;const l=[/^(::cue\()(\..*)(\))/,/^(::cue\()(#.*)(\))/,/^(::cue\()(c|i|b|u|ruby|rt|v|lang)(\))/],d=[[1470,1470],[1472,1472],[1475,1475],[1478,1478],[1488,1514],[1520,1524],[1544,1544],[1547,1547],[1549,1549],[1563,1563],[1566,1610],[1645,1647],[1649,1749],[1765,1766],[1774,1775],[1786,1805],[1807,1808],[1810,1839],[1869,1957],[1969,1969],[1984,2026],[2036,2037],[2042,2042],[2048,2069],[2074,2074],[2084,2084],[2088,2088],[2096,2110],[2112,2136],[2142,2142],[2208,2208],[2210,2220],[8207,8207],[64285,64285],[64287,64296],[64298,64310],[64312,64316],[64318,64318],[64320,64321],[64323,64324],[64326,64449],[64467,64829],[64848,64911],[64914,64967],[65008,65020],[65136,65140],[65142,65276],[67584,67589],[67592,67592],[67594,67637],[67639,67640],[67644,67644],[67647,67669],[67671,67679],[67840,67867],[67872,67897],[67903,67903],[67968,68023],[68030,68031],[68096,68096],[68112,68115],[68117,68119],[68121,68147],[68160,68167],[68176,68184],[68192,68223],[68352,68405],[68416,68437],[68440,68466],[68472,68479],[68608,68680],[126464,126467],[126469,126495],[126497,126498],[126500,126500],[126503,126503],[126505,126514],[126516,126519],[126521,126521],[126523,126523],[126530,126530],[126535,126535],[126537,126537],[126539,126539],[126541,126543],[126545,126546],[126548,126548],[126551,126551],[126553,126553],[126555,126555],[126557,126557],[126559,126559],[126561,126562],[126564,126564],[126567,126570],[126572,126578],[126580,126583],[126585,126588],[126590,126590],[126592,126601],[126603,126619],[126625,126627],[126629,126633],[126635,126651],[1114109,1114109]];class StyleBox{applyStyles(t,n){n=n||this.div;for(const l in t)t.hasOwnProperty(l)&&(n.style[l]=t[l])}formatStyle(t,n){return 0===t?"0":t+n}}n.StyleBox=StyleBox;class CueStyleBox extends StyleBox{constructor(t,n,l,d,p){super(),this.cue=n;let h={textAlign:{start:"left","line-left":"left",left:"left",center:"center",middle:"center","line-right":"right",right:"right",end:"right"}[n.positionAlign]||n.align,whiteSpace:"pre-line",position:"absolute"};h.direction=this.determineBidi(this.cueDiv),h.writingMode=this.directionSettingToWritingMode(n.vertical),h.unicodeBidi="plaintext",this.div=t.document.createElement("div"),this.applyStyles(h),h={backgroundColor:d.backgroundColor,display:"inline-block"},this.parseOpacity(h.backgroundColor)&&(h.padding="5px",h.borderRadius="5px"),this.backgroundDiv=t.document.createElement("div"),this.applyStyles(h,this.backgroundDiv),h={color:l.color,backgroundColor:l.backgroundColor,textShadow:l.textShadow,fontSize:l.fontSize,fontFamily:l.fontFamily,position:"relative",left:"0",right:"0",top:"0",bottom:"0",display:"inline-block",textOrientation:"upright"},h.writingMode=this.directionSettingToWritingMode(n.vertical),h.unicodeBidi="plaintext",this.cueDiv=Mo.default.parseContent(t,n,p),this.applyStyles(h,this.cueDiv),this.backgroundDiv.appendChild(this.cueDiv),this.div.appendChild(this.backgroundDiv);let f=0;if("number"==typeof n.position){let t=n.positionAlign||n.align;if(t)switch(t){case"start":case"left":f=n.position;break;case"center":case"middle":f=n.position-n.size/2;break;case"end":case"right":f=n.position-n.size}}""===n.vertical?this.applyStyles({left:this.formatStyle(f,"%"),width:this.formatStyle(n.size,"%")}):this.applyStyles({top:this.formatStyle(f,"%"),height:this.formatStyle(n.size,"%")})}determineBidi(t){let n,l=[],p="";if(!t||!t.childNodes)return"ltr";function pushNodes(t,n){for(let l=n.childNodes.length-1;l>=0;l--)t.push(n.childNodes[l])}function nextTextNode(t){if(!t||!t.length)return null;let n=t.pop(),l=n.textContent||n.innerText;if(l){const n=/^.*(\n|\r)/.exec(l);return n?(t.length=0,n[0]):l}return"ruby"===n.tagName?nextTextNode(t):n.childNodes?(pushNodes(t,n),nextTextNode(t)):void 0}function isContainedInCharacterList(t,n){for(const l of n)if(t>=l[0]&&t<=l[1])return!0;return!1}for(pushNodes(l,t);p=nextTextNode(l);)for(let t=0;t<p.length;t++)if(n=p.charCodeAt(t),isContainedInCharacterList(n,d))return"rtl";return"ltr"}parseOpacity(t){if(!t||"string"!=typeof t)return null;const n=(t=t.replace(/ /g,"").replace("rgba(","").replace(")","")).split(",");return n&&n.length>=4?n[3]:null}directionSettingToWritingMode(t){return""===t?"horizontal-tb":"lr"===t?"vertical-lr":"vertical-rl"}move(t){this.applyStyles({top:this.formatStyle(t.top,"px"),bottom:this.formatStyle(t.bottom,"px"),left:this.formatStyle(t.left,"px"),right:this.formatStyle(t.right,"px"),height:this.formatStyle(t.height,"px"),width:this.formatStyle(t.width,"px")})}}n.CueStyleBox=CueStyleBox;class BoxPosition{constructor(t){var n;let l,d,p,h,f,y;if(t instanceof CueStyleBox&&t.cue?(n=t.cue)&&""!==n.vertical?this.property="width":this.property="height":t instanceof BoxPosition&&(this.property=t.property||"height"),t instanceof CueStyleBox&&t.div){p=t.div.offsetHeight,h=t.div.offsetWidth,f=t.div.offsetTop;const n=t.div.firstChild;if(y=n?n.getBoundingClientRect():t.div.getBoundingClientRect(),l=y&&y[this.property]||null,n&&n.firstChild){const t=n.firstChild;if(t&&"string"==typeof t.textContent){d=l/this.calculateNewLines(t.textContent)}}}else t instanceof BoxPosition&&(y=t);this.left=y.left,this.right=y.right,this.top=y.top||f,this.height=y.height||p,this.bottom=y.bottom||f+(y.height||p),this.width=y.width||h,this.lineHeight=null!==l?l:y.lineHeight,this.singleLineHeight=null!==d?d:y.singleLineHeight,this.singleLineHeight||(this.singleLineHeight=41)}calculateNewLines(t){let n=1;for(let l=0;l<t.length;l++)"\n"===t[l]&&n++;return n}move(t,n){switch(n=void 0!==n?n:this.singleLineHeight,t){case"+x":this.left+=n,this.right+=n;break;case"-x":this.left-=n,this.right-=n;break;case"+y":this.top+=n,this.bottom+=n;break;case"-y":this.top-=n,this.bottom-=n}}overlaps(t){return this.left<t.right&&this.right>t.left&&this.top<t.bottom&&this.bottom>t.top}overlapsAny(t){for(const n of t)if(this.overlaps(n))return!0;return!1}within(t){return this.top>=t.top&&this.bottom<=t.bottom&&this.left>=t.left&&this.right<=t.right}moveIfOutOfBounds(t,n){switch(n){case"+x":this.left<t.left&&(this.left=t.left,this.right=this.left+this.width);break;case"-x":this.right>t.right&&(this.right=t.right,this.left=this.right-this.width);break;case"+y":this.top<t.top&&(this.top=t.top,this.bottom=this.top+this.height);break;case"-y":this.bottom>t.bottom&&(this.bottom=t.bottom,this.top=this.bottom-this.height)}}toCSSCompatValues(t){return{top:this.top-t.top,bottom:t.bottom-this.bottom,left:this.left-t.left,right:t.right-this.right,height:this.height,width:this.width}}static getSimpleBoxPosition(t){let n=null;t instanceof StyleBox&&t.div?n=t.div:t instanceof HTMLElement&&(n=t);let l=n.offsetHeight||0,d=n.offsetWidth||0,p=n.offsetTop||0,h=p+l,f=n.getBoundingClientRect();const{left:y,right:v}=f;return f.top&&(p=f.top),f.height&&(l=f.height),f.width&&(d=f.width),f.bottom&&(h=f.bottom),{left:y,right:v,top:p,height:l,bottom:h,width:d}}static getBoxPosition(t,n){if(t&&t.length>0){let l=0,d=t[0][n];for(let p=0;p<t.length;p++)n in["top","right"]?t[p][n]>d&&(l=p,d=t[p][n]):n in["bottom","left"]&&t[p][n]<d&&(l=p,d=t[p][n]);return t[l]}return null}static moveToMinimumDistancePlacement(t,n,l){"height"===t.property?"+y"===n?(t.top=l.topMostBoxPosition.bottom+0,t.bottom=t.top+t.height):"-y"===n&&(t.bottom=l.bottomMostBoxPosition.top-0,t.top=t.bottom-t.height):"width"===t.property&&("+x"===n?(t.left=l.rightMostBoxPosition.right+0,t.right=t.left+t.width):"-x"===n&&(t.right=l.leftMostBoxPosition.left-0,t.left=t.right-t.width))}static moveBoxToLinePosition(t,n,l){const d=t.cue;let p,h=new BoxPosition(t),f=function(t){if("number"==typeof t.line&&(t.snapToLines||t.line>=0&&t.line<=100))return t.line;if(!t.track||!t.track.textTrackList||!t.track.textTrackList.mediaElement)return-1;let n=0;const l=t.track,d=l.textTrackList;for(let p=0;p<d.length&&d[p]!==l;p++)"showing"===d[p].mode&&n++;return-1*++n}(d),y=[];if(d.snapToLines){let t=0;switch(d.vertical){case"":y=["+y","-y"],p="height";break;case"rl":y=["+x","-x"],p="width";break;case"lr":y=["-x","+x"],p="width"}const l=h.lineHeight,v=n[p]+l,_=y[0];if(f<0){let p=0;switch(d.vertical){case"":p=n.height-l-.05*n.height;break;case"rl":case"lr":p=-n.width+l+.05*n.width}t=p,y=y.reverse()}else{switch(d.vertical){case"":t=l*Math.round(f);break;case"rl":t=n.width-l*Math.round(f);break;case"lr":t=l*Math.round(f)}Math.abs(t)>v&&(t=t<0?-1:1,t*=Math.ceil(v/l)*l)}h.move(_,t)}else{const l=""===d.vertical?n.height:n.width,p=h.lineHeight/l*100;switch(d.lineAlign){case"center":f-=p/2;break;case"end":f-=p}switch(d.vertical){case"":t.applyStyles({top:t.formatStyle(f,"%")});break;case"rl":t.applyStyles({right:t.formatStyle(f,"%")});break;case"lr":t.applyStyles({left:t.formatStyle(f,"%")})}y=["+y","-y","+x","-x"],"+y"===d.axis?y=["+y","-y","+x","-x"]:"-y"===d.axis&&(y=["-y","+y","+x","-x"]),h=new BoxPosition(t)}const v=function(t,d){let p;for(let h=0;h<d.length;h++){t.moveIfOutOfBounds(n,d[h]);let f=0,y=!1;for(;t.overlapsAny(l)&&!(f>9);)y?t.move(d[h]):(l&&l.length>0&&(p||(p={topMostBoxPosition:BoxPosition.getBoxPosition(l,"top"),bottomMostBoxPosition:BoxPosition.getBoxPosition(l,"bottom"),leftMostBoxPosition:BoxPosition.getBoxPosition(l,"left"),rightMostBoxPosition:BoxPosition.getBoxPosition(l,"right")}),BoxPosition.moveToMinimumDistancePlacement(t,d[h],p)),y=!0),f++}return t}(h,y);t.move(v.toCSSCompatValues(n))}}n.BoxPosition=BoxPosition;class WebVTTRenderer{constructor(t,n,l=!0){if(!t)return null;this.window=t,this.overlay=n,this.loggingEnabled=l,this.foregroundStyleOptions={fontFamily:"Helvetica",fontSize:"36px",color:"rgba(255, 255, 255, 1)",textShadow:"",backgroundColor:"rgba(0, 0, 0, 0)"},this.backgroundStyleOptions={backgroundColor:"rgba(0, 0, 0, 0.5)"},this.globalStyleCollection={};const d=t.document.createElement("div");d.style.position="absolute",d.style.left="0",d.style.right="0",d.style.top="0",d.style.bottom="0",d.style.margin="1.5%",this.paddedOverlay=d,n.appendChild(this.paddedOverlay),this.initSubtitleCSS()}initSubtitleCSS(){const t=[new No.VTTCue(0,0,"String to init CSS - Won't be visible to user")];this.paddedOverlay.style.opacity="0",this.processCues(t),this.processCues([]),this.paddedOverlay.style.opacity="1"}convertCueToDOMTree(t){return t?Mo.default.parseContent(this.window,t,this.globalStyleCollection):null}setStyles(t){function applyStyles(t,n,l){for(const d in n)n.hasOwnProperty(d)&&(!0===l&&void 0!==t[d]||!1===l)&&(t[d]=n[d])}for(const n in t){let d=!1,p=null;"::cue"===n?(p=this.foregroundStyleOptions,d=!0):"::-webkit-media-text-track-display"===n&&(p=this.backgroundStyleOptions,d=!0);const h=t[n];if(!0===d)applyStyles(p,h,d);else for(let t=0;t<l.length;t++){const p=l[t].exec(n);if(p&&4===p.length){const t=p[2],n={};applyStyles(n,h,d),this.globalStyleCollection[t]=n}}}this.initSubtitleCSS(),this.loggingEnabled&&(console.log("WebVTTRenderer setStyles foregroundStyleOptions: "+JSON.stringify(this.foregroundStyleOptions)),console.log("WebVTTRenderer setStyles backgroundStyleOptions: "+JSON.stringify(this.backgroundStyleOptions)),console.log("WebVTTRenderer setStyles globalStyleCollection: "+JSON.stringify(this.globalStyleCollection)))}processCues(t){if(!t)return;for(;this.paddedOverlay.firstChild;)this.paddedOverlay.removeChild(this.paddedOverlay.firstChild);if(!function(t){for(let n=0;n<t.length;n++)if(t[n].hasBeenReset||!t[n].displayState)return!0;return!1}(t)){for(let n=0;n<t.length;n++)this.paddedOverlay.appendChild(t[n].displayState);return}const n=[],l=BoxPosition.getSimpleBoxPosition(this.paddedOverlay);t.length>1&&(t=function(t){const n=[];let l=0;for(let d=0;d<t.length;d++){let p=t[d];if("number"!=typeof p.line)return t;l+=p.line,n.push(p)}return l/=t.length,l>50?(n.forEach((function(t){t.axis="-y"})),n.sort((t,n)=>n.line-t.line)):(n.forEach((function(t){t.axis="+y"})),n.sort((t,n)=>t.line-n.line)),n}(t));for(let d=0;d<t.length;d++){let p=t[d],h=new CueStyleBox(this.window,p,this.foregroundStyleOptions,this.backgroundStyleOptions,this.globalStyleCollection);this.paddedOverlay.appendChild(h.div),BoxPosition.moveBoxToLinePosition(h,l,n),p.displayState=h.div,n.push(BoxPosition.getSimpleBoxPosition(h))}}setSize(t,n){t&&(this.overlay.style.width=t+"px"),n&&(this.overlay.style.height=n+"px")}getOverlay(){return this.overlay}}n.default=WebVTTRenderer,n.WebVTTRenderer=WebVTTRenderer}));unwrapExports(xo);xo.VTTCue,xo.StyleBox,xo.CueStyleBox,xo.BoxPosition,xo.WebVTTRenderer;var Uo=createCommonjsModule((function(t,n){function __export(t){for(var l in t)n.hasOwnProperty(l)||(n[l]=t[l])}Object.defineProperty(n,"__esModule",{value:!0}),__export(Lo),__export(xo)}));unwrapExports(Uo);var Bo=Uo.WebVTTRenderer,jo=function(){function TrackManagerStub(){}return Object.defineProperty(TrackManagerStub.prototype,"currentTrack",{get:function(){return{}},set:function(t){},enumerable:!0,configurable:!0}),Object.defineProperty(TrackManagerStub.prototype,"tracks",{get:function(){return[]},enumerable:!0,configurable:!0}),TrackManagerStub.prototype.destroy=function(){},TrackManagerStub.prototype.restoreSelectedTrack=function(){},TrackManagerStub}(),Fo=qi,Ko=Qi,Vo=en,$o=Pn,Yo=Tn,Ho=Sn,Wo=Cn.textTracksSwitched,zo=Cn.textTracksUpdated,Go=function(){function TextTrackManager(t,n,l){this.mediaElement=t,this.dispatcher=n,this.extensionTracks=l,this._tracks=[],this.trackPersistence=new Po("mk-text-track",["label","language","kind"]);var d,p,h,f,y=this.trackPersistence.getPersistedTrack();if(this._tracks.push({id:-2,label:"Off",language:"",kind:"subtitles",mode:y&&"Off"===y.label?"showing":"disabled"},{id:-1,label:"Auto",language:"",kind:"subtitles",mode:y&&"Auto"!==y.label?"disabled":"showing"}),this.extensionTracks){Le.debug("MEDIA_TRACK Initializing text track manager for HLS.js track events");var v=t.parentElement;this.renderer=new Bo(window,v,!1),this.renderer.setStyles({"::cue":{fontSize:"calc(1vw + 1em)"}}),this.onExtensionTextTracksAdded=this.onExtensionTextTracksAdded.bind(this),this.onExtensionTextTrackSwitched=this.onExtensionTextTrackSwitched.bind(this),this.onCueChange=this.onCueChange.bind(this);var _=this.extensionTracks;_.addEventListener(zo,this.onExtensionTextTracksAdded),_.addEventListener(Wo,this.onExtensionTextTrackSwitched)}else Le.debug("MEDIA_TRACK Initializing text track manager for native track events"),this.onTextTrackAdded=this.onTextTrackAdded.bind(this),this.onTextTrackChanged=this.onTextTrackChanged.bind(this),this.onTextTrackRemoved=this.onTextTrackRemoved.bind(this),this.onPlayStart=this.onPlayStart.bind(this),t.textTracks.addEventListener("addtrack",this.onTextTrackAdded),t.textTracks.addEventListener("change",this.onTextTrackChanged),t.textTracks.addEventListener("removetrack",this.onTextTrackRemoved),t.addEventListener("playing",this.onPlayStart);this.onAudioTrackAddedOrChanged=(d=this.onAudioTrackAddedOrChanged.bind(this),void 0===p&&(p=250),void 0===h&&(h={isImmediate:!1}),function(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];var l=this,doLater=function(){f=void 0,h.isImmediate||d.apply(l,t)},y=h.isImmediate&&void 0===f;void 0!==f&&clearTimeout(f),f=setTimeout(doLater,p),y&&d.apply(l,t)}),n.subscribe(Ko,this.onAudioTrackAddedOrChanged),n.subscribe(Fo,this.onAudioTrackAddedOrChanged)}return Object.defineProperty(TextTrackManager.prototype,"currentTrack",{get:function(){return this.tracks.find((function(t){return"showing"===t.mode}))},set:function(t){var n;t&&(this.trackPersistence.setPersistedTrack(t),this.extensionTracks?(Le.debug("MEDIA_TRACK Setting track on extension "+t.label),"Auto"===t.label?(this.clearCurrentlyPlayingTrack(),void 0===(n=this.extensionTracks.selectForcedTrack())&&this.onExtensionTextTrackSwitched({track:t})):this.extensionTracks.textTrack=t):(Le.debug("MEDIA_TRACK Setting track on element "+t.label),this._tracks.forEach((function(n){n!==t&&"showing"===n.mode&&(n.mode="disabled")})),t&&(Le.debug("MEDIA_TRACK setting track mode to showing for "+t.label),"Auto"===t.label?(this._tracks[1].mode="showing",n=this.selectNativeForcedTrack(this.mediaElement.audioTracks)):"Off"===t.label?this._tracks[0].mode="showing":t.mode="showing")),this.dispatcher.publish(en,n))},enumerable:!0,configurable:!0}),Object.defineProperty(TextTrackManager.prototype,"tracks",{get:function(){return this._tracks},enumerable:!0,configurable:!0}),TextTrackManager.prototype.destroy=function(){if(this.clearCurrentlyPlayingTrack(),this.extensionTracks){var t=this.extensionTracks;t.removeEventListener(zo,this.onExtensionTextTracksAdded),t.removeEventListener(Wo,this.onExtensionTextTrackSwitched)}else this.mediaElement.textTracks.removeEventListener("addtrack",this.onTextTrackAdded),this.mediaElement.textTracks.removeEventListener("change",this.onTextTrackChanged),this.mediaElement.textTracks.removeEventListener("removetrack",this.onTextTrackRemoved),this.mediaElement.removeEventListener("playing",this.onPlayStart);this.dispatcher.unsubscribe(Ko,this.onAudioTrackAddedOrChanged),this.dispatcher.unsubscribe(Fo,this.onAudioTrackAddedOrChanged)},TextTrackManager.prototype.restoreSelectedTrack=function(){return restoreSelectedTrack(this.trackPersistence,this)},TextTrackManager.prototype.onExtensionTextTracksAdded=function(t){var n;Le.debug("MEDIA_TRACK Extension text tracks updated "+JSON.stringify(t)),(n=this._tracks).push.apply(n,__spread(t)),this.restoreSelectedTrack(),this.dispatcher.publish($o,t)},TextTrackManager.prototype.onExtensionTextTrackSwitched=function(t){if(Le.debug("MEDIA_TRACKS Extension text track switched "+t),this.handleVTT(t),this._tracks){this._tracks.forEach((function(n){t.track?t.track.forced&&"Auto"===n.label||"Auto"===t.track.label&&"Auto"===n.label?n.mode="showing":n.mode=t.track.persistentID===n.id?"showing":"disabled":n.mode="Off"===n.label?"showing":"disabled"}))}this.dispatcher.publish(Yo,t)},TextTrackManager.prototype.handleVTT=function(t){var n=t&&t.track&&t.track.id;if(void 0!==n&&n>=0){var l=this.filterSelectableTextTracks(this.mediaElement.textTracks)[n];this.onNativeTrackChange(l)}else this.clearCurrentlyPlayingTrack()},TextTrackManager.prototype.onAudioTrackAddedOrChanged=function(t,n){if(Le.debug("MEDIA_TRACKS text track manager detects audio track change"),this.shouldForceSubtitle())if(this.extensionTracks){Le.debug("MEDIA_TRACKS selecting forced text track via extension");var l=this.extensionTracks.selectForcedTrack();l?this.dispatcher.publish(Vo,l):this.clearCurrentlyPlayingTrack()}else Le.debug("MEDIA_TRACKS selecting forced text track natively"),this.currentTrack=this._tracks[1]},TextTrackManager.prototype.onTextTrackAdded=function(t){this._tracks.push(t.track),this.dispatcher.publish($o,t)},TextTrackManager.prototype.onPlayStart=function(){this.restoreSelectedTrack()},TextTrackManager.prototype.onTextTrackRemoved=function(t){this.dispatcher.publish(Ho,t)},TextTrackManager.prototype.onTextTrackChanged=function(t){var n=this.findNativeSelectedTextTrack(),l=this.trackPersistence.getPersistedTrack();if(l||(l=this._tracks[1]),n&&!trackEquals(n,l,this.trackPersistence.fields))if("Off"===l.label||"Auto"===l.label&&"forced"!==n.kind)this.currentTrack=l;else{var d=this.findNativeTrack(l);d&&(this.currentTrack=d)}else this.dispatcher.publish(Yo,t)},TextTrackManager.prototype.findNativeSelectedTextTrack=function(){for(var t=0;t<this.mediaElement.textTracks.length;t++){var n=this.mediaElement.textTracks[t];if("showing"===n.mode)return n}},TextTrackManager.prototype.findNativeTrack=function(t){for(var n=0;n<this.mediaElement.textTracks.length;n++){var l=this.mediaElement.textTracks[n];if(trackEquals(l,t,this.trackPersistence.fields))return l}},TextTrackManager.prototype.selectNativeForcedTrack=function(t){for(var n=0;n<t.length;n++){var l=t[n];if(l.enabled){var d=this.findNativeForcedTrack(l);return d&&"showing"!==d.mode&&(d.mode="showing"),d}}},TextTrackManager.prototype.findNativeForcedTrack=function(t){for(var n=this.mediaElement.textTracks,l=0;l<n.length;l++){var d=n[l];if("forced"===d.kind&&d.language===t.language)return d}},TextTrackManager.prototype.onNativeTrackChange=function(t){this.clearCurrentlyPlayingTrack(),this._currentlyPlayingTrack=t,t.addEventListener("cuechange",this.onCueChange)},TextTrackManager.prototype.clearCurrentlyPlayingTrack=function(){var t;void 0!==this._currentlyPlayingTrack&&("string"==typeof(t=this._currentlyPlayingTrack).id&&"removeEventListener"in t)&&(this._currentlyPlayingTrack.removeEventListener("cuechange",this.onCueChange),this.renderer.processCues({}),delete this._currentlyPlayingTrack)},TextTrackManager.prototype.onCueChange=function(t){var n=t&&t.target&&t.target.activeCues;n&&this.renderer.processCues(n)},TextTrackManager.prototype.filterSelectableTextTracks=function(t){for(var n=Array(),l=0;l<t.length;l++){var d=t[l];("captions"===d.kind||"subtitles"===d.kind||"metadata"===d.kind&&d.customTextTrackCueRenderer)&&n.push(d)}return n},TextTrackManager.prototype.shouldForceSubtitle=function(){Le.debug("MEDIA_TRACKS Determining whether to select forced text track");var t=this.trackPersistence.getPersistedTrack();return!t||"Auto"===t.label},TextTrackManager}(),qo={"picture-in-picture":t.PresentationMode.pictureinpicture,inline:t.PresentationMode.inline},Qo={};Qo[t.PresentationMode.pictureinpicture]="picture-in-picture",Qo[t.PresentationMode.inline]="inline";var Jo,Xo=mn,Zo=Cn.playbackLicenseError,ea=t.PlaybackStates.stopped,ta=function(n){function VideoPlayer(t){var l=n.call(this,t)||this;return l.mediaPlayerType="video",l._textTrackManager=new jo,l._audioTrackManager=new jo,l.userInitiated=!1,l.restrictPlatforms=!("restrict-platforms"in bo.features)||bo.features["restrict-platforms"],l.pipEventHandler=l.pipEventHandler.bind(l),l}return __extends(VideoPlayer,n),Object.defineProperty(VideoPlayer.prototype,"audioTracks",{get:function(){return this._audioTrackManager.tracks},enumerable:!0,configurable:!0}),Object.defineProperty(VideoPlayer.prototype,"containerElement",{get:function(){return this._context.videoContainerElement?this._context.videoContainerElement:document.getElementById("apple-music-video-container")},enumerable:!0,configurable:!0}),Object.defineProperty(VideoPlayer.prototype,"currentAudioTrack",{get:function(){return this._audioTrackManager.currentTrack},set:function(t){this._audioTrackManager.currentTrack=t},enumerable:!0,configurable:!0}),Object.defineProperty(VideoPlayer.prototype,"currentTextTrack",{get:function(){return this._textTrackManager.currentTrack},set:function(t){this._textTrackManager.currentTrack=t},enumerable:!0,configurable:!0}),Object.defineProperty(VideoPlayer.prototype,"_targetElement",{get:function(){return this.video||__assign({},document.createElement("video"))},enumerable:!0,configurable:!0}),Object.defineProperty(VideoPlayer.prototype,"textTracks",{get:function(){return this._textTrackManager.tracks},enumerable:!0,configurable:!0}),VideoPlayer.prototype.initializeExtension=function(){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(t){return this.restrictPlatforms&&fe.isAndroid?(Le.warn("videoPlayer.initializeExtension Not supported on the current platform"),[2]):(this.video||Le.warn("videoPlayer.initializeExtension No video element, not initializing extension"),[2])}))}))},VideoPlayer.prototype.onPlaybackLicenseError=function(t){this._licenseError(),this._dispatcher.publish(Zo,t)},VideoPlayer.prototype.setupTrackManagers=function(t){var n,l,d,p;null===(l=null===(n=this._textTrackManager)||void 0===n?void 0:n.destroy)||void 0===l||l.call(n),this._textTrackManager=new Go(this._targetElement,this._dispatcher,t),null===(p=null===(d=this._audioTrackManager)||void 0===d?void 0:d.destroy)||void 0===p||p.call(d),this._audioTrackManager=new Eo(this._targetElement,this._dispatcher,t)},VideoPlayer.prototype.destroy=function(){this._textTrackManager.destroy(),this._audioTrackManager.destroy(),n.prototype.destroy.call(this)},VideoPlayer.prototype.initializeEventHandlers=function(){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(t){return n.prototype.initializeEventHandlers.call(this),this.hasMediaElement?(this._targetElement.addEventListener("webkitpresentationmodechanged",this.pipEventHandler),this._targetElement.addEventListener("enterpictureinpicture",this.pipEventHandler),this._targetElement.addEventListener("leavepictureinpicture",this.pipEventHandler),[2]):[2]}))}))},VideoPlayer.prototype.removeEventHandlers=function(){if(n.prototype.removeEventHandlers.call(this),this.hasMediaElement){var t=this._targetElement;t.removeEventListener("webkitpresentationmodechanged",this.pipEventHandler),t.removeEventListener("enterpictureinpicture",this.pipEventHandler),t.removeEventListener("leavepictureinpicture",this.pipEventHandler)}},VideoPlayer.prototype.initializeMediaElement=function(){return __awaiter(this,void 0,void 0,(function(){var t;return __generator(this,(function(n){return Le.debug("videoPlayer.initializeMediaElement Initializing media element"),(t=this.containerElement)?(this.video=((l=Oo.pop())?Le.debug("dom-helpers: retrieving video tag, "+Oo.length+" remain"):(Le.debug("dom-helpers: no available video tags, creating one"),l=document.createElement("video")),l),this.video.autoplay=!1,this.video.controls=!1,this.video.playsInline=!0,this.video.id="apple-music-video-player",t.appendChild(this.video),[2]):(Le.warn("videoPlayer.initializeMediaElement No video element; no container defined"),[2]);var l}))}))},VideoPlayer.prototype.isPlayerSupported=function(){return he.supportsEs6()},VideoPlayer.prototype._stopMediaElement=function(){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(t){switch(t.label){case 0:return[4,n.prototype._stopMediaElement.call(this)];case 1:return t.sent(),this.destroy(),[2]}}))}))},VideoPlayer.prototype.pipEventHandler=function(n){switch(n.type){case"enterpictureinpicture":this._dispatcher.publish(Xo,{mode:t.PresentationMode.pictureinpicture});break;case"leavepictureinpicture":this._dispatcher.publish(Xo,{mode:t.PresentationMode.inline});break;case"webkitpresentationmodechanged":var l=this._targetElement;this._dispatcher.publish(Xo,{mode:this._translateStringToPresentationMode(l.webkitPresentationMode)})}},VideoPlayer.prototype.playItemFromEncryptedSource=function(n,l,p){return void 0===l&&(l=!1),__awaiter(this,void 0,void 0,(function(){return __generator(this,(function(p){return Le.debug("videoPlayer.playItemFromEncryptedSource",n,l),this.playbackState===ea?(Le.debug("video-player.playItemFromEncryptedSource aborting playback because player is stopped"),[2]):(n.playbackType=t.PlaybackType.encryptedFull,this.nowPlayingItem=n,n.state=d.loading,this.userInitiated=l,this.playHlsStream(n.assetURL,n),[2])}))}))},VideoPlayer.prototype.playItemFromUnencryptedSource=function(t,n,l){return __awaiter(this,void 0,void 0,(function(){var l,d;return __generator(this,(function(p){return Le.debug("videoPlayer.playItemFromUnencryptedSource",t,n),this.playbackState===ea?(Le.debug("videoPlayer.playItemFromUnencryptedSource aborting playback because player is stopped"),[2]):(l=__read(t.split("?"),1),(d=l[0]).endsWith("m3u")||d.endsWith("m3u8")?(this.playHlsStream(t),[2]):[2,this._playAssetURL(t,n)])}))}))},VideoPlayer.prototype.setPresentationMode=function(n){return __awaiter(this,void 0,void 0,(function(){var l;return __generator(this,(function(d){if((l=this._targetElement).webkitSupportsPresentationMode&&"function"==typeof l.webkitSetPresentationMode)return[2,l.webkitSetPresentationMode(this._translatePresentationModeToString(n))];if(l.requestPictureInPicture&&document.exitPictureInPicture){if(n===t.PresentationMode.pictureinpicture)return[2,l.requestPictureInPicture()];if(n===t.PresentationMode.inline)return[2,document.exitPictureInPicture()]}return[2]}))}))},VideoPlayer.prototype._translateStringToPresentationMode=function(n){var l=qo[n];return void 0===l&&(Le.warn("videoPlayer._translateStringToPresentationMode "+n+" is not a valid presentation mode, setting to inline"),l=t.PresentationMode.inline),l},VideoPlayer.prototype._translatePresentationModeToString=function(t){var n=Qo[t];return void 0===n&&(Le.warn("videoPlayer._translatePresentationModeToString "+t+" is not a valid presentation mode, setting to inline"),n="inline"),n},VideoPlayer.prototype.setNextGaplessItem=function(t){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(t){return[2]}))}))},__decorate([Bind(),__metadata("design:type",Function),__metadata("design:paramtypes",[Object]),__metadata("design:returntype",void 0)],VideoPlayer.prototype,"onPlaybackLicenseError",null),VideoPlayer}(mo);!function(t){t.NONE="none",t.FAIRPLAY="com.apple.fps",t.PLAYREADY="com.microsoft.playready",t.WIDEVINE="com.widevine.alpha"}(Jo||(Jo={}));var hasSessionStorage=function(){return"undefined"!=typeof window&&window.sessionStorage};function findMediaKeySystemAccess(t,n){return __awaiter(this,void 0,void 0,(function(){var l,d,p;return __generator(this,(function(h){switch(h.label){case 0:l=0,h.label=1;case 1:if(!(l<t.length))return[3,6];h.label=2;case 2:return h.trys.push([2,4,,5]),d=t[l],[4,navigator.requestMediaKeySystemAccess(d,n)];case 3:return p=h.sent(),[2,[d,p]];case 4:return h.sent(),[3,5];case 5:return l++,[3,1];case 6:return[2,[]]}}))}))}var ra,ia=Jo.NONE,na=Jo.FAIRPLAY,oa=Jo.WIDEVINE,aa=Jo.PLAYREADY;function supportsDrm(){if(!ra)throw new Error("findKeySystemPreference has not been invoked");return ra!==ia}function potentialKeySystemsForAccess(){return hasSessionStorage()&&"true"===window.sessionStorage.getItem("mk-playready-cbcs-unsupported")?[oa]:bo.features["prefer-playready"]?[aa,oa]:[oa,aa]}function findKeySystemPreference(){var t,n;return __awaiter(this,void 0,void 0,(function(){var l,d,p,h;return __generator(this,(function(f){switch(f.label){case 0:return pe?(ra=ia,[2,void 0]):(null===(t=window.WebKitMediaKeys)||void 0===t?void 0:t.isTypeSupported(na+".1_0",Mn.AVC1))?(ra=na,[3,4]):[3,1];case 1:return(null===(n=window.MSMediaKeys)||void 0===n?void 0:n.isTypeSupported(aa,Mn.AVC1))?(ra=aa,[3,4]):[3,2];case 2:return l=wo,hasMediaKeySupport()&&l.canPlayType('video/mp4;codecs="avc1.42E01E"')&&l.canPlayType('audio/mp4;codecs="mp4a.40.2"')?(d=[{videoCapabilities:[{contentType:'video/mp4;codecs="avc1.42E01E"',robustness:"SW_SECURE_CRYPTO"}],audioCapabilities:[{contentType:'audio/mp4;codecs="mp4a.40.2"'}]}],[4,findMediaKeySystemAccess(potentialKeySystemsForAccess(),d)]):[3,4];case 3:p=__read.apply(void 0,[f.sent(),1]),h=p[0],ra=h,f.label=4;case 4:return[2,ra=null!=ra?ra:ia]}}))}))}function hasMediaKeySupport(){return!!(navigator&&navigator.requestMediaKeySystemAccess&&window.MediaKeys&&window.MediaKeySystemAccess)}var sa=isNodeEnvironment()?require("util").TextDecoder:self.TextDecoder;function encodedArrayToString(t,n){return void 0===n&&(n="utf-8"),"iso-8859-1"===n?String.fromCharCode.apply(String,__spread$1(t)):new sa(n).decode(t)}function readNullTerminatedString(t,n,l){void 0===n&&(n=0);var d=[];l=null!=l?l:t.length;for(var p=n;p<l;p++){var h=t[p];if("\0"===String.fromCharCode(h))break;d.push(String.fromCharCode(h))}return[d.join(""),d.length]}function isBitAtPositionOn(t,n){return 0!=(t&1<<n)}var ua=function(){function BaseMp4Box(t,n,l,d){this.id=t,this.data=n,this.start=l,this.end=d}return Object.defineProperty(BaseMp4Box.prototype,"size",{get:function(){return this.end-this.start},enumerable:!0,configurable:!0}),Object.defineProperty(BaseMp4Box.prototype,"rawBytes",{get:function(){return this.data.slice(this.start,this.end)},enumerable:!0,configurable:!0}),BaseMp4Box}(),ca=[237,239,139,169,121,214,74,206,163,200,39,220,213,29,33,237],la=function(t){function PsshBox(n,l,d){var p=t.call(this,"pssh",n,l,d)||this;return p.view=new DataView(n.buffer,l),p}return __extends$1(PsshBox,t),Object.defineProperty(PsshBox.prototype,"systemId",{get:function(){var t=this.data,n=this.start+12;return t.slice(n,n+16)},enumerable:!0,configurable:!0}),Object.defineProperty(PsshBox.prototype,"dataSize",{get:function(){return this.view.getUint32(28)},enumerable:!0,configurable:!0}),Object.defineProperty(PsshBox.prototype,"psshData",{get:function(){var t=this.data,n=this.start,l=this.dataSize,d=n+32;return t.slice(d,d+l)},enumerable:!0,configurable:!0}),Object.defineProperty(PsshBox.prototype,"keyBytes",{get:function(){return this.psshData.slice(2,18)},enumerable:!0,configurable:!0}),Object.defineProperty(PsshBox.prototype,"isWidevine",{get:function(){return arrayEquals(this.systemId,ca)},enumerable:!0,configurable:!0}),PsshBox}(ua),da=function(t){function TencBox(n,l,d){var p=t.call(this,"tenc",n,l,d)||this;return p.data=n,p.start=l,p.end=d,p}return __extends$1(TencBox,t),Object.defineProperty(TencBox.prototype,"isProtected",{get:function(){return this.data[this.start+14]},enumerable:!0,configurable:!0}),Object.defineProperty(TencBox.prototype,"defaultKeyId",{get:function(){var t=this.data,n=this.start;return t.slice(n+16,n+32)},set:function(t){for(var n=this.data,l=this.start,d=0;d<t.length;d++)n[d+l+16]=t[d]},enumerable:!0,configurable:!0}),TencBox}(ua);function findBox(t,n,l){void 0===l&&(l=[]);for(var d=n;d<t.length;){if(0===l.length)return;var p=new DataView(t.buffer,d).getUint32(0),h=encodedArrayToString(t.subarray(d+4,d+8)),f=d+p;if(1===l.length&&h===l[0])return new ua(h,t,d,f);if(h===l[0])return findBox(t,d+8,l.slice(1));d+=p}}var pa={developerToken:"developerTokenNotSet",musicUserToken:"musicUserTokenNotSet"};function createHlsOffersLicenseChallengeBody(t){return{"adam-id":t.id,id:1}}function createLicenseChallengeBody(t,n,l,d,p){var h={challenge:l.challenge||Te(l.licenseChallenge),"key-system":d,uri:l.keyuri};return n.isUTS?__assign(__assign({},h),function(t,n){return void 0===n&&(n="start"),{"extra-server-parameters":t.keyServerQueryParameters,"license-action":n}}(n,t)):n.isLiveRadioStation?__assign(__assign({},h),{event:"beats1"}):n.hasOffersHlsUrl?{"license-requests":[__assign(__assign({},h),createHlsOffersLicenseChallengeBody(n))]}:__assign(__assign({},h),function(t,n){return void 0===n&&(n=!1),{adamId:t.songId,isLibrary:t.isCloudItem,"user-initiated":n}}(n,p))}var ha=function(){function License(){}return License.prototype.fetch=function(t){var n={Authorization:"Bearer "+pa.developerToken,Accept:"application/json","Content-Type":"application/json","X-Apple-Music-User-Token":""+pa.musicUserToken};this.keySystem===Jo.WIDEVINE&&(n["X-Apple-Renewal"]=!0);var l=new Headers(n);return fetch(this.licenseUrl,{method:"POST",body:JSON.stringify(t),headers:l})},License.prototype.reset=function(){this.licenseUrl=void 0,this.mediaItem=void 0,this.data=void 0,this.initiated=void 0,this.keySystem=void 0,this.startResponse=void 0},License.prototype.start=function(t,n,l,d,p){var h,f;return void 0===p&&(p=!1),__awaiter(this,void 0,void 0,(function(){var y,v,_,g,m,b,P;return __generator(this,(function(T){switch(T.label){case 0:this.licenseUrl=t,this.mediaItem=n,this.data=l,this.keySystem=d,this.initiated=p,y=l.isRenewalRequest?"renew":"start",v=createLicenseChallengeBody(y,n,l,d,p),n.hasOffersHlsUrl&&(this.licenseUrl+="/"+y),this.startResponse=this.fetch(v),T.label=1;case 1:return T.trys.push([1,4,,5]),[4,this.startResponse];case 2:if(!(_=T.sent()).ok)throw new Fe(Fe.MEDIA_LICENSE,"Error acquiring license");return[4,_.json()];case 3:if(g=T.sent(),(m=(null===(h=g["license-responses"])||void 0===h?void 0:h.length)?g["license-responses"][0]:g).status=null!==(f=m.status)&&void 0!==f?f:m.errorCode,0!==m.status)throw m.message||(m.message=-1004===m.status?Fe.DEVICE_LIMIT:Fe.MEDIA_LICENSE),(b=Fe.serverError(m)).errorCode===Fe.PLAYREADY_CBC_ENCRYPTION_ERROR&&hasSessionStorage()&&window.sessionStorage.setItem("mk-playready-cbcs-unsupported","true"),b;return[2,m];case 4:throw P=T.sent(),this.startResponse=void 0,P;case 5:return[2]}}))}))},License.prototype.stop=function(){return __awaiter(this,void 0,void 0,(function(){var t,n,l;return __generator(this,(function(d){switch(d.label){case 0:if(!this.startResponse)return[3,4];d.label=1;case 1:return d.trys.push([1,3,,4]),[4,this.startResponse];case 2:return d.sent(),[3,4];case 3:return d.sent(),[3,4];case 4:if(!this.mediaItem||!this.data)return[2];if(!this.mediaItem.isUTS)return[2];t=createLicenseChallengeBody("stop",this.mediaItem,this.data,this.keySystem,this.initiated),n=this.fetch(t),this.reset(),d.label=5;case 5:return d.trys.push([5,7,,8]),[4,n];case 6:return d.sent(),[3,8];case 7:return l=d.sent(),Le.warn("license.stop request error",l),[3,8];case 8:return[2]}}))}))},License}(),fa=/max-age=(\d+)/i;function shouldThrowLicenseError(t,n){var l=t.errorCode===Fe.PLAYREADY_CBC_ENCRYPTION_ERROR;return n&&!l}var ya=function(t){function KeySession(){var n=t.call(this,[Cn.playbackLicenseError,Cn.playbackSessionError])||this;return n.initiated=!0,n.isLibrary=!1,n.keySystem=Jo.FAIRPLAY,n._storage=window.sessionStorage,n.boundDispatchKeyError=n.dispatchKeyError.bind(n),n.boundDispatchSessionError=n.dispatchSessionError.bind(n),n.boundHandleSessionCreation=n.handleSessionCreation.bind(n),n.boundStartLicenseSession=n.startLicenseSession.bind(n),n.license=new ha,n}return __extends(KeySession,t),Object.defineProperty(KeySession.prototype,"extID",{get:function(){if(this.extURI)return this.extURI.replace("data:;base64,","")},enumerable:!0,configurable:!0}),Object.defineProperty(KeySession.prototype,"isFairplay",{get:function(){return this.keySystem===Jo.FAIRPLAY},enumerable:!0,configurable:!0}),Object.defineProperty(KeySession.prototype,"isPlayReady",{get:function(){return this.keySystem===Jo.PLAYREADY},enumerable:!0,configurable:!0}),Object.defineProperty(KeySession.prototype,"isWidevine",{get:function(){return this.keySystem===Jo.WIDEVINE},enumerable:!0,configurable:!0}),KeySession.prototype.acquirePlaybackLicense=function(t,n,l){return void 0===l&&(l=this.initiated),__awaiter(this,void 0,void 0,(function(){var d;return __generator(this,(function(p){switch(p.label){case 0:if(!this.keyServerURL||!this.developerToken||!this.userToken)return[2];p.label=1;case 1:return p.trys.push([1,3,,4]),[4,this.license.start(this.keyServerURL,this.item,{challenge:n,keyuri:t},this.keySystem,this.initiated)];case 2:return[2,p.sent()];case 3:if(d=p.sent(),shouldThrowLicenseError(d,l))throw d;return this.dispatchEvent(Cn.playbackLicenseError,d),[3,4];case 4:return[2]}}))}))},KeySession.prototype.startLicenseSession=function(t){var n,l=this;Le.debug("Starting License Session",t);var d=t.message,p=t.target;if(this.isPlayReady){var h=String.fromCharCode.apply(null,new Uint16Array(d.buffer||d)),f=(new DOMParser).parseFromString(h,"application/xml");n=f.getElementsByTagName("Challenge")[0].childNodes[0].nodeValue}else n=Te(new Uint8Array(d));return this.acquirePlaybackLicense(p.extURI||this.extURI,n).then((function(t){return l.handleLicenseJson(t,p,n)}))},KeySession.prototype.setKeyURLs=function(t){this.keyCertURL=t[this.isFairplay?"hls-key-cert-url":"widevine-cert-url"],this.keyServerURL=t["hls-key-server-url"]},KeySession.prototype.dispatchKeyError=function(t){console.error(Fe.MEDIA_KEY+" error in dispatchKeyError:",t),this.dispatchEvent(Cn.playbackSessionError,new Fe(Fe.MEDIA_KEY,t))},KeySession.prototype.dispatchSessionError=function(t){this.dispatchEvent(Cn.playbackSessionError,new Fe(Fe.MEDIA_SESSION,t))},KeySession.prototype.loadCertificateBuffer=function(){return __awaiter(this,void 0,void 0,(function(){var t,n,l,d,p,h,f,y,v,_,g,m,b;return __generator(this,(function(P){switch(P.label){case 0:if(!this.keyCertURL)return[2,Promise.reject(new Fe(Fe.MEDIA_SESSION,"No certificate URL"))];if((t=document.createElement("a")).href=this.keyCertURL,n=Date.now(),l=(""+t.hostname+t.pathname).replace(/[^a-z0-9.]/gi,"."),d=this._storage.getItem(l),p=parseInt(this._storage.getItem("com.ai.mk.vmcc.exp")||"",10),d&&p&&p>n){for(h=new Uint8Array(d.length),f=d.length;f--;)h[f]=d.charCodeAt(f);return[2,h.buffer]}return[4,fetch(this.keyCertURL+"?t="+Date.now())];case 1:return y=P.sent(),v=y.headers.get("cache-control"),_=86400,v&&fa.test(v)&&(g=v.match(fa))&&g[1]&&(_=parseInt(g[1],10)),[4,y.arrayBuffer()];case 2:return m=P.sent(),b=String.fromCharCode.apply(String,new Uint8Array(m)),/^\<\?xml/.test(b)?[2,Promise.reject(new Fe(Fe.MEDIA_CERTIFICATE,"Invalid certificate."))]:(this._storage.setItem(l,b),this._storage.setItem("com.ai.mk.vmcc.exp",(n+1e3*_).toString()),[2,m])}}))}))},KeySession.prototype.handleSessionCreation=function(t){return __awaiter(this,void 0,void 0,(function(){var n=this;return __generator(this,(function(l){return[2,this.createSession(t).catch((function(t){n.dispatchSessionError(t)}))]}))}))},KeySession.prototype.handleLicenseJson=function(t,n,l){return __awaiter(this,void 0,void 0,(function(){var l,d;return __generator(this,(function(p){switch(p.label){case 0:if(Le.debug("handleLicenseResponse",t),!(null==t?void 0:t.license))return[3,4];l=me(t.license),p.label=1;case 1:return p.trys.push([1,3,,4]),[4,n.update(l)];case 2:return p.sent(),[3,4];case 3:return d=p.sent(),Le.error("Failed to updated media keys",d),this.dispatchKeyError(d),[3,4];case 4:return[2]}}))}))},__decorate([Bind(),__metadata("design:type",Function),__metadata("design:paramtypes",[Object]),__metadata("design:returntype",void 0)],KeySession.prototype,"startLicenseSession",null),KeySession}(ke),va=function(t){function EncryptedSession(){return null!==t&&t.apply(this,arguments)||this}return __extends(EncryptedSession,t),EncryptedSession.prototype.attachMedia=function(t,n){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(l){return this.keySystem=n.keySystem,this._keySystemAccess=n,t.addEventListener("encrypted",this.boundHandleSessionCreation,!1),[2]}))}))},EncryptedSession.prototype.detachMedia=function(t){t.removeEventListener("encrypted",this.boundHandleSessionCreation)},EncryptedSession.prototype.createSession=function(t){return __awaiter(this,void 0,void 0,(function(){var n,l,d,p,h=this;return __generator(this,(function(f){switch(f.label){case 0:return Le.debug("Encrypted createSession",t),(n=this._keySystemAccess)?(l=t.initData,d=t.initDataType,p=t.target,this._mediaKeysPromise||(this._mediaKeysPromise=new Promise((function(t,l){return __awaiter(h,void 0,void 0,(function(){var d,h,f;return __generator(this,(function(y){switch(y.label){case 0:return[4,n.createMediaKeys()];case 1:d=y.sent(),y.label=2;case 2:return y.trys.push([2,4,,5]),[4,p.setMediaKeys(d)];case 3:return y.sent(),[3,5];case 4:return h=y.sent(),this.dispatchKeyError(h),l(h),[3,5];case 5:return[4,this.loadCertificateBuffer()];case 6:return f=y.sent(),[4,d.setServerCertificate(f)];case 7:return y.sent(),this._mediaKeysServerCertificate=f,t(d),[2]}}))}))}))),[4,this._mediaKeysPromise]):[2];case 1:return f.sent(),this._mediaKeysServerCertificate?[2,this._createSession(p,l,d)]:[2]}}))}))},EncryptedSession.prototype.generatePSSH=function(t){for(var n=new Uint8Array([0,0,0,52,112,115,115,104,0,0,0,0,237,239,139,169,121,214,74,206,163,200,39,220,213,29,33,237,0,0,0,20,8,1,18,16,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]),l=me(t),d=0;d<l.length;d++)n[n.length-16+d]=l[d];return Le.debug("generatePSSH",n),n},EncryptedSession.prototype._createSession=function(t,n,l){var d=t.mediaKeys.createSession(),p=this.item;if(p){var h;if(this._teardownCurrentSession(),Le.debug("creating media key session",d),this.isWidevine&&p.isSong)h=this.generatePSSH(this.extID);else{var f=function(t){for(var n=[],l=new DataView(t.buffer),d=0;d<t.length;){var p=l.getUint32(d);n.push(new la(t,d,d+p)),d+=p}return n}(new Uint8Array(n)).find((function(t){return t.isWidevine})),y=null==f?void 0:f.rawBytes,v=Te(y);Le.debug("extracted uri",v),d.extURI=v,h=n}return d.addEventListener("message",this.startLicenseSession),this._currentSession=d,d.generateRequest(l,h).catch((function(t){if(t.message.match(/generateRequest.*\(75\)/))return d.generateRequest(l,h);throw t}))}},EncryptedSession.prototype._teardownCurrentSession=function(){this._currentSession&&(Le.debug("tearing down media key session",this._currentSession),this._currentSession.removeEventListener("message",this.startLicenseSession),this._currentSession=void 0)},EncryptedSession}(ya),_a=function(t){function FairplayEncryptedSession(){var n=null!==t&&t.apply(this,arguments)||this;return n._mediaKeySessions={},n._mediaKeySessionRenewals={},n}return __extends(FairplayEncryptedSession,t),FairplayEncryptedSession.prototype.attachMedia=function(t,n){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(l){return this.keySystem=n.keySystem,this._keySystemAccess=n,t.addEventListener("encrypted",this.boundHandleSessionCreation,!1),[2]}))}))},FairplayEncryptedSession.prototype.detachMedia=function(t){var n=this;t.removeEventListener("encrypted",this.boundHandleSessionCreation);var l=this._mediaKeySessions,d=this._mediaKeySessionRenewals;Object.values(l).forEach((function(t){t.removeEventListener("message",n.boundStartLicenseSession),asAsync(t.close())})),this._mediaKeySessions={},Object.values(d).forEach((function(t){return clearTimeout(t)})),this._mediaKeySessionRenewals={}},FairplayEncryptedSession.prototype.createSession=function(t){return __awaiter(this,void 0,void 0,(function(){var n,l,d,p,h,f,y,v=this;return __generator(this,(function(_){switch(_.label){case 0:return Le.debug("Encrypted createSession",t),(n=this._keySystemAccess)?(l=t.initData,d=t.target,this._mediaKeysPromise||(this._mediaKeysPromise=new Promise((function(t,l){return __awaiter(v,void 0,void 0,(function(){var l,p;return __generator(this,(function(h){switch(h.label){case 0:return[4,n.createMediaKeys()];case 1:return l=h.sent(),[4,this.loadCertificateBuffer()];case 2:return p=h.sent(),[4,l.setServerCertificate(p)];case 3:return h.sent(),[4,d.setMediaKeys(l)];case 4:return h.sent(),t(l),[2]}}))}))}))),[4,this._mediaKeysPromise]):[2];case 1:return p=_.sent(),h=new Uint8Array(l),f=String.fromCharCode.apply(void 0,Array.from(h)),(y=p.createSession()).extURI=f,[4,y.generateRequest("skd",l)];case 2:return _.sent(),this._mediaKeySessions[y.sessionId]=y,y.addEventListener("message",this.boundStartLicenseSession),[2]}}))}))},FairplayEncryptedSession.prototype.handleLicenseJson=function(n,l,d){return __awaiter(this,void 0,void 0,(function(){var p,h,f,y;return __generator(this,(function(v){switch(v.label){case 0:return n?[4,t.prototype.handleLicenseJson.call(this,n,l,d)]:[2];case 1:return v.sent(),p=n["renew-after"],n.license&&p&&(h=this._mediaKeySessionRenewals,(f=h[l.sessionId])&&clearTimeout(f),y=setTimeout((function(){return l.update(be("renew"))}),1e3*p),h[l.sessionId]=y),[2]}}))}))},FairplayEncryptedSession}(ya),ga=/^(?:.*)(skd:\/\/.+)$/i,ma=function(t){function WebKitSession(){return null!==t&&t.apply(this,arguments)||this}return __extends(WebKitSession,t),WebKitSession.prototype.attachMedia=function(t,n){return this.target=t,t.addEventListener("webkitneedkey",this.boundHandleSessionCreation,!1),t.addEventListener("webkitkeyerror",this.boundDispatchKeyError),t},WebKitSession.prototype.detachMedia=function(t){t&&(t.removeEventListener("webkitneedkey",this.boundHandleSessionCreation,!1),t.removeEventListener("webkitkeyerror",this.boundDispatchKeyError))},WebKitSession.prototype.destroy=function(){Le.debug("FPS destroy"),this.detachMedia(this.target),this.session&&(this.session.removeEventListener("webkitkeyerror",this.boundDispatchKeyError),this.session.removeEventListener("webkitkeymessage",this.boundStartLicenseSession))},WebKitSession.prototype.createSession=function(t){var n=this;Le.debug("FPS createSession",t);var l=t.initData,d=t.target,p=this._extractAssetId(l);if(Le.debug("extURI",p),!d.webkitKeys){var h=new window.WebKitMediaKeys(this.keySystem);d.webkitSetMediaKeys(h)}return this.loadCertificateBuffer().then((function(t){var h=n._concatInitDataIdAndCertificate(l,p,t),f="VIDEO"===d.tagName?Mn.AVC1:Mn.MP4,y=d.webkitKeys.createSession(f,h);n.session=y,y.extURI=p,y.addEventListener("webkitkeyerror",n.boundDispatchKeyError),y.addEventListener("webkitkeymessage",n.boundStartLicenseSession)}))},WebKitSession.prototype._extractAssetId=function(t){var n=String.fromCharCode.apply(null,new Uint16Array(t.buffer||t)),l=n.match(ga);return l&&l.length>=2&&(n=l[1]),Le.debug("Extracted assetId from EXT-X-KEY URI",n),n},WebKitSession.prototype._concatInitDataIdAndCertificate=function(t,n,l){"string"==typeof n&&(n=Pe(n)),l=new Uint8Array(l);var d=0,p=new ArrayBuffer(t.byteLength+4+n.byteLength+4+l.byteLength),h=new DataView(p);new Uint8Array(p,d,t.byteLength).set(t),d+=t.byteLength,h.setUint32(d,n.byteLength,!0),d+=4;var f=new Uint8Array(p,d,n.byteLength);return f.set(n),d+=f.byteLength,h.setUint32(d,l.byteLength,!0),d+=4,new Uint8Array(p,d,l.byteLength).set(l),new Uint8Array(p,0,p.byteLength)},WebKitSession}(ya),ba=function(t){function MSSession(){return null!==t&&t.apply(this,arguments)||this}return __extends(MSSession,t),MSSession.prototype.attachMedia=function(t,n){return this.keySystem=n.keySystem,t.addEventListener("msneedkey",this.boundHandleSessionCreation,!1),t.addEventListener("mskeyerror",this.boundDispatchKeyError),t},MSSession.prototype.detachMedia=function(t){t.removeEventListener("msneedkey",this.boundHandleSessionCreation,!1),t.removeEventListener("mskeyerror",this.boundDispatchKeyError)},MSSession.prototype.createSession=function(t){var n=t.initData,l=t.target;if(!l.msKeys){var d=new MSMediaKeys(this.keySystem);l.msSetMediaKeys(d)}var p=l.msKeys.createSession(Mn.MP4,n);return p.addEventListener("mskeyerror",this.dispatchKeyError),p.addEventListener("mskeymessage",this.startLicenseSession.bind(this)),p},MSSession}(ya);var Pa=function(t){function MediaExtension(n,l){var d=t.call(this,[Cn.playbackLicenseError,Cn.playbackSessionError])||this;return d.audio=n,d.contentType=l,fe.isIE||fe.isSafari&&fe.engineMajorVersion,d}return __extends(MediaExtension,t),Object.defineProperty(MediaExtension.prototype,"hasMediaKeySupport",{get:function(){return hasMediaKeySupport()},enumerable:!0,configurable:!0}),Object.defineProperty(MediaExtension.prototype,"hasMediaSession",{get:function(){return void 0!==this._session},enumerable:!0,configurable:!0}),Object.defineProperty(MediaExtension.prototype,"isFairplay",{get:function(){return this._session.isFairplay},enumerable:!0,configurable:!0}),Object.defineProperty(MediaExtension.prototype,"extURI",{set:function(t){this._session.extURI=t},enumerable:!0,configurable:!0}),Object.defineProperty(MediaExtension.prototype,"initiated",{set:function(t){this._session.initiated=t},enumerable:!0,configurable:!0}),Object.defineProperty(MediaExtension.prototype,"session",{get:function(){return this._session},enumerable:!0,configurable:!0}),MediaExtension.prototype.initializeKeySystem=function(){return __awaiter(this,void 0,void 0,(function(){var t,n=this;return __generator(this,(function(l){switch(l.label){case 0:return[4,this._attachSession()];case 1:return l.sent(),(t=this._session)?([Cn.playbackLicenseError,Cn.playbackSessionError].forEach((function(l){t.addEventListener(l,(function(t){n.dispatchEvent(l,t)}))})),[2]):[2]}}))}))},MediaExtension.prototype._attachSession=function(){var t,n,l;return __awaiter(this,void 0,void 0,(function(){var d,p,h,f,y,v,_,g,m;return __generator(this,(function(b){switch(b.label){case 0:return p=(d=this).audio,h=d.contentType,(null===(t=window.WebKitMediaKeys)||void 0===t?void 0:t.isTypeSupported(Jo.FAIRPLAY+".1_0",Mn.MP4))?(f=!!(null===localStorage||void 0===localStorage?void 0:localStorage.getItem("mk-safari-modern-eme")),m=void 0,f&&this.hasMediaKeySupport?(_=[{initDataTypes:["skd"],audioCapabilities:[{contentType:h,robustness:""}],distinctiveIdentifier:"not-allowed",persistentState:"not-allowed",sessionTypes:["temporary"]}],[4,findMediaKeySystemAccess([Jo.FAIRPLAY],_)]):[3,2]):[3,3];case 1:y=__read.apply(void 0,[b.sent(),2]),v=y[1],m=v,b.label=2;case 2:return m?(Le.warn("media-extension: Using Fairplay modern EME"),this._session=new _a,this._session.attachMedia(p,m)):(Le.warn("media-extension: Using Fairplay legacy EME"),this._session=new ma,this._session.attachMedia(p,{keySystem:Jo.FAIRPLAY})),[3,6];case 3:return(null===(n=window.MSMediaKeys)||void 0===n?void 0:n.isTypeSupported(Jo.PLAYREADY,Mn.MP4))?(this._session=new ba,this._session.attachMedia(p,{keySystem:Jo.PLAYREADY}),[3,6]):[3,4];case 4:return this.hasMediaKeySupport&&p.canPlayType(h)?(this._session=new va,_=[{initDataTypes:["cenc","keyids"],audioCapabilities:[{contentType:h}],distinctiveIdentifier:"optional",persistentState:"required"}],[4,findMediaKeySystemAccess(potentialKeySystemsForAccess(),_)]):[3,6];case 5:g=__read.apply(void 0,[b.sent(),2]),(m=g[1])?null===(l=this._session)||void 0===l||l.attachMedia(p,m):Le.warn("media-extension: No keysystem detected!"),b.label=6;case 6:return[2]}}))}))},MediaExtension.prototype.setMediaItem=function(t){!function(t,n){n.keyURLs&&(t.developerToken=pa.developerToken,t.userToken=pa.musicUserToken,t.item=n,t.adamId=n.songId,t.isLibrary=n.isCloudItem,t.setKeyURLs(n.keyURLs))}(this._session,t)},MediaExtension.prototype.destroy=function(t){this._session&&this._session.detachMedia(t)},MediaExtension}(ke),Ta=function(){function ByteRangeSegment(t){var n=t.url,l=t.startByte,d=t.length,p=t.isInitSegment,h=void 0!==p&&p;this.url=n,this.isInitSegment=h,this.startByte=parseInt(l,10),this.length=parseInt(d,10),this.endByte=this.startByte+this.length-1,this.range="bytes="+this.startByte+"-"+this.endByte}return ByteRangeSegment.prototype.load=function(){return __awaiter(this,void 0,void 0,(function(){var t,n,l,d,p;return __generator(this,(function(h){switch(h.label){case 0:return n=(t=this).url,l=t.range,n?((d=new Headers).append("Range",l),[4,fetch(n,{headers:d})]):[2,new Uint8Array];case 1:return[4,h.sent().arrayBuffer()];case 2:return p=h.sent(),[2,new Uint8Array(p)]}}))}))},ByteRangeSegment}(),Sa=function(){function ContinuousSegment(t,n){void 0===n&&(n=!1),this.url=t,this.isInitSegment=n}return ContinuousSegment.prototype.load=function(){return __awaiter(this,void 0,void 0,(function(){var t,n;return __generator(this,(function(l){switch(l.label){case 0:return(t=this.url)?(Le.debug("radio-segment: loading",t),[4,fetch(t)]):[2,new Uint8Array];case 1:return[4,l.sent().arrayBuffer()];case 2:return n=l.sent(),[2,new Uint8Array(n)]}}))}))},ContinuousSegment}(),ka=/^#EXT-X-BYTERANGE:([^\n]+)\n/gim,Aa=/^#EXT-X-MAP:([^\n]+)\n/im,Ia=/#EXTINF:\d*\.\d*\,[\n](.+)|^#EXT-X-MAP:URI="([^"]*)"/gim,Ea=/#EXTINF:\d*\.\d*,\s*#EXT-X-BITRATE:\d{1,3}[\n](.+)|^#EXT-X-MAP:URI="([^"]*)"/gim;var wa=function(){function SegmentList(){this._segments=[],this._addedSegments={}}return Object.defineProperty(SegmentList.prototype,"segments",{get:function(){return this._segments},enumerable:!0,configurable:!0}),SegmentList.prototype.addSegment=function(t,n){this._addedSegments[n]||(Le.debug("Adding segment",n),this._segments.push(t),this._addedSegments[n]=!0)},SegmentList.prototype.extractLiveRadioSegments=function(t,n){this._extractContinuousSegments(Ia,t,n)},SegmentList.prototype.extractHlsOffersSegments=function(t,n){this._extractContinuousSegments(Ea,t,n)},SegmentList.prototype._extractContinuousSegments=function(t,n,l){var d;if(n&&t.test(n))for(t.lastIndex=0;d=t.exec(n);){var p=d[0].startsWith("#EXT-X-MAP")?d[2]:d[1],h=rewriteLastUrlPath(l,p),f=d[0].startsWith("#EXT-X-MAP");this.addSegment(new Sa(h,f),p)}},SegmentList.prototype.extractByteRangeSegments=function(t,n){var l,d,p=this;if(t&&ka.test(t)){var h=function(t){if(t&&Aa.test(t))return __read(t.match(Aa),2)[1].split(",").reduce((function(t,n){var l=__read(n.split("="),2),d=l[0],p=l[1];return t[d.toLowerCase()]=p.replace(/\"/gi,""),t}),{})}(t),f=null!==(l=n.split("/").pop())&&void 0!==l?l:"",y=n.replace(f,h.uri),v=__read(h.byterange.split("@"),2),_=v[0],g=v[1],m=new Ta({url:y,startByte:g,length:_});this.addSegment(m,m.range),(null!==(d=t.match(ka))&&void 0!==d?d:[]).forEach((function(t){var n=__read(t.match(/^#EXT-X-BYTERANGE:(\d+)@(\d+)\n/),3),l=n[1],d=n[2],h=new Ta({url:y,startByte:d,length:l});p.addSegment(h,h.range)}))}},SegmentList}(),Oa=/^#EXT-X-TARGETDURATION:(\d+)/im,Ra=/^#EXT-X-KEY:[^\n]+URI="([^"]+)"/im;function loadManifestData(t){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(n){switch(n.label){case 0:return[4,fetch(t)];case 1:return[2,n.sent().text()]}}))}))}var Ca=function(t){function Manifest(n,l){var d=t.call(this,[Cn.manifestParsed])||this;if(d._downlink=0,d._segmentList=new wa,d._data=n,d._item=l,d._url=l.assetURL,!(ra!==Jo.FAIRPLAY))return d;if(l.hasOffersHlsUrl)d._segmentList.extractHlsOffersSegments(n,l.assetURL);else if(l.isLiveRadioStation){d._segmentList.extractLiveRadioSegments(n,l.assetURL);var p=__read(d._data.match(Oa),2)[1];Le.debug("manifest: setting up manifest refresh interval at "+p+" seconds");var h=1e3*parseInt(p,10);d._manifestRefreshInterval=setInterval(d.liveRadioRefresh,h)}else d._segmentList.extractByteRangeSegments(n,l.assetURL);return d}return __extends(Manifest,t),Manifest.load=function(t,n){return void 0===n&&(n=!0),__awaiter(this,void 0,void 0,(function(){var l,d,p,h,f;return __generator(this,(function(y){switch(y.label){case 0:return l=t.assetURL,(p=!!window.sessionStorage&&n)&&(d=window.sessionStorage.getItem(l))?[2,new this(d,t)]:(h=(new Date).getTime(),[4,loadManifestData(l)]);case 1:return d=y.sent(),(f=new this(d,t)).downlink=function(t,n){return 8*n.length/(((new Date).getTime()-t)/1e3)/1024}(h,d),p&&window.sessionStorage.setItem(l,d),[2,Promise.resolve(f)]}}))}))},Object.defineProperty(Manifest.prototype,"downlink",{get:function(){return this._downlink},set:function(t){this._downlink=t},enumerable:!0,configurable:!0}),Object.defineProperty(Manifest.prototype,"mediaItem",{get:function(){return this._item},enumerable:!0,configurable:!0}),Manifest.prototype.liveRadioRefresh=function(){return __awaiter(this,void 0,void 0,(function(){var t;return __generator(this,(function(n){switch(n.label){case 0:return[4,loadManifestData(this._url)];case 1:return t=n.sent(),this._data=t,this._segmentList.extractLiveRadioSegments(t,this._url),this.dispatchEvent(Cn.manifestParsed),[2]}}))}))},Manifest.prototype.segmentsForTimeRange=function(t){var n=Math.floor(t.start/10)+1,l=Math.floor(t.end/10)+1,d=this.segments;return __spread([d[0]],d.slice(n,l+1))},Object.defineProperty(Manifest.prototype,"segments",{get:function(){return this._segmentList.segments},enumerable:!0,configurable:!0}),Object.defineProperty(Manifest.prototype,"extURI",{get:function(){if(!this._extURI){var t=this._data.match(Ra);Le.debug("manifest: EXT_X_KEY_URI matches",t),this._extURI=t&&t[1]||void 0}return this._extURI},enumerable:!0,configurable:!0}),Manifest.prototype.stop=function(){this._manifestRefreshInterval&&clearInterval(this._manifestRefreshInterval)},__decorate([Bind(),__metadata("design:type",Function),__metadata("design:paramtypes",[]),__metadata("design:returntype",Promise)],Manifest.prototype,"liveRadioRefresh",null),Manifest}(ke),rewriteDefaultKid=function(t){var n=function(t){var n=findBox(t,0,["moov","trak","mdia","minf","stbl","stsd"]);if(n){var l,d=36;if((l=findBox(t,n.start+16,["enca"]))||(l=findBox(t,n.start+16,["encv"]),d=86),l){var p=findBox(t,l.start+d,["sinf","schi","tenc"]);return p?new da(p.data,p.start,p.end):void 0}}}(t);if(n){var l=function(t){var n=findBox(t,0,["moov"]),l=[];if(!n)return l;for(var d=new DataView(t.buffer,0),p=n.start+8;p<n.size;){var h=d.getUint32(p);"pssh"===encodedArrayToString(t.subarray(p+4,p+8))&&l.push(new la(t,p,p+h)),p+=h}return l}(t).find((function(t){return t.isWidevine}));l&&(n.defaultKeyId=l.keyBytes)}};function readSynchSafeUint32(t){return 2097152*(127&t[0])+16384*(127&t[1])+128*(127&t[2])+(127&t[3])}var Ma={0:"iso-8859-1",1:"utf-16",2:"utf-16be",3:"utf-8"},Na={TPE1:!0,TIT2:!0,WXXX:!0,PRIV:!0,TALB:!0,CHAP:!0},Da=function(){function ID3(t){this.frames=[],this.unsynchronized=!1,this.hasExtendedHeader=!1,this.hasFooter=!1,this.isExperimental=!1;var n=0,l=ge(t.subarray(n,n+3));if(n+=3,"ID3"===l){this.minor=t[n++],this.revision=t[n++];var d=t[n++];this._parseID3Flags(d);var p=readSynchSafeUint32(t.subarray(n,n+4));n+=4,this.frameLength=p;var h=n+p;if(this.endPos=h,this.hasExtendedHeader)n+=readSynchSafeUint32(t.subarray(n,n+4));this.minor>2&&this._parseID3Frames(this,t,n,h)}}return ID3.prototype._parseID3Flags=function(t){this.unsynchronized=isBitAtPositionOn(t,7),this.hasExtendedHeader=isBitAtPositionOn(t,6),this.isExperimental=isBitAtPositionOn(t,5),this.hasFooter=isBitAtPositionOn(t,4)},ID3.prototype._parseID3Frames=function(t,n,l,d){for(var p=new DataView(n.buffer,0,d),h=this.minor;l+8<=d;){var f=ge(n.subarray(l,l+4));l+=4;var y=4===h?readSynchSafeUint32(n.subarray(l,l+4)):p.getUint32(l);l+=4;n[l++],n[l++];if(Na[f]){var v=l,_=this._extractID3FramePayload(n,f,y,v,d);if(_){var g=this.decodeID3Frame(_);g&&t.frames.push(g)}l+=y}else l+=y}},ID3.prototype._extractID3FramePayload=function(t,n,l,d,p){var h,f=d+l;return f<=p&&(h={type:n,size:l,data:t.slice(d,f)}),h},ID3.prototype.decodeID3Frame=function(t){if("TXXX"!==t.type)return"WXXX"===t.type?this.decodeWxxxFrame(t):"PRIV"===t.type?this.decodePrivFrame(t):"CHAP"===t.type?this.decodeChapFrame(t):"T"===t.type[0]?this.decodeTextFrame(t):{key:t.type,data:t.data}},ID3.prototype.decodeChapFrame=function(t){var n=t.data,l=new DataView(n.buffer),d={key:"CHAP",frames:[]},p=__read$1(readNullTerminatedString(n,0,n.length),2),h=p[0],f=p[1];return d.id=h,f++,d.startTime=l.getUint32(f),f+=4,d.endTime=l.getUint32(f),f+=4,f+=4,f+=4,this._parseID3Frames(d,n,f,n.length),d},ID3.prototype.decodeTextFrame=function(t){var n=t.data,l=Ma[n[0]],d=encodedArrayToString(n.subarray(1),l);return{key:t.type,text:d}},ID3.prototype.decodeWxxxFrame=function(t){var n=t.data,l=Ma[n[0]],d=1,p=encodedArrayToString(n.subarray(d),l);return d+=p.length+1,{key:"WXXX",description:p,text:encodedArrayToString(n.subarray(d))}},ID3.prototype.decodePrivFrame=function(t){var n=encodedArrayToString(t.data);if(n)return{key:"PRIV",info:n,data:t.data.slice(n.length+1)}},ID3}();function checkBoxName(t,n,l){return!(n+4>t.length)&&(t[n]===l[0]&&t[n+1]===l[1]&&t[n+2]===l[2]&&t[n+3]===l[3])}function findEmsgs(t){var n=t.length,l=[];if(function(t){return(null==t?void 0:t.length)>=8&&checkBoxName(t,4,[102,116,121,112])}(t))return l;for(var d=0;d<n;d++){if(checkBoxName(t,d,[109,111,111,102]))return l;if(checkBoxName(t,d,[101,109,115,103])){var p=d-4,h=new DataView(t.buffer,p).getUint32(0),f=t.subarray(p,p+h);d=d+h-1,l.push(f)}}return l}var La,xa,Ua={TALB:"album",TIT2:"title",TPE1:"performer"},Ba=["performer","title","album"],ja=function(){function TimedMetadata(t){var n=this;this.links=[],this.storefrontToIds={},t.forEach((function(t){var l,d,p=t.key,h=Ua[p];if(h)n[h]=null===(l=t.text)||void 0===l?void 0:l.replace(/\0/g,"");else if("WXXX"===t.key){if(t.description){var f=__read$1(t.description.split("\0"),2),y=f[0],v=f[1];n.links.push({description:y,url:v})}}else if("PRIV"===t.key){var _=null===(d=t.info)||void 0===d?void 0:d.split("\0");if(_&&_.length)if(_[0].startsWith("com.apple.radio.adamid"))_[1].split(",").forEach((function(t){var l=__read$1(t.split(":"),2),d=l[0],p=l[1];d&&p&&"0"!==p&&!n.storefrontToIds.hasOwnProperty(d)&&(n.storefrontToIds[d]=p)}))}}))}return TimedMetadata.prototype.resolveAdamIdFromStorefront=function(t){var n=this.storefrontToIds[t];this._adamId=n},Object.defineProperty(TimedMetadata.prototype,"adamId",{get:function(){return this._adamId},enumerable:!0,configurable:!0}),TimedMetadata.prototype.equals=function(t){var n=this;if(!Ba.every((function(l){return n[l]===t[l]})))return!1;var l=this.links,d=t.links;if(l.length!==d.length)return!1;for(var p=0;p<l.length;p++){var h=l[p].description===d[p].description,f=l[p].url===d[p].url;if(!h||!f)return!1}return!0},TimedMetadata}(),Fa=function(){function Emsg(t){this.data=t;var n=new DataView(t.buffer),l=8;if(1===t[l]){l+=4,this.timeScale=n.getUint32(l),l+=4;var d=n.getUint32(l);l+=4;var p=n.getUint32(l);if(l+=4,this.presentationTime=Math.pow(2,32)*d+p,!Number.isSafeInteger(this.presentationTime))throw this.presentationTime=Number.MAX_SAFE_INTEGER,new Error("Failed to create 64 bit integer");this.eventDuration=n.getUint32(l),l+=4,this.id=n.getUint32(l);var h=__read$1(readNullTerminatedString(t,l+=4),2),f=h[0];l+=h[1]+1,this.schemeIdUri=f;var y=__read$1(readNullTerminatedString(t,l),2);y[0];l+=y[1]+1,this.payload=t.subarray(l,t.byteLength),this.id3=new Da(this.payload)}}return Object.defineProperty(Emsg.prototype,"length",{get:function(){return this.data.length},enumerable:!0,configurable:!0}),Object.defineProperty(Emsg.prototype,"elementPresentationTime",{get:function(){var t=this.presentationTime,n=this.timeScale;return t&&n?Math.round(t/n):NaN},enumerable:!0,configurable:!0}),Object.defineProperty(Emsg.prototype,"timedMetadata",{get:function(){var t;if(this._timedMetadata)return this._timedMetadata;var n=null===(t=this.id3)||void 0===t?void 0:t.frames;return n?(this._timedMetadata=new ja(n),this._timedMetadata):void 0},enumerable:!0,configurable:!0}),Emsg}(),Ka=function(){function TimedMetadataManager(t,n){this._currentTime=t,this._onDidChange=n,this._emsgLookup={},this._getCurrentEmsg=this._getCurrentEmsg.bind(this)}return TimedMetadataManager.prototype.processEmsgs=function(t){var n=this,l=findEmsgs(t);l.length&&(this._currentEmsgInterval||(this._currentEmsgInterval=setInterval(this._getCurrentEmsg,1e3)),l.forEach((function(t){var l=new Fa(t);n._emsgLookup[l.elementPresentationTime]=l})))},TimedMetadataManager.prototype.stop=function(){var t=this._currentEmsgInterval;t&&clearInterval(t)},TimedMetadataManager.prototype._getCurrentEmsg=function(){for(var t=this._currentTime,n=this._emsgLookup,l=Math.round(t()),d=[],p=Object.keys(n),h=0;h<p.length;h++){var f=parseInt(p[h],10);if(!(f<l))break;d.push(f)}var y=d.pop();if(y){var v=n[y];if(!v)return;var _=this._currentEmsg,g=this._onDidChange,m=null==_?void 0:_.payload,b=v.payload;m&&arrayEquals(m,b)||(this._currentEmsg=v,g(v)),this._cleanupEmsgs(y)}},TimedMetadataManager.prototype._cleanupEmsgs=function(t){var n=this._emsgLookup;Object.keys(n).forEach((function(l){parseInt(l,10)<t&&delete n[l]}))},TimedMetadataManager}(),Va=function(){function SegmentProcessor(t,n,l){this._item=t,this._timedMetadataManager=new Ka((function(){return n.currentTime}),(function(t){l.publish(En,t.timedMetadata)}))}return SegmentProcessor.prototype.process=function(t,n){var l=this._item;try{l.isLiveRadioStation?this._processLiveRadioSegment(n):l.hasOffersHlsUrl&&this._processHlsOffersSegment(t,n)}catch(e){Le.error("Error processing segment",e)}},SegmentProcessor.prototype.stop=function(){this._timedMetadataManager.stop()},SegmentProcessor.prototype._processHlsOffersSegment=function(t,n){t.isInitSegment&&rewriteDefaultKid(n)},SegmentProcessor.prototype._processLiveRadioSegment=function(t){this._timedMetadataManager.processEmsgs(t)},SegmentProcessor}(),$a=new De({levelFilterStorageKey:"mk-mse-buffer",topic:"mse-buffer"}),Ya=!!localStorage.getItem("mk-mse-buffer"),Ha=Cn.manifestParsed,Wa=function(){function MseBuffer(t){var n=t.dispatcher,l=t.element,d=t.manifest,p=t.currentTime,h=t.duration,f=t.clip;this.firstSegmentLoadPromise=Promise.resolve(),this.hasKickstarted=!1,this.segmentIndexToFetch=-1,this.timeToTrim=10,this.isAtEndOfStream=!1,this.isFullyBuffered=!1,this.deferredRemoves=[],this.currentTimestampOffset=0,this.dispatcher=n,this.clip=f,this.element=l,this.mediaSource=new MediaSource,this.mediaSource.addEventListener("sourceopen",this.onSourceOpen),this.segmentProcessor=new Va(d.mediaItem,l,n),this.playbackTimeline={current:{manifest:d}},d.addEventListener(Ha,this.onManifestParsed),this._currentTime=p||0,this.duration=h,window.mseBuffer=this}return MseBuffer.prototype.onSourceOpen=function(){$a.debug("mediaSource open handler");var t=this.mediaSource;if(t.activeSourceBuffers.length>0)$a.debug("not adding new source buffer");else{$a.debug("adding new source buffer");var n=t.addSourceBuffer('audio/mp4;codecs="mp4a.40.2"');this.sourceBuffer=n,n.addEventListener("updateend",this.updateEndHandler);var l=this.clip,d=this.hasAppendWindowSupport;l&&(d?($a.debug("appendWindowStart/End",l.start,l.end),n.appendWindowStart=l.start,n.appendWindowEnd=l.end):($a.debug("seeking for clip",l.start),asAsync(this.seek(l.start)))),this.updateSegmentToFetch(0,!0)}},MseBuffer.prototype.setNextManifest=function(t){$a.debug("setting next manifest for ",t.mediaItem.title),this.playbackTimeline.next={manifest:t},this.isFullyBuffered&&($a.debug("current song is fully buffered, beginning transition to next"),this.transitionToNextManifest())},Object.defineProperty(MseBuffer.prototype,"currentItem",{get:function(){return this.manifest.mediaItem},enumerable:!0,configurable:!0}),Object.defineProperty(MseBuffer.prototype,"playableUrl",{get:function(){var t=this._playableUrl;return t||(t=window.URL.createObjectURL(this.mediaSource),$a.debug("created url",t),this._playableUrl=t,t)},enumerable:!0,configurable:!0}),Object.defineProperty(MseBuffer.prototype,"segments",{get:function(){var t=this.manifest,n=this.clip;return n?t.segmentsForTimeRange(n):t.segments||[]},enumerable:!0,configurable:!0}),Object.defineProperty(MseBuffer.prototype,"currentTime",{get:function(){return this._currentTime},set:function(t){var n,l;if(t+=this.currentTimestampOffset,this._currentTime!==t){var d=this.nextGaplessTransition;if(d&&t>=d){this.currentTimestampOffset=this.nextGaplessTransition||0,this.nextGaplessTransition=void 0,this.duration=this.manifest.mediaItem.playbackDuration/1e3;var p={previous:null===(l=null===(n=this.playbackTimeline.previous)||void 0===n?void 0:n.manifest)||void 0===l?void 0:l.mediaItem,current:this.manifest.mediaItem};$a.debug("dispatching gapless transition",p),this.dispatcher.publish(In,p)}this._currentTime=t;var h=this.isOverBufferLimit,f=this.timeToTrim,y=t>this.timeToTrim;h&&y&&($a.debug("buffer over limit, trimming to ",f),this.removeToTime(f),this.timeToTrim+=10)}},enumerable:!0,configurable:!0}),Object.defineProperty(MseBuffer.prototype,"hasAppendWindowSupport",{get:function(){var t;return void 0!==(null===(t=this.sourceBuffer)||void 0===t?void 0:t.appendWindowStart)},enumerable:!0,configurable:!0}),MseBuffer.prototype.seek=function(t){return __awaiter(this,void 0,void 0,(function(){var n,l,d,p,h,f,y=this;return __generator(this,(function(v){switch(v.label){case 0:return l=(n=this).duration,d=n.seekWhenUpdated,p=n.sourceBuffer,this.resolveSeekPromise(!1),$a.debug("seek to ",t),this.revertGaplessTrasition(),(t=+t)>l||!p?[2,!1]:p.updating?($a.debug("sourcebuffer updating, deferring seek"),[2,new Promise((function(n){d&&d.resolve(!1),y.seekWhenUpdated={seek:y.seek.bind(y,t),resolve:n}}))]):(this.removeToTime(t),this.timeToTrim=10*Math.floor(t/10),0===(h=this.getSegmentForTime(t))?[3,2]:[4,this.firstSegmentLoadPromise]);case 1:v.sent(),v.label=2;case 2:return $a.debug("seeking to",t,"segment",h),this.updateSegmentToFetch(h,!0),f=new Promise((function(n){y.seekResolver={time:t,resolve:n}})),this.checkSeekBuffered(),[2,f]}}))}))},MseBuffer.prototype.revertGaplessTrasition=function(){var t=this.playbackTimeline;if(this.nextGaplessTransition&&t.previous){this.clearBuffer(),$a.debug("abandoning transition to "+this.manifest.mediaItem.title),t.next=t.current,t.current=t.previous,t.previous=void 0;var n=this.manifest.mediaItem;$a.debug("current item reverted to "+n.title),this.nextGaplessTransition=void 0,this.timestampOffsetAdjustment=0,this.currentTimestampOffset=0,this.duration=n.playbackDuration/1e3,$a.debug("!reverted timestampOffset to 0 and duration to "+this.duration),this.updateSegmentToFetch(0,!0)}else $a.debug("no need to revert, no transition")},Object.defineProperty(MseBuffer.prototype,"streamHasEnding",{get:function(){return!this.manifest.mediaItem.isLiveRadioStation},enumerable:!0,configurable:!0}),MseBuffer.prototype.stop=function(){this.segmentProcessor.stop(),this.setEndOfStream()},MseBuffer.prototype.remove=function(){var t;$a.debug("removing sourceBuffer and mediaSource");var n=this.sourceBuffer,l=this.mediaSource;null===(t=this.seekResolver)||void 0===t||t.resolve(!1),this.manifest.removeEventListener(Ha,this.onManifestParsed);var d=this._playableUrl;d&&($a.debug("revoking url",d),window.URL.revokeObjectURL(d)),l.removeEventListener("sourceopen",this.onSourceOpen),n&&(n.removeEventListener("updateend",this.updateEndHandler),l.removeSourceBuffer(n),this.sourceBuffer=void 0)},MseBuffer.prototype.onManifestParsed=function(){var t=this.segmentIndexToFetch+1;$a.debug("manifestParsed, loading segment",t),this.updateSegmentToFetch(t,!0)},MseBuffer.prototype.updateEndHandler=function(){if(this.kickstartBuffer(),!this.clearDeferredRemove()){if($a.debug("update end",this.seekWhenUpdated),this.seekWhenUpdated){$a.debug("updateEndHandler resolving seekWhenUpdated");var t=this.seekWhenUpdated;return asAsync(t.seek().then(t.resolve)),void(this.seekWhenUpdated=void 0)}this.checkSeekBuffered();var n=this.clip,l=this.sourceBuffer,d=this.hasAppendWindowSupport;if(n&&l&&!d){var p=l.buffered;if(this.isTimeBuffered(n.end+1)){var h=p.end(p.length-1);return $a.debug("clipping sourcebuffer to",n.end,h),void l.remove(n.end,h)}}if(this.isAtEndOfStream)return this.streamHasEnding&&($a.debug("isAtEndOfStream, not fetching any more segments"),this.setEndOfStream(),this.transitionToNextManifest()),void(this.isAtEndOfStream=!1);$a.debug("updateEndHandler invoking loadSegment"),asAsync(this.loadSegment())}},MseBuffer.prototype.clearDeferredRemove=function(){var t;if(0===this.deferredRemoves.length)return!1;var n=this.deferredRemoves.shift();return null===(t=this.sourceBuffer)||void 0===t||t.remove(n.start,n.end),!0},MseBuffer.prototype.transitionToNextManifest=function(){var t;$a.debug("beginning transition to next manifest");var n=this.playbackTimeline,l=this.sourceBuffer;if(n.next&&l){var d=this.endOfBufferTime||this.currentTimestampOffset;$a.debug("setting gapless transition at",d),this.nextGaplessTransition=d,this.timestampOffsetAdjustment=d,this.playbackTimeline.current.endTime=d,n.previous=n.current,$a.debug("previous manifest set to",null===(t=n.previous)||void 0===t?void 0:t.manifest.mediaItem.title),n.current=n.next,$a.debug("current manifest set to",n.current.manifest.mediaItem.title),n.next=void 0,this.updateSegmentToFetch(0,!0)}else $a.debug("no next manifest")},MseBuffer.prototype.updateSegmentToFetch=function(t,n){void 0===n&&(n=!1),this.segments.length&&t<this.segments.length&&t!==this.segmentIndexToFetch&&(this.segmentIndexToFetch=t,n&&($a.debug("updateSegmentToFetch invoking loadSegment"),asAsync(this.loadSegment())))},MseBuffer.prototype.loadSegment=function(){return __awaiter(this,void 0,void 0,(function(){var t,n,l,d,p,h,f,y;return __generator(this,(function(v){switch(v.label){case 0:if(t=this.segmentIndexToFetch,!(n=this.segments[t]))return[2];v.label=1;case 1:return v.trys.push([1,3,,4]),$a.debug("loadSegment "+t),l=n.load(),0===t&&(this.firstSegmentLoadPromise=l),[4,l];case 2:if(d=v.sent(),0!==t&&t!==this.segmentIndexToFetch)return $a.debug("load segment index to fetch changed, not processing bytes for segment",t),[2];if(this.segmentProcessor.process(n,d),$a.debug("loadSegment processed: "+t),h=(p=this).sourceBuffer,f=p.timestampOffsetAdjustment,!h)return[2];try{"number"==typeof f&&($a.debug("adjusting timestampOffset of sourcebuffer to",f),h.timestampOffset=f,this.timestampOffsetAdjustment=void 0),h.appendBuffer(d),this.isFullyBuffered=!1,this.isOverBufferLimit=!1,$a.debug("appended to buffer",d.length),this.printBufferTimes(),t===this.segments.length-1?this.isAtEndOfStream=!0:t===this.segmentIndexToFetch&&($a.debug("loadSegment bumping segment index to fetch to ",t+1),this.updateSegmentToFetch(t+1))}catch(_){"QuotaExceededError"===_.name?(this.isOverBufferLimit=!0,$a.debug("reached buffer limit")):$a.warn("Error appending to source buffer",_)}return[3,4];case 3:return y=v.sent(),$a.error("Error loading segment",y),[3,4];case 4:return[2]}}))}))},MseBuffer.prototype.setEndOfStream=function(){var t=this.sourceBuffer,n=this.mediaSource;t&&"ended"!==n.readyState&&(t.updating||"open"!==n.readyState?$a.error("Could not end of stream (updating, readyState)",t.updating,n.readyState):($a.debug("mediaSource.endOfStream"),n.endOfStream(),this.isFullyBuffered=!0))},MseBuffer.prototype.removeToTime=function(t){$a.debug("removing to time",t),t>0&&this.isTimeBuffered(t)&&this.safeSourceBufferRemove(0,t)},MseBuffer.prototype.safeSourceBufferRemove=function(t,n){var l=this.sourceBuffer;l&&(l.updating?this.deferredRemoves.push({start:t,end:n}):l.remove(t,n))},Object.defineProperty(MseBuffer.prototype,"previousOffset",{get:function(){var t,n;return(null===(n=null===(t=this.playbackTimeline)||void 0===t?void 0:t.previous)||void 0===n?void 0:n.endTime)||0},enumerable:!0,configurable:!0}),Object.defineProperty(MseBuffer.prototype,"manifest",{get:function(){var t;return null===(t=this.playbackTimeline.current)||void 0===t?void 0:t.manifest},enumerable:!0,configurable:!0}),MseBuffer.prototype.checkSeekBuffered=function(){var t=this.seekResolver,n=this.currentTimestampOffset;if(t){var l=t.time,d=l+n,p=this.isTimeBuffered(d);$a.debug("resolving seek for time, adjustedTime, isBuffered",l,d,p),this.printBufferTimes(),p&&($a.debug("resolving seek to true for time:",d),this.element.currentTime=d,this.resolveSeekPromise(!0))}},MseBuffer.prototype.resolveSeekPromise=function(t){this.seekResolver&&(this.seekResolver.resolve(t),this.seekResolver=void 0)},Object.defineProperty(MseBuffer.prototype,"endOfBufferTime",{get:function(){var t,n=null===(t=this.sourceBuffer)||void 0===t?void 0:t.buffered;return!(!n||!n.length)&&Math.floor(n.end(n.length-1))},enumerable:!0,configurable:!0}),MseBuffer.prototype.isTimeBuffered=function(t){var n,l=null===(n=this.sourceBuffer)||void 0===n?void 0:n.buffered;if(!l)return!1;for(var d=0;d<l.length;d++)if($a.debug("isTimeBuffered",l.start(d),t,l.end(d)),t>=l.start(d)&&t<=l.end(d))return!0;return!1},MseBuffer.prototype.clearBuffer=function(){var t=this.sourceBuffer;if(t&&t.buffered)for(var n=t.buffered,l=0;l<n.length;l++)this.safeSourceBufferRemove(n.start(l),n.end(l))},MseBuffer.prototype.printBufferTimes=function(){var t;if(Ya){var n=null===(t=this.sourceBuffer)||void 0===t?void 0:t.buffered;if(n){for(var l=[],d=0;d<n.length;d++)l.push("start "+n.start(d)+" end: "+n.end(d));$a.debug("buffer times",l.join(","))}}},MseBuffer.prototype.getSegmentForTime=function(t){return Math.floor(t/10)+1},MseBuffer.prototype.kickstartBuffer=function(){var t=this.hasKickstarted,n=this.element,l=this.clip,d=n.buffered;t||(this.manifest.mediaItem.isSong?l&&this.isTimeBuffered(l.start)&&(n.currentTime=l.start,this.hasKickstarted=!0):d.length&&(n.currentTime=d.start(0),this.hasKickstarted=!0))},__decorate([Bind(),__metadata("design:type",Function),__metadata("design:paramtypes",[]),__metadata("design:returntype",void 0)],MseBuffer.prototype,"onSourceOpen",null),__decorate([Bind(),__metadata("design:type",Function),__metadata("design:paramtypes",[]),__metadata("design:returntype",void 0)],MseBuffer.prototype,"onManifestParsed",null),__decorate([Bind(),__metadata("design:type",Function),__metadata("design:paramtypes",[]),__metadata("design:returntype",void 0)],MseBuffer.prototype,"updateEndHandler",null),MseBuffer}(),za=nn,Ga=function(n){function AudioPlayer(t){var l=n.call(this,t)||this;return l.currentAudioTrack=void 0,l.currentTextTrack=void 0,l.textTracks=[],l.audioTracks=[],l.mediaPlayerType="audio",l}return __extends(AudioPlayer,n),Object.defineProperty(AudioPlayer.prototype,"_targetElement",{get:function(){return this.audio},enumerable:!0,configurable:!0}),AudioPlayer.prototype.initializeExtension=function(){return __awaiter(this,void 0,void 0,(function(){var t=this;return __generator(this,(function(n){switch(n.label){case 0:return this.extension=new Pa(this.audio,'audio/mp4;codecs="mp4a.40.2"'),[4,this.extension.initializeKeySystem()];case 1:return n.sent(),this.extension.addEventListener(Cn.playbackLicenseError,(function(n){t._licenseError(),t._dispatcher.publish(za,n)})),this.extension.addEventListener(Cn.playbackSessionError,(function(n){t._dispatcher.publish(za,new Fe(Fe.MEDIA_SESSION,n))})),[2]}}))}))},AudioPlayer.prototype.initializeMediaElement=function(){return __awaiter(this,void 0,void 0,(function(){var t;return __generator(this,(function(n){return(t=function(){var t=Ro.pop();return t?Le.debug("dom-helpers: retrieving audio tag, "+Ro.length+" remain"):(Le.debug("dom-helpers: no available audio tags, creating one"),t=document.createElement("audio")),t}()).autoplay=!1,t.id="apple-music-player",t.controls=!1,t.muted=!1,t.playbackRate=1,t.preload="metadata",t.volume=1,this.audio=t,document.body.appendChild(t),Le.debug("initializedMediaElement",t),[2]}))}))},AudioPlayer.prototype.isPlayerSupported=function(){return!0},AudioPlayer.prototype._stopMediaElement=function(){var t,l;return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(d){switch(d.label){case 0:return[4,n.prototype._stopMediaElement.call(this)];case 1:return d.sent(),null===(t=this.manifest)||void 0===t||t.stop(),null===(l=this._buffer)||void 0===l||l.stop(),[2]}}))}))},AudioPlayer.prototype.setNextGaplessItem=function(t){return __awaiter(this,void 0,void 0,(function(){var n,l,d;return __generator(this,(function(p){switch(p.label){case 0:return n=this.extension,(l=this._buffer)&&n?[4,Ca.load(t,!1)]:[2];case 1:return d=p.sent(),l.setNextManifest(d),n.setMediaItem(t),n.extURI=d.extURI,[2]}}))}))},AudioPlayer.prototype.playItemFromEncryptedSource=function(n,l,p){return void 0===l&&(l=!1),__awaiter(this,void 0,void 0,(function(){var h,f,y,v,_;return __generator(this,(function(g){switch(g.label){case 0:return h=this._paused&&!l,n.playRawAssetURL?(n.playbackType=t.PlaybackType.unencryptedFull,this.nowPlayingItem=n,[2,this._playAssetURL(n.assetURL,h)]):(f=this.extension)?(f.initiated=l,f.setMediaItem(n),n.playbackType=t.PlaybackType.encryptedFull,this.nowPlayingItem=n,n.state=d.loading,[4,Ca.load(n,!1)]):[2];case 1:return y=g.sent(),this.manifest=y,n.isSong&&(f.extURI=y.extURI),n.state=d.ready,f.isFairplay?(v=n.assetURL,(null==p?void 0:p.startTime)&&(v+="#t="+p.startTime),[2,this._playAssetURL(v,h)]):(_=this._buffer)?(Le.debug("new item to play, tearing down old buffer"),_.remove(),[2,this.beginNewBufferForItem(n,h,y,p)]):[2,this.beginNewBufferForItem(n,h,y,p)]}}))}))},AudioPlayer.prototype.beginNewBufferForItem=function(t,n,l,d){return __awaiter(this,void 0,void 0,(function(){var p,h=this;return __generator(this,(function(f){switch(f.label){case 0:return Le.debug("creating new MseBuffer"),this._buffer=new Wa({dispatcher:this._dispatcher,element:this._targetElement,duration:t.playbackDuration/1e3,manifest:l}),[4,this._playAssetURL(this._buffer.playableUrl,!0)];case 1:return f.sent(),n?[2]:(p=Promise.resolve(),(null==d?void 0:d.startTime)&&(p=this.seekToTime(d.startTime)),[2,p.then((function(){return h._playMedia()}))])}}))}))},AudioPlayer.prototype.setPresentationMode=function(t){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(t){return[2,Promise.resolve()]}))}))},AudioPlayer}(mo),qa=function(t){function MediaExtensionStub(n){var l=t.call(this,n)||this;return l.audioTracks=[],l.textTracks=[],l.extURI="",l.hasMediaKeySupport=!0,l.initiated=!0,l.isFairplay=!0,l.hasMediaKeySupport=!0,l.hasMediaSession=!0,l}return __extends(MediaExtensionStub,t),MediaExtensionStub.prototype.destroy=function(t){},MediaExtensionStub.prototype.setMediaItem=function(t){},MediaExtensionStub.prototype.initializeKeySystem=function(){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(t){return this.session=new va,[2]}))}))},MediaExtensionStub}(ke),Qa=function(){function PlayerStub(n){this.bitrate=t.PlaybackBitrate.STANDARD,this.audioTracks=[],this.currentBufferedProgress=0,this.currentPlaybackDuration=0,this.currentPlaybackProgress=0,this.currentPlaybackTime=0,this.currentPlaybackTimeRemaining=0,this.formattedCurrentPlaybackDuration={hours:0,minutes:0},this.isPlaying=!1,this.isPrimaryPlayer=!0,this.isReady=!1,this.paused=!1,this.playbackState=t.PlaybackStates.none,this.playbackTargetAvailable=!1,this.playbackTargetIsWireless=!1,this.previewOnly=!1,this.textTracks=[],this.extension=new qa([]),this.hasAuthorization=!0,this.isDestroyed=!1,this._volume=1,this._playbackRate=1,this._dispatcher=n.services.dispatcher,this.windowHandlers=new Wn(this)}return Object.defineProperty(PlayerStub.prototype,"hasMediaElement",{get:function(){return!0},enumerable:!0,configurable:!0}),Object.defineProperty(PlayerStub.prototype,"isEngagedInPlayback",{get:function(){return!this.paused},enumerable:!0,configurable:!0}),Object.defineProperty(PlayerStub.prototype,"playbackRate",{get:function(){return this._playbackRate},set:function(t){this._playbackRate=t,this._dispatcher.publish(dn,new Event("ratechange"))},enumerable:!0,configurable:!0}),Object.defineProperty(PlayerStub.prototype,"volume",{get:function(){return this._volume},set:function(t){this._volume=t,this._dispatcher.publish(_n,new Event("volumeChange"))},enumerable:!0,configurable:!0}),PlayerStub.prototype.destroy=function(){},PlayerStub.prototype.dispatch=function(){},PlayerStub.prototype.exitFullscreen=function(){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(t){return[2]}))}))},PlayerStub.prototype.initialize=function(){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(t){return[2]}))}))},PlayerStub.prototype.isPaused=function(){return this.paused},PlayerStub.prototype.mute=function(){},PlayerStub.prototype.newSeeker=function(){return new Vn(this)},PlayerStub.prototype.pause=function(t){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(t){return[2]}))}))},PlayerStub.prototype.play=function(){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(t){return[2]}))}))},PlayerStub.prototype.playItemFromEncryptedSource=function(t,n,l){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(t){return[2]}))}))},PlayerStub.prototype.playItemFromUnencryptedSource=function(t,n,l){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(t){return[2]}))}))},PlayerStub.prototype.preload=function(){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(t){return[2]}))}))},PlayerStub.prototype.prepareToPlay=function(t,n,l){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(t){return[2]}))}))},PlayerStub.prototype.seekToTime=function(t){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(t){return[2]}))}))},PlayerStub.prototype.requestFullscreen=function(){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(t){return[2]}))}))},PlayerStub.prototype.setPresentationMode=function(t){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(t){return[2]}))}))},PlayerStub.prototype.showPlaybackTargetPicker=function(){},PlayerStub.prototype.stop=function(t){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(t){return[2]}))}))},PlayerStub.prototype.stopMediaAndCleanup=function(){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(t){return[2]}))}))},PlayerStub.prototype.supportsPictureInPicture=function(){return!1},PlayerStub.prototype.tsidChanged=function(){},PlayerStub.prototype.setNextGaplessItem=function(t){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(t){return[2]}))}))},PlayerStub}(),parseSkipItems=function(t){var n=parseInt(t.hlsMetadata["skip.count"],10),l=[];if(isNaN(n)||0===n)return l;for(var d=0;d<n;d++)l.push({start:parseFloat(t.hlsMetadata["skip."+d+".start"]),duration:parseFloat(t.hlsMetadata["skip."+d+".duration"]),target:parseFloat(t.hlsMetadata["skip."+d+".target"]),label:t.hlsMetadata["skip."+d+".label"]});return l},parseRollItems=function(t,n){if(void 0===n&&(n=["pre-roll","mid-roll","post-roll"]),void 0===t.hlsMetadata)return[];var l=[];return n.forEach((function(n){var d=parseInt(t.hlsMetadata[n+".count"],10);if(!isNaN(d))for(var p=0;p<d;p++){var h=n+"."+p;l.push({index:p,type:n,skippable:"true"===t.hlsMetadata[h+".skippable"],"adam-id":t.hlsMetadata[h+".adam-id"],start:Math.round(parseFloat(t.hlsMetadata[h+".start"])),duration:Math.round(parseFloat(t.hlsMetadata[h+".duration"]))})}})),l},addRollItemDuration=function(t,n){return t+n.duration},Ja=function(){function PlaybackMonitor(t){this.isActive=!1,this.isMonitoring=!1,this.watchers=[],this.handlePlaybackThreshold=this.handlePlaybackThreshold.bind(this),this.playbackController=t.controller,this.dispatcher=t.services.dispatcher,this.dispatcher.subscribe(An.nowPlayingItemDidChange,this.handleMediaItemChange),this.apiManager=t.services.apiManager}return PlaybackMonitor.prototype.activate=function(){this.isActive=!0,this.startMonitor()},PlaybackMonitor.prototype.deactivate=function(){this.isActive=!1,this.clearMonitor()},PlaybackMonitor.prototype.clearMonitor=function(){this.isMonitoring&&(this.watchers.forEach((function(t){return t.stopMonitor()})),this.isMonitoring=!1)},PlaybackMonitor.prototype.shouldMonitor=function(){return this.isActive},PlaybackMonitor.prototype.startMonitor=function(){this.shouldMonitor()&&(this.watchers.forEach((function(t){return t.startMonitor()})),this.isMonitoring=!0)},PlaybackMonitor.prototype.handleMediaItemChange=function(){this.isActive&&(this.clearMonitor(),this.shouldMonitor()&&this.startMonitor())},__decorate([Bind(),__metadata("design:type",Function),__metadata("design:paramtypes",[]),__metadata("design:returntype",void 0)],PlaybackMonitor.prototype,"handleMediaItemChange",null),PlaybackMonitor}(),Xa=function(){function SpanWatcher(t,n,l,d,p){void 0===p&&(p=!1),this.dispatcher=t,this.callback=n,this.start=l,this.stop=d,this.allowMultiple=p,this.inWatchSpan=!1}return SpanWatcher.prototype.startMonitor=function(){this.dispatcher.unsubscribe(An.playbackTimeDidChange,this.handleTimeChange),this.dispatcher.subscribe(An.playbackTimeDidChange,this.handleTimeChange)},SpanWatcher.prototype.stopMonitor=function(){this.dispatcher.unsubscribe(An.playbackTimeDidChange,this.handleTimeChange)},SpanWatcher.prototype.handleTimeChange=function(t,n){var l=n.currentPlaybackTime;return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(t){switch(t.label){case 0:return!Number.isFinite(l)||l<this.start||l>this.stop?(this.inWatchSpan=!1,[2]):this.inWatchSpan?[2]:(this.allowMultiple||this.stopMonitor(),this.inWatchSpan=!0,[4,this.callback(l,this)]);case 1:return t.sent(),[2]}}))}))},__decorate([Bind(),__metadata("design:type",Function),__metadata("design:paramtypes",[Object,Object]),__metadata("design:returntype",Promise)],SpanWatcher.prototype,"handleTimeChange",null),SpanWatcher}(),Za=function(t){function RollMonitor(n){var l=t.call(this,n)||this;return l.rollMap=new Map,l}return __extends(RollMonitor,t),RollMonitor.prototype.handlePlaybackThreshold=function(t,n){return __awaiter(this,void 0,void 0,(function(){var t;return __generator(this,(function(l){return this.rollMap.has(n)?(t=this.rollMap.get(n),this.dispatcher.publish(An.mediaRollEntered,t),this.rollMap.delete(n),[2]):[2]}))}))},RollMonitor.prototype.shouldMonitor=function(){return!!t.prototype.shouldMonitor.call(this)&&this.getRollMetadata().length>0},RollMonitor.prototype.startMonitor=function(){this.setupWatchers(this.getRollMetadata()),t.prototype.startMonitor.call(this)},RollMonitor.prototype.getRollMetadata=function(){var t=this.playbackController.nowPlayingItem;return void 0===t?[]:parseRollItems(t,["pre-roll","post-roll"])},RollMonitor.prototype.setupWatchers=function(t){var n=this,l=[];t.forEach((function(t){var d=t.start,p=t.duration,h=new Xa(n.dispatcher,n.handlePlaybackThreshold,d,d+p);l.push(h),n.rollMap.set(h,t)})),this.watchers=l},RollMonitor}(Ja),es=function(t){function SkipAvailable(n){var l=t.call(this,n)||this;return l.skipMap=new Map,l}return __extends(SkipAvailable,t),SkipAvailable.prototype.handlePlaybackThreshold=function(t,n){return __awaiter(this,void 0,void 0,(function(){var t;return __generator(this,(function(l){return this.skipMap.has(n)?(t=this.skipMap.get(n),this.dispatcher.publish(An.mediaSkipAvailable,t),this.skipMap.delete(n),[2]):[2]}))}))},SkipAvailable.prototype.shouldMonitor=function(){return!!t.prototype.shouldMonitor.call(this)&&this.getNowPlayingMetadata().length>0},SkipAvailable.prototype.startMonitor=function(){this.setupWatchers(this.getNowPlayingMetadata()),t.prototype.startMonitor.call(this)},SkipAvailable.prototype.getNowPlayingMetadata=function(){var t=this.playbackController.nowPlayingItem;return void 0===t?[]:parseSkipItems(t)},SkipAvailable.prototype.setupWatchers=function(t){var n=this,l=[];t.forEach((function(t){var d=t.start,p=t.duration,h=new Xa(n.dispatcher,n.handlePlaybackThreshold,d,d+p);l.push(h),n.skipMap.set(h,t)})),this.watchers=l},SkipAvailable}(Ja),ts=new De,getUpNextStart=function(t){return parseFloat(t.hlsMetadata["up-next.start"])},getWatchedTime=function(t){return parseFloat(t.hlsMetadata["watched.time"])},fetchHLSMetadata=function(t){return __awaiter(void 0,void 0,void 0,(function(){var n,l,d;return __generator(this,(function(p){switch(p.label){case 0:if(!t.isUTS||!t.assetURL)return[2];p.label=1;case 1:return p.trys.push([1,3,,4]),[4,fetch(t.assetURL).then((function(t){return t.text()}))];case 2:return n=p.sent(),(l=n.match(/^(?:#EXT-X-SESSION-DATA:?)DATA\-ID="([^"]+)".+VALUE="([^"]+)".*$/gm))&&l.forEach((function(n){var l=n.split(",")[0].split("com.apple.hls.")[1].replace(/"/g,""),d=n.split(",")[1].split("VALUE=")[1].replace(/"/g,"");t.hlsMetadata[l]=d})),[3,4];case 3:return d=p.sent(),ts.log(d),[3,4];case 4:return[2]}}))}))},rs=function(t){function UpNextMonitor(n){var l=t.call(this,n)||this,d=l.handlePlaybackThreshold;return l.watchers=[{startMonitor:function(){l.dispatcher.unsubscribe(Ve.mediaContentComplete,d),l.dispatcher.subscribe(Ve.mediaContentComplete,d)},stopMonitor:function(){l.dispatcher.unsubscribe(Ve.mediaContentComplete,d)}}],l}return __extends(UpNextMonitor,t),UpNextMonitor.prototype.handlePlaybackThreshold=function(){var t,n,l,d;return __awaiter(this,void 0,void 0,(function(){var p,h,f,y,v=this;return __generator(this,(function(_){switch(_.label){case 0:if("Episode"!==(null==(p=this.playbackController.nowPlayingItem)?void 0:p.type))return[3,5];h=void 0,_.label=1;case 1:return _.trys.push([1,3,,4]),[4,null===(t=this.apiManager.utsAPI)||void 0===t?void 0:t.showEpisodeNextepisode({showId:null===(n=null==p?void 0:p.attributes)||void 0===n?void 0:n.showId,episodeId:null==p?void 0:p.id})];case 2:return h=_.sent(),[3,4];case 3:return _.sent(),[3,4];case 4:if(h&&this.isAppleOriginal(h))return this.dispatcher.publish(An.mediaUpNext,{item:h,isNextEpisode:!0}),[2];_.label=5;case 5:return[4,null===(l=this.apiManager.utsAPI)||void 0===l?void 0:l.getPostPlayShelf(null==p?void 0:p.id)];case 6:return(null==(f=_.sent())?void 0:f.items)?[3,8]:[4,null===(d=this.apiManager.utsAPI)||void 0===d?void 0:d.watchlistContinueWatching()];case 7:f=_.sent(),_.label=8;case 8:return(null==f?void 0:f.items)&&Array.isArray(f.items)?((y=f.items.find((function(t){return v.isAppleOriginal(t)&&"Show"!==t.type})))&&this.dispatcher.publish(An.mediaUpNext,{item:y}),[2]):[2]}}))}))},UpNextMonitor.prototype.shouldMonitor=function(){return!!t.prototype.shouldMonitor.call(this)&&(void 0!==this.playbackController.nowPlayingItem&&(n=this.playbackController.nowPlayingItem,!isNaN(getUpNextStart(n))&&!isNaN(getWatchedTime(n))));var n},UpNextMonitor.prototype.isAppleOriginal=function(t){var n;return t.isAppleOriginal||(null===(n=t.content)||void 0===n?void 0:n.isAppleOriginal)},UpNextMonitor}(Ja),is=getHlsJsCdnConfig(),ns={app:{},autoplay:{maxQueueSizeForAutoplay:50,maxQueueSizeInRequest:2,maxUpcomingTracksToMaintain:10},features:{xtrick:!0,isWeb:!0,bookmarking:!1,"safari-native-hls":!0},urls:{hls:is.hls,rtc:is.rtc,mediaApi:"https://amp-api.music.apple.com/v1",webPlayback:"https://"+getCommerceHostname("play")+"/WebObjects/MZPlay.woa/wa/webPlayback"}};if("undefined"!=typeof localStorage)try{var as=null!==(La=localStorage.getItem("mk-offers-key-urls"))&&void 0!==La?La:void 0;isStringNotEmpty(as)&&(ns.urls.hlsOffersKeyUrls=JSON.parse(as))}catch(e){}var ss=function(){function Store(t,n){var l=this;void 0===n&&(n={}),this._hasAuthorized=!1,this._providedRequestUserToken=!1,this._dispatcher=n.services.dispatcher,n.precache&&(this.precache=n.precache),n.storefrontId&&(this.storefrontId=n.storefrontId),this._defaultStorefrontCountryCode=n.storefrontCountryCode,(n.affiliateToken||n.campaignToken)&&(n.linkParameters=__assign(__assign({},n.linkParameters||{}),{at:n.affiliateToken,ct:n.campaignToken})),this.storekit=new Gi(t,{apiBase:ns.urls.mediaApi,authenticateMethod:ns.features["legacy-authenticate-method"]?"POST":"GET",deeplink:n.linkParameters,disableAuthBridge:n.disableAuthBridge,iconURL:ns.app.icon,persist:n.persist,realm:n.realm||0}),this.storekit.addEventListener(An.authorizationStatusDidChange,(function(t){var n=t.authorizationStatus;l._hasAuthorized=[Ni.AUTHORIZED,Ni.RESTRICTED].includes(n)}))}return Object.defineProperty(Store.prototype,"authorizationStatus",{get:function(){return this.storekit.authorizationStatus},enumerable:!0,configurable:!0}),Object.defineProperty(Store.prototype,"cid",{get:function(){return this.storekit.cid},enumerable:!0,configurable:!0}),Object.defineProperty(Store.prototype,"developerToken",{get:function(){return this.storekit.developerToken},enumerable:!0,configurable:!0}),Object.defineProperty(Store.prototype,"hasAuthorized",{get:function(){return this._hasAuthorized},enumerable:!0,configurable:!0}),Object.defineProperty(Store.prototype,"isAuthorized",{get:function(){return this.storekit.hasAuthorized},enumerable:!0,configurable:!0}),Object.defineProperty(Store.prototype,"isRestricted",{get:function(){return this.storekit.authorizationStatus===Ni.RESTRICTED},enumerable:!0,configurable:!0}),Object.defineProperty(Store.prototype,"metricsClientId",{get:function(){return this._metricsClientId},set:function(t){this._metricsClientId=t},enumerable:!0,configurable:!0}),Object.defineProperty(Store.prototype,"musicUserToken",{get:function(){return this.storekit.userToken},set:function(t){this.storekit.userToken=t},enumerable:!0,configurable:!0}),Object.defineProperty(Store.prototype,"dynamicMusicUserToken",{set:function(t){this.storekit.dynamicUserToken=t},enumerable:!0,configurable:!0}),Object.defineProperty(Store.prototype,"needsGDPR",{get:function(){ts.error("needsGDPR has been deprecated. Plesae migrate to shouldDisplayPrivacyLink()")},enumerable:!0,configurable:!0}),Object.defineProperty(Store.prototype,"realm",{get:function(){return this.storekit.realm},enumerable:!0,configurable:!0}),Object.defineProperty(Store.prototype,"requestUserToken",{set:function(t){this._providedRequestUserToken=!0,this.storekit.requestUserToken=t},enumerable:!0,configurable:!0}),Object.defineProperty(Store.prototype,"restrictedEnabled",{get:function(){return this.storekit.restrictedEnabled},enumerable:!0,configurable:!0}),Object.defineProperty(Store.prototype,"storefrontCountryCode",{get:function(){var t;return this.isAuthorized?this.storekit.storefrontCountryCode:null!==(t=this._defaultStorefrontCountryCode)&&void 0!==t?t:this.storekit.storefrontCountryCode},enumerable:!0,configurable:!0}),Object.defineProperty(Store.prototype,"storefrontId",{get:function(){return this._apiStorefrontId||this.storekit.storefrontCountryCode},set:function(t){t&&(t=t.toLowerCase()),t!==this._apiStorefrontId&&(this._apiStorefrontId=t,this._dispatcher.publish(Ve.apiStorefrontChanged,{storefrontId:t}))},enumerable:!0,configurable:!0}),Object.defineProperty(Store.prototype,"subscribeURL",{get:function(){return this.storekit.deeplinkURL({p:"subscribe"})},enumerable:!0,configurable:!0}),Object.defineProperty(Store.prototype,"subscribeFamilyURL",{get:function(){return this.storekit.deeplinkURL({p:"subscribe-family"})},enumerable:!0,configurable:!0}),Object.defineProperty(Store.prototype,"subscribeIndividualURL",{get:function(){return this.storekit.deeplinkURL({p:"subscribe-individual"})},enumerable:!0,configurable:!0}),Object.defineProperty(Store.prototype,"subscribeStudentURL",{get:function(){return this.storekit.deeplinkURL({p:"subscribe-student"})},enumerable:!0,configurable:!0}),Object.defineProperty(Store.prototype,"userToken",{get:function(){return this.musicUserToken},enumerable:!0,configurable:!0}),Store.prototype.authorize=function(){return __awaiter(this,void 0,void 0,(function(){var t,n=this;return __generator(this,(function(l){switch(l.label){case 0:if(this.storekit.userTokenIsValid)return[2,this.storekit.userToken];l.label=1;case 1:return l.trys.push([1,3,,8]),[4,this.storekit.requestUserToken()];case 2:return t=l.sent(),[3,8];case 3:l.sent(),l.label=4;case 4:return l.trys.push([4,6,,7]),[4,this.unauthorize()];case 5:return l.sent(),[3,7];case 6:return l.sent(),[3,7];case 7:throw new Fe(Fe.AUTHORIZATION_ERROR,"Unauthorized");case 8:return this._providedRequestUserToken&&(this.storekit.userToken=t),this.storekit.userTokenIsValid?[4,this.storekit.requestStorefrontCountryCode().catch((function(t){return __awaiter(n,void 0,void 0,(function(){return __generator(this,(function(n){switch(n.label){case 0:return[4,this.unauthorize()];case 1:return n.sent(),[2,Promise.reject(t)]}}))}))}))]:[3,10];case 9:return l.sent(),[2,t];case 10:return[2]}}))}))},Store.prototype.shouldDisplayPrivacyLink=function(t){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(n){return[2,this.storekit.shouldDisplayPrivacyLink(t)]}))}))},Store.prototype.unauthorize=function(){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(t){return[2,this.storekit.revokeUserToken()]}))}))},Store.prototype.validateAgeVerification=function(t){return __awaiter(this,void 0,void 0,(function(){var n,l;return __generator(this,(function(d){switch(d.label){case 0:return 2!==this.storekit.realm?[2]:[4,this.storekit.me()];case 1:return(n=d.sent()).info?n.info.webAgeVerificationData&&!n.info.webAgeVerificationData.isVerified?[2,Promise.reject(new Fe(Fe.AGE_VERIFICATION,"Age verification required"))]:t.rating&&n.info.parentalControlsData&&n.info.parentalControlsData.videoContentRestrictions&&(l=t.rating.system.replace(/[^a-z0-9]+/i,"-"),n.info.parentalControlsData.videoContentRestrictions[l]<t.rating.value)?[2,Promise.reject(new Fe(Fe.CONTENT_RESTRICTED,"Content restricted"))]:[2]:[2]}}))}))},Store}(),us=/\/([a-z]{2})\/(album|artist|episode|movie|music-video|playlist|podcast|post|show|song|station)\/(?:[^\/]*\/)?(?:id)?(\d+|[a-z]{2}\.[a-z0-9\-]+|umc.cmc.[a-zA-Z0-9]+)(?:.*(?:[\?|\&]i=(\d+)).*)?.*$/i;function formattedMediaURL(t){if(!us.test(t))throw new TypeError("Invalid Media URL: "+t);var n=__read(t.match(us),5),l=n[1],d=n[2],p=n[3],h=n[4];return"music-video"===d&&(d="musicVideo"),-1!==["album","playlist"].indexOf(d)&&h?(d="song",p=h):"podcast"===d&&h&&(d="episode",p=h),{storefrontId:l,kind:d,contentId:p,isUTS:!!p&&p.startsWith("umc.")}}function hasAuthorization(t){return void 0===t&&(t=xa&&xa.storekit),void 0!==t&&t.hasAuthorized&&t.userTokenIsValid}function hasMusicSubscription(t){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(n){return void 0===t&&(t=xa&&xa.storekit),[2,t.hasMusicSubscription()]}))}))}var cs,ls=function(){function MediaSessionManager(t,n){this.capabilities=t,this.dispatcher=n,this.session=navigator.mediaSession,this.session&&(this.dispatcher.subscribe(An.nowPlayingItemDidChange,this.onNowPlayingItemDidChange),this.dispatcher.subscribe(An.capabilitiesChanged,this.onCapabilitiesChanged),this._setMediaSessionHandlers())}return MediaSessionManager.prototype.onCapabilitiesChanged=function(){this._resetHandlers(),this._setMediaSessionHandlers()},MediaSessionManager.prototype.onNowPlayingItemDidChange=function(t,n){var l=n.item;this._setMediaSessionMetadata(l)},MediaSessionManager.prototype._setMediaSessionMetadata=function(t){var n,l;this.session&&"MediaMetadata"in window&&t&&(this.session.metadata=new window.MediaMetadata({title:t.title,artist:null!==(n=t.artistName)&&void 0!==n?n:null===(l=t.attributes)||void 0===l?void 0:l.showTitle,album:t.albumName,artwork:t.artwork?[96,128,192,256,384,512].map((function(n){return{src:formatArtworkURL(t.artwork,n,n),sizes:n+"x"+n,type:"image/jpeg"}})):[]}))},MediaSessionManager.prototype._setMediaSessionHandlers=function(){var t=this;this.session&&(this._resetHandlers(),this.session.setActionHandler("play",(function(){var n;return null===(n=t.controller)||void 0===n?void 0:n.play()})),this.capabilities.canPause?this.session.setActionHandler("pause",(function(){var n;return null===(n=t.controller)||void 0===n?void 0:n.pause()})):this.session.setActionHandler("pause",(function(){var n;return null===(n=t.controller)||void 0===n?void 0:n.stop()})),this.capabilities.canSeek&&(this.session.setActionHandler("seekforward",(function(){var n;return null===(n=t.controller)||void 0===n?void 0:n.seekForward()})),this.session.setActionHandler("seekbackward",(function(){var n;return null===(n=t.controller)||void 0===n?void 0:n.seekBackward()}))),this.capabilities.canSkipToNextItem&&this.session.setActionHandler("nexttrack",(function(){var n;return null===(n=t.controller)||void 0===n?void 0:n.skipToNextItem()})),this.capabilities.canSkipToPreviousItem&&this.session.setActionHandler("previoustrack",(function(){var n;return null===(n=t.controller)||void 0===n?void 0:n.skipToPreviousItem()})))},MediaSessionManager.prototype._resetHandlers=function(){this.session&&(this.session.setActionHandler("play",void 0),this.session.setActionHandler("pause",void 0),this.session.setActionHandler("seekforward",void 0),this.session.setActionHandler("seekbackward",void 0),this.session.setActionHandler("nexttrack",void 0),this.session.setActionHandler("previoustrack",void 0))},__decorate([Bind(),__metadata("design:type",Function),__metadata("design:paramtypes",[]),__metadata("design:returntype",void 0)],MediaSessionManager.prototype,"onCapabilitiesChanged",null),__decorate([Bind(),__metadata("design:type",Function),__metadata("design:paramtypes",[Object,Object]),__metadata("design:returntype",void 0)],MediaSessionManager.prototype,"onNowPlayingItemDidChange",null),MediaSessionManager}();!function(t){t[t.PAUSE=0]="PAUSE",t[t.EDIT_QUEUE=1]="EDIT_QUEUE",t[t.SEEK=2]="SEEK",t[t.REPEAT=3]="REPEAT",t[t.SHUFFLE=4]="SHUFFLE",t[t.SKIP_NEXT=5]="SKIP_NEXT",t[t.SKIP_PREVIOUS=6]="SKIP_PREVIOUS",t[t.SKIP_TO_ITEM=7]="SKIP_TO_ITEM"}(cs||(cs={}));var ds=function(){function Capabilities(t){this._dispatcher=t,this._checkCapability=function(t){return!1},this._mediaSession=new ls(this,t)}return Object.defineProperty(Capabilities.prototype,"controller",{set:function(t){this._mediaSession.controller=t},enumerable:!0,configurable:!0}),Capabilities.prototype.updateChecker=function(t){this._checkCapability!==t&&(this._checkCapability=t,this._dispatcher.publish(An.capabilitiesChanged))},Object.defineProperty(Capabilities.prototype,"canEditPlaybackQueue",{get:function(){return this._checkCapability(cs.EDIT_QUEUE)},enumerable:!0,configurable:!0}),Object.defineProperty(Capabilities.prototype,"canPause",{get:function(){return this._checkCapability(cs.PAUSE)},enumerable:!0,configurable:!0}),Object.defineProperty(Capabilities.prototype,"canSeek",{get:function(){return this._checkCapability(cs.SEEK)},enumerable:!0,configurable:!0}),Object.defineProperty(Capabilities.prototype,"canSetRepeatMode",{get:function(){return this._checkCapability(cs.REPEAT)},enumerable:!0,configurable:!0}),Object.defineProperty(Capabilities.prototype,"canSetShuffleMode",{get:function(){return this._checkCapability(cs.SHUFFLE)},enumerable:!0,configurable:!0}),Object.defineProperty(Capabilities.prototype,"canSkipToNextItem",{get:function(){return this._checkCapability(cs.SKIP_NEXT)},enumerable:!0,configurable:!0}),Object.defineProperty(Capabilities.prototype,"canSkipToMediaItem",{get:function(){return this._checkCapability(cs.SKIP_TO_ITEM)},enumerable:!0,configurable:!0}),Object.defineProperty(Capabilities.prototype,"canSkipToPreviousItem",{get:function(){return this._checkCapability(cs.SKIP_PREVIOUS)},enumerable:!0,configurable:!0}),Capabilities}();var ps={condition:function(){return!0},toOptions:function(t,n,l){return[__assign(__assign({},t),{context:l})]}},hs={condition:function(t){var n;return"stations"===t.type&&(null===(n=t.attributes)||void 0===n?void 0:n.isLive)},toOptions:function(t,n,l){return[__assign(__assign({},t),{context:l,container:{attributes:t.attributes,id:t.id,type:t.type,name:null==l?void 0:l.featureName}})]}},hasRelationship=function(t){return function(n){var l,d;return!!(null===(d=null===(l=n.relationships)||void 0===l?void 0:l[t])||void 0===d?void 0:d.data)}},typeIs=function(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];return function(n){var l=n.type;return t.includes(l)}},withBagPrefix=function(t){if(void 0!==t&&""!==t){var n=bo.prefix;return n?n+":"+t:t}},getContainerName=function(t,n){var l,d;return null!==(d=null!=n?n:null===(l=null==t?void 0:t.container)||void 0===l?void 0:l.name)&&void 0!==d?d:$e.SONG},fs={toOptions:function(t,n,l){var d=__assign(__assign({id:t.id},n),{name:withBagPrefix(getContainerName(t,null==l?void 0:l.featureName))});return[{relationships:t.relationships,attributes:t.attributes,id:t.id,type:t.type,container:d,context:l}]},condition:typeIs("songs","library-songs","music-videos")},parseAssets=function(t){var n=t.type,l=t.attributes.assetTokens;return n.includes("udio")?function(t){if(void 0!==t)return t[__read(Object.keys(t),1)[0]]}(l):function(t){if(void 0!==t){var n=Object.keys(t);return t[n[n.length-1]]}}(l)},ys={condition:typeIs("uploaded-audios","uploadedAudio","uploaded-videos","uploadedVideo"),toOptions:function(t,n,l){var d,p,h=__assign(__assign({},t),{context:l,attributes:__assign(__assign({},t.attributes),{assetUrl:parseAssets(t),playParams:null!==(p=null===(d=null==t?void 0:t.attributes)||void 0===d?void 0:d.playParams)&&void 0!==p?p:{id:t.id,kind:t.type}})});return void 0!==n&&(h.container=n),void 0!==(null==l?void 0:l.featureName)&&(h.container=__assign(__assign({},h.container),{name:null==l?void 0:l.featureName})),[h]}},vs={toOptions:function(t,n,l){return t.relationships.episodes.data.map((function(t){return __assign(__assign({},t),{context:l})}))},condition:hasRelationship("episodes"),requiredRelationships:["episodes"]},_s=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,n){t.__proto__=n}||function(t,n){for(var l in n)n.hasOwnProperty(l)&&(t[l]=n[l])};function __extends$5(t,n){function __(){this.constructor=t}_s(t,n),t.prototype=null===n?Object.create(n):(__.prototype=n.prototype,new __)}var gs=Object.assign||function(t){for(var n,l=1,d=arguments.length;l<d;l++)for(var p in n=arguments[l])Object.prototype.hasOwnProperty.call(n,p)&&(t[p]=n[p]);return t};function __decorate$3(t,n,l,d){var p,h=arguments.length,f=h<3?n:null===d?d=Object.getOwnPropertyDescriptor(n,l):d;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)f=Reflect.decorate(t,n,l,d);else for(var y=t.length-1;y>=0;y--)(p=t[y])&&(f=(h<3?p(f):h>3?p(n,l,f):p(n,l))||f);return h>3&&f&&Object.defineProperty(n,l,f),f}function __metadata$3(t,n){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(t,n)}function __awaiter$4(t,n,l,d){return new(l||(l=Promise))((function(p,h){function fulfilled(t){try{step(d.next(t))}catch(e){h(e)}}function rejected(t){try{step(d.throw(t))}catch(e){h(e)}}function step(t){t.done?p(t.value):new l((function(n){n(t.value)})).then(fulfilled,rejected)}step((d=d.apply(t,n||[])).next())}))}function __generator$4(t,n){var l,d,p,h,f={label:0,sent:function(){if(1&p[0])throw p[1];return p[1]},trys:[],ops:[]};return h={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(h[Symbol.iterator]=function(){return this}),h;function verb(h){return function(y){return function(h){if(l)throw new TypeError("Generator is already executing.");for(;f;)try{if(l=1,d&&(p=d[2&h[0]?"return":h[0]?"throw":"next"])&&!(p=p.call(d,h[1])).done)return p;switch(d=0,p&&(h=[0,p.value]),h[0]){case 0:case 1:p=h;break;case 4:return f.label++,{value:h[1],done:!1};case 5:f.label++,d=h[1],h=[0];continue;case 7:h=f.ops.pop(),f.trys.pop();continue;default:if(!(p=f.trys,(p=p.length>0&&p[p.length-1])||6!==h[0]&&2!==h[0])){f=0;continue}if(3===h[0]&&(!p||h[1]>p[0]&&h[1]<p[3])){f.label=h[1];break}if(6===h[0]&&f.label<p[1]){f.label=p[1],p=h;break}if(p&&f.label<p[2]){f.label=p[2],f.ops.push(h);break}p[2]&&f.ops.pop(),f.trys.pop();continue}h=n.call(t,f)}catch(e){h=[6,e],d=0}finally{l=p=0}if(5&h[0])throw h[1];return{value:h[0]?h[1]:void 0,done:!0}}([h,y])}}}function __read$4(t,n){var l="function"==typeof Symbol&&t[Symbol.iterator];if(!l)return t;var d,p,h=l.call(t),f=[];try{for(;(void 0===n||n-- >0)&&!(d=h.next()).done;)f.push(d.value)}catch(error){p={error:error}}finally{try{d&&!d.done&&(l=h.return)&&l.call(h)}finally{if(p)throw p.error}}return f}function __spread$4(){for(var t=[],n=0;n<arguments.length;n++)t=t.concat(__read$4(arguments[n]));return t}function formatRatingsContentType(t,n){return ce(n)&&le(n)?t.replace(/^library-/,""):ce(n)&&!/^library-/.test(t)?"library-"+t:t}function normalizeAdamId(t){return t.replace(/^a\./,"")}function makeRequest(t,n,l,d){return void 0===d&&(d={}),__awaiter$4(this,void 0,void 0,(function(){var p,h,f,y,v,_,g,m,b,P,T,S,k,A,I;return __generator$4(this,(function(E){switch(E.label){case 0:h=n,f=l&&l.ids,d=Object.assign({},d),y=d.shouldCacheResults,v=void 0===y||y,_=d.returnRawJSONApiRecords,g=void 0!==_&&_,m=d.includePagination,b=void 0===m?t.defaultIncludePaginationMetadata:m,P=d.includeResponseMeta,T=void 0!==P&&P,delete d.shouldCacheResults,delete d.returnRawJSONApiRecords,delete d.includePagination,delete d.includeResponseMeta,"string"==typeof f&&(h=n+"/"+encodeURIComponent(f),l&&delete l.ids),E.label=1;case 1:return E.trys.push([1,3,,4]),(b||T)&&(d.useRawResponse=!0),[4,t.request(h,l,d)];case 2:return p=E.sent(),[3,4];case 3:return"status"in(S=E.sent())?404===S.status?[2,Promise.reject(new Fe(Fe.CONTENT_UNAVAILABLE,"The requested content is not available."))]:[2,Promise.reject(Fe.responseError(S))]:[2,Promise.reject(Fe.internalError(S))];case 4:try{if(k=p.results||p.data||p,"object"==typeof p&&"results"in p&&"meta"in p&&(k.meta=p.meta),0===k.length)return[2,Promise.reject(new Fe(Fe.CONTENT_UNAVAILABLE,"The requested content is not available."))];if(A=g?k:t.parseResultData(v,k),!b&&!T)return[2,A];if("results"in p){for(I in p.results)"meta"!==I&&(A[I]=paginateResultSet(p.results[I],A[I],t,l,d));return[2,A]}return[2,paginateResultSet(p,A,t,l,d)]}catch(error){return[2,Promise.reject(Fe.parseError(error))]}return[2]}}))}))}function paginateResultSet(t,n,l,d,p){var h,f;void 0===p&&(p={}),p.includePagination=!0;var y=Object.assign({},p);return delete y.offset,t.next&&(h=function(){return makeRequest(l,formatPaginatedUrl(l.url,t.next),d,y)}),t.previous&&(f=function(){return makeRequest(l,formatPaginatedUrl(l.url,t.previous),d,y)}),{data:n,next:h,previous:f,meta:t.meta}}function mapRequestResult(t,n){return"data"in t?(t.data=n(t.data),t):n(t)}function formatPaginatedUrl(t,n){var l=new window.window.URL(t).pathname,d=new RegExp("^"+l+"/");return n.replace(d,"")}var ms,getFeatureName=function(t,n){if(n)return n;var l=function(t){return void 0===t&&(t=[]),0!==t.length&&t.filter((function(t){var n=t.attributes;return!!n&&(n.workName||n.movementName||n.movementCount||n.movementNumber)})).length>0}(t.relationships.tracks.data);return"albums"===t.type||"library-albums"===t.type?l?$e.ALBUM_CLASSICAL:$e.ALBUM:"playlists"===t.type||"library-playlists"===t.type?l?$e.PLAYLIST_CLASSICAL:$e.PLAYLIST:void 0},bs=[{toOptions:function(t,n,l){var d={attributes:t.attributes,id:t.id,type:t.type,name:withBagPrefix(getFeatureName(t,null==l?void 0:l.featureName))};return t.relationships.tracks.data.map((function(t){return{attributes:t.attributes,id:t.id,type:t.type,container:d,context:l}}))},condition:hasRelationship("tracks"),requiredRelationships:["tracks"]},vs,fs,hs,ys],Ps=bs.reduce((function(t,n){var l=n.requiredRelationships;return l&&t.push.apply(t,__spread(l)),t}),[]),Ts=new Set(Ps),isArrayOf=function(t,n){return Array.isArray(t)&&(0===t.length||n(t[0]))},isMediaAPIResource=function(t){return t&&void 0!==t.id&&void 0!==t.type},isMediaItem=function(t){return t&&void 0!==t.id},isMPMediaItem=function(t){return t&&void 0!==t.contentId&&void 0!==t.metadata&&void 0!==t.metadata.itemId&&void 0!==t.metadata.itemType},isQueueItems=function(t){return t&&t.items&&Array.isArray(t.items)},isQueueLoaded=function(t){return t&&t.loaded},isQueueURLOption=function(t){return t&&t.url},descriptorToMediaItems=function(t){return isQueueItems(t)||isQueueLoaded(t)?((n=isQueueLoaded(t)?loadedDescriptorToMediaItem(t):unloadedDescriptorToMediaItem(t)).forEach((function(n){return n.context=__assign(__assign({},t.context),n.context)})),n):[];var n},unloadedDescriptorToMediaItem=function(t){var n=t.items;return isArrayOf(n,isMPMediaItem)?n.map((function(t){return new _i(function(t){var n=transform({id:"metadata.itemId",type:"metadata.itemType","attributes.contentRating":function(){var n;if(1===(null===(n=null==t?void 0:t.metadata)||void 0===n?void 0:n.isExplicit))return"explicit"},"attributes.playParams":function(){var n,l,d;return 0!==(null===(n=null==t?void 0:t.metadata)||void 0===n?void 0:n.isPlayable)&&{id:null===(l=null==t?void 0:t.metadata)||void 0===l?void 0:l.itemId,kind:null===(d=null==t?void 0:t.metadata)||void 0===d?void 0:d.itemType}},"container.id":"metadata.containerId","container.name":"metadata.containerName","container.type":"metadata.containerType"},t);return Xr({attributes:{}},n)}(t))})):isArrayOf(n,isMediaItem)?n.map((function(t){return new _i(t)})):[]},loadedDescriptorToMediaItem=function(t){var n=[],l=t.loaded,d=t.container,p=t.context;return void 0===l?[]:isArrayOf(l,isDataRecord)?(l.forEach((function(t){n.push.apply(n,__spread(dataRecordToMediaItems(t,d,p)))})),n):isArrayOf(l,isMediaAPIResource)?(l.forEach((function(t){n.push.apply(n,__spread(resourceToMediaItem(t,d,p)))})),n):isDataRecord(l)?dataRecordToMediaItems(l,d,p):isMediaAPIResource(l)?resourceToMediaItem(l,d,p):[]},dataRecordToMediaItems=function(t,n,l){void 0===l&&(l={});var d=t.serialize(!0,void 0,{includeRelationships:Ts}).data;return resourceToMediaItem(d,n,l)},resourceToMediaItem=function(t,n,l){return void 0===l&&(l={}),Le.debug("_resourceToMediaItem",t),function(t,n,l){var d,p,h,f;return void 0===l&&(l={}),n=null!==(h=null===(p=null===(d=n)||void 0===d?void 0:d.serialize)||void 0===p?void 0:p.call(d).data)&&void 0!==h?h:n,(null!==(f=bs.find((function(d){return d.condition(t,n,l)})))&&void 0!==f?f:ps).toOptions(t,n,l).map((function(t){return new _i(t)}))}(t,n,l)},Ss=function(){function BaseModifiableQueue(){this.canModifyQueue=!1}return BaseModifiableQueue.prototype.append=function(t){ts.warn("Append is not supported for this type of playback")},BaseModifiableQueue.prototype.clear=function(){ts.warn("Clear is not supported for this type of playback")},BaseModifiableQueue.prototype.prepend=function(t,n){ts.warn("Prepend is not supported for this type of playback")},BaseModifiableQueue}(),ks=function(){function ModifiableQueue(t){this.canModifyQueue=!0,this.queue=t}return ModifiableQueue.prototype.append=function(t){var n=descriptorToMediaItems(t);this.queue.splice(this.queue.appendTargetIndex,0,n)},ModifiableQueue.prototype.clear=function(){this.queue.length&&(this.queue.splice(0,this.queue.length),this.queue.reset())},ModifiableQueue.prototype.prepend=function(t,n){void 0===n&&(n=!1);var l=descriptorToMediaItems(t),d=(this.queue.position<0?0:this.queue.position)+1;n&&this.queue.splice(d,this.queue.length),this.queue.splice(d,0,l)},ModifiableQueue}();!function(t){t[t.none=0]="none",t[t.one=1]="one",t[t.all=2]="all"}(ms||(ms={}));var As,Is=function(){function BaseRepeatable(){this.canSetRepeatMode=!1}return Object.defineProperty(BaseRepeatable.prototype,"repeatMode",{get:function(){return ms.none},set:function(t){t!==this.repeatMode&&ts.warn("setting repeatMode is not supported in this playback method")},enumerable:!0,configurable:!0}),BaseRepeatable}(),Es=function(){function Repeatable(t){this.dispatcher=t,this.canSetRepeatMode=!0,this._mode=ms.none}return Object.defineProperty(Repeatable.prototype,"repeatMode",{get:function(){return this._mode},set:function(t){t in ms&&t!==this._mode&&(this._mode=t,this.dispatcher.publish(An.repeatModeDidChange,this._mode))},enumerable:!0,configurable:!0}),Repeatable}(),typeRequiresItem=function(t){return[Ve.playbackPlay,Ve.playbackSkip].includes(t)},itemIsRequired=function(t,n){return void 0!==n&&typeRequiresItem(t)},cleanContainer=function(t){var n=__assign({},t);return delete n.attributes,n},computeContainer=function(t,n){var l,d,p=function(t,n){var l;return itemIsRequired(t,n)&&(null===(l=null==n?void 0:n.container)||void 0===l?void 0:l.name)||null}(t,n),h=itemIsRequired(t,n)?__assign(__assign({},null==n?void 0:n.container),null===(d=null===(l=null==n?void 0:n.container)||void 0===l?void 0:l.attributes)||void 0===d?void 0:d.playParams):null;if(null!==p||null!==h)return{container:cleanContainer(__assign(__assign({},h),null!==p?{name:p}:{}))}},generateItemDescriptorForPAF=function(t,n){var l=__assign(__assign(__assign(__assign(__assign({},function(t,n){var l;if(!typeRequiresItem(t))return{};if(void 0===n)return{};var d=null===(l=n.attributes)||void 0===l?void 0:l.mediaKind;return __assign(__assign({},void 0!==d?{mediaType:d}:{}),n.playParams)}(t,n)),function(t,n){if(!typeRequiresItem(t)||void 0===n)return{};var l=n.context;return{recoData:(void 0===l?{}:l).reco_id}}(t,n)),function(t,n){if(!typeRequiresItem(t)||void 0===n)return{};var l=n.playbackDuration;return l?{duration:l/1e3}:{}}(t,n)),computeContainer(t,n)),{trackInfo:null==n?void 0:n.trackInfo});return ts.trace("PAF descriptor",l),l},asCode=function(t){switch(typeof t){case"string":return t;case"undefined":return"undefined";default:return"PlayActivityEndReasonType."+He[t]}},ws=(function(){function PAFTrackerAPI(){}Object.defineProperty(PAFTrackerAPI.prototype,"apiService",{get:function(){if(void 0===this.service)throw new Fe(Fe.CONFIGURATION_ERROR,"Play Activity service was called before configuration.");return this.service},enumerable:!0,configurable:!0}),PAFTrackerAPI.prototype.configure=function(t,n){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(l){return this.service=new Hr(t.developerToken,t.musicUserToken,t.storefrontCountryCode,{app:{build:ns.app.build,name:ns.app.name,version:ns.app.version},fetch:!pe&&fetch.bind(window),logInfo:ts.enabled,sourceType:t.sourceType,services:n.services,userIsSubscribed:function(){return t.isAuthorized&&xa.storekit._getIsActiveSubscription.getCachedValue()}}),[2,this]}))}))},PAFTrackerAPI.prototype.cleanup=function(){},PAFTrackerAPI.prototype.shouldConfigure=function(t){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(n){return[2,void 0!==t.musicUserToken]}))}))},PAFTrackerAPI.prototype.activate=function(t){return void 0===t&&(t={}),this.apiService.activate(t.flush)},PAFTrackerAPI.prototype.exit=function(t){return void 0===t&&(t={}),ts.debug("PAF debug","client.exit("+t.position+")"),this.apiService.exit(t.position)},PAFTrackerAPI.prototype.pause=function(t,n){return void 0===n&&(n={}),"number"==typeof n.endReasonType?(ts.debug("PAF debug","client.stop("+n.position+", "+n.endReasonType+")"),this.apiService.stop(n.position,n.endReasonType)):(ts.debug("PAF debug","client.pause("+n.position+")"),this.apiService.pause(n.position))},PAFTrackerAPI.prototype.play=function(t,n){void 0===n&&(n={});var l=generateItemDescriptorForPAF(Ve.playbackPlay,t);return ts.debug("PAF debug","client.play("+JSON.stringify(l)+", "+n.position+")"),this.apiService.play(l,n.position)},PAFTrackerAPI.prototype.scrub=function(t,n){return void 0===n&&(n={}),ts.debug("PAF debug","client.scrub("+n.position+", "+asCode(n.endReasonType)+")"),this.apiService.scrub(n.position,n.endReasonType)},PAFTrackerAPI.prototype.seek=function(t,n){return void 0===n&&(n={}),__awaiter(this,void 0,void 0,(function(){return __generator(this,(function(l){switch(l.label){case 0:return[4,this.scrub(t,{position:n.startPosition,endReasonType:He.SCRUB_BEGIN})];case 1:return l.sent(),[4,this.scrub(t,{position:n.position,endReasonType:He.SCRUB_END})];case 2:return l.sent(),[2]}}))}))},PAFTrackerAPI.prototype.skip=function(t,n){return void 0===n&&(n={}),__awaiter(this,void 0,void 0,(function(){var l,d;return __generator(this,(function(p){switch(p.label){case 0:l=generateItemDescriptorForPAF(Ve.playbackSkip,t),ts.debug("PAF debug","client.skip("+JSON.stringify(l)+", "+asCode(n.direction)+", "+n.position+")"),p.label=1;case 1:return p.trys.push([1,3,,7]),[4,this.apiService.skip(l,n.direction,n.position)];case 2:return p.sent(),[3,7];case 3:return"A play stop() method was called without a previous play() descriptor"!==(d=p.sent()).message?[3,5]:[4,this.play(t,n)];case 4:return p.sent(),[3,6];case 5:return[2,Promise.reject(d)];case 6:return[3,7];case 7:return[2]}}))}))},PAFTrackerAPI.prototype.stop=function(t,n){var l;return void 0===n&&(n={}),(null==t?void 0:t.isLiveRadioStation)&&n.position&&(n.position=n.position-n.startPosition),(null==t?void 0:t.isLiveRadioStation)&&(n.endReasonType=null!==(l=n.endReasonType)&&void 0!==l?l:He.PLAYBACK_MANUALLY_PAUSED),ts.debug("PAF debug","client.stop("+n.position+", "+asCode(n.endReasonType)+")"),this.apiService.stop(n.position,n.endReasonType)},PAFTrackerAPI.prototype.shouldTrackPlayActivity=function(n,l){var d=hasAuthorization(),p=!l||l.playbackType!==t.PlaybackType.preview,h=this.alwaysSendForActivityType(n),f=!l||l&&this.mediaRequiresPlayActivity(l);return!(!d||!p||!h&&!f)},PAFTrackerAPI.prototype.alwaysSendForActivityType=function(t){return t===Ve.playerActivate||t===Ve.playerExit},PAFTrackerAPI.prototype.mediaRequiresPlayActivity=function(t){return isAUC(t.type)||-1!==["musicVideo","song","radioStation"].indexOf(t.type)}}(),[Ve.playbackPause,Ve.playbackPlay,Ve.playbackScrub,Ve.playbackSeek,Ve.playbackSkip,Ve.playbackStop,Ve.playerActivate,Ve.playerExit,An.nowPlayingItemWillChange]),Os=((As={})[Ve.playbackPause]="pause",As[Ve.playbackPlay]="play",As[Ve.playbackScrub]="scrub",As[Ve.playbackSeek]="seek",As[Ve.playbackSkip]="skip",As[Ve.playbackStop]="stop",As[Ve.playerActivate]="activate",As[Ve.playerExit]="exit",As),Rs=function(){function PlayActivityService(t,n){this.isBuffering=!1,this.apis=Array.isArray(t)?t:[t],this.dispatcher=n}return PlayActivityService.prototype.cleanup=function(){this.currentItem=void 0,this.teardownWatchers(),this.apis.forEach((function(t){return t.cleanup()}))},PlayActivityService.prototype.configure=function(t,n){return __awaiter(this,void 0,void 0,(function(){var l,d,p,h;return __generator(this,(function(f){switch(f.label){case 0:return[4,Promise.all(this.apis.map((function(n){return n.shouldConfigure(t)})))];case 1:if(l=f.sent(),0===(d=this.apis.filter((function(t,n){return l[n]}))).length)return[2];this.cleanup(),this.instance=t,p=d.map((function(l){return l.configure(t,n)})),f.label=2;case 2:return f.trys.push([2,4,5,6]),[4,Promise.all(p)];case 3:return f.sent(),[3,6];case 4:return h=f.sent(),ts.error("Error configuring a play activity service",h),[3,6];case 5:return this.setupWatchers(),this.clearIntention(),[7];case 6:return[2]}}))}))},PlayActivityService.prototype.getTrackerByType=function(t){return this.apis.find((function(n){return n instanceof t}))},PlayActivityService.prototype.handleEvent=function(t,n){void 0===n&&(n={});var l=n.item;void 0!==l&&(this.currentItem=l),ts.debug(t,n);var d=Os[t];if(void 0!==d){var p=this.addIntention(t,n);switch(delete p.item,t){case Ve.playbackPause:case Ve.playbackPlay:case Ve.playbackScrub:case Ve.playbackSeek:case Ve.playbackSkip:case Ve.playbackStop:return this.callApis(t,d,this.currentItem,p);case Ve.playerActivate:p.flush="boolean"==typeof n.isPlaying?!n.isPlaying:void 0;case Ve.playerExit:return this.callApis(t,d,p);case An.nowPlayingItemWillChange:this.currentItem=l}}},PlayActivityService.prototype.addIntention=function(t,n){var l=__assign({},n);return this.shouldAddIntention(t)?(l=__assign(__assign(__assign({},this.lastUserIntent),this.lastApplicationIntent),l),this.clearIntention(),l):l},PlayActivityService.prototype.callApis=function(t,n){for(var l=[],d=2;d<arguments.length;d++)l[d-2]=arguments[d];return __awaiter(this,void 0,void 0,(function(){var d,p=this;return __generator(this,(function(h){return d=this.apis.map((function(d){if("function"==typeof d[n]&&d.shouldTrackPlayActivity(t,p.currentItem))return d[n].apply(d,__spread(l))})),[2,Promise.all(d)]}))}))},PlayActivityService.prototype.clearIntention=function(){this.lastUserIntent=void 0,this.lastApplicationIntent=void 0},PlayActivityService.prototype.onPlaybackStateChange=function(n,l){return __awaiter(this,void 0,void 0,(function(){var n,d;return __generator(this,(function(p){return n=l.state,d={position:this.instance.currentPlaybackTime},n===t.PlaybackStates.waiting?(this.isBuffering=!0,[2,this.callApis("bufferStart","bufferStart",this.currentItem,d)]):n===t.PlaybackStates.playing&&this.isBuffering?(this.isBuffering=!1,[2,this.callApis("bufferEnd","bufferEnd",this.currentItem,d)]):[2]}))}))},PlayActivityService.prototype.recordApplicationIntent=function(t,n){this.lastApplicationIntent=n},PlayActivityService.prototype.recordUserIntent=function(t,n){this.lastUserIntent=n},PlayActivityService.prototype.shouldAddIntention=function(t){return[Ve.playbackPause,Ve.playbackStop].includes(t)},PlayActivityService.prototype.setupWatchers=function(){var t=this;ws.forEach((function(n){t.dispatcher.subscribe(n,t.handleEvent)})),this.dispatcher.subscribe(Ve.userActivityIntent,this.recordUserIntent),this.dispatcher.subscribe(Ve.applicationActivityIntent,this.recordApplicationIntent),this.dispatcher.subscribe(An.playbackStateDidChange,this.onPlaybackStateChange)},PlayActivityService.prototype.teardownWatchers=function(){var t=this;ws.forEach((function(n){t.dispatcher.unsubscribe(n,t.handleEvent)})),this.dispatcher.unsubscribe(Ve.userActivityIntent,this.recordUserIntent),this.dispatcher.unsubscribe(Ve.applicationActivityIntent,this.recordApplicationIntent),this.dispatcher.unsubscribe(An.playbackStateDidChange,this.onPlaybackStateChange)},__decorate([Bind(),__metadata("design:type",Function),__metadata("design:paramtypes",[String,Object]),__metadata("design:returntype",void 0)],PlayActivityService.prototype,"handleEvent",null),__decorate([Bind(),__metadata("design:type",Function),__metadata("design:paramtypes",[Object,Object]),__metadata("design:returntype",Promise)],PlayActivityService.prototype,"onPlaybackStateChange",null),__decorate([Bind(),__metadata("design:type",Function),__metadata("design:paramtypes",[Object,Object]),__metadata("design:returntype",void 0)],PlayActivityService.prototype,"recordApplicationIntent",null),__decorate([Bind(),__metadata("design:type",Function),__metadata("design:paramtypes",[Object,Object]),__metadata("design:returntype",void 0)],PlayActivityService.prototype,"recordUserIntent",null),PlayActivityService}(),Cs={setDelegate:!0};function isDefinedNonNull(t){return function(t){return void 0!==t}(t)&&null!==t}function isFunction(t){return"function"==typeof t}function isNumber(t){return"number"==typeof t}function isInteger(t){return isNumber(t)&&t%1==0}function isArray(t){return t&&t.constructor===Array}function extend(t){var n=[!0,!0,!0].concat(Array.prototype.slice.call(arguments));return copyKeysAndValues.apply(null,n)}function copyKeysAndValues(t,n,l,d){for(var p,h=l&&d||{},f=3;f<arguments.length;f++)for(var y in p=arguments[f])if(Object.prototype.hasOwnProperty.call(p,y)){var v=p[y];(t||null!=v)&&(n||"function"!=typeof v)&&(h[y]=v)}return h}function attachDelegate(t,n){var l=!1;if(t&&n&&t!==n){var d={};Object.keys(n).forEach((function(n){t[n]||(d[n]=!0)})),extend(d,Cs),l=attachMethods(t,n,null,d)}return l}function attachMethods(t,n,l,d){var p=!1;if(t&&n){d=d||{},l=l||n;var captureFunction=function(t,n,l,d){var returnValue=function(){return l[d].apply(t,arguments)};return n&&(returnValue.origFunction=n),returnValue};for(var h in n)if(!(h in d)&&n[h]&&isFunction(n[h])){var f=t[h],y=f&&isFunction(f)?f.bind(t):null;t[h]=captureFunction(l,y,n,h),p=!0}}return p}function setDelegates(t,n){var l={};for(var d in t)n[d]&&isFunction(t[d].setDelegate)&&(l[d]=t[d].setDelegate(n[d]));return l}function exceptionString(t,n){return"The function "+t+"."+n+"() must be overridden with a platform-specific delegate function.If you have no data for this function, have your delegate return null or undefined (no 'return')"}var Ms={flagArguments:{INCLUDE_CALL_STACK:new function(){},MIRROR_TO_SERVER:new function(){},SUPPRESS_CLIENT_OUTPUT:new function(){}},setDelegate:function(t){return attachDelegate(this,t)},execute:function(t,n,l){var d=t.levelStringToIntMap[n];if(t.level()!==t.NONE&&t.level()<=d){var p=Array.prototype.slice.call(l),h=Ms.nonFlagLogArguments(p),f=Ms.logOptions(t,d,p),y=f.includeCallStack?(new Error).stack:null,v=y?h.concat("\n"+y):h;if(t[n]._lastLog=v,f.mirrorToServer&&Ms.sendToServer(t,n,h,y),f.throwInsteadOfPrint)throw new Error(h.toString());f.suppressClientOutput||(console[n]?console[n].apply(console,v):console.log.apply(console,v))}},isFlagObject:function(t){return t&&t===Ms.flagArguments[t.constructor.name]},nonFlagLogArguments:function(t){return t.filter((function(t){return!Ms.isFlagObject(t)}))},logOptions:function(t,n,l){var d,p={};return l.forEach((function(t){Ms.isFlagObject(t)&&(d=function(t,n){var l="";if(t)for(var d,p=t.toLowerCase().split("_"),h=0;h<p.length;h++)d=p[h][0],(0!==h||n)&&(d=d.toUpperCase()),l+=d+p[h].slice(1);return l}(t.constructor.name),p[d]=!0)})),isFunction(t.mirrorToServerLevel)&&t.mirrorToServerLevel()!==t.NONE&&t.mirrorToServerLevel()<=n&&(p.mirrorToServer=!0),t.throwLevel()!==t.NONE&&t.throwLevel()<=n&&(p.throwInsteadOfPrint=!0),p},sendToServer:function(t,n,l,d){}},Ns={MIN_LEVEL:0,NONE:0,DEBUG:1,INFO:2,WARN:3,ERROR:4,MAX_LEVEL:4,levelIntToStringMap:{0:"none",1:"debug",2:"info",3:"warn",4:"error"},levelStringToIntMap:{none:0,debug:1,info:2,warn:3,error:4}},Ds={loggerName:"defaultLogger",level:Ns.INFO,throwLevel:Ns.NONE},Ls=!1,xs={};function Logger$1(t){this._loggerName=t,this._level,this._throwLevel,Ls||(Ls=!0,extend(Logger$1.prototype,Ns),extend(Logger$1.prototype,Ms.flagArguments))}function loggerNamed(t){var n=xs[t=t||Ds.loggerName];return n||(n=new Logger$1(t),xs[t]=n),n}Logger$1.level=function(){return Ds.level},Logger$1.throwLevel=function(){return Ds.throwLevel},Logger$1.prototype.setDelegate=function(t){return attachDelegate(this,t)},Logger$1.prototype.loggerName=function(){return this._loggerName},Logger$1.prototype.levelParameterAsInt=function(t){var n,l,d=null;return"string"==typeof(l=t)||l instanceof String?n=this.levelStringToIntMap[t.toLowerCase()]:isNumber(t)&&(n=t),n>=this.MIN_LEVEL&&n<=this.MAX_LEVEL&&(d=n),d},Logger$1.prototype.setLevel=function(t){var n=this.levelParameterAsInt(t);null!==n&&(this._level=n)},Logger$1.prototype.setThrowLevel=function(t){var n=this.levelParameterAsInt(t);null!==n&&(this._throwLevel=n)},Logger$1.prototype.level=function(){var t=this._level;return isNumber(t)?t:Logger$1.level()},Logger$1.prototype.levelString=function(){return this.levelIntToStringMap[this.level()]},Logger$1.prototype.throwLevel=function(){var t=this._throwLevel;return isNumber(t)?t:Logger$1.throwLevel()},Logger$1.prototype.debug=function(){Ms.execute(this,"debug",arguments)},Logger$1.prototype.info=function(){Ms.execute(this,"info",arguments)},Logger$1.prototype.warn=function(){Ms.execute(this,"warn",arguments)},Logger$1.prototype.error=function(){Ms.execute(this,"error",arguments)},Logger$1.prototype.lastLog=function(t){return this[t]?this[t]._lastLog:null};var Us={LOCAL_STORAGE:"localStorage",SESSION_STORAGE:"sessionStorage"},_storageObject=function(t){var n=null,l=!1;return function(){return t?n=t:(l||(console.error("storageObject: storage object not found. Override this function if there is a platform-specific implementation"),l=!0),n||(n={storage:{},getItem:function(t){return this.storage[t]},setItem:function(t,n){this.storage[t]=n},removeItem:function(t){delete this.storage[t]}})),n}};function _defaultStorageObject(t){var n=null,l=t===Us.LOCAL_STORAGE;try{n="undefined"!==(l?typeof localStorage:typeof sessionStorage)?l?localStorage:sessionStorage:null}catch(e){n=null,console.error("_utils.storage._defaultStorageObject: Unable to retrieve storage object: "+e)}return n}var Bs=_storageObject(_defaultStorageObject(Us.LOCAL_STORAGE)),js=_storageObject(_defaultStorageObject(Us.SESSION_STORAGE));function saveObjectToStorage(t,n,l){var d=null;if(l)try{t.setItem(n,JSON.stringify(l)),d=l}catch(e){}else d=t.removeItem(n);return d}function objectFromStorage(t,n){var l=null,d=t.getItem(n);if(d)try{l=JSON.parse(d)}catch(e){l=void 0}return l}var Fs={maxWait:1500,initialDelay:100,factor:2},ExponentialStrategy=function(t,n,l){this.delay=t||Fs.initialDelay,this.maxWait=isNumber(n)?n:Fs.maxWait,this.factor=l||Fs.factor,this.timeWaited=0};function exponentialBackoff(t,n,l,d,p,h){!function _backoff(t,n,l,d){n.call(n,l,(function(){var p=t.nextDelay();p?setTimeout(_backoff.bind(null,t,n,l,d),p):d.apply(d,arguments)}))}(new ExponentialStrategy(d,p,h),t,n,l)}function _valueForKeyPath(t,n,l){var d=n;if(t&&n)for(var p=t.split("."),h=0;d&&h<p.length;h++){var f=p[h];!(f in d)&&l&&(d[f]={}),d=f in d?d[f]:null}return d}function valueForKeyPath(t){var n=null;if(t&&arguments.length>1)for(var l=sourcesArray(Array.prototype.slice.call(arguments,1)),d=l.length-1;d>=0;d--){var p=l[d];if(isDefinedNonNull(n=_valueForKeyPath(t,p)))break}return n}function sourcesArray(t){var n=[],l=[];l=l.concat(t),arguments&&arguments.length>1&&(l=l.concat(Array.prototype.slice.call(arguments,1)));for(var d=0;d<l.length;d++){var p=l[d];n=n.concat(p)}return n}function makeAjaxRequest(t,n,l,d,p,h){var f=new XMLHttpRequest;l=l||void 0,h=h||{},d=isFunction(d)?d:function(){},p=isFunction(p)?p:function(){};var y=!1!==h.async;h.timeout&&y&&(f.timeout=h.timeout),f.onload=function(){f.status>=200&&f.status<300?d(f.response):p(new Error("XHR error: server responded with status "+f.status+" "+f.statusText),f.status)},f.onerror=function(){p(new Error("XHR error"))},f.open(n,t,y),f.withCredentials=!0,f.setRequestHeader("Content-type","application/json"),f.send(l)}ExponentialStrategy.prototype.nextDelay=function(){var t=null,n=this.maxWait-this.timeWaited;return n>0&&(this.delay=Math.min(this.delay,n),this.timeWaited+=this.delay),(0===this.maxWait||n>0)&&(t=this.delay,this.delay=this.delay*this.factor),t};var Ks={setDelegate:function(t){return attachDelegate(this,t)},localStorageObject:Bs,sessionStorageObject:js},Vs={setDelegate:function(t){return attachDelegate(this,t)},makeAjaxRequest:makeAjaxRequest},$s={blacklistedFields:["capacitySystem","capacitySystemAvailable","capacityDisk","capacityData","capacityDataAvailable"],compoundSeparator:"_",configBaseUrl:"https://xp.apple.com/config/1/report",constraints:{profiles:{AMPWeb:{precedenceOrderedRules:[{filters:"any",fieldConstraints:{clientId:{generateValue:!0,namespace:"AMPWeb_isSignedOut",expirationPeriod:864e5}}},{filters:{valueMatches:{isSignedIn:[!0]}},fieldConstraints:{clientId:{generateValue:!0,namespace:"AMPWeb_isSignedIn",expirationPeriod:15552e6}}}]},strict:{precedenceOrderedRules:[{filters:"any",fieldConstraints:{clientId:{generateValue:!0,scopeFieldName:"parentPageUrl",scopeStrategy:"mainDomain",expirationPeriod:864e5},consumerId:{blacklisted:!0},dsId:{blacklisted:!0},parentPageUrl:{scope:"hostname"}}},{filters:{valueMatches:{eventType:["click"],actionType:["signUp"]}},fieldConstraints:{parentPageUrl:{scope:"fullWithoutParams"}}},{filters:{valueMatches:{eventType:["dialog"],dialogType:["upsell"],result:["upsell"]}},fieldConstraints:{parentPageUrl:{scope:"fullWithoutParams"}}},{filters:{valueMatches:{userType:["signedIn"]}},fieldConstraints:{clientId:{scopeStrategy:"all"}}},{filters:{valueMatches:{userType:["signedIn"],eventType:["click","dialog","media","search"]}},fieldConstraints:{clientId:{blacklisted:!0},consumerId:{blacklisted:!1},dsId:{blacklisted:!1}}},{filters:{valueMatches:{userType:["signedIn"],eventType:["page","impressions"]},nonEmptyFields:["pageHistory"]},fieldConstraints:{clientId:{blacklisted:!0},consumerId:{blacklisted:!1},dsId:{blacklisted:!1}}}]}}},fieldsMap:{cookies:["itcCt","itscc"],custom:{impressions:["id","adamId","link.type","station-hash"],location:["id","adamId","dataSetId","name","fcKind","kindIds","type","link.type","station-hash","core-seed-name"]},single:{targetId:["id","adamId","contentId","type","link.type","fcId","userPreference","label","station-hash","linkIdentifier"]}},metricsUrl:"https://xp.apple.com/report",postFrequency:6e4,postFrequencyLowLatency:5e3,tokenSeparator:"|"},Ys={},_appendSectionAndSubsectionToConfigSources=function(t,n,l){if(l){t.push(l);var d=l[n];d&&function(t){for(var n in t)if(t.hasOwnProperty(n))return!0}(d)&&t.push(d)}},Config=function(t){this._topic=t,this._debugSource=null,this._cachedSource=null,this._serviceSource=null,this._initCalled=!1,this._initialized=!1,this._showedDebugWarning=!1,this._showedNoProvidedSourceWarning=!1,this._keyPathsThatSuppressWarning={configBaseUrl:!0},this.DEBUG_SOURCE_KEY="mtClientConfig_debugSource"+$s.compoundSeparator+this._topic,this.CACHED_SOURCE_KEY="mtClientConfig_cachedSource"+$s.compoundSeparator+this._topic};function disabled(t){return!!this.value("disabled",t)}function blacklistedEvents(t){return this.value("blacklistedEvents",t)||[]}function blacklistedFields(t){return this.value("blacklistedFields",t)||[]}function removeBlacklistedFields(t,n){if(t)for(var l=blacklistedFields.call(this,n),d=0;d<l.length;d++){var p=l[d];p&&p in t&&delete t[p]}return t}function metricsDisabledOrBlacklistedEvent(t,n){return disabled.call(this,n)||!!t&&blacklistedEvents.call(this,n).indexOf(t)>-1}Config.createConfig=function(t,n,l,d){var p=Config.getConfig(t);return t&&"noTopicConfig"!==t&&!p._initCalled&&p.init(n,l,d),p},Config.getConfig=function(t){var n=Ys[t=t||"noTopicConfig"];return n||(n=new Config(t),Ys[t]=n),n},Config.defaultConfig=function(){return Config.getConfig()},Config.value=function(t,n){var l=n&&Ys[n]||Config.defaultConfig();return l.value.call(l,t)},Config.environment=Ks,Config.logger=loggerNamed("mt-client-config"),Config.network=Vs,Config.prototype._defaults=function(){return $s},Config.prototype._setInitialized=function(t){this._initialized=t},Config.prototype._setInitCalled=function(t){this._initCalled=t},Config.prototype._setShowedDebugWarning=function(t){this._showedDebugWarning=t},Config.prototype._setShowedNoProvidedSourceWarning=function(t){this._showedNoProvidedSourceWarning=t},Config.prototype.setDelegate=function(t){return attachDelegate(this,t)},Config.prototype.topic=function(){return this._topic},Config.prototype.configHostname=function(){},Config.prototype.configUrl=function(){var t,n=this.configHostname();return t=n?"https://"+n+"/config/1/report":this.value("configBaseUrl"),"noTopicConfig"!==this._topic?t+="/"+this.topic():Config.logger.error("config.configUrl(): Topic must be provided"),t},Config.prototype.sources=function(){},Config.prototype.value=function(t){var n,l=this.cachedSource(),d=this.serviceSource(),p=this.sources(),h=this.debugSource(),f=l||d||p||h;return p||d||t in this._keyPathsThatSuppressWarning||this._showedNoProvidedSourceWarning||(this._showedNoProvidedSourceWarning=!0,Config.logger.warn("Metrics config: No config provided via delegate or fetched via init(), using default/cached config values.")),h&&(this._showedDebugWarning||(this._showedDebugWarning=!0,Config.logger.warn('"debugSource" found.\nThis will override any same-named client-supplied configSource fields.\nThis setting "sticks" across session, use "setDebugSource(null)" to clear'))),isArray(p)||(p=[p]),n=0===t.indexOf("blacklisted")?f?[l,d,p,h]:[$s]:[$s,l,d,p,h],n=this.configSourcesWithOverrides(n,this.topic()),valueForKeyPath.apply(null,[t].concat(n))},Config.prototype.configSourcesWithOverrides=function(t,n){var l=t;if(t&&t.length&&n){l=[];for(var d=0;d<t.length;d++){var p=t[d];if(p)if(isArray(p)&&p.length){for(var h=[],f=0;f<p.length;f++)_appendSectionAndSubsectionToConfigSources(h,n,p[f]);l.push(h)}else _appendSectionAndSubsectionToConfigSources(l,n,p)}}return l},Config.prototype.setDebugSource=function(t){return this._debugSource=t||null,saveObjectToStorage(Ks.localStorageObject(),this.DEBUG_SOURCE_KEY,this._debugSource)},Config.prototype.debugSource=function(){return this._debugSource||(this._debugSource=objectFromStorage(Ks.localStorageObject(),this.DEBUG_SOURCE_KEY)),this._debugSource},Config.prototype.setCachedSource=function(t){return this._cachedSource=t||null,saveObjectToStorage(Ks.localStorageObject(),this.CACHED_SOURCE_KEY,this._cachedSource)},Config.prototype.cachedSource=function(){return this._cachedSource||(this._cachedSource=objectFromStorage(Ks.localStorageObject(),this.CACHED_SOURCE_KEY)),this._cachedSource},Config.prototype.setServiceSource=function(t){return this._serviceSource=t,this._serviceSource},Config.prototype.serviceSource=function(){return this._serviceSource},Config.prototype.fetchConfig=function(t,n,l){l=l||function(){};exponentialBackoff(Vs.makeAjaxRequest.bind(Vs,t,"GET",null),(function(t){var d;try{t=JSON.parse(t),d=!0}catch(e){l.call(l,e)}d&&n&&n.call(n,t)}),l)},Config.prototype.init=function(t,n,l){if(!this._initCalled){this._initCalled=!0,n=n||function(){};var d=function(){this._initialized=!0,n.call(n)}.bind(this);if(t)this.setDelegate({sources:t}),d();else{this.setCachedSource(this.cachedSource());var p=this.configUrl(),h=function(t){this.setCachedSource(t),this.setServiceSource(t),d()}.bind(this);this.fetchConfig(p,h,l)}}},Config.prototype.initialize=function(t,n,l){return this.init.apply(this,Array.prototype.slice.call(arguments))},Config.prototype.initialized=function(){return this._initialized};function recordEvent(t,n,l){var d=null;return l&&!metricsDisabledOrBlacklistedEvent.call(Config,l.eventType,n)&&(removeBlacklistedFields.call(Config,l,n),t.apply(null,Array.prototype.slice.call(arguments,1)),d=l),d}var Hs=1e4,Ws="events",zs="1.0",Gs=2;function enrichAndSerializeEvents(t){var n=null;if(t&&t.length){var l={};l.deliveryVersion=zs,l.postTime=Date.now(),l[Ws]=t;try{n=JSON.stringify(l)}catch(e){loggerNamed("mt-event-queue").error("Error stringifying events as JSON: "+e)}}return n}function _immediateRecordEvent(t,n){var l=enrichAndSerializeEvents([n]);l&&makeAjaxRequest(function(t){return Config.value("metricsUrl",t)+"/"+Gs+"/"+t}(t),"POST",l,null,null,{timeout:function(t){var n=Config.value("requestTimeout",t)||Hs;return n=Math.min(n,Config.value("postFrequency",t))}(t)})}var qs,Qs,Js,Xs={recordEvent:function(t,n){return recordEvent.apply(null,[_immediateRecordEvent].concat(Array.prototype.slice.call(arguments)))},sendMethod:function(){return"javascript"}},Zs={_document:function(){if("undefined"!=typeof document)return document;throw"metricskit-delegates-html.environment HTML delegate 'document' object not found"},_window:function(){if("undefined"!=typeof window)return window;throw"metricskit-delegates-html.environment HTML delegate 'window' object not found"},cookie:function(){return Zs._window().document.cookie},pageUrl:function(){return Zs._window().location.href},parentPageUrl:function(){var t,n=Zs._window(),l=n.parent;if(l!==n)try{t=l.location.href}catch(e){t=Zs._document().referrer}return t},pixelRatio:function(){return Zs._window().devicePixelRatio},screenHeight:function(){return Zs._window().screen.height},screenWidth:function(){return Zs._window().screen.width},userAgent:function(){return Zs._window().navigator.userAgent},windowInnerHeight:function(){return Zs._window().innerHeight},windowInnerWidth:function(){return Zs._window().innerWidth},windowOuterHeight:function(){return Zs._window().outerHeight},windowOuterWidth:function(){return Zs._window().outerWidth},timeOriginOffset:function(){var t=null,n=Zs._window().performance;return n&&n.timing&&(t=n.timing.navigationStart),t},app:function(){},appVersion:function(){},capacityData:function(){},capacityDataAvailable:function(){},capacityDisk:function(){},capacitySystem:function(){},capacitySystemAvailable:function(){},connectionType:function(){},dsId:function(){},hardwareBrand:function(){},hardwareFamily:function(){},hardwareModel:function(){},hostApp:function(){},hostAppVersion:function(){},os:function(){},osBuildNumber:function(){},osLanguages:function(){},osVersion:function(){},resourceRevNum:function(){},storeFrontCountryCode:function(){},storeFrontHeader:function(){},userType:function(){}};function mergeAndCleanEventFields(t){for(var n=[!1,!1,!1].concat(Array.prototype.slice.call(arguments)),l=[],d=0;d<n.length;d++){var p=n[d];if(p&&p.constructor===Array)for(var h=0;h<p.length;h++)l.push(p[h]);else l.push(p)}return copyKeysAndValues.apply(null,l)}function processMetricsData(t,n,l,d){var p=mergeAndCleanEventFields(d),h=p;if(t&&n){var f={};if(l||(n=n.filter((function(t){return t in p}))),n.length)for(var y=0;y<n.length;y++){var v=n[y],_=t[v];isFunction(_)&&(f[v]=_.call(t,p))}h=mergeAndCleanEventFields(h,f)}return h}function applyFieldsMap(t,n,l,d){var p,h,f,y;if(t&&n&&l){var v,_;if(h={},p=valueForKeyPath(n,l,l.custom))if(isArray(p))for(v=0;v<p.length;++v)isDefinedNonNull(_=t[p[v]])&&(h[p[v]]=_);else if((y=p)&&y.constructor===Object){for(var g in p)for(v=0;v<p[g].length;++v)if(isDefinedNonNull(_=valueForKeyPath(p[g][v],t))){h[g]=_;break}}else f="metrics: incorrect data type provided to applyFieldsMap (only accepts objects and Arrays)";else f="metrics: unable to get "+n+" section from fieldsMap"}else{var m=[];t||m.push("data"),n||m.push("sectionName"),l||m.push("fieldsMap"),f="metrics: missing argument(s): "+m.join(",")+" not provided to applyFieldsMap"}return f&&isFunction(d)&&d(f),h}function environmentBaseFieldNames(){return Qs||(Qs=["app","appVersion","hardwareFamily","hardwareModel","os","osBuildNumber","osLanguages","osVersion","resourceRevNum","screenHeight","screenWidth","userAgent"].concat(["delegateApp","hardwareBrand","storeFrontCountryCode","storeFrontHeader"])),Qs}function Base(t){this.setDelegate({topic:t}),Js||(Js=!0,environmentBaseFieldNames().forEach(function(t){Base.prototype[t]=function(n){return n&&n.hasOwnProperty(t)?n[t]:this.environment()[t]()}.bind(this)}.bind(this)))}Base._className="eventHandlers.base",Base.prototype.setDelegate=function(t){return attachDelegate(this,t)},Base.prototype.topic=function(){throw exceptionString(Base._className,"topic")},Base.prototype.environment=function(){throw exceptionString(Base._className,"environment")},Base.prototype.eventRecorder=function(){throw exceptionString(Base._className,"eventRecorder")},Base.prototype.metricsData=function(){throw exceptionString(Base._className,"metricsData")},Base.prototype.processMetricsData=function(){throw exceptionString(Base._className,"processMetricsData")},Base.prototype.knownFields=function(){return qs||(qs=environmentBaseFieldNames().concat(["baseVersion","clientEventId","connection","eventTime","eventType","eventVersion","timezoneOffset","xpPostFrequency","xpSendMethod"])),qs},Base.prototype.baseVersion=function(){return 1},Base.prototype.clientEventId=function(t){return t&&t.clientEventId||function(t){var l;if(16777215==Math.floor(4294967295/256)){var d,p,h,f,y,v=n.crypto||n.msCrypto;if(v&&v.getRandomValues)d=v.getRandomValues(new Uint32Array(16/Uint32Array.BYTES_PER_ELEMENT)),y=!0;else if(v&&v.randomBytes){var _=v.randomBytes(16);d=new Uint32Array(_.buffer,_.byteOffset,_.byteLength/Uint32Array.BYTES_PER_ELEMENT),y=!0}else for(d=new Uint32Array(16/Uint32Array.BYTES_PER_ELEMENT),p=0;p<d.length;p++)d[p]=Math.floor(Math.random()*Math.floor(4294967295));if(d){for(l="",p=0;p<d.length;p++)for(f=d[p],h=0;h<6;h++)l+="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz"[f%62],f=Math.floor(f/62);t&&(l="1_"+(y?"1":"2")+"_"+l)}}return l}(!0)},Base.prototype.connection=function(t){return t&&t.connection||this.environment().connectionType()},Base.prototype.dsId=function(t){return t&&t.dsId||this.environment().dsId()},Base.prototype.eventTime=function(t){return t&&t.eventTime||Date.now()},Base.prototype.eventVersion=function(t){return t&&t.eventVersion||null},Base.prototype.timezoneOffset=function(t){return t&&t.timezoneOffset||(new Date).getTimezoneOffset()},Base.prototype.xpPostFrequency=function(t){return t&&t.xpPostFrequency||Config.value("postFrequency",this.topic())},Base.prototype.xpSendMethod=function(t){return t&&t.xpSendMethod||this.eventRecorder().sendMethod()};var eu=Base;function MetricsData(){this._eventData={}}MetricsData.prototype.updateData=function(){extend.apply(null,[this._eventData].concat(Array.prototype.slice.call(arguments)))};var tu,ru,iu=MetricsData;function Environment(){tu||(tu=!0,["app","appVersion","hardwareFamily","hardwareModel","os","osBuildNumber","osLanguages","osVersion","resourceRevNum","screenHeight","screenWidth","userAgent"].forEach((function(t){Environment.prototype[t]=function(){throw exceptionString(Environment._className,t)}})),["delegateApp","hardwareBrand","storeFrontCountryCode","storeFrontHeader"].forEach((function(t){Environment.prototype[t]=function(){}})))}function topic(){return ru}Environment._className="system.environment",Environment.prototype.setDelegate=function(t){return attachDelegate(this,t)},Environment.prototype.connectionType=function(){throw exceptionString(Environment._className,"connectionType")},Environment.prototype.dsId=function(){},Environment.prototype.localStorageObject=Bs,Environment.prototype.sessionStorageObject=js;var nu="unknown",ou="next",au="previous",su="location",uu="interval",cu="playhead",lu="scrub",du="transition",pu="interruption",hu="buffering",fu="play",yu="seek",vu="skipIntro",_u="actionType",gu="consumerId",mu="consumerNs",bu="dsId",Pu="eventType",Tu="eventVersion",Su="isOffline",ku="videoViewportHeight",Au="videoViewportWidth",Iu={TYPE:{MANUAL:"manual",AUTOMATIC:"automatic",UNKNOWN:nu},PLAY_START_REASON:{PLAY:fu,UNPAUSE:"unpause",NEXT:ou,PREVIOUS:au,SEEK:yu,TRANSITION:du,INTERRUPTION:pu,FOREGROUND:"foreground",FOCUS:"focus",BUFFERING:hu,UNKNOWN:nu},PLAY_START_REASON_TYPE:{SKIP_INTRO:vu},PLAY_STOP_REASON:{COMPLETE:"complete",TRANSITION:du,PLAY_OTHER:"playOther",PAUSE:"pause",SEEK:yu,NEXT:ou,INTERRUPTION:pu,BACKGROUND:"background",EXIT:"exit",INACTIVITY:"inactivity",BUFFERING:hu,ERROR:"error",FAILURE:"failure",UNKNOWN:nu,CLOSE_PLAYER:"closePlayer"},PLAY_STOP_REASON_TYPE:{SKIP_INTRO:vu},SEEK_START_REASON:{NEXT:ou,PREVIOUS:au,LOCATION:su,INTERVAL:uu,PLAYHEAD:cu,SCRUB:lu,UNKNOWN:nu,SKIP_INTRO:vu},SEEK_STOP_REASON:{NEXT:ou,PREVIOUS:au,LOCATION:su,INTERVAL:uu,PLAYHEAD:cu,SCRUB:lu,UNKNOWN:nu,SKIP_INTRO:vu}},Eu={ACTIVITY_TYPE:{PLAY:fu,SEEK:yu},ACTION_TYPE:{START:"start",STOP:"stop"},EVENT_TYPE:{PLAY_ACTIVITY:"playActivity",SEEK_ACTIVITY:"seekActivity"}},wu={INCLUDES_START_POSITIONS:"includesStartPositions",INCLUDES_END_POSITIONS:"includesEndPositions"};function VPAFKitEnvironment(){Environment.apply(this,arguments)}VPAFKitEnvironment.prototype=new Environment,VPAFKitEnvironment.prototype.constructor=VPAFKitEnvironment,VPAFKitEnvironment.prototype.consumerId=function(){},VPAFKitEnvironment.prototype.consumerNs=function(){},VPAFKitEnvironment.prototype.isOffline=function(){},VPAFKitEnvironment.prototype.videoViewportHeight=function(){},VPAFKitEnvironment.prototype.videoViewportWidth=function(){};var Ou={setDelegate:function(t){return attachDelegate(this,t)},recordEvent:function(t,n){throw exceptionString("system.eventRecorder","recordEvent")},sendMethod:function(){throw exceptionString("system.eventRecorder","sendMethod")},flushUnreportedEvents:function(t){}},Ru={};Ru.environment=new VPAFKitEnvironment,Ru.eventRecorder=Ou,Ru.logger=loggerNamed("mt-vpafkit");var Cu=eu,VPAFKitBase=function(){Cu.apply(this,arguments)};(VPAFKitBase.prototype=new Cu).constructor=VPAFKitBase,VPAFKitBase.prototype.environment=function(){return Ru.environment},VPAFKitBase.prototype.eventRecorder=function(){return Ru.eventRecorder},VPAFKitBase.prototype.knownFields=function(){var t=Cu.prototype.knownFields().concat([_u,gu,mu,bu,Su,ku,Au]);return t},VPAFKitBase.prototype.consumerId=function(t){var n=gu;return t&&n in t?t[n]:this.environment().consumerId()},VPAFKitBase.prototype.consumerNs=function(t){var n=mu;return t&&n in t?t[n]:this.environment().consumerNs()},VPAFKitBase.prototype.isOffline=function(t){var n=Su;return t&&n in t?t[n]:this.environment().isOffline()},VPAFKitBase.prototype.videoViewportHeight=function(t){var n=ku;return t&&n in t?t[n]:this.environment().videoViewportHeight()},VPAFKitBase.prototype.videoViewportWidth=function(t){var n=Au;return t&&n in t?t[n]:this.environment().videoViewportWidth()};var Mu=new VPAFKitBase((function(){return topic()}));Mu.metricsData=function(){return Mu.processMetricsData.apply(Mu,[null].concat(Array.prototype.slice.call(arguments)))},Mu.processMetricsData=function(t){var n=null;if(!Config.metricsDisabledOrBlacklistedEvent(t,topic())){var l=Array.prototype.slice.call(arguments,1);if(this!==Mu){var d=Mu.metricsData.apply(Mu,l);l=[d].concat(l)}n=processMetricsData(this,this.knownFields(),!0,l)}return Config.removeBlacklistedFields(n,topic()),n};var MediaActivity=function(t,n){this._defaultEventType=t,this._reasonConstants=n,this._defaultActionType};extend(MediaActivity,Eu),Object.defineProperties(MediaActivity.prototype,{TYPE:{get:function(){return Iu.TYPE}},REASON:{get:function(){return this._reasonConstants}}}),MediaActivity.prototype.setDelegate=function(t){return attachDelegate(this,t)},MediaActivity.prototype.knownFields=function(){var t=[_u,Pu,Tu];return t},MediaActivity.prototype.eventType=function(t){return this._defaultEventType},MediaActivity.prototype.eventVersion=function(t){var n=Mu.eventVersion(t);return null!==n?n:1},MediaActivity.prototype.actionType=function(t){return this._defaultActionType};var StartMediaActivity=function(t,n){MediaActivity.apply(this,arguments),this._defaultActionType=MediaActivity.ACTION_TYPE.START};(StartMediaActivity.prototype=new MediaActivity).constructor=StartMediaActivity,StartMediaActivity.prototype.metricsData=function(t,n,l,d){var p=this.eventType(),h={position:t,overallPosition:n,startType:l,startReason:d},f=Array.prototype.slice.call(arguments,4);return Mu.processMetricsData.apply(this,[p,h].concat(f))};var StopMediaActivity=function(t,n){MediaActivity.apply(this,arguments),this._defaultActionType=MediaActivity.ACTION_TYPE.STOP};(StopMediaActivity.prototype=new MediaActivity).constructor=StopMediaActivity,StopMediaActivity.prototype.metricsData=function(t,n,l,d,p){var h=this.eventType(),f={position:t,overallPosition:n,stopType:l,stopReason:d,startPosition:(p=p||{}).position,startOverallPosition:p.overallPosition,startTime:p.eventTime,startType:p.startType,startReason:p.startReason,startReasonType:p.startReasonType};h===MediaActivity.EVENT_TYPE.SEEK_ACTIVITY&&(f.startAssetId=p.assetId);var y=Array.prototype.slice.call(arguments,5);return Mu.processMetricsData.apply(this,[h,f].concat(y))};var Nu=new StartMediaActivity(MediaActivity.EVENT_TYPE.PLAY_ACTIVITY,Iu.PLAY_START_REASON),Du=new StopMediaActivity(MediaActivity.EVENT_TYPE.PLAY_ACTIVITY,Iu.PLAY_STOP_REASON),Lu=new StartMediaActivity(MediaActivity.EVENT_TYPE.SEEK_ACTIVITY,Iu.SEEK_START_REASON),xu=new StopMediaActivity(MediaActivity.EVENT_TYPE.SEEK_ACTIVITY,Iu.SEEK_STOP_REASON),Uu=Object.freeze({__proto__:null,base:Mu,playStart:Nu,playStop:Du,seekStart:Lu,seekStop:xu}),MediaActivity$1=function(t){this._activityType=t,this._startMetricsData=null,this._isStopped=!1};MediaActivity$1.ACTIVITY_TYPE=Eu.ACTIVITY_TYPE,Object.defineProperties(MediaActivity$1.prototype,{isStopped:{get:function(){return this._isStopped}},type:{get:function(){return this._activityType}},startOverallPosition:{get:function(){return this._startMetricsData?this._startMetricsData.overallPosition:null}}}),extend(MediaActivity$1.prototype,Iu),MediaActivity$1.prototype.started=function(t,n,l,d){var p=this._startEventHandler();p&&(this._startMetricsData=p.metricsData.apply(p,arguments),this.type!=MediaActivity$1.ACTIVITY_TYPE.SEEK&&Ou.recordEvent(topic(),this._startMetricsData))},MediaActivity$1.prototype.stopped=function(t,n,l,d){var p=this._stopEventHandler();if(p){this._isStopped=!0;var h=[t,n,l,d,this._startMetricsData].concat(Array.prototype.slice.call(arguments,4)),f=p.metricsData.apply(p,h);Ou.recordEvent(topic(),f)}},MediaActivity$1.prototype._startEventHandler=function(){var t;switch(this.type){case MediaActivity$1.ACTIVITY_TYPE.PLAY:t=Nu;break;case MediaActivity$1.ACTIVITY_TYPE.SEEK:t=Lu}return t},MediaActivity$1.prototype._stopEventHandler=function(){var t;switch(this.type){case MediaActivity$1.ACTIVITY_TYPE.PLAY:t=Du;break;case MediaActivity$1.ACTIVITY_TYPE.SEEK:t=xu}return t};var TimeTracker=function(t,n){this._date=new Date,this._position=n,this._validatePlaybackRate(t),this._playbackRate=t};Object.defineProperties(TimeTracker.prototype,{playbackRate:{get:function(){return this._playbackRate}}}),TimeTracker.prototype.update=function(t,n){this._date=new Date,this._position=n,this._validatePlaybackRate(t),this._playbackRate=t},TimeTracker.prototype.estimatedTime=function(t){var n;isInteger(t)?n=t:(Ru.logger.error("VPAFKit error: position should be an integer"),n=Math.round(t));var l=(n-this._position)/(0==this.playbackRate?1:this.playbackRate);return this._date.getTime()+Math.round(l)},TimeTracker.prototype._validatePlaybackRate=function(t){0==t&&Ru.logger.error("VPAFKit error: playbackRate should not be zero.")};var Bu=iu,ju=wu.INCLUDES_START_POSITIONS,Fu=wu.INCLUDES_END_POSITIONS,MediaActivityTracker=function(t){Bu.apply(this,arguments),this._playlist=t,this._playActivity=null,this._playStartPlaylistItem=null,this._seekActivity=null,this._timeTracker=null,this._shouldGenerateTransitions=!0};(MediaActivityTracker.prototype=new Bu).constructor=MediaActivityTracker,extend(MediaActivityTracker.prototype,Iu),Object.defineProperties(MediaActivityTracker.prototype,{shouldGenerateTransitions:{get:function(){return this._shouldGenerateTransitions},set:function(t){this._shouldGenerateTransitions=t}}}),MediaActivityTracker.prototype.setDelegate=function(t){return attachDelegate(this,t)},MediaActivityTracker.prototype.playStarted=function(t,n,l){return this.playStartedWithPlaybackRate.apply(this,[1].concat(Array.prototype.slice.call(arguments)))},MediaActivityTracker.prototype.playStartedWithPlaybackRate=function(t,n,l,d){if(this._hasUnstoppedActivity(this._playActivity))this._error("inconsistent state: did you forget to call playStopped?");else{var p=this._playlistItem(n,ju);p&&(this._playStarted.apply(this,[p].concat(Array.prototype.slice.call(arguments,1))),this.shouldGenerateTransitions&&(this._timeTracker=new TimeTracker(t,n)))}},MediaActivityTracker.prototype.playStopped=function(t,n,l){this._generatePlaylistTransitionsIfNecessary(t),this._hasUnstoppedActivity(this._playActivity)?this._playStopped.apply(this,Array.prototype.slice.call(arguments)):this._error("inconsistent state: did you forget to call playStarted?"),this._playStartPlaylistItem=null,this._timeTracker=null},MediaActivityTracker.prototype.playTransitioned=function(t){this.playStopped.apply(this,[t,this.TYPE.AUTOMATIC,this.PLAY_STOP_REASON.TRANSITION].concat(Array.prototype.slice.call(arguments,1))),this.playStarted.apply(this,[t,this.TYPE.AUTOMATIC,this.PLAY_START_REASON.TRANSITION].concat(Array.prototype.slice.call(arguments,1)))},MediaActivityTracker.prototype.seekStarted=function(t,n,l){if(this._hasUnstoppedActivity(this._seekActivity))this._error("inconsistent state: did you forget to call seekStopped?");else{var d=this._playlistItem(t,ju);if(d){var p=this._activityArguments.apply(this,[d].concat(Array.prototype.slice.call(arguments)));this._seekActivity=new MediaActivity$1(MediaActivity$1.ACTIVITY_TYPE.SEEK),this._seekActivity.started.apply(this._seekActivity,p)}}},MediaActivityTracker.prototype.seekStopped=function(t,n,l){var d=this._playlistItem(t,Fu);if(d&&this._hasUnstoppedActivity(this._seekActivity)){var p=this._activityArguments.apply(this,[d].concat(Array.prototype.slice.call(arguments)));this._seekActivity.stopped.apply(this._seekActivity,p)}else this._error("inconsistent state: did you forget to call seekStarted?")},MediaActivityTracker.prototype.synchronize=function(t,n){if(this.shouldGenerateTransitions){var l=t>0,d=this._hasUnstoppedActivity(this._playActivity);d&&l?(this._generatePlaylistTransitionsIfNecessary(n),this._timeTracker.update(t,n)):d&&!l?this._error("inconsistent state: did you forget to call playStopped?"):!d&&l&&this._error("inconsistent state: did you forget to call playStarted?")}},MediaActivityTracker.prototype._playStarted=function(t,n,l,d){var p=this._activityArguments.apply(this,[t].concat(Array.prototype.slice.call(arguments,1)));this._playStartPlaylistItem=t,this._playActivity=new MediaActivity$1(MediaActivity$1.ACTIVITY_TYPE.PLAY),this._playActivity.started.apply(this._playActivity,p)},MediaActivityTracker.prototype._playStopped=function(t,n,l){var d=this._playStartPlaylistItem,p=this._activityArguments.apply(this,[d].concat(Array.prototype.slice.call(arguments)));this._playActivity.stopped.apply(this._playActivity,p)},MediaActivityTracker.prototype._playlistItem=function(t,n){var l;return this._playlist&&isFunction(this._playlist.getItem)&&(l=this._playlist.getItem(t,n)),l||this._error("unable to get item from playlist"),l},MediaActivityTracker.prototype._playlistItems=function(t,n){var l=[];return this._playlist&&isFunction(this._playlist.getItems)?l=this._playlist.getItems(t,n):this._error("unable to get items from playlist"),l},MediaActivityTracker.prototype._relativePosition=function(t,n){var l;return(n=n||this._playlistItem(t))&&isNumber(n.startOverallPosition)&&(l=t-n.startOverallPosition+(n.startPosition||0)),l},MediaActivityTracker.prototype._combineEventData=function(t,n){var l=this._playlist?this._playlist.eventData:null,d=t?t.eventData:null,p=[];return l&&p.push(l),d&&p.push(d),this._eventData&&p.push(this._eventData),n&&(p=p.concat(n)),p},MediaActivityTracker.prototype._activityArguments=function(t,n,l,d){var p=this._relativePosition(n,t),h=this._combineEventData(t,Array.prototype.slice.call(arguments,4)),f=[p,n,l,d].concat(h);return f},MediaActivityTracker.prototype._generatePlaylistTransitionsIfNecessary=function(t){if(this.shouldGenerateTransitions&&this._hasUnstoppedActivity(this._playActivity)){var n,l,d,p=this._playActivity.startOverallPosition||0,h=this._playlistItems(p,t);this._playlist._returnsOrderedItems||h.sort(this._playlistItemComparator);for(var f=0;f+1<h.length;f++)if(h[f],!((n=(l=h[f+1]).startOverallPosition)<=p)){if(n>=t)break;d={eventTime:this._timeTracker?this._timeTracker.estimatedTime(n):null},this._playStopped(n,this.TYPE.AUTOMATIC,this.PLAY_STOP_REASON.TRANSITION,d),this._playStarted(l,n,this.TYPE.AUTOMATIC,this.PLAY_START_REASON.TRANSITION,d)}}},MediaActivityTracker.prototype._hasUnstoppedActivity=function(t){return t&&!t.isStopped},MediaActivityTracker.prototype._error=function(t){Ru.logger.error(this.constructor.name+" error: "+t)},MediaActivityTracker.prototype._playlistItemComparator=function(t,n){return t.startOverallPosition==n.startOverallPosition?0:t.startOverallPosition<n.startOverallPosition?-1:1};var Ku=iu,MediaPlaylistItem=function(t){Ku.apply(this,arguments),this._startOverallPosition=t,this._startPosition=0};(MediaPlaylistItem.prototype=new Ku).constructor=MediaPlaylistItem,Object.defineProperties(MediaPlaylistItem.prototype,{startOverallPosition:{get:function(){return this._startOverallPosition}},startPosition:{get:function(){return this._startPosition},set:function(t){this._startPosition=t}},eventData:{get:function(){return this._eventData}}});var HLSRollItem=function(t,n){MediaPlaylistItem.apply(this,arguments),this._duration=n};(HLSRollItem.prototype=new MediaPlaylistItem).constructor=HLSRollItem,Object.defineProperties(HLSRollItem.prototype,{duration:{get:function(){return this._duration}},endOverallPosition:{get:function(){return this.startOverallPosition+this.duration}}}),HLSRollItem.prototype.containsOverallPosition=function(t){return this.startOverallPosition<=t&&this.endOverallPosition>t};var MediaPlaylist=function(){};MediaPlaylist.prototype.RANGE_OPTIONS=wu,Object.defineProperties(MediaPlaylist.prototype,{eventData:{get:function(){}}}),MediaPlaylist.prototype.getItem=function(t,n){},MediaPlaylist.prototype.getItems=function(t,n){};var HLSVideoPlaylist=function(t){MediaPlaylist.apply(this,arguments),this._startPosition=t,this._mainFeatureMetricsData=copyKeysAndValues.apply(null,[!1,!1,!1,null].concat(Array.prototype.slice.call(arguments,1))),this._rollItems=[]};(HLSVideoPlaylist.prototype=new MediaPlaylist).constructor=HLSVideoPlaylist,HLSVideoPlaylist.prototype.setDelegate=function(t){return attachDelegate(this,t)},HLSVideoPlaylist.prototype.addRollInfoItems=function(t){t&&t.length&&t.forEach((function(t){this.addRollInfoItem(t)}),this)},HLSVideoPlaylist.prototype.addRollInfoItem=function(t){t&&this.addRollItem(1e3*t.start,1e3*t.duration,t.metricsData)},HLSVideoPlaylist.prototype.addRollItem=function(t,n){var l=new HLSRollItem(t,n);l.updateData.apply(l,Array.prototype.slice.call(arguments,2)),this._addRollItem(l)},HLSVideoPlaylist.prototype.updateMainFeatureMetricsData=function(){extend.apply(null,[this._mainFeatureMetricsData].concat(Array.prototype.slice.call(arguments)))},HLSVideoPlaylist.prototype.getItem=function(t,n){var l,d=this._indexOfLastRollItemWithStartBeforePosition(t);if(isInteger(d)){for(;n!=this.RANGE_OPTIONS.INCLUDES_START_POSITIONS&&this._rollItems[d].startOverallPosition==t&&d>0;)d--;(l=this._rollItems[d]).containsOverallPosition(t)||n==this.RANGE_OPTIONS.INCLUDES_END_POSITIONS&&l.endOverallPosition==t||(l=this._mainFeatureItemWithStartOverallPosition(l.endOverallPosition))}else l=this._mainFeatureItemWithStartOverallPosition(this._startPosition);return l},HLSVideoPlaylist.prototype.getItems=function(t,n){var l=[];if(this._rollItems.length){var d=this._indexOfLastRollItemWithStartBeforePosition(t);for(isInteger(d)||(l.push(this._mainFeatureItemWithStartOverallPosition(this._startPosition)),d=0);d<this._rollItems.length;){var p=this._rollItems[d];if(p.startOverallPosition>n)break;if(p.endOverallPosition>=t&&l.push(p),d++,p.endOverallPosition<n)if(d<this._rollItems.length){var h=this._rollItems[d];h.startOverallPosition&&h.startOverallPosition>p.endOverallPosition&&l.push(this._mainFeatureItemWithStartOverallPosition(p.endOverallPosition))}else l.push(this._mainFeatureItemWithStartOverallPosition(p.endOverallPosition))}}else l.push(this._mainFeatureItemWithStartOverallPosition(this._startPosition));return l},HLSVideoPlaylist.prototype._addRollItem=function(t){if(t){var n=this._insertionIndexForItemWithPosition(t.startOverallPosition);this._rollItems.splice(n,0,t)}},HLSVideoPlaylist.prototype._indexOfLastRollItemWithStartBeforePosition=function(t){var n,l=this._rollItems[0];return l&&isInteger(t)&&l.startOverallPosition<=t&&(n=this._insertionIndexForItemWithPosition(t)-1),n},HLSVideoPlaylist.prototype._insertionIndexForItemWithPosition=function(t){for(var n=0,l=this._rollItems.length;n<l;){var d=Math.floor((n+l)/2);this._rollItems[d].startOverallPosition>t?l=d:n=d+1}return n},HLSVideoPlaylist.prototype._mainFeatureItemWithStartOverallPosition=function(t){var n=new MediaPlaylistItem(t);return n.startPosition=this._featurePlayheadProgress(t),n.updateData(this._mainFeatureMetricsData),n},HLSVideoPlaylist.prototype._featurePlayheadProgress=function(t){t=t||0;var n,l,d=this._indexOfLastRollItemWithStartBeforePosition(t),p=this._startPosition||0;isInteger(d)||(d=-1);for(var h=d;h>=0;h--)n=this._rollItems[h],0===h?p+=n.startOverallPosition:(l=this._rollItems[h-1],p+=n.startOverallPosition-l.endOverallPosition);return p};var Vu=Object.freeze({__proto__:null,createTracker:function(t){var n=new MediaActivityTracker(t);return n.updateData.apply(n,Array.prototype.slice.call(arguments,1)),n},createHLSVideoPlaylist:function(t){var n=new HLSVideoPlaylist(t);return n.updateMainFeatureMetricsData.apply(n,Array.prototype.slice.call(arguments,1)),n}});var $u=Object.freeze({__proto__:null,applyFieldsMap:function(t,n){return applyFieldsMap(t,n,Config.value("fieldsMap",topic()))}}),Yu=Object.freeze({__proto__:null,eventFields:$u});function PlayActivity$2(){this.config=Config.defaultConfig(),this._initCalled=!1}PlayActivity$2.prototype._utReset=function(){this.config=Config.defaultConfig(),this._initCalled=!1},PlayActivity$2.prototype.init=function(t,n,l,d,p){if(!this._initCalled){this._initCalled=!0,l&&(setDelegates(Uu,l),setDelegates(Ru,l)),function(t){ru=t}(t);var h=Config.getConfig(t),f={metricsDisabledOrBlacklistedEvent:metricsDisabledOrBlacklistedEvent,removeBlacklistedFields:removeBlacklistedFields};attachMethods(h,f,h),attachMethods(Config,f,Config),function(t,n){var l=null;if(t&&n&&n.setDelegate){var d,p={};for(d in t)isFunction(t[d])&&t[d].origFunction&&(p[d]=t[d]);l=n.setDelegate(p)}}(this.config,h),h.init(n,d,p),this.config=h}},PlayActivity$2.prototype.system=Ru,PlayActivity$2.prototype.eventHandlers=Uu,PlayActivity$2.prototype.mediaActivityTracker=Vu,PlayActivity$2.prototype.utils=Yu;var Hu,Wu,zu,Gu,qu,Qu,Ju,Xu,Zu,ec=new PlayActivity$2,tc={"ac-3":"AC3","mp4a.a5":"AC3",alac:"Apple Lossless","ec-3":"EC3","mp4a.a6":"EC3",flac:"Free Lossless","mp4a.40.2":"AAC","mp4a.40.5":"AAC","mp4a.40.29":"AAC","mp4a.40.34":"MP3","mp4a.40.42":"AAC"},rc=/^[0-9]+\/JOC$/,isAtmos=function(t,n){return"EC3"===tc[t]&&function(t){return rc.test(t)}(n)},ic=["dvh1.05.01","dvhe.05.06"],nc={PQ:"HDR",HLG:"HDR",SDH:"SDH"},convertToVideoColorRange=function(t,n){return function(t){return-1!==ic.indexOf(t)}(t)?"DolbyVision":function(t){var n;return null!==(n=nc[t])&&void 0!==n?n:t}(n)},getDefaultPlayable=function(t){if(hasPlayables(t))return t.playables[0]},hasPlayables=function(t){return void 0!==t.playables&&Array.isArray(t.playables)&&t.playables.length>0},oc={initial:"idle",states:{idle:{on:(Hu={},Hu.PLAY={target:"playing",context:{reason:"PLAY",manual:"MANUAL"}},Hu)},binging:{on:(Wu={},Wu.PLAY={target:"playing",context:{reason:"NEXT",manual:"~~previous~~"}},Wu)},playing:{on:(zu={},zu.BUFFER_START={target:"buffering",context:{reason:"BUFFERING",manual:"AUTOMATIC"}},zu.EXIT={target:"idle",context:{reason:"EXIT"}},zu.PAUSE={target:"paused",context:{reason:"PAUSE"}},zu.STOP={target:"idle",context:{}},zu.NEXT={target:"binging",context:{reason:"NEXT"}},zu.NEW={target:"idle",context:{}},zu)},paused:{on:(Gu={},Gu.PLAY={target:"playing",context:{reason:"UNPAUSE"}},Gu.NEW={target:"idle",context:{}},Gu)},buffering:{on:(qu={},qu.BUFFER_STOP={target:"playing",context:{reason:"BUFFERING",manual:"AUTOMATIC"}},qu)}}},ac={manual:"UNKNOWN",reason:"UNKNOWN"},sc=function(){function VPAFStateMachine(){this.currentState=oc.initial,this.currentContext=ac}return VPAFStateMachine.prototype.isAllowedTransition=function(t){return void 0!==this.getNextState(t)},VPAFStateMachine.prototype.transition=function(t,n){void 0===n&&(n={});var l=this.getNextState(t);if(l){var d={};return n.hasOwnProperty("manual")&&(void 0!==n.manual?d.manual=n.manual?"MANUAL":"AUTOMATIC":d.manual="UNKNOWN"),void 0!==n.reason&&(d.reason=n.reason),this.currentContext=__assign(__assign(__assign(__assign({},ac),l.context),d),this.preservePreviousContext(l.context)),this.currentState=l.target,this.currentContext}},VPAFStateMachine.prototype.reset=function(){this.currentState=oc.initial,this.currentContext=ac},VPAFStateMachine.prototype.getNextState=function(t){return oc.states[this.currentState].on[t]},VPAFStateMachine.prototype.preservePreviousContext=function(t){var n=this,l={};return["manual","reason","reasonType"].forEach((function(d){"~~previous~~"===t[d]&&(l[d]=n.currentContext[d])})),l},VPAFStateMachine}(),uc=__assign(__assign({},{NEXT_ITEM:"NEXT"}),He),cc=((Qu={})[Ve.playbackPause]="PAUSE",Qu[Ve.playbackPlay]="PLAY",Qu[Ve.playbackStop]="STOP",Qu[Ve.playerExit]="EXIT",Qu),lc=((Ju={})[He.EXITED_APPLICATION]="EXIT",Ju[He.FAILED_TO_LOAD]="FAILURE",Ju[He.MANUALLY_SELECTED_PLAYBACK_OF_A_DIFF_ITEM]="PLAY_OTHER",Ju[He.NATURAL_END_OF_TRACK]="COMPLETE",Ju[He.PLAYBACK_PAUSED_DUE_TO_INACTIVITY]="INACTIVITY",Ju[He.SCRUB_BEGIN]="SEEK",Ju[He.TRACK_SKIPPED_BACKWARDS]="SEEK",Ju[He.TRACK_SKIPPED_FORWARDS]="SEEK",Ju[uc.NEXT_ITEM]="NEXT",Ju),dc={captions:"closedCaptionLocale",subtitles:"subtitleLocale"},pc=((Xu={})[t.PresentationMode.pictureinpicture]="pictureInPicture",Xu[t.PresentationMode.inline]="foreground",Xu._default="foreground",Xu),hc=function(){function VPAFTrackerAPI(){this.isScrubbing=!1,this.vpafKitInited=!1,this.state=new sc,ec.config.setDelegate({configHostname:function(){return"daf.xp.apple.com"}})}return Object.defineProperty(VPAFTrackerAPI.prototype,"currentItem",{get:function(){return this._currentItem},set:function(t){this._currentItem=t,this.currentSkipItems=t?parseSkipItems(t):void 0},enumerable:!0,configurable:!0}),VPAFTrackerAPI.prototype.configure=function(t,n){var l,d;return __awaiter(this,void 0,void 0,(function(){var p,h=this;return __generator(this,(function(f){switch(f.label){case 0:if(this.instance=t,this.dispatcher=n.services.dispatcher,xa.storekit.cid)return[3,4];f.label=1;case 1:return f.trys.push([1,3,,4]),[4,xa.storekit.infoRefresh()];case 2:return f.sent(),[3,4];case 3:return f.sent(),[3,4];case 4:return p=null===(d=null===(l=n.services.apiManager)||void 0===l?void 0:l.utsAPI)||void 0===d?void 0:d.config,[2,new Promise((function(t,n){var l=[];navigator.languages?l=navigator.languages:navigator.language?l=[navigator.language]:navigator.userLanguage&&(l=[navigator.userLanguage]);var onSuccess=function(){return ec.system.environment.setDelegate({app:function(){return"com.apple.tv"},appVersion:function(){return"1.0"},consumerId:function(){return xa.storekit.cid},consumerNs:function(){return"TV"},isOffline:function(){return!1},delegateApp:function(){return"web-tv-player"},osLanguages:function(){return l},resourceRevNum:function(){return ns.app.build},storeFrontCountryCode:function(){var t,n;return null!==(n=null===(t=null==p?void 0:p.userProps)||void 0===t?void 0:t.country)&&void 0!==n?n:""}}),h.setupListeners(),h.vpafKitInited=!0,t(h)};if(h.vpafKitInited)return onSuccess();var d={environment:Zs,eventRecorder:Xs};ec.init("xp_amp_tv_vpaf",null,d,onSuccess,(function(t){n(t)}))}))]}}))}))},VPAFTrackerAPI.prototype.cleanup=function(){this.tracker=void 0,this.isScrubbing=!1,this.scrubStopPosition=void 0,this.teardownListeners(),this.stopSynchronizing()},VPAFTrackerAPI.prototype.shouldConfigure=function(t){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(t){return[2,!0]}))}))},VPAFTrackerAPI.prototype.shouldTrackPlayActivity=function(t,n){if(!n)return!1;var l=getDefaultPlayable(n);if(!l||!l.vpafMetrics)return!1;var d=cc[t];return void 0===d||this.state.isAllowedTransition(d)},VPAFTrackerAPI.prototype.activate=function(t){return Promise.resolve()},VPAFTrackerAPI.prototype.bufferStart=function(t,n){return __awaiter(this,void 0,void 0,(function(){var l;return __generator(this,(function(d){switch(d.label){case 0:return void 0!==this.currentItem&&this.isCurrentItem(t)?[3,2]:[4,this.play(t,n)];case 1:d.sent(),d.label=2;case 2:return[4,this.shouldTrack(t)];case 3:return d.sent()?(l=this.adjustedPosition(n),this.state.transition("BUFFER_START"),this.trackEvent("playStopped",l),[2]):[2]}}))}))},VPAFTrackerAPI.prototype.bufferEnd=function(t,n){return __awaiter(this,void 0,void 0,(function(){var l;return __generator(this,(function(d){switch(d.label){case 0:return[4,this.shouldTrack(t)];case 1:return d.sent()?(l=this.adjustedPosition(n),this.state.transition("BUFFER_STOP"),this.trackEvent("playStarted",l),[2]):[2]}}))}))},VPAFTrackerAPI.prototype.exit=function(t){return void 0===t&&(t={}),__awaiter(this,void 0,void 0,(function(){return __generator(this,(function(n){switch(n.label){case 0:return[4,this.shouldTrack()];case 1:return n.sent()?(this.state.transition("EXIT"),this.trackEvent("playStopped",this.adjustedPosition(t)),this.stopSynchronizing(),[2]):[2]}}))}))},VPAFTrackerAPI.prototype.pause=function(t,n){return void 0===n&&(n={}),__awaiter(this,void 0,void 0,(function(){var l,d;return __generator(this,(function(p){switch(p.label){case 0:return l=this.adjustedPosition(n),[4,this.shouldTrack(t)];case 1:return p.sent()?(d=n.endReasonType===uc.NEXT_ITEM?"NEXT":"PAUSE",this.state.transition(d,this.getExplicitStateContext(n)),this.trackEvent("playStopped",l),[2]):[2]}}))}))},VPAFTrackerAPI.prototype.play=function(t,n){return void 0===n&&(n={}),__awaiter(this,void 0,void 0,(function(){var l,d;return __generator(this,(function(p){switch(p.label){case 0:return l=this.adjustedPosition(n),d=void 0!==l?l:0,[4,this.shouldTrack(t)];case 1:return p.sent()?(this.state.transition("PLAY",this.getExplicitStateContext(n)),this.trackEvent("playStarted",d),[2]):[2]}}))}))},VPAFTrackerAPI.prototype.scrub=function(t,n){return void 0===n&&(n={}),__awaiter(this,void 0,void 0,(function(){var l;return __generator(this,(function(d){return void 0===t||void 0===n.position?[2]:(l=this.adjustedPosition(n),this.isScrubbing&&void 0===n.endReasonType?(this.scrubStopPosition=l,[2]):(this.isScrubbing&&this.scrubEnd(t,l),[2]))}))}))},VPAFTrackerAPI.prototype.seek=function(t,n){return void 0===n&&(n={}),__awaiter(this,void 0,void 0,(function(){var l,d;return __generator(this,(function(p){switch(p.label){case 0:return void 0===t||void 0===n.startPosition||void 0===n.position?[2]:this.isSkippingIntro(n)||this.isSeekingInterval(n)?(l=void 0,this.isSkippingIntro(n)&&(d=this.getSkipActionName(n.position))&&(l={actionName:d}),this.trackSeekStart(t,__assign(__assign({},n),{position:n.startPosition}),l),this.trackSeekStop(t,n,l),[2]):[4,this.scrubStart(t,this.convertTime(n.startPosition))];case 1:return p.sent(),this.scrubEnd(t,this.convertTime(n.position)),[2]}}))}))},VPAFTrackerAPI.prototype.skip=function(t,n){return Promise.resolve()},VPAFTrackerAPI.prototype.stop=function(t,n){return void 0===n&&(n={}),__awaiter(this,void 0,void 0,(function(){var l;return __generator(this,(function(d){switch(d.label){case 0:return[4,this.shouldTrack(t)];case 1:return d.sent()?(l=this.adjustedPosition(n),this.state.transition("STOP",this.getExplicitStateContext(n)),this.trackEvent("playStopped",l),this.stopSynchronizing(),[2]):[2]}}))}))},VPAFTrackerAPI.prototype.adjustedPosition=function(t){return void 0===t.position?void 0:this.convertTime(t.position)},VPAFTrackerAPI.prototype.calculateOverallLength=function(t,n,l){var d=parseFloat(t.hlsMetadata["feature.duration"]);if(isNaN(d))return this.convertTime(n.duration);var p=l.reduce((function(t,n){return t+n.duration}),d);return this.convertTime(p)},VPAFTrackerAPI.prototype.convertTime=function(t){return Math.round(1e3*t)},VPAFTrackerAPI.prototype.createTracker=function(t){return __awaiter(this,void 0,void 0,(function(){var n,l,d,p,h,f,y,v;return __generator(this,(function(_){return void 0===t||this.isCurrentItem(t)?[2]:(this.state.transition("NEW"),this.currentItem=t,void 0===(n=getDefaultPlayable(t))?[2]:(l=this.getMainFeatureData(t,n),d=this.transformRollItems(t),ts.debug("VPAF: Creating HLS Playlist",l),p=ec.mediaActivityTracker.createHLSVideoPlaylist(0,l),ts.debug("VPAF: adding roll items",d),p.addRollInfoItems(d),h=ec.utils.eventFields.applyFieldsMap(n,"utsVpafPlayable"),f=ec.utils.eventFields.applyFieldsMap(t.attributes,"utsVpafContent"),y=n.vpafMetrics,(v=this.getAdditionalTrackingData(n)).overallLength=this.calculateOverallLength(t,n,d),ts.debug("VPAF: creating tracker with",[h,f,y,v]),this.tracker=ec.mediaActivityTracker.createTracker(p,h,f,y,v),this.startSynchronizing(),[2,this.tracker]))}))}))},VPAFTrackerAPI.prototype.getCurrentAudioSelection=function(){var t,n,l,d,p,h=null===(l=null===(n=this.instance)||void 0===n?void 0:n.currentAudioTrack)||void 0===l?void 0:l.language;if(void 0!==h){var f="description"===(null===(p=null===(d=this.instance)||void 0===d?void 0:d.currentAudioTrack)||void 0===p?void 0:p.kind)?"audioDescriptionLocale":"audioLocale",y="audioLocale"===f?"audioDescriptionLocale":"audioLocale";return(t={})[f]=h,t[y]=void 0,t}},VPAFTrackerAPI.prototype.getMainFeatureData=function(t,n){var l,d=null===(l=null==t?void 0:t.hlsMetadata)||void 0===l?void 0:l["feature.adam-id"],p={url:t.attributes.url,assetPlacement:"feature",assetId:d};return!0===t.attributes.isAdultContent&&(p.sensitiveContentType="adult"),p},VPAFTrackerAPI.prototype.transformRollItems=function(t){return parseRollItems(t).map((function(t){return{start:t.start,duration:t.duration,metricsData:{assetPlacement:t.type.replace("-",""),assetId:t["adam-id"],isSkippable:t.skippable}}}))},VPAFTrackerAPI.prototype.getMappedStopReason=function(t){if(void 0!==t.endReasonType)return lc[t.endReasonType]},VPAFTrackerAPI.prototype.getExplicitStateContext=function(t){return{manual:t.userInitiated,reason:this.getMappedStopReason(t)}},VPAFTrackerAPI.prototype.handleLevelUpdated=function(t,n){var l,d=n.level,p=n.channels;if(d){var h=d.audioCodec,f=d.videoRange,y=d.videoCodec;if(h&&p||f&&y){var v={};h&&p&&(v.audioFormat=function(t,n){var l,d,p=null!==(l=null==t?void 0:t.toLowerCase())&&void 0!==l?l:"";return isAtmos(p,n)?"Atmos":null!==(d=tc[p])&&void 0!==d?d:t}(h,p)),f&&y&&(v.videoColorRange=convertToVideoColorRange(y,f)),null===(l=this.tracker)||void 0===l||l.updateData(v)}}},VPAFTrackerAPI.prototype.handleAudioTrackChange=function(){var t=this.tracker;if(void 0!==t){var n=this.getCurrentAudioSelection();n&&t.updateData(n)}},VPAFTrackerAPI.prototype.handleForcedTextTrackChange=function(t,n){var l;null===(l=this.tracker)||void 0===l||l.updateData({forcedSubtitleLocale:null==n?void 0:n.language})},VPAFTrackerAPI.prototype.handlePresentationModeChange=function(t,n){var l,d,p=n.mode,h=null!==(l=pc[p])&&void 0!==l?l:pc._default;null===(d=this.tracker)||void 0===d||d.updateData({playbackFocus:h})},VPAFTrackerAPI.prototype.handleTargetWirelessChange=function(){var t;null===(t=this.tracker)||void 0===t||t.updateData({delegatedPlayback:this.getDelegatedPlayback()})},VPAFTrackerAPI.prototype.handleTextTrackChange=function(){var t,n=this.tracker;if(void 0!==n){var l=null===(t=this.instance)||void 0===t?void 0:t.currentTextTrack;if(l&&("captions"===l.kind||"subtitles"===(null==l?void 0:l.kind))){var d=""===l.language?void 0:l.language,p={closedCaptionLocale:"captions"===l.kind?d:void 0,subtitleLocale:"subtitles"===l.kind?d:void 0};n.updateData(p)}}},VPAFTrackerAPI.prototype.isSkippingIntro=function(n){return n.seekReasonType===t.SeekReasonType.SkipIntro},VPAFTrackerAPI.prototype.isSeekingInterval=function(n){return n.seekReasonType===t.SeekReasonType.Interval},VPAFTrackerAPI.prototype.shouldTrack=function(t){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(n){switch(n.label){case 0:return[4,this.createTracker(t)];case 1:return n.sent(),[2,void 0!==this.tracker]}}))}))},VPAFTrackerAPI.prototype.isCurrentItem=function(t){return void 0!==this.currentItem&&void 0!==t&&this.currentItem.id===t.id},VPAFTrackerAPI.prototype.getAdditionalTrackingData=function(t){var n,l,d,p=this.instance,h=null===(n=null==p?void 0:p.videoContainerElement)||void 0===n?void 0:n.querySelector("video"),f=null===(l=t.primaryLocale)||void 0===l?void 0:l.locale,y=null!==(d=this.getCurrentAudioSelection())&&void 0!==d?d:void 0!==f?{audioLocale:f}:{},v=null==p?void 0:p.currentTextTrack,_={programmingType:"videoOnDemand",downloadState:"streaming",videoViewportHeight:null==h?void 0:h.clientHeight,videoViewportWidth:null==h?void 0:h.clientWidth,playbackFocus:pc._default,delegatedPlayback:this.getDelegatedPlayback()};if(v){var g=dc[v.kind];g&&v.language&&(_[g]=v.language)}return __assign(__assign({},_),y)},VPAFTrackerAPI.prototype.getDelegatedPlayback=function(){var t;return(null===(t=this.instance)||void 0===t?void 0:t.playbackTargetIsWireless)?"Airplay":"None"},VPAFTrackerAPI.prototype.getSkipActionName=function(t){var n,l=(null!==(n=this.currentSkipItems)&&void 0!==n?n:[]).find((function(n){return n.target===t}));return null==l?void 0:l.label},VPAFTrackerAPI.prototype.onVideoComponentScrubStart=function(t){return this.scrubStart(this.currentItem,this.convertTime(t.detail.currentSeconds))},VPAFTrackerAPI.prototype.setupListeners=function(){void 0!==this.dispatcher&&(this.dispatcher.subscribe(An.audioTrackChanged,this.handleAudioTrackChange),this.dispatcher.subscribe(An.textTrackChanged,this.handleTextTrackChange),this.dispatcher.subscribe(An.forcedTextTrackChanged,this.handleForcedTextTrackChange),this.dispatcher.subscribe(Ve.hlsLevelUpdated,this.handleLevelUpdated),this.dispatcher.subscribe(An.playbackTargetIsWirelessDidChange,this.handleTargetWirelessChange),this.dispatcher.subscribe(An.presentationModeDidChange,this.handlePresentationModeChange)),pe||window.addEventListener("triggerSeekStart",this.onVideoComponentScrubStart)},VPAFTrackerAPI.prototype.teardownListeners=function(){void 0!==this.dispatcher&&(this.dispatcher.unsubscribe(An.audioTrackChanged,this.handleAudioTrackChange),this.dispatcher.unsubscribe(An.textTrackChanged,this.handleTextTrackChange),this.dispatcher.unsubscribe(An.forcedTextTrackChanged,this.handleForcedTextTrackChange),this.dispatcher.unsubscribe(Ve.hlsLevelUpdated,this.handleLevelUpdated),this.dispatcher.unsubscribe(An.playbackTargetIsWirelessDidChange,this.handleTargetWirelessChange),this.dispatcher.unsubscribe(An.presentationModeDidChange,this.handlePresentationModeChange)),pe||window.removeEventListener("triggerSeekStart",this.onVideoComponentScrubStart)},VPAFTrackerAPI.prototype.scrubEnd=function(t,n){this.trackEvent("seekStopped",n,this.tracker.TYPE.MANUAL,this.tracker.SEEK_STOP_REASON.SCRUB),"playing"===this.state.currentState&&(this.trackEvent("playStopped",this.scrubStopPosition,this.tracker.TYPE.AUTOMATIC,this.tracker.PLAY_STOP_REASON.SEEK),this.trackEvent("playStarted",n,this.tracker.TYPE.AUTOMATIC,this.tracker.PLAY_START_REASON.SEEK)),this.isScrubbing=!1,this.scrubStopPosition=void 0},VPAFTrackerAPI.prototype.scrubStart=function(t,n){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(l){switch(l.label){case 0:return[4,this.shouldTrack(t)];case 1:return l.sent()?(this.isScrubbing=!0,this.scrubStopPosition=n,this.trackEvent("seekStarted",n,this.tracker.TYPE.MANUAL,this.tracker.SEEK_START_REASON.SCRUB),[2]):[2]}}))}))},VPAFTrackerAPI.prototype.startSynchronizing=function(){void 0===this.synchronizeTimeout&&(this.synchronizeTimeout=setInterval(this.synchronize,6e4))},VPAFTrackerAPI.prototype.stopSynchronizing=function(){void 0!==this.synchronizeTimeout&&(clearInterval(this.synchronizeTimeout),this.synchronizeTimeout=void 0)},VPAFTrackerAPI.prototype.synchronize=function(){if(void 0!==this.tracker&&void 0!==this.instance){var t="paused"===this.state.currentState,n=this.instance,l=n.playbackRate,d=n.currentPlaybackTime,p=t?0:l,h=Math.round(1e3*d);ts.debug("VPAF: synchronize rate: "+p+" and current time: "+h),this.tracker.synchronize(p,h)}else this.stopSynchronizing()},VPAFTrackerAPI.prototype.trackSeekStart=function(n,l,d){void 0===d&&(d={});var p=l.seekReasonType===t.SeekReasonType.SkipIntro?this.tracker.SEEK_START_REASON.SKIP_INTRO:this.tracker.SEEK_START_REASON.INTERVAL,h=this.adjustedPosition(l),f=this.tracker.TYPE.MANUAL;if(this.trackEvent("seekStarted",h,f,p,d),"playing"===this.state.currentState){var y=this.isSkippingIntro(l)?__assign(__assign({},d),{stopReasonType:this.tracker.PLAY_STOP_REASON_TYPE.SKIP_INTRO}):d;this.trackEvent("playStopped",h,f,this.tracker.PLAY_STOP_REASON.SEEK,y)}},VPAFTrackerAPI.prototype.trackSeekStop=function(t,n,l){void 0===l&&(l={});var d=this.isSeekingInterval(n)?this.tracker.SEEK_STOP_REASON.INTERVAL:this.tracker.SEEK_STOP_REASON.SKIP_INTRO,p=this.adjustedPosition(n),h=this.tracker.TYPE.AUTOMATIC;if(this.trackEvent("seekStopped",p,h,d,l),"playing"===this.state.currentState){var f=this.isSkippingIntro(n)?__assign(__assign({},l),{startReasonType:this.tracker.PLAY_START_REASON_TYPE.SKIP_INTRO}):l;this.trackEvent("playStarted",p,h,this.tracker.PLAY_START_REASON.SEEK,f)}},VPAFTrackerAPI.prototype.trackEvent=function(t,n,l,d,p){void 0===l&&(l=this.tracker.TYPE[this.state.currentContext.manual]),void 0===d&&(d="playStarted"===t?this.tracker.PLAY_START_REASON[this.state.currentContext.reason]:this.tracker.PLAY_STOP_REASON[this.state.currentContext.reason]),ts.debug("VPAF: "+t,n,l,d,p),this.tracker[t].call(this.tracker,Math.round(n),l,d,p)},__decorate([Bind(),__metadata("design:type",Function),__metadata("design:paramtypes",[Object,Object]),__metadata("design:returntype",void 0)],VPAFTrackerAPI.prototype,"handleLevelUpdated",null),__decorate([Bind(),__metadata("design:type",Function),__metadata("design:paramtypes",[]),__metadata("design:returntype",void 0)],VPAFTrackerAPI.prototype,"handleAudioTrackChange",null),__decorate([Bind(),__metadata("design:type",Function),__metadata("design:paramtypes",[Object,Object]),__metadata("design:returntype",void 0)],VPAFTrackerAPI.prototype,"handleForcedTextTrackChange",null),__decorate([Bind(),__metadata("design:type",Function),__metadata("design:paramtypes",[Object,Object]),__metadata("design:returntype",void 0)],VPAFTrackerAPI.prototype,"handlePresentationModeChange",null),__decorate([Bind(),__metadata("design:type",Function),__metadata("design:paramtypes",[]),__metadata("design:returntype",void 0)],VPAFTrackerAPI.prototype,"handleTargetWirelessChange",null),__decorate([Bind(),__metadata("design:type",Function),__metadata("design:paramtypes",[]),__metadata("design:returntype",void 0)],VPAFTrackerAPI.prototype,"handleTextTrackChange",null),__decorate([Bind(),__metadata("design:type",Function),__metadata("design:paramtypes",[CustomEvent]),__metadata("design:returntype",void 0)],VPAFTrackerAPI.prototype,"onVideoComponentScrubStart",null),__decorate([Bind(),__metadata("design:type",Function),__metadata("design:paramtypes",[]),__metadata("design:returntype",void 0)],VPAFTrackerAPI.prototype,"synchronize",null),VPAFTrackerAPI}(),fc=function(){function BookmarkAPI(){var t=this;this.onContentCompletionTheshhold=function(n){return __awaiter(t,void 0,void 0,(function(){return __generator(this,(function(t){switch(t.label){case 0:return[4,this.trackActivity(this.currentItem,n)];case 1:return t.sent(),this.dispatcher.publish(Ve.mediaContentComplete,this.currentItem),[2]}}))}))}}return BookmarkAPI.prototype.configure=function(t){var n;return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(l){return this.dispatcher=t.services.dispatcher,this.utsAPI=null===(n=t.services.apiManager)||void 0===n?void 0:n.utsAPI,[2,this]}))}))},BookmarkAPI.prototype.cleanup=function(){this.clearItem()},BookmarkAPI.prototype.shouldConfigure=function(t){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(n){return[2,!!ns.features.bookmarking&&t.isAuthorized]}))}))},BookmarkAPI.prototype.shouldTrackPlayActivity=function(n,l){if(!l||!this.utsAPI)return!1;var d=-1===[t.PlaybackType.none,t.PlaybackType.preview].indexOf(l.playbackType),p="Vod"!==l.type;return ts.debug("Bookmark shouldTrackPlayActivity",d&&p,n),d&&p},BookmarkAPI.prototype.activate=function(t){return Promise.resolve()},BookmarkAPI.prototype.exit=function(t){return void 0===t&&(t={}),__awaiter(this,void 0,void 0,(function(){return __generator(this,(function(n){switch(n.label){case 0:return[4,this.trackActivity(void 0,t.position)];case 1:return n.sent(),[2]}}))}))},BookmarkAPI.prototype.pause=function(t,n){return void 0===n&&(n={}),__awaiter(this,void 0,void 0,(function(){return __generator(this,(function(l){switch(l.label){case 0:return[4,this.trackActivity(t,n.position)];case 1:return l.sent(),[2]}}))}))},BookmarkAPI.prototype.play=function(t,n){return void 0===n&&(n={}),__awaiter(this,void 0,void 0,(function(){var l;return __generator(this,(function(d){switch(d.label){case 0:return l=void 0===n.position?0:n.position,[4,this.trackActivity(t,l)];case 1:return d.sent(),[2]}}))}))},BookmarkAPI.prototype.scrub=function(t,n){return void 0===n&&(n={}),__awaiter(this,void 0,void 0,(function(){return __generator(this,(function(l){switch(l.label){case 0:return[4,this.trackActivity(t,n.position)];case 1:return l.sent(),[2]}}))}))},BookmarkAPI.prototype.seek=function(t,n){return void 0===n&&(n={}),__awaiter(this,void 0,void 0,(function(){return __generator(this,(function(l){switch(l.label){case 0:return[4,this.trackActivity(t,n.position)];case 1:return l.sent(),[2]}}))}))},BookmarkAPI.prototype.skip=function(t,n){return void 0===n&&(n={}),__awaiter(this,void 0,void 0,(function(){return __generator(this,(function(l){switch(l.label){case 0:return[4,this.trackActivity(t,n.position)];case 1:return l.sent(),[2]}}))}))},BookmarkAPI.prototype.stop=function(t,n){return void 0===n&&(n={}),__awaiter(this,void 0,void 0,(function(){return __generator(this,(function(l){switch(l.label){case 0:return[4,this.trackActivity(t,n.position)];case 1:return l.sent(),[2]}}))}))},BookmarkAPI.prototype.clearItem=function(){this.currentItem=void 0,this.decorated=void 0,this.currentItemTiming=void 0,this.currentPlayable=void 0,this.currentAppBundleIds=void 0,this.clearWatcher()},BookmarkAPI.prototype.clearWatcher=function(){void 0!==this.watcher&&(this.watcher.stopMonitor(),this.watcher=void 0)},BookmarkAPI.prototype.determineRelativePosition=function(t,n){return t<=n.mainContentStarts?0:t>=n.mainContentEnds?n.mainContentEnds:t-n.mainContentStarts},BookmarkAPI.prototype.generateVodEvent=function(t,n,l,d){var p={playable:{externalPlayableId:t.id.split(":").pop(),brandId:n.brandId},internalLegId:n.internalLegId,canonicalId:n.canonicalId,mediaLengthInMilliseconds:Math.floor(1e3*l.totalContentLength),mainContentLengthInMilliseconds:Math.floor(1e3*l.mainContentLength),playHeadInMilliseconds:Math.floor(1e3*d),mainContentPlayHeadInMilliseconds:Math.floor(1e3*this.determineRelativePosition(d,l)),featureOrEndCredits:d>l.mainContentEnds?"End_Credits":"Feature"};return"Episode"===n.contentType&&(p.tvEpisode={externalShowId:n.externalShowId,canonicalShowId:n.canonicalShowId,currentOrPreviousEpisode:n.isCurrent?"Latest_And_Current_Episode":"Previous_Episode",openOrClosedShow:n.isShowClosed?"Show_Closed_No_More_Episodes_Expected":"Show_Open_More_Episodes_Expected"}),p},BookmarkAPI.prototype.getAppBundleIds=function(t,n){var l,d,p=null==n?void 0:n.channels;if(Array.isArray(p)&&void 0!==(null==t?void 0:t.channelId)){var h=p.find((function(n){return n.id===t.channelId}));return null!==(d=null===(l=null==h?void 0:h.appBundleIds)||void 0===l?void 0:l[0])&&void 0!==d?d:void 0}},BookmarkAPI.prototype.setupWatcher=function(t,n){this.clearWatcher(),this.watcher=new Xa(this.dispatcher,this.onContentCompletionTheshhold,t,n,!0),this.watcher.startMonitor()},BookmarkAPI.prototype.trackActivity=function(t,n){return __awaiter(this,void 0,void 0,(function(){var l,d,p,h,f,y,v;return __generator(this,(function(_){switch(_.label){case 0:return void 0===n||void 0===this.utsAPI?[2]:void 0===t?[3,2]:[4,this.updateItem(t)];case 1:_.sent(),_.label=2;case 2:return void 0===this.currentItem?[2]:(d=(l=this).decorated,p=l.currentPlayable,h=l.currentItemTiming,f=l.currentAppBundleIds,void 0===d||void 0===p||void 0===h?[2]:[4,xa.storekit.pldfltcid()]);case 3:return(y=_.sent())?(v=this.generateVodEvent(p,d,h,n),[4,this.utsAPI.playActivity(v,y,null!=f?f:"com.apple.tv")]):[2];case 4:return _.sent(),[2]}}))}))},BookmarkAPI.prototype.updateItem=function(t){var n;return __awaiter(this,void 0,void 0,(function(){var l,d,p,h,f;return __generator(this,(function(y){switch(y.label){case 0:return void 0===this.utsAPI?[2]:(this.currentItem&&this.currentItem.id!==t.id&&this.clearItem(),void 0!==this.currentItem?[2]:(this.currentItem=t,void 0===(l=getDefaultPlayable(t))?[2]:(this.currentPlayable=l,this.currentItemTiming=function(t){var n,l,d=parseRollItems(t,["pre-roll"]),p=parseRollItems(t,["post-roll"]),h=d.reduce(addRollItemDuration,0),f=p.reduce(addRollItemDuration,0),y=null!==(l=null!==(n=t.hlsMetadata["up-next.start"])&&void 0!==n?n:t.hlsMetadata["watched.time"])&&void 0!==l?l:t.hlsMetadata["feature.duration"],v=parseFloat(y);return{mainContentStarts:h,mainContentEnds:v,mainContentLength:v-h,totalContentLength:v+f}}(t),this.currentAppBundleIds=this.getAppBundleIds(l,t),d=function(t){return Math.min(Math.round(getUpNextStart(t)),Math.round(getWatchedTime(t)))}(t),this.setupWatcher(d,Number.POSITIVE_INFINITY),p=1e3*parseInt(""+l.duration,10),h=l.id+":"+p,[4,this.utsAPI.decorate(h)])));case 1:return f=y.sent(),this.decorated=null===(n=null==f?void 0:f.data)||void 0===n?void 0:n[h],[2]}}))}))},BookmarkAPI}(),yc=function(){function BaseSeekable(t){this.mediaItemPlayback=t,this.canSeek=!1}return BaseSeekable.prototype.getSeekSeconds=function(t){return ts.warn("Seeking by predetermined amounts are not supported in this playback method"),{BACK:0,FORWARD:0}},BaseSeekable.prototype.seekBackward=function(t){ts.warn("seekBackward is not supported in this playback method")},BaseSeekable.prototype.seekForward=function(t){ts.warn("seekForward is not supported in this playback method")},BaseSeekable.prototype.seekToTime=function(t,n){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(t){return ts.warn("seekToTime is not supported in this playback method"),[2]}))}))},BaseSeekable}(),vc=function(){function Seekable(t,n){this._dispatcher=t,this.mediaItemPlayback=n,this.canSeek=!0}return Seekable.prototype.getSeekSeconds=function(t){return function(t){switch(t.type){case"Show":case"Episode":case"Movie":case"Vod":case"uploaded-videos":case"uploadedVideo":case"musicVideo":return{FORWARD:10,BACK:10};default:return{FORWARD:30,BACK:15}}}(t)},Seekable.prototype.seekBackward=function(n){return void 0===n&&(n=this._seekToBeginning),__awaiter(this,void 0,void 0,(function(){var l;return __generator(this,(function(d){switch(d.label){case 0:return void 0===this.mediaItemPlayback.nowPlayingItem?(ts.warn("Cannot seekBackward when nowPlayingItem is not yet set."),[2]):(l=this.mediaItemPlayback.currentPlaybackTime-this.getSeekSeconds(this.mediaItemPlayback.nowPlayingItem).BACK)<0?[4,n.call(this)]:[3,2];case 1:return d.sent(),[2];case 2:return[4,this.seekToTime(l,t.SeekReasonType.Interval)];case 3:return d.sent(),[2]}}))}))},Seekable.prototype.seekForward=function(n){return void 0===n&&(n=this._seekToEnd),__awaiter(this,void 0,void 0,(function(){var l;return __generator(this,(function(d){switch(d.label){case 0:return void 0===this.mediaItemPlayback.nowPlayingItem?(ts.warn("Cannot seekForward when nowPlayingItem is not yet set."),[2]):(l=this.mediaItemPlayback.currentPlaybackTime+this.getSeekSeconds(this.mediaItemPlayback.nowPlayingItem).FORWARD)>this.mediaItemPlayback.currentPlaybackDuration?[4,n.call(this)]:[3,2];case 1:return d.sent(),[2];case 2:return[4,this.seekToTime(l,t.SeekReasonType.Interval)];case 3:return d.sent(),[2]}}))}))},Seekable.prototype.seekToTime=function(n,l){return void 0===l&&(l=t.SeekReasonType.Manual),__awaiter(this,void 0,void 0,(function(){var t,d;return __generator(this,(function(p){switch(p.label){case 0:return t=this.mediaItemPlayback.currentPlaybackTime,d=Math.min(Math.max(0,n),this.mediaItemPlayback.currentPlaybackDuration-1),[4,this.mediaItemPlayback.seekToTime(d,l)];case 1:return p.sent(),this._dispatcher.publish(Ve.playbackSeek,{startPosition:t,position:d,seekReasonType:l}),[2]}}))}))},Seekable.prototype._seekToBeginning=function(){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(n){switch(n.label){case 0:return[4,this.seekToTime(0,t.SeekReasonType.Interval)];case 1:return n.sent(),[2]}}))}))},Seekable.prototype._seekToEnd=function(){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(n){switch(n.label){case 0:return[4,this.seekToTime(this.mediaItemPlayback.currentPlaybackDuration,t.SeekReasonType.Interval)];case 1:return n.sent(),[2]}}))}))},Seekable}(),shuffleCollection=function(t){for(var n=__spread$1(t),l=n.length,d=0;d<l;++d){var p=d+Math.floor(Math.random()*(l-d)),h=n[p];n[p]=n[d],n[d]=h}return n};!function(t){t[t.off=0]="off",t[t.songs=1]="songs"}(Zu||(Zu={}));var _c,gc="Shuffling is not supported in this playback method.",mc=function(){function BaseShuffler(){this.canSetShuffleMode=!1}return Object.defineProperty(BaseShuffler.prototype,"shuffle",{set:function(t){ts.warn(gc)},enumerable:!0,configurable:!0}),Object.defineProperty(BaseShuffler.prototype,"shuffleMode",{get:function(){return Zu.off},set:function(t){ts.warn(gc)},enumerable:!0,configurable:!0}),BaseShuffler.prototype.checkAndReshuffle=function(t){ts.warn(gc)},BaseShuffler}(),bc=function(){function Shuffler(t,n){var l=n.dispatcher;this.controller=t,this.canSetShuffleMode=!0,this.mode=Zu.off,this._unshuffledIDs=[],this.dispatcher=l,this.dispatcher.subscribe(Ve.queueModified,this.queueModifiedHandler),this._queue=t.queue}return Object.defineProperty(Shuffler.prototype,"queue",{get:function(){return this._queue},set:function(t){this._queue=t,this._unshuffledIDs=t.items.map((function(t){return t.id})),this.checkAndReshuffle(!1)},enumerable:!0,configurable:!0}),Shuffler.prototype.queueModifiedHandler=function(t,n){var l,d=n.start,p=n.added,h=n.removed;if(h.length>0){var f=h.map((function(t){return t.id}));this._unshuffledIDs=this._unshuffledIDs.filter((function(t){return!f.includes(t)}))}p.length>0&&(l=this._unshuffledIDs).splice.apply(l,__spread([d,0],p.map((function(t){return t.id}))))},Object.defineProperty(Shuffler.prototype,"shuffle",{set:function(t){this.shuffleMode=t?Zu.songs:Zu.off},enumerable:!0,configurable:!0}),Object.defineProperty(Shuffler.prototype,"shuffleMode",{get:function(){return this.mode},set:function(t){t!==this.shuffleMode&&t in Zu&&(ts.debug("mk: set shuffleMode from "+this.shuffleMode+" to "+t),this.mode=t,this.mode===Zu.songs?this.shuffleQueue():this.unshuffleQueue(),this.controller.nowPlayingItem&&(this._queue.position=this._queue.indexForItem(this.controller.nowPlayingItem.id)),this.dispatcher.publish(An.shuffleModeDidChange,this.shuffleMode))},enumerable:!0,configurable:!0}),Shuffler.prototype.checkAndReshuffle=function(t){void 0===t&&(t=!1),this.shuffleMode===Zu.songs&&this.shuffleQueue(t)},Shuffler.prototype.shuffleQueue=function(t){void 0===t&&(t=!0);var n=this._queue.items;if(n.length<=1)return n;var l=n.slice(0),d=this._queue.position>-1?l.splice(this._queue.position,1):[],p=[];do{p=shuffleCollection(l)}while(arrayEquals(p,l));var h=__spread(d,p);this._queue.replaceQueueItems(h,t)},Shuffler.prototype.unshuffleQueue=function(t){void 0===t&&(t=!0);var n=[],l=this._unshuffledIDs.reduce((function(t,n,l){return t[n]=l,t}),{}),d=[];this._queue.items.forEach((function(t){var p=l[t.id];void 0===p&&d.push(t),n[p]=t})),n=n.filter(Boolean),this._queue.replaceQueueItems(n.concat(d),t)},__decorate([Bind(),__metadata("design:type",Function),__metadata("design:paramtypes",[String,Object]),__metadata("design:returntype",void 0)],Shuffler.prototype,"queueModifiedHandler",null),Shuffler}();!function(t){t.continuous="continuous",t.serial="serial"}(_c||(_c={}));var Pc,Tc=An.queueItemsDidChange,Sc=function(){function PlaybackController(t){var n;this._context={},this.onPlaybackStateDidChange=this.onPlaybackStateDidChange.bind(this),this._autoplayEnabled=null!==(n=null==t?void 0:t.autoplayEnabled)&&void 0!==n&&n,this._services=t.services,this._playerOptions=t,this.storekit=t.storekit,this._skipIntro=new es({controller:this,services:t.services}),this._upNext=new rs({controller:this,services:t.services}),this._rollMonitor=new Za({controller:this,services:t.services}),this._queueModifier=new Ss,this._shuffler=new mc,this._seekable=new yc(this._mediaItemPlayback),this._repeatable=new Is,this._dispatcher.subscribe(In,this.onGaplessTransition),this._dispatcher.subscribe(An.autoplayEnabledDidChange,this.updateAutoplay)}return PlaybackController.prototype.updateAutoplay=function(t,n){this.autoplayEnabled=n},Object.defineProperty(PlaybackController.prototype,"context",{get:function(){return this._context},enumerable:!0,configurable:!0}),Object.defineProperty(PlaybackController.prototype,"continuous",{get:function(){return this._continuous||this.hasAuthorization},set:function(t){this._continuous=t},enumerable:!0,configurable:!0}),Object.defineProperty(PlaybackController.prototype,"autoplayEnabled",{get:function(){return this._autoplayEnabled},set:function(t){this._autoplayEnabled=t},enumerable:!0,configurable:!0}),Object.defineProperty(PlaybackController.prototype,"currentBufferedProgress",{get:function(){return this._mediaItemPlayback.currentBufferedProgress},set:function(t){this._mediaItemPlayback.currentBufferedProgress=t},enumerable:!0,configurable:!0}),Object.defineProperty(PlaybackController.prototype,"currentPlaybackProgress",{set:function(t){this._mediaItemPlayback.currentPlaybackProgress=t},enumerable:!0,configurable:!0}),Object.defineProperty(PlaybackController.prototype,"_dispatcher",{get:function(){return this._services.dispatcher},enumerable:!0,configurable:!0}),Object.defineProperty(PlaybackController.prototype,"formattedCurrentPlaybackDuration",{get:function(){return this._mediaItemPlayback.formattedCurrentPlaybackDuration},enumerable:!0,configurable:!0}),Object.defineProperty(PlaybackController.prototype,"hasAuthorization",{get:function(){return hasAuthorization(this.storekit)},enumerable:!0,configurable:!0}),Object.defineProperty(PlaybackController.prototype,"isPlaying",{get:function(){return this._mediaItemPlayback.isPlaying},enumerable:!0,configurable:!0}),Object.defineProperty(PlaybackController.prototype,"isPrimaryPlayer",{get:function(){return this._mediaItemPlayback.isPrimaryPlayer},set:function(t){this._mediaItemPlayback.isPrimaryPlayer=t},enumerable:!0,configurable:!0}),Object.defineProperty(PlaybackController.prototype,"isReady",{get:function(){return this._mediaItemPlayback.isReady},enumerable:!0,configurable:!0}),Object.defineProperty(PlaybackController.prototype,"_mediaItemPlayback",{get:function(){return this._services.mediaItemPlayback},enumerable:!0,configurable:!0}),Object.defineProperty(PlaybackController.prototype,"nowPlayingItem",{get:function(){return this._mediaItemPlayback.nowPlayingItem},enumerable:!0,configurable:!0}),Object.defineProperty(PlaybackController.prototype,"nowPlayingItemIndex",{get:function(){return this.queue?this.queue.position:-1},enumerable:!0,configurable:!0}),Object.defineProperty(PlaybackController.prototype,"queue",{get:function(){return this._queue},set:function(t){this._prepareQueue(t),this._queue=t,this._shuffler.queue=this._queue,this._queueModifier.queue=this._queue,this._dispatcher.publish(Tc,t.items)},enumerable:!0,configurable:!0}),Object.defineProperty(PlaybackController.prototype,"repeatMode",{get:function(){return this._repeatable.repeatMode},set:function(t){this._repeatable.repeatMode=t},enumerable:!0,configurable:!0}),Object.defineProperty(PlaybackController.prototype,"seekSeconds",{get:function(){var t=this.nowPlayingItem;if(void 0!==t)return this._seekable.getSeekSeconds(t)},enumerable:!0,configurable:!0}),Object.defineProperty(PlaybackController.prototype,"shuffle",{set:function(t){this._shuffler.shuffle=t},enumerable:!0,configurable:!0}),Object.defineProperty(PlaybackController.prototype,"shuffleMode",{get:function(){return this._shuffler.shuffleMode},set:function(t){this._shuffler.shuffleMode=t},enumerable:!0,configurable:!0}),Object.defineProperty(PlaybackController.prototype,"storekit",{get:function(){return this._storekit},set:function(t){var n=this;t&&(t.addEventListener(Vi.authorizationStatusWillChange,(function(t){var l=t.authorizationStatus,d=t.newAuthorizationStatus;return __awaiter(n,void 0,void 0,(function(){return __generator(this,(function(t){switch(t.label){case 0:return this.isPlaying?l>Ni.DENIED&&d<Ni.RESTRICTED?[4,this.stop({endReasonType:He.PLAYBACK_SUSPENDED,userInitiated:!1})]:[3,2]:[3,4];case 1:return t.sent(),[3,4];case 2:return[4,this.stop({userInitiated:!1})];case 3:t.sent(),t.label=4;case 4:return[2]}}))}))})),this._storekit=t)},enumerable:!0,configurable:!0}),PlaybackController.prototype.append=function(t){return __awaiter(this,void 0,void 0,(function(){var n;return __generator(this,(function(l){switch(l.label){case 0:return[4,this._dataForQueueOptions(t)];case 1:return n=l.sent(),this._queueModifier.append(n),[2,this.queue]}}))}))},PlaybackController.prototype._dataForQueueOptions=function(t){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(n){return[2,__assign(__assign({},t),{context:this.context})]}))}))},PlaybackController.prototype.clear=function(){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(t){return this._queueModifier.clear(),[2,this.queue]}))}))},PlaybackController.prototype.changeToMediaAtIndex=function(t){var n,l,d;return void 0===t&&(t=0),__awaiter(this,void 0,void 0,(function(){var p,h,f,y;return __generator(this,(function(v){switch(v.label){case 0:return[4,this.stop()];case 1:return v.sent(),p=null===(n=this.queue.item(t))||void 0===n?void 0:n.id,h=null===(d=null===(l=this._mediaItemPlayback)||void 0===l?void 0:l.playOptions)||void 0===d?void 0:d.get(p),f=(null==h?void 0:h.startTime)||0,[4,this._changeToMediaAtIndex(t,!0)];case 2:return(y=v.sent())&&(y.id!==p&&(f=0),this._dispatcher.publish(Ve.playbackPlay,{item:y,position:f})),[2]}}))}))},PlaybackController.prototype.changeToMediaItem=function(t){return __awaiter(this,void 0,void 0,(function(){var n;return __generator(this,(function(l){return-1===(n=this.queue.indexForItem(t))?[2,Promise.reject(new Fe(Fe.MEDIA_DESCRIPTOR))]:[2,this.changeToMediaAtIndex(n)]}))}))},PlaybackController.prototype.activate=function(){ts.debug("mk: base controller - activate"),this._dispatcher.unsubscribe(An.playbackStateDidChange,this.onPlaybackStateDidChange),this._dispatcher.subscribe(An.playbackStateDidChange,this.onPlaybackStateDidChange),this._skipIntro.activate(),this._upNext.activate(),this._rollMonitor.activate()},PlaybackController.prototype.deactivate=function(){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(t){switch(t.label){case 0:return[4,this.stop()];case 1:return t.sent(),this._dispatcher.unsubscribe(An.playbackStateDidChange,this.onPlaybackStateDidChange),this._skipIntro.deactivate(),this._upNext.deactivate(),this._rollMonitor.deactivate(),[2]}}))}))},PlaybackController.prototype.destroy=function(){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(t){switch(t.label){case 0:return[4,this.deactivate()];case 1:return t.sent(),this._dispatcher.unsubscribe(An.autoplayEnabledDidChange,this.updateAutoplay),[2]}}))}))},PlaybackController.prototype.hasCapabilities=function(t){switch(t){case cs.SEEK:return this._seekable.canSeek;case cs.REPEAT:return this._repeatable.canSetRepeatMode;case cs.SHUFFLE:return this._shuffler.canSetShuffleMode;case cs.EDIT_QUEUE:return this._queueModifier.canModifyQueue;case cs.PAUSE:case cs.SKIP_NEXT:case cs.SKIP_TO_ITEM:return!0;case cs.SKIP_PREVIOUS:default:return!1}},PlaybackController.prototype.pause=function(t){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(n){return[2,this._mediaItemPlayback.pause(t)]}))}))},PlaybackController.prototype.play=function(){return __awaiter(this,void 0,void 0,(function(){var t;return __generator(this,(function(n){return this.nowPlayingItem?[2,this._mediaItemPlayback.play()]:!this._queue||this._queue.isEmpty?[2]:this.nowPlayingItemIndex>=0?[2,this.changeToMediaAtIndex(this.nowPlayingItemIndex)]:-1!==(t=this.queue).nextPlayableItemIndex?[2,this.changeToMediaAtIndex(t.nextPlayableItemIndex)]:(t.isRestricted&&t.items.every((function(t){return t.isRestricted}))&&this._dispatcher.publish(An.mediaPlaybackError,new Fe(Fe.CONTENT_RESTRICTED,"Content restricted")),[2])}))}))},PlaybackController.prototype.playSingleMediaItem=function(t){return __awaiter(this,void 0,void 0,(function(){var n;return __generator(this,(function(l){switch(l.label){case 0:return[4,fetchHLSMetadata(t)];case 1:return l.sent(),this._dispatcher.publish(An.queueItemsDidChange,[t]),[4,this._mediaItemPlayback.startMediaItemPlayback(t,!0)];case 2:return(n=l.sent())&&this._dispatcher.publish(Ve.playbackPlay,{item:n,position:0,userInitiated:!0}),[2]}}))}))},PlaybackController.prototype.onPlaybackStateDidChange=function(n,l){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(n){switch(n.label){case 0:return l.state!==t.PlaybackStates.ended?[2]:this.continuous||this.repeatMode===ms.one?(this._dispatcher.publish(Ve.applicationActivityIntent,{endReasonType:He.TRACK_SKIPPED_FORWARDS,userInitiated:!1}),[4,this._next()]):[3,2];case 1:n.sent(),n.label=2;case 2:return[2]}}))}))},PlaybackController.prototype.onGaplessTransition=function(t,n){ts.debug("controller handling gapless transition, PAF stop",n),this._dispatcher.publish(Ve.playbackStop,{endReasonType:He.NATURAL_END_OF_TRACK,position:n.previous.playbackDuration/1e3,isPlaying:!1}),asAsync(this._next(!1,!0))},PlaybackController.prototype.preload=function(){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(t){return[2,this._mediaItemPlayback.preload()]}))}))},PlaybackController.prototype.prepend=function(t,n){return __awaiter(this,void 0,void 0,(function(){var l;return __generator(this,(function(d){switch(d.label){case 0:return[4,this._dataForQueueOptions(t)];case 1:return l=d.sent(),this._queueModifier.prepend(l,n),[2,this.queue]}}))}))},PlaybackController.prototype.prepareToPlay=function(t){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(n){return[2,this._mediaItemPlayback.prepareToPlay(t)]}))}))},PlaybackController.prototype.showPlaybackTargetPicker=function(){this._mediaItemPlayback.showPlaybackTargetPicker()},PlaybackController.prototype.seekBackward=function(){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(t){return[2,this._seekable.seekBackward()]}))}))},PlaybackController.prototype.seekForward=function(){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(t){return[2,this._seekable.seekForward(this.skipToNextItem.bind(this))]}))}))},PlaybackController.prototype.skipToNextItem=function(){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(t){return[2,this._next(!0)]}))}))},PlaybackController.prototype.getNewSeeker=function(){return this._mediaItemPlayback.getNewSeeker()},PlaybackController.prototype.seekToTime=function(t,n){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(l){switch(l.label){case 0:return[4,this._seekable.seekToTime(t,n)];case 1:return l.sent(),[2]}}))}))},PlaybackController.prototype.setQueue=function(t){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(n){switch(n.label){case 0:return[4,this.extractGlobalValues(t)];case 1:return n.sent(),[4,this._mediaItemPlayback.stop()];case 2:return n.sent(),[2,this.returnQueueForOptions(t)]}}))}))},PlaybackController.prototype.extractGlobalValues=function(t){var n;return __awaiter(this,void 0,void 0,(function(){var l;return __generator(this,(function(d){return this._context=null!==(n=t.context)&&void 0!==n?n:{},void 0!==(l=t.featureName)&&(ts.warn("featureName is deprecated, pass it inside context"),this._context.featureName=l),[2]}))}))},PlaybackController.prototype.stop=function(t){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(n){switch(n.label){case 0:return[4,this._mediaItemPlayback.stop(t)];case 1:return n.sent(),[2]}}))}))},PlaybackController.prototype._changeToMediaAtIndex=function(t,n){return void 0===t&&(t=0),void 0===n&&(n=!1),__awaiter(this,void 0,void 0,(function(){var l,p;return __generator(this,(function(h){switch(h.label){case 0:return this.queue.isEmpty?[2]:(this.queue.position=t,(l=this.queue.item(this.queue.position))?[4,this._mediaItemPlayback.startMediaItemPlayback(l,n)]:[2]);case 1:return(p=h.sent())||l.state!==d.unsupported?[3,3]:[4,this.skipToNextItem()];case 2:return h.sent(),[2];case 3:return[2,p]}}))}))},PlaybackController.prototype._next=function(n,l){return void 0===n&&(n=!1),void 0===l&&(l=!1),__awaiter(this,void 0,void 0,(function(){var d,p,h,f;return __generator(this,(function(y){switch(y.label){case 0:return this.queue.isEmpty?[2]:(d=this._mediaItemPlayback,this.queue.nextPlayableItemIndex<0?(ts.debug("controller/index._next no next item available, stopping playback"),[4,this.stop({userInitiated:n})]):[3,2]);case 1:return y.sent(),d.playbackState=t.PlaybackStates.completed,[2];case 2:return p=this.isPlaying,h=d.currentPlaybackTime,[4,this._changeToMediaAtIndex(this.queue.nextPlayableItemIndex,n)];case 3:return f=y.sent(),this._notifySkip(p,f,l,{userInitiated:n,position:h,direction:He.TRACK_SKIPPED_FORWARDS}),[2,f]}}))}))},PlaybackController.prototype._notifySkip=function(t,n,l,d){var p=d.userInitiated,h=d.direction,f=d.position,y=this._dispatcher;l?(ts.debug("gapless transition, PAF play"),y.publish(Ve.playbackPlay,{item:n,position:0,endReasonType:He.NATURAL_END_OF_TRACK})):t?n?y.publish(Ve.playbackSkip,{item:n,userInitiated:p,direction:h,position:f}):y.publish(Ve.playbackStop,{userInitiated:p,position:f}):n&&y.publish(Ve.playbackPlay,__assign({item:n,position:0},p?{endReasonType:He.MANUALLY_SELECTED_PLAYBACK_OF_A_DIFF_ITEM}:{}))},PlaybackController.prototype._prepareQueue=function(t){ts.debug("mk: _prepareQueue"),this.hasAuthorization&&(t.isRestricted=this.storekit.restrictedEnabled||!1),t.repeatable=this._repeatable},__decorate([Bind(),__metadata("design:type",Function),__metadata("design:paramtypes",[String,Boolean]),__metadata("design:returntype",void 0)],PlaybackController.prototype,"updateAutoplay",null),__decorate([Bind(),__metadata("design:type",Function),__metadata("design:paramtypes",[Object,Object]),__metadata("design:returntype",void 0)],PlaybackController.prototype,"onGaplessTransition",null),PlaybackController}();function rejectOnLast(){return Promise.reject("The last middleware in the stack should not call next")}function createNextFunction(t){var n=__read$1(t),l=n[0],d=n.slice(1);return function(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];return l.apply(void 0,__spread$1([createNextFunction(d)],t))}}function parameterizeString(t,n){return function(t){try{return function recursiveTokenizeParameterizedString(t,n){void 0===n&&(n=[]);if(t.startsWith("{{")){var l=t.indexOf("}}");if(-1===l)throw new Error("UNCLOSED_PARAMETER");var d={type:Pc.Parameter,value:t.slice(2,l)};return l+2<t.length?recursiveTokenizeParameterizedString(t.slice(l+2),__spread$1(n,[d])):__spread$1(n,[d])}var p=t.indexOf("{{");return-1===p?__spread$1(n,[{type:Pc.Static,value:t}]):recursiveTokenizeParameterizedString(t.slice(p),__spread$1(n,[{type:Pc.Static,value:t.slice(0,p)}]))}(t)}catch(error){if("UNCLOSED_PARAMETER"===error.message)throw new Error('Unclosed parameter in path: "'+t+'"');throw error}}(t).map((function(t){switch(t.type){case Pc.Parameter:return t.value in n?encodeURIComponent(""+n[t.value]):"{{"+t.value+"}}";case Pc.Static:default:return t.value}})).join("")}function constructUrlMiddleware(t,n){var l=n.url;return l||(l=addPathToURL(n.baseUrl,n.path)),n.urlParameters&&(l=parameterizeString(l,n.urlParameters)),n.queryParameters&&(l=addQueryParamsToURL(l,n.queryParameters)),t(se(se({},n),{url:l}))}function unwrapJSONFromResponse(t){return __awaiter$1(this,void 0,void 0,(function(){return __generator$1(this,(function(n){switch(n.label){case 0:return n.trys.push([0,2,,3]),[4,t.json()];case 1:return[2,n.sent()];case 2:return n.sent(),[2,void 0];case 3:return[2]}}))}))}function fetchMiddlewareFactory(t){return function(n,l){return __awaiter$1(this,void 0,void 0,(function(){var n,d,p;return __generator$1(this,(function(h){switch(h.label){case 0:return[4,t(l.url,l.fetchOptions)];case 1:return n=h.sent(),p={request:l,response:n},[4,unwrapJSONFromResponse(n)];case 2:if(p.data=h.sent(),d=p,!n.ok)throw Fe.responseError(n);return[2,d]}}))}))}}!function(t){t[t.Static=0]="Static",t[t.Parameter=1]="Parameter"}(Pc||(Pc={}));var kc,Ac=fetchMiddlewareFactory("undefined"!=typeof fetch?fetch:function(){throw new Error("window.fetch is not defined")});!function(t){t.Replace="REPLACE",t.Merge="MERGE"}(kc||(kc={}));var Ic=["url"],Ec=function(){function APISession(t){this.reconfigure(t)}return Object.defineProperty(APISession.prototype,"config",{get:function(){return this._config},enumerable:!0,configurable:!0}),APISession.prototype.request=function(t,n,l){var d;return void 0===n&&(n={}),void 0===l&&(l={}),function(t){for(var n=[],l=1;l<arguments.length;l++)n[l-1]=arguments[l];return t.length?createNextFunction(__spread$1(t,[rejectOnLast])).apply(void 0,__spread$1(n)):Promise.reject("processMiddleware requires at mimimum one middleware function")}(this.middlewareStack,se(se(se({},this.config.defaultOptions),l),{baseUrl:this.config.url,path:t,fetchOptions:mergeFetchOptions(null===(d=this.config.defaultOptions)||void 0===d?void 0:d.fetchOptions,l.fetchOptions),queryParameters:se(se({},this.config.defaultQueryParameters),n),urlParameters:se(se({},this.config.defaultUrlParameters),l.urlParameters)}))},APISession.prototype.reconfigure=function(t,n){void 0===n&&(n=kc.Replace),n===kc.Merge&&(t=deepmerge(this.config,t)),Ic.forEach((function(n){if(void 0===t[n])throw new Error('Session requires a valid SessionConfig, missing "'+n+'"')})),this._config=t,this.middlewareStack=this.createMiddlewareStack()},APISession.prototype.createMiddlewareStack=function(){return Array.isArray(this.config.middleware)?__spread$1([constructUrlMiddleware],this.config.middleware,[this.makeFetchMiddleware()]):[constructUrlMiddleware,this.makeFetchMiddleware()]},APISession.prototype.makeFetchMiddleware=function(){return"function"==typeof this.config.fetchFunction?fetchMiddlewareFactory(this.config.fetchFunction):Ac},APISession}(),wc={music:{url:"https://api.music.apple.com"},apps:{url:"https://amp-api.apps.apple.com"},books:{url:"https://amp-api.books.apple.com"}};wc.music={url:"https://amp-api.music.apple.com"},wc.videos={url:"https://amp-api.videos.apple.com"},wc.podcasts={url:"https://amp-api.podcasts.apple.com"};var Oc=function(){function MediaAPIV3(t){for(var n in wc)this.configure(n,deepmerge(wc[n],t))}return MediaAPIV3.prototype.configure=function(t,n,l){var d;void 0===l&&(l=kc.Merge),this.storefrontId=n.storefrontId;var p=function(t){var n={};t.url&&(n.url=t.url);t.storefrontId&&(n.defaultUrlParameters={storefrontId:t.storefrontId});t.mediaUserToken&&(n.defaultOptions={fetchOptions:{headers:{"Media-User-Token":t.mediaUserToken}}});t.developerToken&&(n=deepmerge(n,{defaultOptions:{fetchOptions:{headers:{Authorization:"Bearer "+t.developerToken}}}}));t.options&&(n=deepmerge(n,t.options));return n}(n);if(this[t])this[t].session.reconfigure(p,l);else{var h=new Ec(p),f=h.request.bind(h);f.session=h;var y="undefined"!=typeof process&&"test"===(null===(d=process.env)||void 0===d?void 0:d.NODE_ENV);Object.defineProperty(this,t,{value:f,writable:y,enumerable:!0})}},MediaAPIV3}();var Rc=function(){function QueueItem(t,n){var l;this.isAutoplay=!1,this.item=t,this.isAutoplay=null!==(l=null==n?void 0:n.isAutoplay)&&void 0!==l&&l}return QueueItem.prototype.restrict=function(){return this.item.restrict()},QueueItem}();function toQueueItems(t,n){return t.map((function(t){return new Rc(t,n)}))}function toMediaItems(t){return t.map((function(t){return t.item}))}var Cc,parseQueueURLOption=function(t){if(isQueueURLOption(t)){var n=formattedMediaURL(t.url),l=n.contentId,d=n.kind,p=n.storefrontId;t[d]=l,xa.storefrontId=p,delete t.url,Le.debug("parseQueueURLOption",t)}},Mc=An.queueItemsDidChange,Nc=An.queuePositionDidChange,Dc=function(){function Queue(t){this._itemIDs=[],this._queueItems=[],this._isRestricted=!1,this._nextPlayableItemIndex=-1,this._position=-1,this._dispatcher=t.services.dispatcher,t.descriptor&&(this._queueItems=toQueueItems(descriptorToMediaItems(t.descriptor)),this._reindex(),this.position=this._getStartItemPosition(t.descriptor.startWith))}return Object.defineProperty(Queue.prototype,"isEmpty",{get:function(){return 0===this.length},enumerable:!0,configurable:!0}),Object.defineProperty(Queue.prototype,"isRestricted",{get:function(){return this._isRestricted},set:function(t){this._isRestricted=t,this._isRestricted&&this._queueItems&&this._queueItems.forEach((function(t){t.restrict()}))},enumerable:!0,configurable:!0}),Object.defineProperty(Queue.prototype,"appendTargetIndex",{get:function(){var t=this.position+this._unplayedQueueItems.findIndex((function(t){return t.isAutoplay}));return t<0&&(t=this.length),t},enumerable:!0,configurable:!0}),Object.defineProperty(Queue.prototype,"items",{get:function(){return toMediaItems(this._queueItems)},enumerable:!0,configurable:!0}),Object.defineProperty(Queue.prototype,"autoplayItems",{get:function(){return toMediaItems(this._queueItems.filter((function(t){return t.isAutoplay})))},enumerable:!0,configurable:!0}),Object.defineProperty(Queue.prototype,"unplayedAutoplayItems",{get:function(){return toMediaItems(this._unplayedQueueItems.filter((function(t){return t.isAutoplay})))},enumerable:!0,configurable:!0}),Object.defineProperty(Queue.prototype,"userAddedItems",{get:function(){return toMediaItems(this._queueItems.filter((function(t){return!t.isAutoplay})))},enumerable:!0,configurable:!0}),Object.defineProperty(Queue.prototype,"unplayedUserItems",{get:function(){return toMediaItems(this._unplayedQueueItems.filter((function(t){return!t.isAutoplay})))},enumerable:!0,configurable:!0}),Object.defineProperty(Queue.prototype,"length",{get:function(){return this._queueItems.length},enumerable:!0,configurable:!0}),Object.defineProperty(Queue.prototype,"nextPlayableItem",{get:function(){if(-1!==this.nextPlayableItemIndex)return this.item(this.nextPlayableItemIndex)},enumerable:!0,configurable:!0}),Object.defineProperty(Queue.prototype,"nextPlayableItemIndex",{get:function(){return this._nextPlayableItemIndex=this._getNextPlayableItemIndex(),this._nextPlayableItemIndex},enumerable:!0,configurable:!0}),Object.defineProperty(Queue.prototype,"position",{get:function(){return this._position},set:function(t){this._updatePosition(t)},enumerable:!0,configurable:!0}),Object.defineProperty(Queue.prototype,"previousPlayableItem",{get:function(){if(void 0!==this.previousPlayableItemIndex)return this.item(this.previousPlayableItemIndex)},enumerable:!0,configurable:!0}),Object.defineProperty(Queue.prototype,"previousPlayableItemIndex",{get:function(){if(void 0===this._previousPlayableItemIndex)for(var t=this.position-1;t>-1;){var n=this.item(t);if(this._isItemPlayable(n)){this._previousPlayableItemIndex=t;break}t--}return this._previousPlayableItemIndex},enumerable:!0,configurable:!0}),Queue.prototype.removeQueueItems=function(t){for(var n=this.length-1;n>=0;n--)t(this.queueItem(n),n)&&this.spliceQueueItems(n,1)},Queue.prototype.indexForItem=function(t){return("string"==typeof t?this._itemIDs:this.items).indexOf(t)},Queue.prototype.item=function(t){var n;return null===(n=this.queueItem(t))||void 0===n?void 0:n.item},Queue.prototype.queueItem=function(t){var n;return null===(n=this._queueItems)||void 0===n?void 0:n[t]},Queue.prototype.remove=function(t){if(logDeprecation("remove",{message:"The queue remove function has been deprecated"}),t===this.position)throw new Fe(Fe.INVALID_ARGUMENTS);this.splice(t,1)},Queue.prototype.append=function(t){return void 0===t&&(t=[]),this.appendQueueItems(toQueueItems(t))},Queue.prototype.appendQueueItems=function(t){return void 0===t&&(t=[]),this.spliceQueueItems(this.appendTargetIndex,0,t)},Queue.prototype.splice=function(t,n,l){return void 0===l&&(l=[]),toMediaItems(this.spliceQueueItems(t,n,toQueueItems(l)))},Queue.prototype.spliceQueueItems=function(t,n,l){var d,p;void 0===l&&(l=[]);var h=(d=this._queueItems).splice.apply(d,__spread([t,n],l));return(p=this._itemIDs).splice.apply(p,__spread([t,n],l.map((function(t){return t.item.id})))),this._dispatcher.publish(Ve.queueModified,{start:t,added:toMediaItems(l),removed:toMediaItems(h)}),this._dispatcher.publish(Mc,this.items),h},Queue.prototype.replaceQueueItems=function(t,n){void 0===n&&(n=!0),this._isSameItems(t)?(this._queueItems=toQueueItems(t),this._reindex(),n&&this._dispatcher.publish(Mc,t)):Le.warn("Cannot use replaceQueueItems with different items.")},Queue.prototype.reset=function(){var t=this.position;this._position=-1,this._dispatcher.publish(Nc,{oldPosition:t,position:this.position})},Queue.prototype._isSameItems=function(t){if(t.length!==this.length)return!1;var n,l,d=t.map((function(t){return t.id})).sort(),p=__spread(this._itemIDs).sort();try{n=JSON.stringify(d),l=JSON.stringify(p)}catch(e){return!1}return n===l},Queue.prototype._reindex=function(){this._queueItems&&(this._itemIDs=this._queueItems.map((function(t){return t.item.id})))},Queue.prototype._updatePosition=function(t){if(t!==this._position){var n=this._position;this._position=this._getNextPlayableItemIndex(t),this._previousPlayableItemIndex=void 0,this._dispatcher.publish(Nc,{oldPosition:n,position:this._position})}},Queue.prototype._getNextPlayableItemIndex=function(t){var n;void 0===t&&(t=this.position+1);for(var l=t;l<this.length;){var d=this.item(l);if(this._isItemPlayable(d))return l;l++}if((null===(n=this.repeatable)||void 0===n?void 0:n.repeatMode)===ms.all)for(l=0;l<=t;){d=this.item(l);if(this._isItemPlayable(d))return l;l++}return-1},Object.defineProperty(Queue.prototype,"_unplayedQueueItems",{get:function(){var t=this.position<0?0:this.position;return this._queueItems.slice(t)},enumerable:!0,configurable:!0}),Queue.prototype._getStartItemPosition=function(t){if(void 0===t)return-1;if("object"==typeof t&&"id"in t&&(t=t.id),"string"==typeof t)return this.indexForItem(t);var n=parseInt(""+t,10);return n>=0&&n<this.length?n:-1},Queue.prototype._isItemPlayable=function(t){return(null==t?void 0:t.isPlayable)||(null==t?void 0:t.previewURL)},Queue}(),Lc=function(){function StationTrackLoader(t,n,l,d){var p=l.dispatcher,h=l.logger,f=l.apiManager;void 0===d&&(d={}),this.queue=t,this.station=n,this.context=d,this.isActive=!1,this.dispatcher=p,this.logger=h,this.apiManager=f}return StationTrackLoader.prototype.activate=function(){this.dispatcher.unsubscribe(An.queuePositionDidChange,this.checkLoadMore),this.dispatcher.subscribe(An.queuePositionDidChange,this.checkLoadMore),this.isActive=!0},StationTrackLoader.prototype.deactivate=function(){this.dispatcher.unsubscribe(An.queuePositionDidChange,this.checkLoadMore),this.isActive=!1},StationTrackLoader.prototype.start=function(){return this.isActive||this.activate(),this.loadNextTracks()},StationTrackLoader.prototype.checkLoadMore=function(){if(!(this.queue.isEmpty||this.queue.nextPlayableItemIndex>=0))return this.loadNextTracks()},StationTrackLoader.prototype.loadNextTracks=function(){var t,n,l;return __awaiter(this,void 0,void 0,(function(){var d,p,h,f;return __generator(this,(function(y){switch(y.label){case 0:return d=[],(null==(p=this.apiManager)?void 0:p.api)instanceof Oc?[4,p.api.music("v1/me/stations/next-tracks/"+this.station.id,void 0,{fetchOptions:{method:"POST"}})]:[3,2];case 1:return h=y.sent(),d=null===(t=null==h?void 0:h.data)||void 0===t?void 0:t.data,[3,4];case 2:return[4,null===(n=p.mediaAPI)||void 0===n?void 0:n.nextStationTracks(this.station.id)];case 3:d=null!==(l=y.sent())&&void 0!==l?l:[],y.label=4;case 4:if(0===d.length)throw this.logger.warn("No track data is available for the current station",{stationId:this.station.id}),new Fe(Fe.CONTENT_UNAVAILABLE,"No track data is available for the current station.");return f=descriptorToMediaItems({context:this.context,loaded:d,container:this.station}),this.queue.splice(this.queue.length,0,f),[2]}}))}))},__decorate([Bind(),__metadata("design:type",Function),__metadata("design:paramtypes",[]),__metadata("design:returntype",void 0)],StationTrackLoader.prototype,"checkLoadMore",null),StationTrackLoader}();!function(t){t.artist="artist",t.song="song",t.station="station",t.radioStation="radioStation"}(Cc||(Cc={}));var isIdentityQueue=function(t){return t&&void 0!==t.identity},isLiveStationQueue=function(t){return t&&void 0!==t.station&&!0===t.isLive},isLiveQueue=function(t){return isIdentityQueue(t)||isLiveStationQueue(t)},xc=function(t){function ContinuousPlaybackController(n){var l=t.call(this,n)||this;return l.type=_c.continuous,l._isLive=!1,l._continuous=!0,l}return __extends(ContinuousPlaybackController,t),Object.defineProperty(ContinuousPlaybackController.prototype,"continuous",{get:function(){return!0},set:function(t){if(!0!==t)throw new Fe(Fe.UNSUPPORTED_ERROR,"Continuous playback cannot be disabled for station queues.")},enumerable:!0,configurable:!0}),Object.defineProperty(ContinuousPlaybackController.prototype,"context",{get:function(){return __assign({featureName:$e.STATION},this._context)},enumerable:!0,configurable:!0}),Object.defineProperty(ContinuousPlaybackController.prototype,"isLive",{get:function(){return this._isLive},set:function(t){t!==this._isLive&&(this._isLive=t,this._dispatcher.publish(An.capabilitiesChanged))},enumerable:!0,configurable:!0}),ContinuousPlaybackController.prototype.changeToMediaItem=function(t){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(t){return this.generateMethodNotAvailable("changeToMediaItem"),[2]}))}))},ContinuousPlaybackController.prototype.hasCapabilities=function(n){switch(n){case cs.PAUSE:case cs.SKIP_NEXT:return!this.isLive;case cs.SKIP_PREVIOUS:case cs.SKIP_TO_ITEM:return!1;default:return t.prototype.hasCapabilities.call(this,n)}},ContinuousPlaybackController.prototype.pause=function(n){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(l){return this.isLive?(this.generateMethodNotAvailable("pause"),[2]):[2,t.prototype.pause.call(this,n)]}))}))},ContinuousPlaybackController.prototype.skipToPreviousItem=function(){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(t){return this.generateMethodNotAvailable("skipToPreviousItem"),[2]}))}))},ContinuousPlaybackController.prototype._dataForQueueOptions=function(n){return __awaiter(this,void 0,void 0,(function(){var l;return __generator(this,(function(d){switch(d.label){case 0:return[4,t.prototype._dataForQueueOptions.call(this,n)];case 1:return l=d.sent(),this.isLive&&(l.loaded=this.station),[2,l]}}))}))},ContinuousPlaybackController.prototype.returnQueueForOptions=function(t){return __awaiter(this,void 0,void 0,(function(){var n,l,d;return __generator(this,(function(p){switch(p.label){case 0:return this.isLive=isLiveQueue(t),this.isLive?isIdentityQueue(t)?[4,this.loadStationByIdentity(t.identity)]:[3,2]:[3,5];case 1:return n=p.sent(),[3,4];case 2:return isLiveStationQueue(t)?[4,this.loadStationByStationId(t.station)]:[3,4];case 3:n=p.sent(),p.label=4;case 4:return[3,7];case 5:return[4,this.loadStationByStationId(this.generateStationId(t))];case 6:n=p.sent(),p.label=7;case 7:return void 0===n?[2,Promise.reject(new Fe(Fe.UNSUPPORTED_ERROR,"Cannot load requested station"))]:(this.station=n,d={services:{dispatcher:this._dispatcher}},[4,this._dataForQueueOptions(t)]);case 8:return d.descriptor=p.sent(),l=d,this.queue=new Dc(l),this.isLive?[3,10]:(this.trackLoader=new Lc(this.queue,n,{dispatcher:this._dispatcher,logger:ts,apiManager:this._services.apiManager},this.context),[4,this.trackLoader.start()]);case 9:p.sent(),p.label=10;case 10:return this._seekable=this.isLive?new yc(this._mediaItemPlayback):new vc(this._dispatcher,this._mediaItemPlayback),[2,this.queue]}}))}))},ContinuousPlaybackController.prototype.getNewSeeker=function(){return this.hasCapabilities(cs.SEEK)?t.prototype.getNewSeeker.call(this):new Kn},ContinuousPlaybackController.prototype.skipToNextItem=function(){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(n){return this.isLive?(this.generateMethodNotAvailable("skipToNextItem"),[2]):[2,t.prototype.skipToNextItem.call(this)]}))}))},ContinuousPlaybackController.prototype.generateMethodNotAvailable=function(t){ts.warn(t+" is not supported for this type of playback")},ContinuousPlaybackController.prototype.generateStationId=function(t){var n;if(isQueueURLOption(t)){var l=formattedMediaURL(t.url),d=l.contentId,p=l.kind,h=l.storefrontId;t[p]=d,xa.storefrontId=h,n=p}var f=t;if(f.artist)return"ra."+f.artist;if(f.song)return"ra."+f.song;if(f.station)return f.station;if(f.radioStation)return f.radioStation;throw new Fe(Fe.UNSUPPORTED_ERROR,n?n+" is not a supported option. Use setQueue instead.":"Unsupported options specified for setStationQueue. You may want setQueue instead.")},ContinuousPlaybackController.prototype.loadStationByIdentity=function(t){var n,l,d;return __awaiter(this,void 0,void 0,(function(){var p,h,f;return __generator(this,(function(y){switch(y.label){case 0:return(null==(p=this._services.apiManager)?void 0:p.api)instanceof Oc?[4,p.api.music("v1/catalog/{{storefrontId}}/stations",{filter:{identity:t}})]:[3,2];case 1:return h=y.sent(),[2,null===(l=null===(n=null==h?void 0:h.data)||void 0===n?void 0:n.data)||void 0===l?void 0:l[0]];case 2:return[4,null===(d=null==p?void 0:p.mediaAPI)||void 0===d?void 0:d.stations(void 0,{filter:{identity:t}})];case 3:return[2,(f=y.sent())&&f[0]]}}))}))},ContinuousPlaybackController.prototype.loadStationByStationId=function(t){var n,l,d;return __awaiter(this,void 0,void 0,(function(){var p,h;return __generator(this,(function(f){switch(f.label){case 0:return(null==(p=this._services.apiManager)?void 0:p.api)instanceof Oc?[4,p.api.music("v1/catalog/{{storefrontId}}/stations/"+t)]:[3,2];case 1:return h=f.sent(),[2,null===(l=null===(n=null==h?void 0:h.data)||void 0===n?void 0:n.data)||void 0===l?void 0:l[0]];case 2:return[2,null===(d=null==p?void 0:p.mediaAPI)||void 0===d?void 0:d.station(t)]}}))}))},ContinuousPlaybackController.prototype.activate=function(){t.prototype.activate.call(this),this.trackLoader&&this.trackLoader.activate()},ContinuousPlaybackController.prototype.deactivate=function(){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(n){switch(n.label){case 0:return[4,t.prototype.deactivate.call(this)];case 1:return n.sent(),this.trackLoader&&this.trackLoader.deactivate(),[2]}}))}))},__decorate([Bind(),__metadata("design:type",Function),__metadata("design:paramtypes",[Number]),__metadata("design:returntype",Boolean)],ContinuousPlaybackController.prototype,"hasCapabilities",null),ContinuousPlaybackController}(Sc),Uc=function(){function PercentageWatcher(t,n,l){this.dispatcher=t,this.callback=n,this.percentage=l,this.threshold=-1}return PercentageWatcher.prototype.startMonitor=function(){this.dispatcher.unsubscribe(An.playbackDurationDidChange,this.updateThreshold),this.dispatcher.unsubscribe(An.playbackTimeDidChange,this.handleTimeChange),this.dispatcher.subscribe(An.playbackDurationDidChange,this.updateThreshold),this.dispatcher.subscribe(An.playbackTimeDidChange,this.handleTimeChange)},PercentageWatcher.prototype.stopMonitor=function(){this.dispatcher.unsubscribe(An.playbackDurationDidChange,this.updateThreshold),this.dispatcher.unsubscribe(An.playbackTimeDidChange,this.handleTimeChange),this.threshold=-1},PercentageWatcher.prototype.handleTimeChange=function(t,n){var l=n.currentPlaybackDuration,d=n.currentPlaybackTime;return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(n){switch(n.label){case 0:return this.threshold<0&&this.updateThreshold(t,{duration:l}),d<this.threshold?[2]:(this.stopMonitor(),[4,this.callback(d,this)]);case 1:return n.sent(),[2]}}))}))},PercentageWatcher.prototype.updateThreshold=function(t,n){var l=n.duration;this.threshold=l*this.percentage},__decorate([Bind(),__metadata("design:type",Function),__metadata("design:paramtypes",[Object,Object]),__metadata("design:returntype",Promise)],PercentageWatcher.prototype,"handleTimeChange",null),__decorate([Bind(),__metadata("design:type",Function),__metadata("design:paramtypes",[Object,Object]),__metadata("design:returntype",void 0)],PercentageWatcher.prototype,"updateThreshold",null),PercentageWatcher}(),Bc=function(t){function Preloader(n){var l=t.call(this,n)||this;return l.watchers=[new Uc(l.dispatcher,l.handlePlaybackThreshold,.3)],l}return __extends(Preloader,t),Preloader.prototype.handlePlaybackThreshold=function(){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(t){switch(t.label){case 0:return[4,this.playbackController.prepareToPlay(this._next,!0)];case 1:return t.sent(),[2]}}))}))},Preloader.prototype.shouldMonitor=function(){if(!t.prototype.shouldMonitor.call(this))return!1;if(!this.playbackController.hasAuthorization)return!1;var n=this.getNextPlayableItem();return void 0!==n&&!n.isPreparedToPlay},Preloader.prototype.startMonitor=function(){this._next=this.getNextPlayableItem(),t.prototype.startMonitor.call(this)},Preloader.prototype.clearMonitor=function(){t.prototype.clearMonitor.call(this),this._next=void 0},Preloader.prototype.getNextPlayableItem=function(){return this.playbackController.queue.nextPlayableItem},Preloader}(Ja);function dasherize(t){return t.replace(/([A-Z])/g,"-$1").replace(/[-_\s]+/g,"-").toLowerCase()}function loadRelationshipData(t,n,l,d){return void 0===d&&(d={}),__awaiter(this,void 0,void 0,(function(){var p,h,f,y;return __generator(this,(function(v){switch(v.label){case 0:return void 0===n?[2,l]:(void 0===d.limit&&(d.limit=100),void 0===d.offset&&(d.offset=0),p=n.relationship,h=n.method,f=t[h].bind(t),isDataRecord(l)?(void 0===l[p]&&l.setProperty(p,[],"relationships"),y=l[p]):(l.relationships=l.relationships||{},void 0===l.relationships[p]&&Object.defineProperty(l.relationships,p,{value:{data:[]},enumerable:!0}),y=l.relationships[p].data),[4,recursiveRelationshipLoad(f,[l.id,p,d],y)]);case 1:return v.sent(),[2,l]}}))}))}var jc,Fc,recursiveRelationshipLoad=function(t,n,l){return __awaiter(void 0,void 0,void 0,(function(){var d,p,h,f,y,v,_;return __generator(this,(function(g){switch(g.label){case 0:if(d=__read(n,3),p=d[0],h=d[1],f=d[2],(y=l.length)>0&&y<f.limit+f.offset)return[2,l];(v=__assign({},f)).offset=y,g.label=1;case 1:return g.trys.push([1,3,,4]),[4,t(p,h,v)];case 2:return _=g.sent(),[3,4];case 3:return g.sent(),[2,l];case 4:return l.push.apply(l,__spread(_)),_.length<v.limit?[2,l]:[2,recursiveRelationshipLoad(t,n,l)]}}))}))},getNamedQueueOptions=function(t,n){var l=[],d=t.namedQueueOptions;for(var p in n)Object.keys(d).includes(p)&&l.push([p,d[p]]);return l},loadNamedQueueData=function(t,n,l){return __awaiter(void 0,void 0,void 0,(function(){var d,p,h,f,y,v,_,g,m,b,P,T;return __generator(this,(function(S){switch(S.label){case 0:return d=__read(l,2),p=d[0],h=d[1],f=n[p],y=Array.isArray(f),v=y?""+f[0]:""+f,[4,t.getAPIForItem(v)];case 1:return(_=S.sent())instanceof Oc?((g=dasherize(p)).endsWith("s")||(g+="s"),m=(ce(v)?"v1/me/library/":"v1/catalog/{{storefrontId}}/")+g+(y?"":"/{{id}}"),b={},y&&(b.ids=f),[4,_.music(m,b,{urlParameters:{id:f}})]):[3,3];case 2:return P=S.sent(),y?[2,P.data.data]:[2,P.data.data[0]];case 3:return[4,_[h.apiMethod](f,n.parameters)];case 4:return T=S.sent(),y?[3,6]:[4,loadRelationshipData(_,h.relationshipMethod,T)];case 5:S.sent(),S.label=6;case 6:return[2,T]}}))}))},Kc=function(){function AutoplayTrackLoader(t,n,l){var d=n.dispatcher,p=n.logger,h=n.apiManager;void 0===l&&(l={}),this.queue=t,this.context=l,this.isActive=!1,this.dispatcher=d,this.logger=p,this.apiManager=h}return AutoplayTrackLoader.prototype.activate=function(){this.isActive||(this.dispatcher.unsubscribe(An.queuePositionDidChange,this.checkLoadMore),this.dispatcher.subscribe(An.queuePositionDidChange,this.checkLoadMore),this.isActive=!0)},AutoplayTrackLoader.prototype.deactivate=function(){this.isActive&&(this.dispatcher.unsubscribe(An.queuePositionDidChange,this.checkLoadMore),this.isActive=!1)},AutoplayTrackLoader.prototype.start=function(){if(!this.isActive)return this.activate(),this.loadNextTracks()},AutoplayTrackLoader.prototype.stop=function(){this.isActive&&(this.deactivate(),this.cleanupQueue())},AutoplayTrackLoader.prototype.checkLoadMore=function(){var t,n=null!==(t=this.queue.unplayedAutoplayItems.length)&&void 0!==t?t:0,l=ns.autoplay.maxUpcomingTracksToMaintain;if(!this.queue.isEmpty&&!(this.queue.unplayedUserItems.length>ns.autoplay.maxQueueSizeForAutoplay||this.queue.nextPlayableItemIndex>=0))return n<l?this.loadNextTracks(l-n):this.loadNextTracks()},AutoplayTrackLoader.prototype.cleanupQueue=function(){var t=this;this.queue.removeQueueItems((function(n,l){return!(l<=t.queue.position)&&!!n.isAutoplay}))},AutoplayTrackLoader.prototype.loadNextTracks=function(t){var n,l;return void 0===t&&(t=ns.autoplay.maxUpcomingTracksToMaintain),__awaiter(this,void 0,void 0,(function(){var d,p,h,f,y,v;return __generator(this,(function(_){switch(_.label){case 0:return d=this.queue.items.slice(-1*ns.autoplay.maxQueueSizeInRequest).map((function(t){return{id:t.id,type:"songs"}})),p={data:d},[4,null===(n=this.apiManager.mediaAPI)||void 0===n?void 0:n.continuousStation(p,{"limit[results:tracks]":t,with:["tracks"]})];case 1:return h=_.sent(),f=h.station,y=h.tracks,(null===(l=null==h?void 0:h.tracks)||void 0===l?void 0:l.length)||this.logger.warn("No track data is available for the current station",{stationId:null==f?void 0:f.id}),v=descriptorToMediaItems({context:this.context,loaded:y,container:f}),this.queue.appendQueueItems(toQueueItems(v,{isAutoplay:!0})),[2]}}))}))},__decorate([Bind(),__metadata("design:type",Function),__metadata("design:paramtypes",[]),__metadata("design:returntype",void 0)],AutoplayTrackLoader.prototype,"checkLoadMore",null),AutoplayTrackLoader}(),Vc=An.queueIsReady;!function(t){t.album="album",t.musicVideo="musicVideo",t.playlist="playlist",t.song="song",t.episode="episode",t.podcast="podcast",t.uploadedAudio="uploadedAudio",t.uploadedVideo="uploadedVideo"}(jc||(jc={})),function(t){t.albums="albums",t.musicVideos="musicVideos",t.playlists="playlists",t.songs="songs",t.episodes="episodes",t.podcasts="podcasts",t.uploadedAudio="uploadedAudios",t.uploadedVideo="uploadedVideos"}(Fc||(Fc={}));var $c=function(t){function SerialPlaybackController(n){var l=t.call(this,n)||this;l.type=_c.serial,l._queue=new Dc(n),l._repeatable=new Es(l._dispatcher);var d={controller:l,services:n.services};return l._seekable=new vc(l._dispatcher,l._mediaItemPlayback),l._preloader=new Bc(d),l._shuffler=new bc(l,{dispatcher:l._dispatcher}),l._queueModifier=new ks(l._queue),l}return __extends(SerialPlaybackController,t),Object.defineProperty(SerialPlaybackController.prototype,"autoplayEnabled",{get:function(){return this._autoplayEnabled},set:function(t){var n;this._autoplayEnabled=t;var l=t?"start":"stop";null===(n=this._autoplayTrackLoader)||void 0===n||n[l]()},enumerable:!0,configurable:!0}),SerialPlaybackController.prototype.activate=function(){t.prototype.activate.call(this),this._preloader.activate()},SerialPlaybackController.prototype.deactivate=function(){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(n){switch(n.label){case 0:return[4,t.prototype.deactivate.call(this)];case 1:return n.sent(),this._preloader.deactivate(),[2]}}))}))},SerialPlaybackController.prototype.hasCapabilities=function(n){return n===cs.SKIP_PREVIOUS||t.prototype.hasCapabilities.call(this,n)},SerialPlaybackController.prototype.prepareToPlay=function(t,n){return void 0===n&&(n=!1),__awaiter(this,void 0,void 0,(function(){var l=this;return __generator(this,(function(d){return ts.debug("mk: SerialController - prepareToPlay - ",{item:t,preload:n}),t.isPlayable?[2,this._mediaItemPlayback.prepareToPlay(t).catch((function(t){var d=!n&&-1===[Fe.DEVICE_LIMIT,Fe.STREAM_UPSELL].indexOf(t.errorCode);if(l.continuous&&d)return l._dispatcher.publish(Ve.applicationActivityIntent,{endReasonType:He.TRACK_SKIPPED_FORWARDS,userInitiated:!1}),l._next();throw t}))]:[2]}))}))},SerialPlaybackController.prototype.returnQueueForOptions=function(t){return __awaiter(this,void 0,void 0,(function(){var n,l,d;return __generator(this,(function(p){switch(p.label){case 0:return parseQueueURLOption(t),void 0!==t.startPosition&&(logDeprecation("startPosition",{message:"startPosition has been deprecated in favor of startWith"}),void 0===t.startWith&&(t.startWith=t.startPosition)),[4,this._dataForQueueOptions(t)];case 1:if(n=p.sent(),l={services:{dispatcher:this._dispatcher},descriptor:n},void 0!==t.shuffleMode&&(this.shuffleMode=t.shuffleMode),this.queue=new Dc(l),"number"==typeof t.startTime&&(d=this.queue.nextPlayableItem)&&this._mediaItemPlayback.playOptions.set(d.id,{startTime:t.startTime}),0===this.queue.length)throw ts.warn("No item data is available for the current media queue",t),new Fe(Fe.CONTENT_UNAVAILABLE,"No item data is available for the current media queue.");return this._autoplayTrackLoader=new Kc(this.queue,{dispatcher:this._dispatcher,logger:ts,apiManager:this._services.apiManager},this._context),this.autoplayEnabled&&this._autoplayTrackLoader.start(),this._dispatcher.publish(Vc,this.queue.items),[2,this.queue]}}))}))},SerialPlaybackController.prototype.skipToPreviousItem=function(){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(t){return[2,this._previous(!0)]}))}))},SerialPlaybackController.prototype._dataForQueueOptions=function(n){return __awaiter(this,void 0,void 0,(function(){var l,d,p,h,f;return __generator(this,(function(y){switch(y.label){case 0:return l=n,void 0!==(d=function(t,n){var l=getNamedQueueOptions(t,n);if(l.length>1)throw new Fe(Fe.UNSUPPORTED_ERROR,"Queues with multiple media types are not supported.");if(0!==l.length){var d=__read(l,1)[0],p=__read(d,2),h=p[0],f=p[1];if(Array.isArray(n[h])!==f.isPlural)throw new Fe(Fe.UNSUPPORTED_ERROR,f.isPlural?"Queue option "+h+" must be an array of id values":"Queue option "+h+" must be a single id value");return d}}(this._services.apiManager.apiService,n))?[3,2]:(p=[{}],[4,t.prototype._dataForQueueOptions.call(this,n)]);case 1:return[2,__assign.apply(void 0,[__assign.apply(void 0,p.concat([y.sent()])),l])];case 2:return h=l,[4,loadNamedQueueData(this._services.apiManager.apiService,n,d)];case 3:return h.loaded=y.sent(),f=[{}],[4,t.prototype._dataForQueueOptions.call(this,n)];case 4:return[2,__assign.apply(void 0,[__assign.apply(void 0,f.concat([y.sent()])),l])]}}))}))},SerialPlaybackController.prototype._next=function(n,l){return void 0===n&&(n=!1),void 0===l&&(l=!1),__awaiter(this,void 0,void 0,(function(){var d;return __generator(this,(function(p){switch(p.label){case 0:return this.queue.isEmpty||this.repeatMode!==ms.one?[3,2]:[4,this._changeToMediaAtIndex(this.nowPlayingItemIndex,n)];case 1:return(d=p.sent())&&this._dispatcher.publish(Ve.playbackPlay,{item:d,userInitiated:n,position:0}),[2,this.nowPlayingItem];case 2:return[2,t.prototype._next.call(this,n,l)]}}))}))},SerialPlaybackController.prototype._previous=function(t){return void 0===t&&(t=!1),__awaiter(this,void 0,void 0,(function(){var n,l,d,p;return __generator(this,(function(h){switch(h.label){case 0:return this.queue.isEmpty||-1===(n=this.queue).previousPlayableItemIndex?[2]:(l=this.isPlaying,d=this._mediaItemPlayback.currentPlaybackTime,[4,this._changeToMediaAtIndex(n.previousPlayableItemIndex,t)]);case 1:return p=h.sent(),this._notifySkip(l,p,!1,{userInitiated:t,direction:He.TRACK_SKIPPED_BACKWARDS,position:d}),[2,p]}}))}))},SerialPlaybackController.prototype._prepareQueue=function(n){t.prototype._prepareQueue.call(this,n),this._shuffler.checkAndReshuffle()},__decorate([Bind(),__metadata("design:type",Function),__metadata("design:paramtypes",[Number]),__metadata("design:returntype",Boolean)],SerialPlaybackController.prototype,"hasCapabilities",null),SerialPlaybackController}(Sc),Yc=function(){function MKDialog(t,n){void 0===n&&(n=""),this._message=t,this._explanation=n,this.id="musickit-dialog",this.scrimId=this.id+"-scrim",this.styleId=this.id+"-style",this._okButtonString="OK",[this.id,this.scrimId,this.styleId].forEach((function(t){try{var n=document.getElementById(t);n.parentElement.removeChild(n)}catch(Jr){}})),this._appendStyle("\n#musickit-dialog {\n  --mk-dialog-background: rgba(255, 255, 255, 1);\n  --mk-dialog-text: rgba(0, 0, 0, 0.95);\n  --mk-dialog-border: rgba(0, 0, 0, 0.07);\n  --mk-dialog-scrim: rgba(255, 255, 255, 0.8);\n  --mk-dialog-primary: rgba(0, 122, 255, 1);\n}\n\n@media (prefers-color-scheme: dark) {\n  #musickit-dialog {\n      --mk-dialog-background: rgba(30, 30, 30, 1);\n      --mk-dialog-text: rgba(255, 255, 255, 0.85);\n      --mk-dialog-border: rgba(255, 255, 255, 0.1);\n      --mk-dialog-scrim: rgba(38, 38, 38, 0.8);\n      --mk-dialog-primary: rgba(8, 132, 255, 1);\n  }\n}\n\n#musickit-dialog-scrim {\n  position: fixed;\n  top: 0;\n  left: 0;\n  right: 0;\n  bottom: 0;\n  width: 100%;\n  height: 100%;\n  background: rgba(0, 0, 0, 0.35);\n}\n\n#musickit-dialog * {\n  -webkit-tap-highlight-color: transparent;\n  -webkit-touch-callout: none;\n  -ms-touch-action: none;\n  -webkit-user-select: none;\n  -moz-user-select: none;\n  -ms-user-select: none;\n  user-select: none;\n  font-family: -apple-system, SF UI Text, Helvetica Neue, Helvetica, sans-serif;\n  font-size: 15px;\n  line-height: 20px;\n}\n\n#musickit-dialog *:focus { outline: 0; }\n\n#musickit-dialog {\n  display: -webkit-box;\n  display: -moz-box;\n  display: -ms-flexbox;\n  display: -webkit-flex;\n  display: flex;\n  -webkit-flex-direction: column;\n  -moz-flex-direction: column;\n  flex-direction: column;\n  -webkit-justify-content: space-between;\n  -moz-justify-content: space-between;\n  justify-content: space-between;\n  min-width: 277px;\n  max-width: 290px;\n  min-height: 109px;\n  background: var(--mk-dialog-background);\n  box-shadow: 0px 0px 9px rgba(0, 0, 0, 0.18);\n  border-radius: 10px;\n  color: var(--mk-dialog-text);\n  position: fixed;\n  top: 50%;\n  left: 50%;\n  margin-left: -142px;\n  margin-top: -67px;\n  z-index: 9999999999999999999999999;\n}\n\n#musickit-dialog #mk-dialog-body {\n  display: -webkit-box;\n  display: -moz-box;\n  display: -ms-flexbox;\n  display: -webkit-flex;\n  display: flex;\n  -webkit-flex-direction: column;\n  -moz-flex-direction: column;\n  flex-direction: column;\n  flex-grow: 1;\n  -webkit-justify-content: space-evenly;\n  -moz-justify-content: space-evenly;\n  justify-content: space-evenly;\n  -webkit-align-items: stretch;\n  align-items: stretch;\n  padding: 10px 20px;\n  min-height: 74px;\n  text-align: center;\n}\n\n#musickit-dialog .mk-dialog h5 {\n  font-weight: 500;\n  line-height: 20px;\n  margin: 7px 0 0 0;\n  padding: 0;\n}\n\n#musickit-dialog .mk-dialog p {\n  margin: 0 0 7px 0;\n  padding: 0;\n  paddin-top: 3px;\n  line-height: 18px;\n  font-size: 13px;\n  font-weight: 300;\n}\n\n#musickit-dialog #mk-dialog-actions {\n  border-top: 1px solid var(--mk-dialog-border);\n  display: -webkit-box;\n  display: -moz-box;\n  display: -ms-flexbox;\n  display: -webkit-flex;\n  display: flex;\n  -webkit-flex-direction: row;\n  -moz-flex-direction: colrowumn;\n  flex-direction: row;\n  max-height: 41px;\n  min-height: 34px;\n  -webkit-justify-self: flex-end;\n  -moz-justify-self: flex-end;\n  justify-self: flex-end;\n}\n\n#musickit-dialog #mk-dialog-actions button {\n  flex-grow: 1;\n  border: 0;\n  background: none;\n  color: var(--mk-dialog-primary);\n  padding: 0;\n  margin: 0;\n  min-height: 34px;\n  height: 41px;\n  text-align: center;\n}\n\n#musickit-dialog #mk-dialog-actions *:nth-child(2) {\n  border-left: 1px solid var(--mk-dialog-border);\n  font-weight: 500;\n}\n")}return MKDialog.presentError=function(t){var n=t.dialog;void 0!==n?MKDialog.serverDialog(n).present():new MKDialog(t.message).present()},MKDialog.serverDialog=function(t){var n=new this(t.message,t.explanation);return t.okButtonAction&&t.okButtonAction.url&&(n._okButtonActionURL=t.okButtonAction.url),t.okButtonString&&(n._okButtonString=t.okButtonString),t.cancelButtonString&&(n._cancelButtonString=t.cancelButtonString),n},MKDialog.clientDialog=function(t){var n=new this(t.message,t.explanation);return t.okButtonAction&&(n._okButtonAction=t.okButtonAction),t.cancelButtonAction&&(n._cancelButtonAction=t.cancelButtonAction),t.okButtonString&&(n._okButtonString=t.okButtonString),t.cancelButtonString&&(n._cancelButtonString=t.cancelButtonString),n},Object.defineProperty(MKDialog.prototype,"actions",{get:function(){return this.cancelButton?'<div id="mk-dialog-actions">'+this.cancelButton+this.okButton+"</div>":'<div id="mk-dialog-actions">'+this.okButton+"</div>"},enumerable:!0,configurable:!0}),Object.defineProperty(MKDialog.prototype,"cancelButton",{get:function(){if("string"==typeof this._cancelButtonString)return'<button type="button">'+this._cancelButtonString+"</button>"},set:function(t){this._cancelButtonString=t},enumerable:!0,configurable:!0}),Object.defineProperty(MKDialog.prototype,"explanation",{get:function(){return'<p id="mk-dialog-explanation">'+this._explanation+"</p>"},enumerable:!0,configurable:!0}),Object.defineProperty(MKDialog.prototype,"hasOKButtonAction",{get:function(){return!!this._okButtonActionURL||!!this._okButtonAction},enumerable:!0,configurable:!0}),Object.defineProperty(MKDialog.prototype,"message",{get:function(){return'<h5 id="mk-dialog-title">'+this._message+"</h5>"},enumerable:!0,configurable:!0}),Object.defineProperty(MKDialog.prototype,"okButton",{get:function(){return this.hasOKButtonAction&&this._okButtonActionURL?'<button type="button" data-ok-action-url=\''+this._okButtonActionURL+"'>"+this._okButtonString+"</button>":'<button type="button">'+this._okButtonString+"</button>"},enumerable:!0,configurable:!0}),MKDialog.prototype.present=function(){var t=this,n=document.createDocumentFragment(),l=document.createElement("div");l.id=this.scrimId,n.appendChild(l);var d=document.createElement("div");d.id=this.id,d.classList.add("mk-dialog"),d.setAttribute("role","alertDialog"),d.setAttribute("aria-modal","true"),d.setAttribute("aria-labeledby","mk-dialog-title"),d.setAttribute("aria-describedby","mk-dialog-explanation");var p='\n      <div id="mk-dialog-body">\n        '+this.message+"\n        "+this.explanation+"\n      </div>";p="\n      "+p+"\n      "+this.actions+"\n    ",d.innerHTML=p,n.appendChild(d),document.body.appendChild(n),document.querySelector("#"+d.id+" #mk-dialog-actions *:first-child").focus(),setTimeout((function(){document.querySelector("#"+d.id+" #mk-dialog-actions *:first-child").addEventListener("click",(function(){t._cancelButtonAction&&t._cancelButtonAction(),d.parentElement.removeChild(d),l.parentElement.removeChild(l)})),t.hasOKButtonAction&&(t._okButtonActionURL?document.querySelector("#"+d.id+" #mk-dialog-actions *:last-child").addEventListener("click",(function(t){window.open(t.target.dataset.okActionUrl,"_blank"),d.parentElement.removeChild(d),l.parentElement.removeChild(l)})):t._okButtonAction&&document.querySelector("#"+d.id+" #mk-dialog-actions *:last-child").addEventListener("click",(function(n){t._okButtonAction(),d.parentElement.removeChild(d),l.parentElement.removeChild(l)})))}))},MKDialog.prototype._appendStyle=function(t){var n=document.createElement("style");n.id=this.styleId,n.styleSheet?n.styleSheet.cssText=t:n.innerHTML=t,document.body.appendChild(n)},MKDialog}();function getPlayerType(t){var n,l;switch(null==t?void 0:t.type){case"contributors":case"modalities":case"movie":case"musicVideo":case"musicMovie":case"trailer":case"tvEpisode":case"uploadedVideo":case"uploaded-videos":case"music-videos":case"music-movies":case"tv-episodes":case"workouts":case"Episode":case"Movie":case"RealityVideo":case"Show":case"Vod":case"EditorialVideoClip":return"video";case"podcast-episodes":return"audio";default:return null!==(l=null===(n=null==t?void 0:t.attributes)||void 0===n?void 0:n.mediaKind)&&void 0!==l?l:"audio"}}var Hc=Cn.audioTracksSwitched,Wc=Cn.audioTracksUpdated,zc=Cn.textTracksSwitched,Gc=Cn.textTracksUpdated,qc=function(t){function HlsJsTracks(n){var l=t.call(this,[Hc,Wc,zc,Gc])||this;return l.session=n,l._audioTracks=[],l._textTracks=[],l.session.on(window.Hls.Events.MANIFEST_LOADED,l.handleManifestLoaded.bind(l)),l.session.on(window.Hls.Events.AUDIO_TRACK_SWITCHED,l.handleAudioTrackSwitched.bind(l)),l.session.on(window.Hls.Events.SUBTITLE_TRACK_SWITCH,l.handleSubtitleTrackSwitch.bind(l)),l}return __extends(HlsJsTracks,t),Object.defineProperty(HlsJsTracks.prototype,"audioTracks",{get:function(){return this._audioTracks},enumerable:!0,configurable:!0}),Object.defineProperty(HlsJsTracks.prototype,"textTracks",{get:function(){return this._textTracks},enumerable:!0,configurable:!0}),Object.defineProperty(HlsJsTracks.prototype,"audioTrack",{set:function(t){this.session&&t&&t.id&&(this.session.audioSelectedPersistentID=t.id)},enumerable:!0,configurable:!0}),Object.defineProperty(HlsJsTracks.prototype,"textTrack",{set:function(t){var n;this.session.subtitleSelectedPersistentID=null!==(n=null==t?void 0:t.id)&&void 0!==n?n:-1},enumerable:!0,configurable:!0}),HlsJsTracks.prototype.selectForcedTrack=function(){var t=this.session;if(null==t?void 0:t.audioTracks){var n=this.session.audioTracks.filter((function(n){return n.id===t.audioTrack})),l=n&&n.length&&n[0];if(l){var d,p=t.subtitleMediaOptions.filter((function(t){return 0===t.MediaSelectionOptionsDisplaysNonForcedSubtitles&&t.MediaSelectionOptionsExtendedLanguageTag===l.lang})),h=null==p?void 0:p[0];return h?(Le.debug("hlsjsTracks: found forced track for "+h.MediaSelectionOptionsExtendedLanguageTag),t.subtitleSelectedPersistentID=h.MediaSelectionOptionsPersistentID,d=this.normalizeTextTrack(h)):t.subtitleSelectedPersistentID=-1,d}}},HlsJsTracks.prototype.audioTracksUpdated=function(t,n){var l=n&&n.audioMediaSelectionGroup&&n.audioMediaSelectionGroup.MediaSelectionGroupOptions||[];window.hlsSession=this.session;var d=l.map(this.normalizeAudioTrack,this);this._audioTracks=d,this.dispatchEvent(Wc,d)},HlsJsTracks.prototype.handleAudioTrackSwitched=function(){this.dispatchEvent(Hc,{selectedId:this.session.audioSelectedPersistentID})},HlsJsTracks.prototype.handleManifestLoaded=function(t,n){this.audioTracksUpdated(t,n),this.subtitleTracksUpdated(t,n)},HlsJsTracks.prototype.handleSubtitleTrackSwitch=function(t,n){this.dispatchEvent(zc,n)},HlsJsTracks.prototype.subtitleTracksUpdated=function(t,n){var l=this,d=n&&n.subtitleMediaSelectionGroup&&n.subtitleMediaSelectionGroup.MediaSelectionGroupOptions||[],p=Array();d.forEach((function(t){0!==t.MediaSelectionOptionsDisplaysNonForcedSubtitles&&p.push(l.normalizeTextTrack(t))})),this._textTracks=p,this.dispatchEvent(Gc,p)},HlsJsTracks.prototype.normalizeAudioTrack=function(t){var n,l="public.accessibility.describes-video"===(null===(n=t.MediaSelectionOptionsTaggedMediaCharacteristics)||void 0===n?void 0:n[0])?"description":"main";return __assign(__assign({},this.normalizeSelectionOption(t)),{enabled:!1,kind:l})},HlsJsTracks.prototype.normalizeTextTrack=function(t){var n,l;return l=(null===(n=t.MediaSelectionOptionsTaggedMediaCharacteristics)||void 0===n?void 0:n.includes("public.accessibility.describes-music-and-sound"))||"clcp"===t.MediaSelectionOptionsMediaType?"captions":"subtitles",__assign(__assign({},this.normalizeSelectionOption(t)),{mode:"disabled",kind:l})},HlsJsTracks.prototype.normalizeSelectionOption=function(t){return{id:t.MediaSelectionOptionsPersistentID,label:t.MediaSelectionOptionsName,language:t.MediaSelectionOptionsExtendedLanguageTag}},HlsJsTracks}(ke),Qc="keySystemGenericError",Jc={};Jc[Jo.FAIRPLAY]="fairplaystreaming",Jc[Jo.PLAYREADY]="playready",Jc[Jo.WIDEVINE]="widevine";var Xc=!1;"undefined"!=typeof localStorage&&(Xc=!!localStorage.getItem("mk-hlsjs-debug")),Xc||(window.globalHlsLogConfig=Xc);var Zc,el=function(t){function HlsJsVideoPlayer(n){var l,d=t.call(this,n)||this;return d._channelsByGroup={},d._rtcTracker=null===(l=null==n?void 0:n.playbackServices)||void 0===l?void 0:l.getRTCStreamingTracker(),d._license=new ha,d}return __extends(HlsJsVideoPlayer,t),Object.defineProperty(HlsJsVideoPlayer.prototype,"shouldDispatchErrors",{get:function(){return!this.userInitiated||this._playbackDidStart},enumerable:!0,configurable:!0}),HlsJsVideoPlayer.prototype.initializeExtension=function(){return __awaiter(this,void 0,void 0,(function(){var t,n;return __generator(this,(function(l){switch(l.label){case 0:return t=this,[4,findKeySystemPreference()];case 1:t._keySystem=l.sent(),l.label=2;case 2:if(l.trys.push([2,4,,5]),!bo.urls.hls)throw new Error("bag.urls.hls is not configured");return[4,loadScript(bo.urls.hls)];case 3:return l.sent(),[3,5];case 4:throw n=l.sent(),Le.error("hlsjs-video-player failed to load script "+bo.urls.hls,n),n;case 5:return[2]}}))}))},HlsJsVideoPlayer.prototype.destroy=function(){Le.debug("hlsjs-video-player.destroy");var n=this._hls;n&&(n.stopLoad(),n.detachMedia(),n.destroy()),t.prototype.destroy.call(this),asAsync(this._license.stop())},HlsJsVideoPlayer.prototype.playHlsStream=function(t,n){Le.debug("hlsjs-video-player.playHlsStream",t,n);var l=this._keySystem;if(l){var d,p;this.createHlsPlayer(),l===Jo.WIDEVINE&&(d="WIDEVINE_SOFTWARE",p={initDataTypes:["cenc","keyids"],distinctiveIdentifier:"optional",persistentState:"required"});var h={platformInfo:{requiresCDMAttachOnStart:!0,maxSecurityLevel:d,keySystemConfig:p},appData:{serviceName:bo.app.name}},f=this._rtcTracker,y=this._hls;if(f){var v=f.prepareReportingAgent(n);void 0!==v&&(h.appData.reportingAgent=v)}Le.debug("RTC: loadSource with load options",h),y.loadSource(t,h),y.attachMedia(this.video),n&&(this._licenseServerUrl=n.keyURLs["hls-key-server-url"],l===Jo.FAIRPLAY?y.setProtectionData({fairplaystreaming:{serverCertUrl:n.keyURLs["hls-key-cert-url"]}}):y.setProtectionData({widevine:{serverCertUrl:n.keyURLs["widevine-cert-url"]}}))}},HlsJsVideoPlayer.prototype.createHlsPlayer=function(){var t=this._keySystem,n=new window.Hls({clearMediaKeysOnPromise:!1,customTextTrackCueRenderer:!0,debug:Xc,enablePerformanceLogging:Xc,enablePlayReadyKeySystem:!0,enableRtcReporting:void 0!==this._rtcTracker,keySystemPreference:Jc[t],useMediaKeySystemAccessFilter:!0}),l=window.Hls.Events,d=l.ERROR,p=l.INTERNAL_ERROR,h=l.MANIFEST_PARSED,f=l.KEY_REQUEST_STARTED,y=l.LICENSE_CHALLENGE_CREATED,v=l.LEVEL_SWITCHED;n.on(d,this.handleHlsError),n.on(p,this.handleHlsError),n.on(h,this.handleManifestParsed),n.on(f,this.handleKeyRequestStarted),n.on(y,this.handleLicenseChallengeCreated),n.on(v,this.handleLevelSwitched),this._hls=n,this.setupTrackManagers(new qc(n))},HlsJsVideoPlayer.prototype.handleLevelSwitched=function(t,n){var l,d,p=n.level;if(p){var h=null===(l=this._levels)||void 0===l?void 0:l.find((function(t){return t.persistentId===p}));if(h&&(null===(d=this._currentLevel)||void 0===d?void 0:d.persistentId)!==(null==h?void 0:h.persistentId)){this._currentLevel=h;var f=void 0!==h.audioGroupId?this._channelsByGroup[h.audioGroupId]:void 0;this._dispatcher.publish(Ve.hlsLevelUpdated,{level:h,channels:f})}}},HlsJsVideoPlayer.prototype.handleHlsError=function(t,n){Le.warn("HLS.js error",n);var l=new Fe(Fe.UNSUPPORTED_ERROR,n.reason);l.data=n;var d=Qc;if(n.details!==d){if("output-restricted"===n.reason&&(l=new Fe(Fe.OUTPUT_RESTRICTED,n.reason)),n.fatal){if(this._hls.destroy(),!this.shouldDispatchErrors)throw l;this._dispatcher.publish(nn,l)}}else this._dispatcher.publish(d,l)},HlsJsVideoPlayer.prototype.handleManifestParsed=function(t,n){var l,p;this._levels=null!==(l=n.levels)&&void 0!==l?l:[],this.nowPlayingItem.state=d.ready,this._channelsByGroup=(null!==(p=n.audioTracks)&&void 0!==p?p:[]).reduce((function(t,n){return t[n.groupId]=n.channels,t}),{}),asAsync(this._playMedia())},HlsJsVideoPlayer.prototype.handleKeyRequestStarted=function(t,n){Le.debug("hlsjs-video.handleKeyRequestStarted"),this._hls.generateKeyRequest(n.keyuri,{})},HlsJsVideoPlayer.prototype.handleLicenseChallengeCreated=function(t,n){var l;return __awaiter(this,void 0,void 0,(function(){var t,d,p,h,f,y,v,_,g;return __generator(this,(function(m){switch(m.label){case 0:d=(t=this)._licenseServerUrl,p=t.nowPlayingItem,h=t._keySystem,f=t.userInitiated,m.label=1;case 1:return m.trys.push([1,3,,4]),[4,null===(l=this._license)||void 0===l?void 0:l.start(d,p,n,h,f)];case 2:return(null==(y=m.sent())?void 0:y.license)&&(v={statusCode:y.status},h===Jo.FAIRPLAY?v.ckc=me(y.license):v.license=me(y.license),(_=y["renew-after"])&&(v.renewalDate=new Date(Date.now()+1e3*_)),this._hls.setLicenseResponse(n.keyuri,v)),[3,4];case 3:if(g=m.sent(),shouldThrowLicenseError(g,f))throw g;return this.onPlaybackLicenseError(g),[3,4];case 4:return[2]}}))}))},__decorate([Bind(),__metadata("design:type",Function),__metadata("design:paramtypes",[Object,Object]),__metadata("design:returntype",void 0)],HlsJsVideoPlayer.prototype,"handleLevelSwitched",null),__decorate([Bind(),__metadata("design:type",Function),__metadata("design:paramtypes",[Object,Object]),__metadata("design:returntype",void 0)],HlsJsVideoPlayer.prototype,"handleHlsError",null),__decorate([Bind(),__metadata("design:type",Function),__metadata("design:paramtypes",[Object,Object]),__metadata("design:returntype",void 0)],HlsJsVideoPlayer.prototype,"handleManifestParsed",null),__decorate([Bind(),__metadata("design:type",Function),__metadata("design:paramtypes",[Object,Object]),__metadata("design:returntype",void 0)],HlsJsVideoPlayer.prototype,"handleKeyRequestStarted",null),__decorate([Bind(),__metadata("design:type",Function),__metadata("design:paramtypes",[Object,Object]),__metadata("design:returntype",Promise)],HlsJsVideoPlayer.prototype,"handleLicenseChallengeCreated",null),HlsJsVideoPlayer}(ta),tl=nn,rl=Cn.playbackLicenseError,il=Cn.playbackSessionError,nl=function(t){function NativeSafariVideoPlayer(){return null!==t&&t.apply(this,arguments)||this}return __extends(NativeSafariVideoPlayer,t),NativeSafariVideoPlayer.prototype.initializeExtension=function(){return __awaiter(this,void 0,void 0,(function(){var t;return __generator(this,(function(n){switch(n.label){case 0:return t=new Pa(this.video,'video/mp4;codecs="avc1.42E01E"'),this.extension=t,[4,t.initializeKeySystem()];case 1:return n.sent(),t.addEventListener(rl,this.onPlaybackLicenseError),t.addEventListener(il,this.onPlaybackSessionError),[2]}}))}))},NativeSafariVideoPlayer.prototype.destroy=function(){Le.debug("native-safari-video-player.destroy");var n=this.extension;n&&(n.removeEventListener(rl,this.onPlaybackLicenseError),n.removeEventListener(il,this.onPlaybackSessionError),this.video.removeEventListener("loadedmetadata",this.onMetadataLoaded),t.prototype.destroy.call(this))},NativeSafariVideoPlayer.prototype.playHlsStream=function(t){var n;return __awaiter(this,void 0,void 0,(function(){var l;return __generator(this,(function(d){return Le.debug("native-safari-video-player.playHlsStream",t),this.setupTrackManagers(),this.video.src=t,(l=this.nowPlayingItem)&&(null===(n=this.extension)||void 0===n||n.setMediaItem(l)),this.video.addEventListener("loadedmetadata",this.onMetadataLoaded),[2]}))}))},NativeSafariVideoPlayer.prototype.onPlaybackSessionError=function(t){this._dispatcher.publish(tl,new Fe(Fe.MEDIA_SESSION,t))},NativeSafariVideoPlayer.prototype.onMetadataLoaded=function(){Le.debug("native-safari-video-player.onMetadataLoaded");var t=this.nowPlayingItem;t&&(t.state=d.ready),asAsync(this._playMedia())},__decorate([Bind(),__metadata("design:type",Function),__metadata("design:paramtypes",[Object]),__metadata("design:returntype",void 0)],NativeSafariVideoPlayer.prototype,"onPlaybackSessionError",null),__decorate([Bind(),__metadata("design:type",Function),__metadata("design:paramtypes",[]),__metadata("design:returntype",void 0)],NativeSafariVideoPlayer.prototype,"onMetadataLoaded",null),NativeSafariVideoPlayer}(ta),ol=function(){function Factory(t){this._playersByType={},this._playerOptions=t}return Factory.prototype.getPlayerForMediaItem=function(t,n,l){return __awaiter(this,void 0,void 0,(function(){var d,p,h,f,y;return __generator(this,(function(v){switch(v.label){case 0:if(Le.debug("mk: getPlayerForMediaItem",t,n),d=getPlayerType(t),(null==(p=this._playersByType[d])?void 0:p.isDestroyed)&&(Le.debug("mk: existingPlayer was previously destroyed. Removing from factory."),p=void 0,delete this._playersByType[d]),p&&p===l)return[2,l];if(p)return this._applyPlayerState(p,n),[2,p];switch(h=this._playerOptions,d){case"audio":return[3,1];case"video":return[3,2]}return[3,4];case 1:return f=new Ga(h),this._playersByType[d]=f,[3,5];case 2:return[4,this._playerOptions.playbackServices.requiresHlsJs()];case 3:return y=v.sent(),f=y?new el(h):new nl(h),[3,5];case 4:throw new Error("Invalid player type requested: "+d);case 5:return[4,f.initialize()];case 6:return v.sent(),this._applyPlayerState(f,n),[2,f]}}))}))},Factory.prototype._applyPlayerState=function(t,n){return n?(Le.debug("_applyPlayerState",n),Object.keys(n).forEach((function(l){void 0!==t[l]&&(t[l]=n[l])})),t):t},Factory.prototype.destroy=function(){Object.values(this._playersByType).forEach((function(t){return t.destroy()}))},Factory}(),al=gn,sl=Cn.playbackLicenseError,ul=Qc,cl=!1,ll=function(){function MediaItemPlayback(t){this.playerState={playbackRate:1,volume:1},this.playOptions=new Map,this._previewOnly=!1;var n,l,d=t.playbackServices;this.hasMusicSubscription=d.hasMusicSubscription,this.playMediaItem=d.playMediaItem,this.prepareForEncryptedPlayback=d.prepareForEncryptedPlayback,n=t.tokens,pa=n,t.bag&&(l=t.bag,Object.assign(bo,l)),this._dispatcher=t.services.dispatcher,this._playerFactory=new ol(t),this._currentPlayer=new Qa(t),this._dispatcher.subscribe(sl,this.onPlaybackLicenseError),this._dispatcher.subscribe(ul,this.onKeySystemGenericError)}return Object.defineProperty(MediaItemPlayback.prototype,"currentPlaybackTime",{get:function(){return this._currentPlayer.currentPlaybackTime},enumerable:!0,configurable:!0}),Object.defineProperty(MediaItemPlayback.prototype,"currentPlaybackTimeRemaining",{get:function(){return this._currentPlayer.currentPlaybackTimeRemaining},enumerable:!0,configurable:!0}),Object.defineProperty(MediaItemPlayback.prototype,"audioTracks",{get:function(){return this._currentPlayer.audioTracks},enumerable:!0,configurable:!0}),Object.defineProperty(MediaItemPlayback.prototype,"currentAudioTrack",{get:function(){return this._currentPlayer.currentAudioTrack},set:function(t){this._currentPlayer.currentAudioTrack=t},enumerable:!0,configurable:!0}),Object.defineProperty(MediaItemPlayback.prototype,"currentPlaybackDuration",{get:function(){return this._currentPlayer.currentPlaybackDuration},enumerable:!0,configurable:!0}),Object.defineProperty(MediaItemPlayback.prototype,"currentBufferedProgress",{get:function(){return this._currentPlayer.currentBufferedProgress},set:function(t){this._currentPlayer.currentBufferedProgress=t},enumerable:!0,configurable:!0}),Object.defineProperty(MediaItemPlayback.prototype,"currentPlaybackProgress",{get:function(){return this._currentPlayer.currentPlaybackProgress},set:function(t){this._currentPlayer.currentPlaybackProgress=t},enumerable:!0,configurable:!0}),Object.defineProperty(MediaItemPlayback.prototype,"currentTextTrack",{get:function(){return this._currentPlayer.currentTextTrack},set:function(t){this._currentPlayer.currentTextTrack=t},enumerable:!0,configurable:!0}),Object.defineProperty(MediaItemPlayback.prototype,"previewOnly",{get:function(){return this._previewOnly},set:function(t){this._previewOnly=t,this._currentPlayer&&(this._currentPlayer.previewOnly=t)},enumerable:!0,configurable:!0}),Object.defineProperty(MediaItemPlayback.prototype,"formattedCurrentPlaybackDuration",{get:function(){return this._currentPlayer.formattedCurrentPlaybackDuration},enumerable:!0,configurable:!0}),Object.defineProperty(MediaItemPlayback.prototype,"isPlaying",{get:function(){return this._currentPlayer.isPlaying},enumerable:!0,configurable:!0}),Object.defineProperty(MediaItemPlayback.prototype,"isPrimaryPlayer",{get:function(){return this._currentPlayer.isPrimaryPlayer},set:function(t){this._currentPlayer.isPrimaryPlayer=t},enumerable:!0,configurable:!0}),Object.defineProperty(MediaItemPlayback.prototype,"isReady",{get:function(){return this._currentPlayer.isReady},enumerable:!0,configurable:!0}),Object.defineProperty(MediaItemPlayback.prototype,"nowPlayingItem",{get:function(){return this._currentPlayer.nowPlayingItem},enumerable:!0,configurable:!0}),Object.defineProperty(MediaItemPlayback.prototype,"playbackRate",{get:function(){return this._currentPlayer.playbackRate},set:function(t){this._updatePlayerState("playbackRate",t)},enumerable:!0,configurable:!0}),Object.defineProperty(MediaItemPlayback.prototype,"playbackState",{get:function(){return this._currentPlayer.playbackState},set:function(t){this._currentPlayer.playbackState=t},enumerable:!0,configurable:!0}),Object.defineProperty(MediaItemPlayback.prototype,"playbackTargetAvailable",{get:function(){return this._currentPlayer.playbackTargetAvailable},enumerable:!0,configurable:!0}),Object.defineProperty(MediaItemPlayback.prototype,"playbackTargetIsWireless",{get:function(){return this._currentPlayer.playbackTargetIsWireless},enumerable:!0,configurable:!0}),Object.defineProperty(MediaItemPlayback.prototype,"textTracks",{get:function(){return this._currentPlayer.textTracks},enumerable:!0,configurable:!0}),Object.defineProperty(MediaItemPlayback.prototype,"volume",{get:function(){return this._currentPlayer.volume},set:function(t){this._updatePlayerState("volume",t)},enumerable:!0,configurable:!0}),MediaItemPlayback.prototype.destroy=function(){var t,n;this._playerFactory.destroy(),null===(t=this._dispatcher)||void 0===t||t.unsubscribe(sl,this.onPlaybackLicenseError),null===(n=this._dispatcher)||void 0===n||n.unsubscribe(ul,this.onKeySystemGenericError)},MediaItemPlayback.prototype.exitFullscreen=function(){return this._currentPlayer.exitFullscreen()},MediaItemPlayback.prototype.getNewSeeker=function(){return this._currentPlayer.newSeeker()},MediaItemPlayback.prototype.mute=function(){this._volumeAtMute=this.volume,this.volume=0},MediaItemPlayback.prototype.pause=function(t){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(n){return[2,this._currentPlayer.pause(t)]}))}))},MediaItemPlayback.prototype.play=function(){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(t){return[2,this._currentPlayer.play()]}))}))},MediaItemPlayback.prototype.preload=function(){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(t){return[2,this._currentPlayer.preload()]}))}))},MediaItemPlayback.prototype.prepareToPlay=function(t){var n;return __awaiter(this,void 0,void 0,(function(){var l,d,p,h;return __generator(this,(function(f){switch(f.label){case 0:return Le.debug("invoking prepareToPlay for ",t.title),[4,this.prepareForEncryptedPlayback(t,this._currentPlayer)];case 1:return l=f.sent(),d=null===(n=this._currentPlayback)||void 0===n?void 0:n.item,p=bo.features["enable-gapless"],h="song"===(null==d?void 0:d.type)&&"song"===t.type,p&&h?(Le.debug("setting "+t.title+" for gapless transition"),[4,this._currentPlayer.setNextGaplessItem(t)]):[3,3];case 2:f.sent(),f.label=3;case 3:return[2,l]}}))}))},MediaItemPlayback.prototype.requestFullscreen=function(t){return this._currentPlayer.requestFullscreen(t)},MediaItemPlayback.prototype.showPlaybackTargetPicker=function(){this._currentPlayer.showPlaybackTargetPicker()},MediaItemPlayback.prototype.seekToTime=function(n,l){return void 0===l&&(l=t.SeekReasonType.Manual),__awaiter(this,void 0,void 0,(function(){return __generator(this,(function(t){switch(t.label){case 0:return[4,this._currentPlayer.seekToTime(n,l)];case 1:return t.sent(),[2]}}))}))},MediaItemPlayback.prototype.setPresentationMode=function(t){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(n){return[2,this._currentPlayer.setPresentationMode(t)]}))}))},MediaItemPlayback.prototype.startMediaItemPlayback=function(t,n){var l,d,p;return void 0===n&&(n=!1),__awaiter(this,void 0,void 0,(function(){var h,f,y,v,_,g=this;return __generator(this,(function(m){switch(m.label){case 0:return Le.debug("MediaItemPlayback: startMediaItemPlayback",t),t.resetState(),(null===(d=null===(l=t.container)||void 0===l?void 0:l.attributes)||void 0===d?void 0:d.requiresSubscription)?[4,this.hasMusicSubscription()]:[3,2];case 1:if(!m.sent())throw(h=new Fe(Fe.SUBSCRIPTION_ERROR)).data=t,h;m.label=2;case 2:return[4,this._getPlayerForMediaItem(t)];case 3:return f=m.sent(),[4,this.setCurrentPlayer(f)];case 4:if(m.sent(),!(null===(p=this._currentPlayer)||void 0===p?void 0:p.hasMediaElement))return Le.warn("MediaItemPlayback: Could not play media of type "+t.type+", marking item as unsupported and skipping."),t.notSupported(),[2];m.label=5;case 5:return m.trys.push([5,7,,8]),t.beginMonitoringStateDidChange((function(t){var n;return null===(n=g._dispatcher)||void 0===n?void 0:n.publish(ti,t)})),t.beginMonitoringStateWillChange((function(t){var n;return null===(n=g._dispatcher)||void 0===n?void 0:n.publish(ri,t)})),(y=this.playOptions.get(t.id))&&this.playOptions.delete(t.id),[4,this.playMediaItem(t,this._currentPlayer,n,y)];case 6:return v=m.sent(),this._currentPlayback={item:t,userInitiated:n},[2,v];case 7:throw _=m.sent(),Le.error(_),_;case 8:return[2]}}))}))},MediaItemPlayback.prototype.stop=function(t){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(n){switch(n.label){case 0:return[4,this._currentPlayer.stop(t)];case 1:return n.sent(),[2]}}))}))},MediaItemPlayback.prototype.unmute=function(){this.volume>0||(this.volume=this._volumeAtMute||1,this._volumeAtMute=void 0)},MediaItemPlayback.prototype._getPlayerForMediaItem=function(t){return __awaiter(this,void 0,void 0,(function(){var n;return __generator(this,(function(l){switch(l.label){case 0:return Le.debug("MediaItemPlayback:  _getPlayerForMediaItem",t.id),[4,this._playerFactory.getPlayerForMediaItem(t,this.playerState,this._currentPlayer)];case 1:return(n=l.sent()).previewOnly=this._previewOnly,[2,n]}}))}))},MediaItemPlayback.prototype.setCurrentPlayer=function(t){var n;return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(l){switch(l.label){case 0:return this._currentPlayer===t?[2]:(Le.debug("MediaItemPlayback: setting currentPlayer",t),[4,this._currentPlayer.stop()]);case 1:return l.sent(),this._currentPlayer=t,null===(n=this._dispatcher)||void 0===n||n.publish(al,{player:t}),[2]}}))}))},MediaItemPlayback.prototype.onKeySystemGenericError=function(t,n){var l;return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(t){switch(t.label){case 0:return cl?(null===(l=this._dispatcher)||void 0===l||l.publish(nn,n),[3,3]):[3,1];case 1:return cl=!0,Le.warn("Retrying playback after keysystemGenericError"),[4,this.restartPlayback()];case 2:t.sent(),t.label=3;case 3:return[2]}}))}))},MediaItemPlayback.prototype.onPlaybackLicenseError=function(t,n){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(t){switch(t.label){case 0:return n.errorCode!==Fe.PLAYREADY_CBC_ENCRYPTION_ERROR?[3,2]:(Le.warn("MediaItemPlayback: PLAYREADY_CBC_ENCRYPTION_ERROR...retrying with different key system"),[4,this.restartPlayback()]);case 1:t.sent(),t.label=2;case 2:return[2]}}))}))},MediaItemPlayback.prototype.restartPlayback=function(){return __awaiter(this,void 0,void 0,(function(){var t,n,l;return __generator(this,(function(d){switch(d.label){case 0:return[4,this.stop()];case 1:return d.sent(),(t=this._currentPlayback)?(n=t.item,l=t.userInitiated,n.resetState(),[4,this.startMediaItemPlayback(n,l)]):[3,3];case 2:d.sent(),d.label=3;case 3:return[2]}}))}))},MediaItemPlayback.prototype._updatePlayerState=function(t,n){this.playerState[t]=n,this._currentPlayer[t]=n},__decorate([Bind(),__metadata("design:type",Function),__metadata("design:paramtypes",[Object,Object]),__metadata("design:returntype",Promise)],MediaItemPlayback.prototype,"onKeySystemGenericError",null),__decorate([Bind(),__metadata("design:type",Function),__metadata("design:paramtypes",[Object,Object]),__metadata("design:returntype",Promise)],MediaItemPlayback.prototype,"onPlaybackLicenseError",null),MediaItemPlayback}();(Zc=t.SupportedAPIs||(t.SupportedAPIs={})).UTS="uts-api",Zc.MEDIA="media-api";var dl=function(){function APIServiceManager(t,n){this.store=t,this._dispatcher=n,this._apisByType={}}return Object.defineProperty(APIServiceManager.prototype,"api",{get:function(){return this.getApiByType(this._defaultAPI)},enumerable:!0,configurable:!0}),Object.defineProperty(APIServiceManager.prototype,"apiService",{get:function(){if(void 0!==this._defaultAPI)return this._apisByType[this._defaultAPI];ts.error("There is no API instance configured")},enumerable:!0,configurable:!0}),Object.defineProperty(APIServiceManager.prototype,"mediaAPI",{get:function(){return this.getApiByType(t.SupportedAPIs.MEDIA)},enumerable:!0,configurable:!0}),Object.defineProperty(APIServiceManager.prototype,"utsAPI",{get:function(){return this.getApiByType(t.SupportedAPIs.UTS)},enumerable:!0,configurable:!0}),APIServiceManager.prototype.getApiByType=function(t){var n;if(void 0!==t&&(n=this._apisByType[t]),void 0===n||void 0===n.api)throw new Fe(Fe.CONFIGURATION_ERROR,"There is no API instance configured for the requested type: "+t);return n.api},Object.defineProperty(APIServiceManager.prototype,"defaultApiType",{set:function(t){this._defaultAPI=t},enumerable:!0,configurable:!0}),APIServiceManager.prototype.registerAPIService=function(t){return __awaiter(this,void 0,void 0,(function(){var n,l,d,p,h,f;return __generator(this,(function(y){switch(y.label){case 0:return n=t.apiType,l=t.configureFn,d=t.options,p=d.apiOptions||{},void 0===this._defaultAPI&&(this._defaultAPI=n),h=this._apisByType,f=n,[4,l.call(this,{apiOptions:p,store:this.store,dispatcher:this._dispatcher})];case 1:return h[f]=y.sent(),[2]}}))}))},APIServiceManager}(),pl=function(){function BitrateCalculator(n,l){var d,p;void 0===l&&(l=t.PlaybackBitrate.STANDARD),this._downlinkSamples=[],this._bitrate=l,this._dispatcher=n,void 0!==(null===(p=null===(d=null===window||void 0===window?void 0:window.navigator)||void 0===d?void 0:d.connection)||void 0===p?void 0:p.downlink)&&this._recalculateBitrate(100*(window.navigator.connection.downlink||0))}return Object.defineProperty(BitrateCalculator.prototype,"bitrate",{get:function(){return this._bitrate},set:function(t){this._bitrate!==t&&(this._bitrate=t,this._dispatcher.publish(An.playbackBitrateDidChange,{bitrate:t}))},enumerable:!0,configurable:!0}),BitrateCalculator.prototype._calculateAverageDownlink=function(){return 0===this._downlinkSamples.length?0:this._downlinkSamples.reduce((function(t,n){return t+n}),0)/this._downlinkSamples.length||0},BitrateCalculator.prototype._recalculateBitrate=function(n){ts.debug("_recalculateBitrate",n),this._downlinkSamples.push(n),this._calculateAverageDownlink()>t.PlaybackBitrate.STANDARD?(ts.debug("setting bitrate to",t.PlaybackBitrate.HIGH),this.bitrate=t.PlaybackBitrate.HIGH):(ts.debug("setting bitrate to",t.PlaybackBitrate.STANDARD),this.bitrate=t.PlaybackBitrate.STANDARD)},BitrateCalculator}(),hl={};function adaptAddEventListener(t,n,l,d){void 0===d&&(d={});var p=d.once,h=function(t,n){var l=getCallbacksForName(t),wrappedCallback=function(t,l){n(l)};return l.push([n,wrappedCallback]),wrappedCallback}(n,l);!0===p?t.subscribeOnce(n,h):t.subscribe(n,h)}function getCallbacksForName(t){var n=hl[t];return n||(n=[],hl[t]=n),n}function requiresHlsJs(t){return __awaiter(this,void 0,void 0,(function(){var n,l,d;return __generator(this,(function(p){switch(p.label){case 0:return null==t?[3,1]:(l=t,[3,3]);case 1:return[4,findKeySystemPreference()];case 2:l=p.sent(),p.label=3;case 3:return n=l,d=!(!0===ns.features["safari-native-hls"]||0===xa.realm),[2,supportsDrm()&&(n!==Jo.FAIRPLAY||d)]}}))}))}var fl,yl=function(){function RTCStreamingTracker(t){this.options=t}return RTCStreamingTracker.prototype.configure=function(t,n){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(n){switch(n.label){case 0:if(this.instance=t,!ns.urls.rtc)throw new Error("bag.urls.rtc is not configured");return[4,loadScript(ns.urls.rtc)];case 1:return n.sent(),[2,this]}}))}))},RTCStreamingTracker.prototype.prepareReportingAgent=function(t){var n,l;this.clearReportingAgent();var d=t||this.instance.nowPlayingItem,p=d?getDefaultPlayable(d):void 0,h=window.rtc.RTCReportingAgentConfigKeys,f=h.Sender,y=h.ClientName,v=h.ServiceName,_=h.ApplicationName,g=h.ReportingStoreBag,m=h.DeviceName,b={firmwareVersion:this.generateBrowserVersion(),model:this.options.browserName};p&&((null===(l=p.mediaMetrics)||void 0===l?void 0:l.MediaIdentifier)&&(b.MediaIdentifier=p.mediaMetrics.MediaIdentifier),p.channelId&&(b.ContentProvider=p.channelId)),void 0===this._storeBag&&(this._storeBag=this.generateStoreBag());var P=((n={})[f]="HLSJS",n[y]=this.options.clientName,n[v]=this.options.serviceName,n[_]=this.options.applicationName,n[g]=this._storeBag,n[m]=this.options.osVersion,n.userInfoDict=b,n);return ts.debug("RTC: creating reporting agent with config",P),this.reportingAgent=new window.rtc.RTCReportingAgent(P),ts.debug("RTC: created reporting agent",this.reportingAgent),this.reportingAgent},RTCStreamingTracker.prototype.shouldConfigure=function(t){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(t){return[2,requiresHlsJs()]}))}))},RTCStreamingTracker.prototype.shouldTrackPlayActivity=function(t,n){return!0},RTCStreamingTracker.prototype.cleanup=function(){this.clearReportingAgent()},RTCStreamingTracker.prototype.clearReportingAgent=function(){void 0!==this.reportingAgent&&(this.reportingAgent.destroy(),ts.debug("RTC: called destroy on reporting agent",this.reportingAgent),this.reportingAgent=void 0)},RTCStreamingTracker.prototype.generateBrowserVersion=function(){return this.options.browserMajorVersion?this.options.browserMajorVersion+"."+(this.options.browserMinorVersion||0):"unknown"},RTCStreamingTracker.prototype.generateStoreBag=function(){var t,n=this.options,l=n.storeBagURL,d=n.clientName,p=n.applicationName,h=n.serviceName,f=n.browserName,y={HLSJSVersion:null===(t=null===window||void 0===window?void 0:window.Hls)||void 0===t?void 0:t.version},v=new window.rtc.RTCStorebag.RTCReportingStoreBag(l,d,h,p,f,y);return ts.debug("RTC: created store bag",v),v},RTCStreamingTracker}();!function(t){t[t.ACCURATE=0]="ACCURATE",t[t.ROUND=1]="ROUND"}(fl||(fl={}));var vl=function(){function TimingAccuracy(t){void 0===t&&(t=!1),this.mode=t?fl.ACCURATE:fl.ROUND}return TimingAccuracy.prototype.time=function(t){return void 0===t&&(t=0),this.mode===fl.ROUND?Math.round(t):t},TimingAccuracy}(),loadLiveRadioAssets=function(t,n,l){return __awaiter(void 0,void 0,void 0,(function(){var d,p,h,f,y,v,_,g,m,b,P,T;return __generator(this,(function(S){switch(S.label){case 0:return d=new Headers({Authorization:"Bearer "+n,Accept:"application/json","Content-Type":"application/json","X-Apple-Music-User-Token":""+l}),p=__assign(__assign({},t.playParams),{keyFormat:"web"}),h=urlEncodeParameters(p),f=ns.urls.mediaApi+"/play/assets?"+h,[4,fetch(f,{method:"GET",headers:d})];case 1:if(500!==(y=S.sent()).status)return[3,2];throw(g=new Fe(Fe.SERVER_ERROR)).data=t,g;case 2:if(403!==y.status)return[3,7];v=void 0,S.label=3;case 3:return S.trys.push([3,5,,6]),[4,y.json()];case 4:return v=S.sent(),v=null===(P=null==v?void 0:v.errors)||void 0===P?void 0:P[0],[3,6];case 5:return S.sent(),[3,6];case 6:throw _="40303"===(null==v?void 0:v.code)?Fe.SUBSCRIPTION_ERROR:Fe.ACCESS_DENIED,(g=new Fe(_,null!==(T=null==v?void 0:v.title)&&void 0!==T?T:null==v?void 0:v.detail)).data=t,g;case 7:if(!y.ok)throw(g=new Fe(Fe.CONTENT_UNAVAILABLE)).data=t,g;S.label=8;case 8:return[4,y.json()];case 9:return m=S.sent(),b=m.results,ts.debug("media-item: loaded data from "+f+": "+JSON.stringify(b)),[2,b]}}))}))},prepareMediaAPIItem=function(t,n,l){return __awaiter(void 0,void 0,void 0,(function(){return __generator(this,(function(d){switch(d.label){case 0:return t.hasOffersHlsUrl?[4,prepareOffersHlsUrlForEncryptedPlayback(t)]:[3,2];case 1:return d.sent(),[3,6];case 2:return t.isLiveRadioStation?[4,prepareLiveRadioForEncryptedPlayback(t,n,l)]:[3,4];case 3:return d.sent(),[3,6];case 4:return[4,prepareItemWithMZPlay(t,n,l)];case 5:d.sent(),d.label=6;case 6:return[2]}}))}))},prepareOffersHlsUrlForEncryptedPlayback=function(t){return __awaiter(void 0,void 0,void 0,(function(){var n;return __generator(this,(function(l){switch(l.label){case 0:if(!(n=ns.urls.hlsOffersKeyUrls))throw new Fe(Fe.CONTENT_UNSUPPORTED,"HLS OFFERS");return t.updateWithLoadedKeys(n),[4,fetchMasterManifestUrl(t,t.offersHlsUrl)];case 1:return l.sent(),[2]}}))}))},prepareLiveRadioForEncryptedPlayback=function(t,n,l){return __awaiter(void 0,void 0,void 0,(function(){var d,p;return __generator(this,(function(h){switch(h.label){case 0:if(!ns.features["playready-live-radio"]&&ra===Jo.PLAYREADY&&"video"!==t.attributes.mediaKind&&!ns.features["mse-live-radio"])throw new Fe(Fe.CONTENT_UNSUPPORTED,"LIVE_RADIO");return[4,loadLiveRadioAssets(t,n,l)];case 1:return d=h.sent(),p=d.assets[0],t.updateWithLoadedKeys({"hls-key-cert-url":p.fairPlayKeyCertificateUrl,"hls-key-server-url":p.keyServerUrl,"widevine-cert-url":p.widevineKeyCertificateUrl}),filterUnavailableLiveRadioUrls(p,t),[4,fetchMasterManifestUrl(t,p.url)];case 2:return h.sent(),[2]}}))}))},fetchMasterManifestUrl=function(t,n){return __awaiter(void 0,void 0,void 0,(function(){var l,d;return __generator(this,(function(p){switch(p.label){case 0:return p.trys.push([0,2,,3]),[4,fetch(n)];case 1:return l=p.sent(),[3,3];case 2:throw p.sent(),makeContentUnavailableError(t);case 3:return[4,l.text()];case 4:return d=p.sent(),extractAssetsFromMasterManifest(d,n,t),[2]}}))}))},extractAssetsFromMasterManifest=function(t,n,l){for(var d,p=/^#EXT-X-STREAM-INF:.*BANDWIDTH=(\d+),CODECS="(.*)"\s*\n(.*$)/gim;d=p.exec(t);){var h=__read(d,4),f=(h[0],h[1]),y=h[2],v=h[3];/^http(s)?:\/\//.test(v)||(v=rewriteLastUrlPath(n,v)),l.assets.push({bandwidth:Number(f),codec:y,URL:v})}},filterUnavailableLiveRadioUrls=function(t,n){if(!new URL(t.url).host.endsWith(".apple.com"))throw makeContentUnavailableError(n)},makeContentUnavailableError=function(t){var n=new Fe(Fe.CONTENT_UNAVAILABLE);return n.data=t,n},prepareItemWithMZPlay=function(t,n,l){return __awaiter(void 0,void 0,void 0,(function(){var d,p,h,f,y,v,_,g,m;return __generator(this,(function(b){switch(b.label){case 0:return ts.debug("mk: loadWithMZPlay",t.playParams),"podcast-episodes"===t.type?(t.assetURL=t.attributes.assetUrl,[2]):[4,hasMusicSubscription()];case 1:if(!b.sent())return[2];if(d=t.playParams.id,p=new Headers({Authorization:"Bearer "+n,Accept:"application/json","Content-Type":"application/json","X-Apple-Music-User-Token":""+l}),h={salableAdamId:d},t.isCloudItem&&(h={},t.playParams.purchasedId&&(h.purchaseAdamId=t.playParams.purchasedId),t.playParams.catalogId&&(h.subscriptionAdamId=t.playParams.catalogId),(f=/^a\.(\d+)$/).test(d)?h.subscriptionAdamId=d.replace(f,"$1"):ce(d)&&(h.universalLibraryId=d)),!ns.urls.webPlayback)throw new Error("bag.urls.webPlayback is not configured");return[4,fetch(ns.urls.webPlayback,{method:"POST",body:JSON.stringify(h),headers:p})];case 2:return[4,b.sent().text()];case 3:return y=b.sent(),(v=JSON.parse(y))&&v.songList?(g=__read(v.songList,1),m=g[0],t.updateFromSongList(m),[2]):(_=Fe.serverError(v),t.updateFromLoadError(_),ts.debug("mk: prepareItemWithMZPlay - rejecting with error",_),[2,Promise.reject(_)])}}))}))},prepareUTSAPIItem=function(t,n){return __awaiter(void 0,void 0,void 0,(function(){var l,p,h,f,y,v,_,g;return __generator(this,(function(m){switch(m.label){case 0:return[4,n.viewProductPersonalized({id:t.id,reload:!0})];case 1:return l=m.sent(),t.playables=null!==(_=null==l?void 0:l.playables)&&void 0!==_?_:null===(g=null==l?void 0:l.currentEpisode)||void 0===g?void 0:g.playables,t.channels=null==l?void 0:l.channels,hasPlayables(t)?(void 0!==(p=getDefaultPlayable(t))&&(t.ageGatePolicy=p.ageGatePolicy,t.playEvent=p.playEvent),0===(h=t.playables.reduce((function(t,n){return void 0!==n.assets&&t.push(n.assets),t}),[])).length?[2]:(f=__read(h,1),y=f[0],v=y.hlsUrl,ns.features.xtrick&&(v=addQueryParamsToURL(v,{xtrick:!0})),ns.features.isWeb&&(v=addQueryParamsToURL(v,{webbrowser:!0})),t.bingeWatching&&(v=addQueryParamsToURL(v,{bingeWatching:!0}),t.bingeWatching=!1),t.updateWithLoadedAssets(h,v),t.updateWithLoadedKeys({"hls-key-cert-url":y.fpsCertificateUrl,"hls-key-server-url":y.fpsKeyServerUrl,"widevine-cert-url":y.wideVineCertificateUrl},y.fpsKeyServerQueryParameters),[4,fetchHLSMetadata(t)])):[2];case 2:return m.sent(),t.state=d.ready,[2]}}))}))};function prepareToPlayMediaItem(t,n){return __awaiter(this,void 0,void 0,(function(){var l,p,h;return __generator(this,(function(f){switch(f.label){case 0:return l=t.store,p=l.developerToken,h=l.userToken,void 0===p||void 0===h?[2,Promise.reject(new Fe(Fe.AUTHORIZATION_ERROR,"Unable to prepare media item for play."))]:n.isPreparedToPlay?(ts.warn("media-item: item is prepared to play"),[2]):(ts.debug("media-item: item.prepareToPlay playParams",n.playParams),n.state=d.loading,n.isUTS?[4,prepareUTSAPIItem(n,t.utsAPI)]:[3,2]);case 1:return f.sent(),[3,4];case 2:return[4,prepareMediaAPIItem(n,p,h)];case 3:f.sent(),f.label=4;case 4:return[2]}}))}))}function shouldPlayPreview(t,n){return __awaiter(this,void 0,void 0,(function(){var l;return __generator(this,(function(d){switch(d.label){case 0:return t.previewURL?n.previewOnly?[2,!0]:t.playRawAssetURL?[2,!1]:(l=!t.isUTS)?[4,hasMusicSubscription()]:[3,2]:[2,!1];case 1:l=!d.sent(),d.label=2;case 2:return l?[2,!0]:[2,!hasAuthorization()||!supportsDrm()||!t.isPlayable]}}))}))}function prepareForEncryptedPlayback(t,n,l){return __awaiter(this,void 0,void 0,(function(){var d,p;return __generator(this,(function(h){switch(h.label){case 0:if(ts.debug("prepareForEncryptedPlayback"),!hasAuthorization())return l.destroy(),[2,Promise.reject(new Fe(Fe.AUTHORIZATION_ERROR,"Unable to prepare for playback."))];h.label=1;case 1:return h.trys.push([1,3,,4]),[4,t.store.validateAgeVerification(n)];case 2:return h.sent(),[3,4];case 3:return(d=h.sent()).errorCode===Fe.CONTENT_RESTRICTED&&n.restrict(),l.destroy(),[2,Promise.reject(d)];case 4:return h.trys.push([4,6,,14]),[4,prepareToPlayMediaItem(t,n)];case 5:return h.sent(),[3,14];case 6:return p=h.sent(),[Fe.AUTHORIZATION_ERROR].includes(p.errorCode)?[4,t.store.storekit.revokeUserToken()]:[3,8];case 7:return h.sent(),[3,13];case 8:if(p.errorCode!==Fe.TOKEN_EXPIRED)return[3,13];h.label=9;case 9:return h.trys.push([9,12,,13]),[4,t.store.storekit.renewUserToken()];case 10:return h.sent(),[4,prepareToPlayMediaItem(t,n)];case 11:return h.sent(),n.playbackData=_playbackDataForItem(n,l),[2,n];case 12:return h.sent(),[3,13];case 13:return p?(l.destroy(),[2,Promise.reject(p)]):[3,14];case 14:return n.playbackData=_playbackDataForItem(n,l),[2,n]}}))}))}function _playbackDataForItem(n,l){if(ts.debug("mk: _playbackDataForItem",n),n.isCloudUpload)return n.assets[0];if("musicVideo"!==n.type){if(!n.isLiveRadioStation&&!n.hasOffersHlsUrl)return __read(n.assets.filter((function(t){var n;if(!("flavor"in t))return!1;var d=new RegExp("\\d{1,2}\\:(c"+(l.extension.isFairplay?"bc":"tr")+"p)(\\d{2,3})","i"),p=d.test(t.flavor),h=null!==(n=t.flavor.match(d))&&void 0!==n?n:[];return p&&parseInt(h[2],0)<=l.bitrate})),1)[0];var d=n.assets.reduce((function(t,n){var l=n.bandwidth;return t[l]||(t[l]=[]),t[l].push(n),t}),{}),p=Object.keys(d).sort((function(t,n){return parseInt(t,10)-parseInt(n,10)})),h=l.bitrate===t.PlaybackBitrate.STANDARD?p[0]:p[p.length-1];n.assetURL=d[h][0].URL}}function handleAgeGate(t){return new Promise((function(n,l){var d=t.ageGatePolicy;if(!d||!d.age||!d.frequencyInMinutes)return ts.debug("No ageGatePolicy. Resolving handleAgeGate()"),n(void 0);var p=window.localStorage.ageGatePolicyAge,h=window.localStorage.ageGatePolicyExpiration;if(p&&h&&parseInt(h,10)>Date.now()&&parseInt(p,10)>=d.age)return n(void 0);Yc.clientDialog({okButtonString:"Yes",okButtonAction:function(){return localStorage.setItem("ageGatePolicyAge",d.age.toString()),localStorage.setItem("ageGatePolicyExpiration",(Date.now()+60*d.frequencyInMinutes*1e3).toString()),n(void 0)},cancelButtonString:"No",cancelButtonAction:function(){return l(new Fe("AGE_GATE","Age Gate Declined"))},explanation:"This content may not be appropriate for ages younger than "+d.age+".",message:"Are you "+d.age+" or older?"}).present()}))}var _l,gl=[Fe.AGE_VERIFICATION,Fe.CONTENT_EQUIVALENT,Fe.CONTENT_RESTRICTED,Fe.CONTENT_UNAVAILABLE,Fe.CONTENT_UNSUPPORTED,Fe.SERVER_ERROR,Fe.SUBSCRIPTION_ERROR,Fe.UNSUPPORTED_ERROR];(_l=t.PlaybackMode||(t.PlaybackMode={}))[_l.PREVIEW_ONLY=0]="PREVIEW_ONLY",_l[_l.MIXED_CONTENT=1]="MIXED_CONTENT",_l[_l.FULL_PLAYBACK_ONLY=2]="FULL_PLAYBACK_ONLY";var ml=function(){function MKInstance(n,l){if(void 0===l&&(l={}),this._autoplayEnabled=!1,this.privateEnabled=!1,this.siriInitiated=!1,this.sourceType=ut.MUSICKIT,this.version=t.version,this._bag=ns,this._playbackControllers={},this._playbackErrorDialog=!0,this._playbackMode=t.PlaybackMode.MIXED_CONTENT,this._whenConfigured=void 0,"string"!=typeof n)throw new Error("MusicKit was initialized without an developerToken.");Object.assign(ns.features,function(t){void 0===t&&(t=[]);var n={};return t.forEach((function(t){"-"===t.charAt(0)?(t=t.substr(1),n[t]=!1):n[t]=!0})),n}(l.features)),Object.assign(ns.autoplay,l.autoplay),this.context={};var d=new Je;this.capabilities=new ds(d);var p=new vl(!!ns.features["player-accurate-timing"]),h=new pl(d,l.bitrate);this._services={dispatcher:d,timing:p,bitrateCalculator:h},void 0!==l.playActivityAPI&&(this._services.playActivity=new Rs(l.playActivityAPI,d)),l.services=this._services,this._configureLogger(l),ns.app=l.app||{},ns.store=new we({filter:getFilterFromFlags(l.storeFilterTypes||[]),shouldDisableRecordReuse:!!ns.features["disable-data-store-record-reuse"]}),Object.assign(ns.urls,l.urls||{});var f=function(t,n){return xa=new ss(t,n)}(n,l);this._services.apiManager=new dl(f,d);var y=new ll(this._createPlayerControllerOptions());if(this._services.mediaItemPlayback=y,l.sourceType&&(this.sourceType=l.sourceType),this._initializeEventHandling(),l.bitrate&&(this.bitrate=l.bitrate),l.prefix&&/^(?:web|preview)$/.test(l.prefix)&&(this.prefix=ns.prefix=l.prefix),l.suppressErrorDialog&&(this._playbackErrorDialog=!l.suppressErrorDialog),void 0!==l.playbackMode&&(this.playbackMode=l.playbackMode),this.privateEnabled=l.privateEnabled||!1,this.siriInitiated=l.siriInitiated||!1,this.id=generateUUID(),ts.log("MusicKit JS Version: "+this.version),ts.debug("Link Parameters",l.linkParameters),ts.log("InstanceId",this.id),ns.app&&ts.debug("App",ns.app),l.userToken){var v=l.userToken;"function"==typeof v?xa.dynamicMusicUserToken=v:this.musicUserToken=v}}return Object.defineProperty(MKInstance.prototype,"developerToken",{get:function(){return xa.developerToken},enumerable:!0,configurable:!0}),Object.defineProperty(MKInstance.prototype,"api",{get:function(){return this._services.apiManager.api},enumerable:!0,configurable:!0}),Object.defineProperty(MKInstance.prototype,"audioTracks",{get:function(){return this._mediaItemPlayback.audioTracks},enumerable:!0,configurable:!0}),Object.defineProperty(MKInstance.prototype,"authorizationStatus",{get:function(){return xa.authorizationStatus},enumerable:!0,configurable:!0}),Object.defineProperty(MKInstance.prototype,"bitrate",{get:function(){return this._services.bitrateCalculator.bitrate},set:function(t){this._services.bitrateCalculator.bitrate=t},enumerable:!0,configurable:!0}),Object.defineProperty(MKInstance.prototype,"browserSupportsPictureInPicture",{get:function(){return function(){if(pe)return Le.warn("dom-helpers: Browser checks are not supported in Node environments"),!1;var t=wo,n=t&&t.webkitSupportsPresentationMode&&"function"==typeof t.webkitSetPresentationMode,l=document.pictureInPictureEnabled;return!(!n&&!l)}()},enumerable:!0,configurable:!0}),Object.defineProperty(MKInstance.prototype,"browserSupportsVideoDrm",{get:function(){return supportsDrm()},enumerable:!0,configurable:!0}),Object.defineProperty(MKInstance.prototype,"cid",{get:function(){return(2===this.realm||this.sourceType!==ut.MUSICKIT)&&xa.cid},enumerable:!0,configurable:!0}),Object.defineProperty(MKInstance.prototype,"continuous",{get:function(){return this._playbackController.continuous},set:function(t){this._playbackController.continuous=t},enumerable:!0,configurable:!0}),Object.defineProperty(MKInstance.prototype,"autoplayEnabled",{get:function(){return this._autoplayEnabled},set:function(t){0!==this.realm&&(t=!1),t!==this.autoplayEnabled&&(this._autoplayEnabled=t,this._services.dispatcher.publish(An.autoplayEnabledDidChange,this.autoplayEnabled))},enumerable:!0,configurable:!0}),Object.defineProperty(MKInstance.prototype,"currentAudioTrack",{get:function(){return this._mediaItemPlayback.currentAudioTrack},set:function(t){this._mediaItemPlayback.currentAudioTrack=t},enumerable:!0,configurable:!0}),Object.defineProperty(MKInstance.prototype,"currentPlaybackDuration",{get:function(){return this._mediaItemPlayback.currentPlaybackDuration},enumerable:!0,configurable:!0}),Object.defineProperty(MKInstance.prototype,"currentPlaybackProgress",{get:function(){return this._mediaItemPlayback.currentPlaybackProgress},enumerable:!0,configurable:!0}),Object.defineProperty(MKInstance.prototype,"currentPlaybackTime",{get:function(){return this._mediaItemPlayback.currentPlaybackTime},enumerable:!0,configurable:!0}),Object.defineProperty(MKInstance.prototype,"currentPlaybackTimeRemaining",{get:function(){return this._mediaItemPlayback.currentPlaybackTimeRemaining},enumerable:!0,configurable:!0}),Object.defineProperty(MKInstance.prototype,"currentTextTrack",{get:function(){return this._mediaItemPlayback.currentTextTrack},set:function(t){this._mediaItemPlayback.currentTextTrack=t},enumerable:!0,configurable:!0}),Object.defineProperty(MKInstance.prototype,"isAuthorized",{get:function(){return xa.isAuthorized},enumerable:!0,configurable:!0}),Object.defineProperty(MKInstance.prototype,"isPlaying",{get:function(){return this._playbackController.isPlaying},enumerable:!0,configurable:!0}),Object.defineProperty(MKInstance.prototype,"isRestricted",{get:function(){return xa.isRestricted},enumerable:!0,configurable:!0}),Object.defineProperty(MKInstance.prototype,"metricsClientId",{get:function(){return xa.metricsClientId},set:function(t){xa.metricsClientId=t},enumerable:!0,configurable:!0}),Object.defineProperty(MKInstance.prototype,"musicUserToken",{get:function(){return xa.musicUserToken},set:function(t){t&&xa.musicUserToken===t||(xa.musicUserToken=t)},enumerable:!0,configurable:!0}),Object.defineProperty(MKInstance.prototype,"needsGDPR",{get:function(){return xa.needsGDPR},enumerable:!0,configurable:!0}),Object.defineProperty(MKInstance.prototype,"nowPlayingItem",{get:function(){return this._mediaItemPlayback.nowPlayingItem},enumerable:!0,configurable:!0}),Object.defineProperty(MKInstance.prototype,"nowPlayingItemIndex",{get:function(){return this._playbackController.nowPlayingItemIndex},enumerable:!0,configurable:!0}),Object.defineProperty(MKInstance.prototype,"playbackMode",{get:function(){return this._playbackMode},set:function(n){if(-1!==Object.values(t.PlaybackMode).indexOf(n)){this._playbackMode=n;var l=n===t.PlaybackMode.PREVIEW_ONLY,d=this._services.mediaItemPlayback;d&&(d.previewOnly=l)}},enumerable:!0,configurable:!0}),Object.defineProperty(MKInstance.prototype,"playbackRate",{get:function(){return this._mediaItemPlayback.playbackRate},set:function(t){this._mediaItemPlayback.playbackRate=t},enumerable:!0,configurable:!0}),Object.defineProperty(MKInstance.prototype,"playbackState",{get:function(){return this._mediaItemPlayback.playbackState},enumerable:!0,configurable:!0}),Object.defineProperty(MKInstance.prototype,"playbackTargetAvailable",{get:function(){return this._mediaItemPlayback.playbackTargetAvailable},enumerable:!0,configurable:!0}),Object.defineProperty(MKInstance.prototype,"playbackTargetIsWireless",{get:function(){return this._mediaItemPlayback.playbackTargetIsWireless},enumerable:!0,configurable:!0}),Object.defineProperty(MKInstance.prototype,"previewOnly",{get:function(){return this.playbackMode===t.PlaybackMode.PREVIEW_ONLY},set:function(n){this.playbackMode=n?t.PlaybackMode.PREVIEW_ONLY:t.PlaybackMode.MIXED_CONTENT},enumerable:!0,configurable:!0}),Object.defineProperty(MKInstance.prototype,"queue",{get:function(){return this._playbackController.queue},enumerable:!0,configurable:!0}),Object.defineProperty(MKInstance.prototype,"queueIsEmpty",{get:function(){return this._playbackController.queue.isEmpty},enumerable:!0,configurable:!0}),Object.defineProperty(MKInstance.prototype,"realm",{get:function(){return xa.realm},enumerable:!0,configurable:!0}),Object.defineProperty(MKInstance.prototype,"repeatMode",{get:function(){return this._playbackController.repeatMode},set:function(t){this._playbackController.repeatMode=t},enumerable:!0,configurable:!0}),Object.defineProperty(MKInstance.prototype,"requestUserToken",{set:function(t){xa.requestUserToken=t},enumerable:!0,configurable:!0}),Object.defineProperty(MKInstance.prototype,"restrictedEnabled",{get:function(){return xa.restrictedEnabled},enumerable:!0,configurable:!0}),Object.defineProperty(MKInstance.prototype,"seekSeconds",{get:function(){return this._playbackController.seekSeconds},enumerable:!0,configurable:!0}),Object.defineProperty(MKInstance.prototype,"services",{get:function(){return this._services},enumerable:!0,configurable:!0}),Object.defineProperty(MKInstance.prototype,"shuffle",{set:function(t){this._playbackController.shuffle=t},enumerable:!0,configurable:!0}),Object.defineProperty(MKInstance.prototype,"shuffleMode",{get:function(){return this._playbackController.shuffleMode},set:function(t){this._playbackController.shuffleMode=t},enumerable:!0,configurable:!0}),Object.defineProperty(MKInstance.prototype,"storefrontCountryCode",{get:function(){return xa.storefrontCountryCode},enumerable:!0,configurable:!0}),Object.defineProperty(MKInstance.prototype,"subscribeURL",{get:function(){return xa.subscribeURL},enumerable:!0,configurable:!0}),Object.defineProperty(MKInstance.prototype,"subscribeFamilyURL",{get:function(){return xa.subscribeFamilyURL},enumerable:!0,configurable:!0}),Object.defineProperty(MKInstance.prototype,"subscribeIndividualURL",{get:function(){return xa.subscribeIndividualURL},enumerable:!0,configurable:!0}),Object.defineProperty(MKInstance.prototype,"subscribeStudentURL",{get:function(){return xa.subscribeStudentURL},enumerable:!0,configurable:!0}),Object.defineProperty(MKInstance.prototype,"textTracks",{get:function(){return this._mediaItemPlayback.textTracks},enumerable:!0,configurable:!0}),Object.defineProperty(MKInstance.prototype,"videoContainerElement",{get:function(){return this.context.videoContainerElement},set:function(t){this.context.videoContainerElement=t},enumerable:!0,configurable:!0}),Object.defineProperty(MKInstance.prototype,"volume",{get:function(){return this._mediaItemPlayback.volume},set:function(t){this._mediaItemPlayback.volume=t},enumerable:!0,configurable:!0}),Object.defineProperty(MKInstance.prototype,"storefrontId",{get:function(){return xa.storefrontId},set:function(t){xa.storefrontId=t},enumerable:!0,configurable:!0}),Object.defineProperty(MKInstance.prototype,"_mediaItemPlayback",{get:function(){return this._services.mediaItemPlayback},enumerable:!0,configurable:!0}),Object.defineProperty(MKInstance.prototype,"_playbackController",{get:function(){if(void 0!==this._playbackControllerInternal)return this._playbackControllerInternal;ts.debug("setting _playbackController");var t=this._getPlaybackControllerByType(_c.serial);return this._playbackController=t,t},set:function(t){this._playbackControllerInternal=t,this._playbackControllerInternal.autoplayEnabled=this._autoplayEnabled,this._playbackControllerInternal.activate(),this.capabilities.updateChecker(this._playbackControllerInternal.hasCapabilities),this.capabilities.controller=this._playbackControllerInternal},enumerable:!0,configurable:!0}),MKInstance.prototype.addEventListener=function(t,n,l){void 0===l&&(l={}),adaptAddEventListener(this._services.dispatcher,t,n,l)},MKInstance.prototype.authorize=function(){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(t){return this.deferPlayback(),[2,xa.authorize()]}))}))},MKInstance.prototype.canAuthorize=function(){return supportsDrm()&&!this.isAuthorized},MKInstance.prototype.canUnauthorize=function(){return supportsDrm()&&this.isAuthorized},MKInstance.prototype.changeToMediaAtIndex=function(t){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(n){switch(n.label){case 0:return this._isPlaybackSupported()?[4,this._validateAuthorization()]:[2];case 1:return n.sent(),this._signalChangeItemIntent(),[4,this._playbackController.changeToMediaAtIndex(t)];case 2:return n.sent(),[2]}}))}))},MKInstance.prototype.changeToMediaItem=function(t){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(n){switch(n.label){case 0:return ts.debug("instance.changeToMediaItem",t),this._isPlaybackSupported()?[4,this._validateAuthorization()]:[2];case 1:return n.sent(),this._signalChangeItemIntent(),[4,this._playbackController.changeToMediaItem(t)];case 2:return n.sent(),[2]}}))}))},MKInstance.prototype.changeUserStorefront=function(t){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(n){return this.storefrontId=t,[2]}))}))},MKInstance.prototype.cleanup=function(){var t;return __awaiter(this,void 0,void 0,(function(){var n,l,d=this;return __generator(this,(function(p){switch(p.label){case 0:null===(t=this._services.mediaItemPlayback)||void 0===t||t.destroy(),this._signalIntent({endReasonType:He.EXITED_APPLICATION}),n=Object.keys(this._playbackControllers).map((function(t){return d._playbackControllers[t].destroy()})),p.label=1;case 1:return p.trys.push([1,3,,4]),[4,Promise.all(n)];case 2:return p.sent(),[3,4];case 3:return l=p.sent(),ts.error("Error cleaning up controller",l),[3,4];case 4:return this._services.dispatcher.clear(),[2]}}))}))},MKInstance.prototype.configure=function(t){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(n){return this._whenConfigured=this._configure(t),[2,this._whenConfigured]}))}))},MKInstance.prototype._configure=function(t){return __awaiter(this,void 0,void 0,(function(){var n;return __generator(this,(function(l){switch(l.label){case 0:return[4,xa.storekit.whenAuthCompleted];case 1:return l.sent(),n=t.map(this._services.apiManager.registerAPIService,this._services.apiManager),[4,Promise.all(n)];case 2:return l.sent(),[4,this._configurePlayActivity()];case 3:return l.sent(),[2]}}))}))},MKInstance.prototype.deferPlayback=function(){ts.debug("deferPlayback",this._playbackControllerInternal),deferPlayback()},MKInstance.prototype.getApiByType=function(t){var n;return null===(n=this._services.apiManager)||void 0===n?void 0:n.getApiByType(t)},MKInstance.prototype.me=function(){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(t){switch(t.label){case 0:return t.trys.push([0,2,,3]),[4,xa.storekit.me()];case 1:return[2,t.sent()];case 2:return t.sent(),[2,Promise.reject(new Fe(Fe.AUTHORIZATION_ERROR,"Unauthorized"))];case 3:return[2]}}))}))},MKInstance.prototype.musicSubcriptionOffers=function(){return xa.storekit.musicSubscriptionOffers(this.storefrontId)},MKInstance.prototype.hasMusicSubscription=function(){return hasMusicSubscription(xa.storekit)},MKInstance.prototype.mute=function(){return this._mediaItemPlayback.mute()},MKInstance.prototype.pause=function(t){return __awaiter(this,void 0,void 0,(function(){var n;return __generator(this,(function(l){switch(l.label){case 0:if(!this._isPlaybackSupported())return[2];l.label=1;case 1:return l.trys.push([1,3,,4]),this._signalIntent({endReasonType:He.PLAYBACK_MANUALLY_PAUSED}),[4,this._playbackController.pause(t)];case 2:return l.sent(),[3,4];case 3:return n=l.sent(),this._handlePlaybackError(n),[3,4];case 4:return[2,Promise.resolve()]}}))}))},MKInstance.prototype.play=function(){return __awaiter(this,void 0,void 0,(function(){var t;return __generator(this,(function(n){switch(n.label){case 0:return ts.debug("instance.play()"),this._isPlaybackSupported()?[4,this._validateAuthorization()]:[2];case 1:n.sent(),n.label=2;case 2:return n.trys.push([2,4,,5]),[4,this._playbackController.play()];case 3:return n.sent(),[3,5];case 4:return t=n.sent(),this._handlePlaybackError(t),[3,5];case 5:return[2,Promise.resolve()]}}))}))},MKInstance.prototype.playMediaItem=function(t){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(n){return ts.debug("mk: playMediaItem",t),this.deferPlayback(),[2,this._playbackController.playSingleMediaItem(t)]}))}))},MKInstance.prototype.playNext=function(t,n){return void 0===n&&(n=!1),__awaiter(this,void 0,void 0,(function(){return __generator(this,(function(l){return this._isPlaybackSupported()?this._playbackController.queue?(this.deferPlayback(),[2,this._playbackController.prepend(t,n)]):[2,this.setQueue(t)]:[2]}))}))},MKInstance.prototype.playLater=function(t){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(n){return this._isPlaybackSupported()?this._playbackController.queue?(this.deferPlayback(),[2,this._playbackController.append(t)]):[2,this.setQueue(t)]:[2]}))}))},MKInstance.prototype.clearQueue=function(){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(t){return[2,this._playbackController.clear()]}))}))},MKInstance.prototype.removeEventListener=function(t,n){!function(t,n,l){for(var d,p=getCallbacksForName(n),h=p.length-1;h>=0;h--){var f=__read(p[h],2),y=f[0],v=f[1];if(y===l){d=v,p.splice(h,1);break}}d&&t.unsubscribe(n,d)}(this._services.dispatcher,t,n)},MKInstance.prototype.shouldDisplayPrivacyLink=function(t){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(n){return[2,xa.shouldDisplayPrivacyLink(t)]}))}))},MKInstance.prototype.exitFullscreen=function(){return this._mediaItemPlayback.exitFullscreen()},MKInstance.prototype.requestFullscreen=function(t){return this._mediaItemPlayback.requestFullscreen(t)},MKInstance.prototype.getNewSeeker=function(){return this._playbackController.getNewSeeker()},MKInstance.prototype.seekToTime=function(n,l){return void 0===l&&(l=t.SeekReasonType.Manual),__awaiter(this,void 0,void 0,(function(){var t;return __generator(this,(function(d){switch(d.label){case 0:return this._isPlaybackSupported()?[4,this._validateAuthorization()]:[2];case 1:d.sent(),d.label=2;case 2:return d.trys.push([2,4,,5]),[4,this._playbackController.seekToTime(n,l)];case 3:return d.sent(),[3,5];case 4:return t=d.sent(),this._handlePlaybackError(t),[3,5];case 5:return[2,Promise.resolve()]}}))}))},MKInstance.prototype.setQueue=function(t){return __awaiter(this,void 0,void 0,(function(){var n;return __generator(this,(function(l){switch(l.label){case 0:return ts.debug("instance.setQueue()",t),this._isPlaybackSupported()?this._isStationQueueOptions(t)?(ts.warn("setQueue options contained a station queue request. Changing to setStationQueue mode."),[2,this.setStationQueue(t)]):(this._signalChangeItemIntent(),this.deferPlayback(),[4,this._updatePlaybackController(this._getPlaybackControllerByType(_c.serial))]):(ts.warn("Playback is not supported"),[2]);case 1:return l.sent(),[4,this._playbackController.setQueue(t)];case 2:return n=l.sent(),void 0!==t.repeatMode&&(this._playbackController.repeatMode=t.repeatMode),void 0!==t.autoplay&&(logDeprecation("autoplay",{message:"autoplay has been deprecated, use startPlaying instead"}),void 0===t.startPlaying&&(t.startPlaying=t.autoplay)),t.startPlaying?[4,this.play()]:[3,4];case 3:l.sent(),l.label=4;case 4:return[2,n]}}))}))},MKInstance.prototype.setStationQueue=function(t){return __awaiter(this,void 0,void 0,(function(){var n;return __generator(this,(function(l){switch(l.label){case 0:return this._isPlaybackSupported()?[4,this._validateAuthorization(!0)]:[2];case 1:return l.sent(),this._signalChangeItemIntent(),this.deferPlayback(),parseQueueURLOption(t),[4,this._updatePlaybackController(this._getPlaybackControllerByType(_c.continuous))];case 2:return l.sent(),n=this._playbackController.setQueue(t),void 0!==t.autoplay&&(logDeprecation("autoplay",{message:"autoplay has been deprecated, use startPlaying instead"}),void 0===t.startPlaying&&(t.startPlaying=t.autoplay)),t.startPlaying?[4,this.play()]:[3,4];case 3:l.sent(),l.label=4;case 4:return[2,n]}}))}))},MKInstance.prototype.setPresentationMode=function(t){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(n){return[2,this._mediaItemPlayback.setPresentationMode(t)]}))}))},MKInstance.prototype.skipToNextItem=function(){return __awaiter(this,void 0,void 0,(function(){var t;return __generator(this,(function(n){switch(n.label){case 0:return this._isPlaybackSupported()?[4,this._validateAuthorization()]:[2];case 1:n.sent(),this._signalIntent({endReasonType:He.TRACK_SKIPPED_FORWARDS,direction:He.TRACK_SKIPPED_FORWARDS}),n.label=2;case 2:return n.trys.push([2,4,,5]),[4,this._playbackController.skipToNextItem()];case 3:return n.sent(),[3,5];case 4:return t=n.sent(),this._handlePlaybackError(t),[3,5];case 5:return[2]}}))}))},MKInstance.prototype.skipToPreviousItem=function(){return __awaiter(this,void 0,void 0,(function(){var t;return __generator(this,(function(n){switch(n.label){case 0:return this._isPlaybackSupported()?[4,this._validateAuthorization()]:[2];case 1:n.sent(),this._signalIntent({endReasonType:He.TRACK_SKIPPED_BACKWARDS,direction:He.TRACK_SKIPPED_BACKWARDS}),n.label=2;case 2:return n.trys.push([2,4,,5]),[4,this._playbackController.skipToPreviousItem()];case 3:return n.sent(),[3,5];case 4:return t=n.sent(),this._handlePlaybackError(t),[3,5];case 5:return[2]}}))}))},MKInstance.prototype.seekForward=function(){return __awaiter(this,void 0,void 0,(function(){var t;return __generator(this,(function(n){switch(n.label){case 0:return this._isPlaybackSupported()?[4,this._validateAuthorization()]:[2];case 1:n.sent(),n.label=2;case 2:return n.trys.push([2,4,,5]),this._signalIntent({endReasonType:He.TRACK_SKIPPED_FORWARDS,direction:He.TRACK_SKIPPED_FORWARDS}),[4,this._playbackController.seekForward()];case 3:return n.sent(),[3,5];case 4:return t=n.sent(),this._handlePlaybackError(t),[3,5];case 5:return[2]}}))}))},MKInstance.prototype.seekBackward=function(){return __awaiter(this,void 0,void 0,(function(){var t;return __generator(this,(function(n){switch(n.label){case 0:return this._isPlaybackSupported()?[4,this._validateAuthorization()]:[2];case 1:n.sent(),n.label=2;case 2:return n.trys.push([2,4,,5]),[4,this._playbackController.seekBackward()];case 3:return n.sent(),[3,5];case 4:return t=n.sent(),this._handlePlaybackError(t),[3,5];case 5:return[2]}}))}))},MKInstance.prototype.showPlaybackTargetPicker=function(){this._playbackController.showPlaybackTargetPicker()},MKInstance.prototype.stop=function(t){var n;return __awaiter(this,void 0,void 0,(function(){var l;return __generator(this,(function(d){switch(d.label){case 0:if(!this._isPlaybackSupported())return[2];this._signalIntent({endReasonType:null==t?void 0:t.endReasonType,userInitiated:null===(n=null==t?void 0:t.userInitiated)||void 0===n||n}),d.label=1;case 1:return d.trys.push([1,3,,4]),[4,this._playbackController.stop(t)];case 2:return d.sent(),[3,4];case 3:return l=d.sent(),this._handlePlaybackError(l),[3,4];case 4:return[2]}}))}))},MKInstance.prototype.resetSubscribeViewEligibility=function(){xa.storekit.resetSubscribeViewEligibility()},MKInstance.prototype.unauthorize=function(){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(t){return[2,xa.unauthorize()]}))}))},MKInstance.prototype.unmute=function(){return this._mediaItemPlayback.unmute()},MKInstance.prototype._createPlayerControllerOptions=function(){var n=this;return{tokens:xa,bag:ns,playbackServices:{getRTCStreamingTracker:function(){var t;return null===(t=n._services.playActivity)||void 0===t?void 0:t.getTrackerByType(yl)},hasMusicSubscription:hasMusicSubscription,playMediaItem:function(l,d,p,h){return function(n,l,d,p,h){return __awaiter(this,void 0,void 0,(function(){var f,y,v,_,g,m;return __generator(this,(function(b){switch(b.label){case 0:return f=d.isPaused()&&!p,ts.debug("playMediaItem",l,f),[4,shouldPlayPreview(l,d)];case 1:return y=b.sent(),ts.debug("mk: shouldPreview",y),y?(supportsDrm()||d.dispatch(An.drmUnsupported,{item:l}),l.playbackType=t.PlaybackType.preview,d.nowPlayingItem=l,[4,d.playItemFromUnencryptedSource(l.previewURL,f)]):[3,3];case 2:return b.sent(),[2,l];case 3:return function(t){return!(!t.playRawAssetURL||!t.attributes.assetUrl)}(l)?(ts.debug("shouldPlayRawAsset",l),l.playbackType=t.PlaybackType.unencryptedFull,d.nowPlayingItem=l,[4,d.playItemFromUnencryptedSource(l.attributes.assetUrl,f,h)]):[3,5];case 4:return b.sent(),[2,l];case 5:if(!isBroadcastRadio(l))return[3,8];if(!ns.features["broadcast-radio"])throw(v=new Fe(Fe.CONTENT_UNAVAILABLE)).data=l,v;return[4,loadLiveRadioAssets(l,n.store.developerToken,n.store.userToken)];case 6:return _=b.sent(),g=_.assets[0],l.playbackType=t.PlaybackType.unencryptedFull,l.trackInfo=_["track-info"],d.nowPlayingItem=l,[4,d.playItemFromUnencryptedSource(g.url,f)];case 7:return b.sent(),[2,l];case 8:if(!l||!l.isPlayable)return[2,Promise.reject(new Fe(Fe.MEDIA_PLAYBACK,"Not Playable"))];b.label=9;case 9:return b.trys.push([9,11,,12]),[4,prepareForEncryptedPlayback(n,l,d)];case 10:return b.sent(),[3,12];case 11:return m=b.sent(),ts.error("prepareForEncryptedPlayback Error: userInitiated "+p),p?[2,Promise.reject(m)]:(d.dispatch(An.mediaPlaybackError,m),[2]);case 12:return[4,handleAgeGate(l)];case 13:return b.sent(),ts.debug("About to play item as encrypted",l),[4,d.playItemFromEncryptedSource(l,p,h)];case 14:return b.sent(),[2,l]}}))}))}(n._services.apiManager,l,d,p,h)},prepareForEncryptedPlayback:function(t,l){return prepareForEncryptedPlayback(n._services.apiManager,t,l)},requiresHlsJs:requiresHlsJs},services:this._services,context:this.context,autoplayEnabled:this.autoplayEnabled,privateEnabled:this.privateEnabled,siriInitiated:this.siriInitiated,storekit:null==xa?void 0:xa.storekit}},MKInstance.prototype._getPlaybackControllerByType=function(t){var n,l=this._playbackControllers[t];if(l)return l;switch(t){case _c.serial:n=new $c(this._createPlayerControllerOptions());break;case _c.continuous:n=new xc(this._createPlayerControllerOptions());break;default:throw new Fe(Fe.UNSUPPORTED_ERROR,"Unsupported controller requested: "+t)}return this._playbackControllers[t]=n,n},MKInstance.prototype._handlePlaybackError=function(t){if(ts.error("mediaPlaybackError",t),gl.includes(t.name))throw t;this._playbackErrorDialog&&!pe&&Yc.presentError(t)},MKInstance.prototype._initializeEventHandling=function(){var n=this;[An.authorizationStatusDidChange,An.needsGDPRDidChange,An.storefrontCountryCodeDidChange,An.storefrontIdentifierDidChange,An.userTokenDidChange,An.eligibleForSubscribeView].forEach((function(t){xa.storekit.addEventListener(t,(function(l){return n._services.dispatcher.publish(t,l)}))})),xa.storekit.addEventListener(An.userTokenDidChange,(function(){n._whenConfigured&&n._whenConfigured.then((function(){n._configurePlayActivity().catch()})).catch()}));var l=this._services.dispatcher;l.subscribe(An.mediaPlaybackError,(function(t,l){return n._handlePlaybackError(l)})),l.subscribe(An.playbackStateDidChange,(function(l,d){d.state===t.PlaybackStates.paused&&(ts.debug("mk: playbackStateDidChange callback - calling storekit.presentSubscribeViewForEligibleUsers"),xa.storekit.presentSubscribeViewForEligibleUsers({state:d.state,item:n.nowPlayingItem},!1))}));var d=Qe[this.storefrontId.toUpperCase()],p=_e[d];l.subscribe(En,(function(t,n){n.resolveAdamIdFromStorefront(p),l.publish(An.timedMetadataDidChange,n)}))},MKInstance.prototype._configureLogger=function(t){t.debug&&(ts.enabled=!0,ts.level=parseInt(t.logLevel,10)||1)},MKInstance.prototype._configurePlayActivity=function(){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(t){switch(t.label){case 0:return void 0===this._services.playActivity?[2]:[4,this._services.playActivity.configure(this,{services:this._services})];case 1:return t.sent(),[2]}}))}))},MKInstance.prototype._isPlaybackSupported=function(){return!pe||(ts.warn("Media playback is not supported in Node environments."),!1)},MKInstance.prototype._isStationQueueOptions=function(t){return parseQueueURLOption(t),!(!function(t){return!!t&&(!!isLiveQueue(t)||(!!isQueueURLOption(t)||Object.keys(Cc).some((function(n){return void 0!==t[n]}))))}(t)||function(t){return!!t&&(!!isQueueURLOption(t)||(!!isQueueItems(t)||Object.keys(jc).concat(Object.keys(Fc)).some((function(n){return void 0!==t[n]}))))}(t))},MKInstance.prototype._updatePlaybackController=function(t){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(n){switch(n.label){case 0:return ts.debug("mk: _updatePlaybackController",t),this._playbackControllerInternal===t?[2]:this._playbackControllerInternal?[4,this._playbackControllerInternal.deactivate()]:[3,2];case 1:n.sent(),n.label=2;case 2:return this._playbackController=t,[2]}}))}))},MKInstance.prototype._signalChangeItemIntent=function(){this._signalIntent({endReasonType:He.MANUALLY_SELECTED_PLAYBACK_OF_A_DIFF_ITEM})},MKInstance.prototype._signalIntent=function(t){this.services.dispatcher.publish(Ve.userActivityIntent,__assign({userInitiated:!0},t))},MKInstance.prototype._validateAuthorization=function(n){return void 0===n&&(n=!1),__awaiter(this,void 0,void 0,(function(){return __generator(this,(function(l){switch(l.label){case 0:return n||this.playbackMode===t.PlaybackMode.FULL_PLAYBACK_ONLY?void 0!==this._playbackControllerInternal&&this._playbackControllerInternal.isReady?[3,2]:[4,this.authorize()]:[2];case 1:l.sent(),l.label=2;case 2:return[2]}}))}))},__decorate([AsyncDebounce(250,{isImmediate:!0,cancelledValue:void 0}),__metadata("design:type",Function),__metadata("design:paramtypes",[Object]),__metadata("design:returntype",Promise)],MKInstance.prototype,"pause",null),__decorate([AsyncDebounce(250,{isImmediate:!0,cancelledValue:void 0}),__metadata("design:type",Function),__metadata("design:paramtypes",[]),__metadata("design:returntype",Promise)],MKInstance.prototype,"play",null),__decorate([SerialAsync("skip"),__metadata("design:type",Function),__metadata("design:paramtypes",[]),__metadata("design:returntype",Promise)],MKInstance.prototype,"skipToNextItem",null),__decorate([SerialAsync("skip"),__metadata("design:type",Function),__metadata("design:paramtypes",[]),__metadata("design:returntype",Promise)],MKInstance.prototype,"skipToPreviousItem",null),MKInstance}(),bl="undefined"!=typeof window&&"undefined"!=typeof document,Pl=!1,Tl=[];function cleanupInstances(){return __awaiter(this,void 0,void 0,(function(){var t;return __generator(this,(function(n){switch(n.label){case 0:return t=Tl.map((function(t){return t.cleanup()})),[4,Promise.all(t)];case 1:return n.sent(),Tl.splice(0,Tl.length),[2]}}))}))}function dispatchDocumentEvent(t){if(!pe){var n=document.createEvent("Event");n.initEvent(t,!0,!0),setTimeout((function(){return document.dispatchEvent(n)}))}}function configure$1(t,n,l){return void 0===n&&(n=ml),__awaiter(this,void 0,void 0,(function(){var d,p,h,f;return __generator(this,(function(y){switch(y.label){case 0:if(!t)throw new Fe(Fe.INVALID_ARGUMENTS,"configuration required");if(d={},p=t.developerToken,h=t.mergeQueryParams,!p)throw new Fe(Fe.CONFIGURATION_ERROR,"Missing developer token");return h&&bl&&window.location&&(d.linkParameters=__assign(__assign({},t.linkParameters||{}),parseQueryParams(window.location.href))),[4,findKeySystemPreference()];case 1:return y.sent(),f=new n(p,__assign(__assign({},t),d)),Pl?[3,3]:[4,cleanupInstances()];case 2:y.sent(),y.label=3;case 3:return l?[4,l(f)]:[3,5];case 4:y.sent(),y.label=5;case 5:return Tl.push(f),dispatchDocumentEvent(An.configured),[2,f]}}))}))}function transformParameters(t,n){if(void 0===n&&(n=25),t)return t.limit&&(t.limit=t.limit>n?n:t.limit),t}function transformStoreData(t){var n=Object.assign({},t),l=n.href;return void 0!==l&&(delete n.href,n.attributes=gs(gs({},n.attributes),{href:l})),n}bl&&dispatchDocumentEvent(An.loaded);function transformTrackParameters(t){return t.map((function(t){return"string"==typeof t?{id:t,type:"songs"}:{id:t.id,type:t.type||"songs"}}))}function transformDescriptorsToIdMap(t){var n,l,d={};if(!t)return d;try{for(var p=function(t){var n="function"==typeof Symbol&&t[Symbol.iterator],l=0;return n?n.call(t):{next:function(){return t&&l>=t.length&&(t=void 0),{value:t&&t[l++],done:!t}}}}(t),h=p.next();!h.done;h=p.next()){var f=h.value;if(f){var y=f.type,v=f.id;y in d||(d[y]=[]),d[y].push(v)}}}catch(_){n={error:_}}finally{try{h&&!h.done&&(l=p.return)&&l.call(p)}finally{if(n)throw n.error}}return d}var Sl=["extend","include","l","platform","views"],kl=function(){function LocalDataStore(t){void 0===t&&(t={}),this.enableDataStore=!1;var n=!1;t.features&&t.features.hasOwnProperty("api-data-store")&&(this.enableDataStore=!!t.features["api-data-store"]),t.features&&t.features.hasOwnProperty("disable-data-store-record-reuse")&&(n=!!t.features["disable-data-store-record-reuse"]),this.enableDataStore&&(this._store=t.store||new we({shouldDisableRecordReuse:n}),this._store.mapping=transformStoreData)}return Object.defineProperty(LocalDataStore.prototype,"hasDataStore",{get:function(){return this.enableDataStore&&void 0!==this._store},enumerable:!0,configurable:!0}),LocalDataStore.prototype.delete=function(t,n){this.hasDataStore&&this._store.remove(t,n)},LocalDataStore.prototype.read=function(t,n,l,d){d||"function"!=typeof l||(d=l,l=void 0);var p={},h=!1;if(l&&(h=Object.keys(l).some((function(t){return/^(fields|extend)/.test(t)})),l.views&&(p.views=l.views),l.include&&(p.relationships=l.include)),this.hasDataStore&&!h){var f=[];l&&(f=Object.keys(l).reduce((function(t,n){return-1===Sl.indexOf(n)&&t.push([n,l[n]]),t}),f));var y=void 0;if(y=f&&1===f.length?this._store.query(f[0][0],f[0][1]):this._store.peek(t,n,p),Array.isArray(y)){if(!l&&y.length)return y}else if(y)return y}if("function"==typeof d)return d()},LocalDataStore.prototype.write=function(t){var n=this;return this._prepareDataForDataStore(t,(function(t){return n._store.save(t)}))},LocalDataStore.prototype.parse=function(t){var n=this;return this._prepareDataForDataStore(t,(function(t){return n._store.populateDataRecords(t,{})}))},LocalDataStore.prototype._prepareDataForDataStore=function(t,n){return this.hasDataStore?Array.isArray(t)?n({data:t}):Object.keys(t).reduce((function(l,d){var p=t[d];return p.hasOwnProperty("data")&&(l[d]=n({data:p.data})),"meta"===d&&(l[d]=t[d]),l}),{}):t},LocalDataStore}(),ChunkedIdApi=function(t,n,l){return void 0===n&&(n=100),void 0===l&&(l=1e3),function(d,p,h){if(void 0===h||"function"!=typeof h.value)throw new TypeError("Only methods can be decorated with @ChunkedIdApi, but "+p+" is not a method.");return{configurable:!0,get:function(){var d=h.value;function chunkedIdApi(){for(var p=[],h=0;h<arguments.length;h++)p[h]=arguments[h];return __awaiter$4(this,void 0,void 0,(function(){var h,f,y,v,_,g,m,b,P,T,S,k,A,I;return __generator$4(this,(function(E){switch(E.label){case 0:if(!(h=p[t])||!Array.isArray(h))return[3,2];if(f=h[0].length||20,y=Math.min(n,Math.floor(l/f)),!((v=Math.ceil(h.length/y))>1))return[3,2];for(_=p.slice(0,t),g=p.slice(t+1),m=[],b=0,P=1;P<=v;P++)T=Math.min(P*y,h.length),S=h.slice(b,T),k=__spread$4(_,[S],g),m.push(d.apply(this,k)),b+=y;return[4,Promise.all(m)];case 1:return A=E.sent(),[2,(I=[]).concat.apply(I,A)];case 2:return[2,d.apply(this,p)]}}))}))}return Object.defineProperty(this,p,{value:chunkedIdApi,configurable:!0,writable:!0}),chunkedIdApi}}}},formatTimezoneOffset=function(t){void 0===t&&(t=new Date);var n=t.getTimezoneOffset(),l=Math.floor(Math.abs(n)/60),d=Math.round(Math.abs(n)%60),p="+";return 0!==n&&(p=n>0?"-":"+"),""+p+leadingZeros(l,2)+":"+leadingZeros(d,2)},leadingZeros=function(t,n){void 0===n&&(n=2);for(var l=""+t;l.length<n;)l="0"+l;return l};function makeAlbumKey(t){var n;return(null===(n=t.artwork)||void 0===n?void 0:n.url)+"ï£¿"+t.artistName+"ï£¿"+t.name}var Al,Il,El=function(){function ServerLedger(t,n,l){this._data=this._initData(),this._catalogApi=n,this._storageKey="ï£¿ï£¿mk-server-ledger:"+(t||""),this._sessionStorage=l||("undefined"!=typeof sessionStorage?sessionStorage:void 0),this.load()}return ServerLedger.prototype._initData=function(){return{lastTimestamp:0,albums:{added:Object.create(null),removed:Object.create(null)},playlists:{added:Object.create(null),removed:Object.create(null)}}},ServerLedger.prototype._checkTimestamp=function(){var t=this._data.lastTimestamp;t&&t+24e5<Date.now()&&(this._data=this._initData(),this._sessionStorage&&this._sessionStorage.removeItem(this._storageKey))},ServerLedger.prototype.added=function(t){var n=this;this.load();var l=null==t?void 0:t.playlists,d=null==t?void 0:t.albums;return l||d?(l&&l.forEach((function(t){var l=Date.now();n._data.playlists.added[t]=l,n._data.lastTimestamp=l})),d&&d.forEach((function(t){var l=Date.now();n._data.albums.added[t]=l,n._data.lastTimestamp=l})),this.save(),t):t},ServerLedger.prototype.removed=function(t){var n=this;this.load();var l=null==t?void 0:t.playlists;return l?(ensureArray(l).forEach((function(t){if(0!==t.indexOf("pl.")){var l=Date.now();n._data.playlists.removed[t]=l,n._data.lastTimestamp=l}})),this.save(),t):t},ServerLedger.prototype.reconcile=function(t,n,l,d,p){var h,f;return __awaiter$4(this,void 0,void 0,(function(){var p,y,v,_,g,m,b,P,T,S,k,A,I,E,w,O,R,C,M=this;return __generator$4(this,(function(N){switch(N.label){case 0:if(this._checkTimestamp(),!(p=n.data||n)||!Array.isArray(p)||Array.isArray(l))return[2,n];if(y=this._data.albums.added,v=this._data.playlists.removed,_=this._data.playlists.added,g=[],m=d&&!d.offset||!!l&&(void 0===l.offset||0===l.offset),b=!1,"all"!==t&&"playlists"!==t)return[3,2];for(I=p.length-1;I>=0;I--)E=p[I],w=null===(h=E.playParams)||void 0===h?void 0:h.globalId,"library-playlists"===E.type&&(v[E.id]?p.splice(I,1):w&&_[w]&&(delete _[w],b=!0,m||p.splice(I,1)));return m&&this._catalogApi&&(P=Object.keys(_)).length?[4,this._catalogApi.playlists(P)]:[3,2];case 1:T=N.sent(),g.splice.apply(g,__spread$4([0,0],T)),N.label=2;case 2:return!this._catalogApi||"all"!==t&&"albums"!==t?[3,4]:(S=Object.keys(y)).length?[4,this._catalogApi.albums(S)]:[3,4];case 3:for(k=N.sent(),A=Object.create(null),k.forEach((function(t,n){var l=makeAlbumKey(t);A[l]={catalogId:S[n],album:t}})),I=p.length-1;I>=0;I--)E=p[I],w=null===(f=E.playParams)||void 0===f?void 0:f.globalId,"library-albums"===E.type&&(O=makeAlbumKey(E),(R=A[O])&&(delete y[R.catalogId],b=!0,m?delete A[O]:p.splice(I,1)));m&&(C=Object.keys(A).map((function(t){return A[t].album}))).length&&g.splice.apply(g,__spread$4([0,0],C)),N.label=4;case 4:return b&&this.save(),m&&g.length&&(g.sort((function(t,n){var l=M._data.albums.added[t.id]||M._data.playlists.added[t.id]||0;return(M._data.albums.added[n.id]||M._data.playlists.added[n.id]||0)-l})),p.splice.apply(p,__spread$4([0,0],g))),[2,n]}}))}))},ServerLedger.prototype.load=function(){if(this._sessionStorage){var t=this._sessionStorage.getItem(this._storageKey);if(t)try{this._data=JSON.parse(t),this._data.albums&&this._data.playlists||(this._data=this._initData())}catch(e){this._data||(this._data=this._initData())}else this._data=this._initData()}},ServerLedger.prototype.save=function(){if(this._sessionStorage){var t=this._data,n=0===Object.keys(t.albums.added).length&&0===Object.keys(t.albums.removed).length&&0===Object.keys(t.playlists.added).length&&0===Object.keys(t.playlists.removed).length;try{if(n)this._sessionStorage.getItem(this._storageKey)&&this._sessionStorage.removeItem(this._storageKey);else{var l=JSON.stringify(this._data);this._sessionStorage.setItem(this._storageKey,l)}}catch(e){}}},ServerLedger}(),wl="me/library",Ol=function(t){function Library(n,l,d,p,h,f){void 0===p&&(p={});var y=t.call(this,n,l,gs(gs({},f),{userToken:d}))||this;return y._last=0,y._store=new kl(p),y._serverLedger=new El(d,h),y.defaultIncludePaginationMetadata=p.features&&p.features.hasOwnProperty("api-pagination-metadata"),y}return __extends$5(Library,t),Library.prototype.add=function(t){return __awaiter$4(this,void 0,void 0,(function(){var n,l,d,p,h,f;return __generator$4(this,(function(y){switch(y.label){case 0:if(n=transformKeys(t,dasherize),(l=Date.now())-this._last<1e3)return[2,Promise.reject(new Fe(Fe.QUOTA_EXCEEDED))];d=new Headers({Authorization:"Bearer "+this.developerToken,"Music-User-Token":this.userToken}),p=Object.keys(n).map((function(t){return"ids["+t+"]="+n[t].join(",")})).join("&"),y.label=1;case 1:return y.trys.push([1,3,,4]),[4,fetch(this.url+"/"+wl+"?"+p,{method:"POST",headers:d})];case 2:return(h=y.sent()).ok?(this._last=l,[2,this._serverLedger.added(n)]):[2,Promise.reject(Fe.responseError(h))];case 3:return f=y.sent(),[2,Promise.reject(Fe.responseError(f))];case 4:return[2]}}))}))},Library.prototype.remove=function(t){return __awaiter$4(this,void 0,void 0,(function(){var n,l,d,p,h,f;return __generator$4(this,(function(y){switch(y.label){case 0:if(!this.developerToken||!this.userToken)return[2,Promise.reject("Invalid tokens")];n=new Headers({Authorization:"Bearer "+this.developerToken,"Music-User-Token":this.userToken}),l=transformKeys(t,dasherize),d=Object.keys(l)[0],p=Object.values(l)[0],y.label=1;case 1:return y.trys.push([1,3,,4]),[4,fetch(this.url+"/"+wl+"/"+d+"/"+p,{method:"DELETE",headers:n})];case 2:return(h=y.sent()).ok?[2,this._serverLedger.removed(l)]:[2,Promise.reject(Fe.responseError(h))];case 3:return f=y.sent(),[2,Promise.reject(Fe.responseError(f))];case 4:return[2]}}))}))},Library.prototype.album=function(t,n,l){return __awaiter$4(this,void 0,void 0,(function(){return __generator$4(this,(function(d){return[2,this.resource("albums",t,n,l)]}))}))},Library.prototype.albumRelationship=function(t,n,l,d){return __awaiter$4(this,void 0,void 0,(function(){return __generator$4(this,(function(p){return[2,this.collection("albums/"+t+"/"+n,void 0,l,d)]}))}))},Library.prototype.albums=function(t,n,l){return __awaiter$4(this,void 0,void 0,(function(){var d;return __generator$4(this,(function(p){switch(p.label){case 0:return[4,this.collection("albums",t,n,gs(gs({},l),{shouldCacheResults:!1}))];case 1:return d=p.sent(),[2,this._serverLedger.reconcile("albums",d,t,n,l)]}}))}))},Library.prototype.artist=function(t,n,l){return __awaiter$4(this,void 0,void 0,(function(){return __generator$4(this,(function(d){return[2,this.resource("artists",t,n,l)]}))}))},Library.prototype.artistRelationship=function(t,n,l,d){return void 0===n&&(n="albums"),__awaiter$4(this,void 0,void 0,(function(){return __generator$4(this,(function(p){return[2,this.collection("artists/"+t+"/"+n,void 0,l,d)]}))}))},Library.prototype.artists=function(t,n,l){return __awaiter$4(this,void 0,void 0,(function(){return __generator$4(this,(function(d){return[2,this.collection("artists",t,n,l)]}))}))},Library.prototype.createPlaylist=function(t,n){return void 0===t&&(t={}),__awaiter$4(this,void 0,void 0,(function(){var l,d,p,h,f,y,v,_,g;return __generator$4(this,(function(m){switch(m.label){case 0:d=t.name,p=t.description,h=t.tracks,f=transformTrackParameters(void 0===h?[]:h),y={attributes:{name:d,description:p},relationships:{tracks:{data:f}}},v=JSON.stringify(y),m.label=1;case 1:return m.trys.push([1,3,,4]),[4,this.request(wl+"/playlists",n,{body:v,method:"POST"})];case 2:return l=m.sent(),[3,4];case 3:return _=m.sent(),[2,Promise.reject(Fe.responseError(_))];case 4:try{return g=__read$4(this._store.write(l),1),[2,g[0]]}catch(error){return[2,Promise.reject(Fe.parseError(error))]}return[2]}}))}))},Library.prototype.deletePlaylist=function(t,n){return __awaiter$4(this,void 0,void 0,(function(){var l,d;return __generator$4(this,(function(p){switch(p.label){case 0:l=wl+"/playlists/"+t,p.label=1;case 1:return p.trys.push([1,3,,4]),[4,this.request(l,n,{method:"DELETE"})];case 2:return p.sent(),[3,4];case 3:return d=p.sent(),[2,Promise.reject(Fe.responseError(d))];case 4:return this.purgePlaylistFromCaches(t),[2]}}))}))},Library.prototype.editPlaylist=function(t,n,l){return __awaiter$4(this,void 0,void 0,(function(){var d,p,h;return __generator$4(this,(function(f){switch(f.label){case 0:d=JSON.stringify({attributes:n}),f.label=1;case 1:return f.trys.push([1,3,,4]),[4,this.request(wl+"/playlists/"+t,l,{body:d,method:"PATCH"})];case 2:return f.sent(),[3,4];case 3:return p=f.sent(),[2,Promise.reject(Fe.responseError(p))];case 4:try{return h=n,"library-playlists",this._store.write({data:[{type:"library-playlists",id:t,attributes:h}]}),[2,n]}catch(error){return[2,Promise.reject(Fe.parseError(error))]}return[2]}}))}))},Library.prototype.updatePlaylistTracklist=function(t,n){return __awaiter$4(this,void 0,void 0,(function(){return __generator$4(this,(function(l){switch(l.label){case 0:return[4,this.putPlaylistTracklisting(t,n,"PUT")];case 1:return l.sent(),this.purgePlaylistFromCaches(t),[2]}}))}))},Library.prototype.appendTracksToPlaylist=function(t,n){return __awaiter$4(this,void 0,void 0,(function(){return __generator$4(this,(function(l){switch(l.label){case 0:return[4,this.putPlaylistTracklisting(t,n,"POST")];case 1:return l.sent(),this.purgePlaylistFromCaches(t),[2]}}))}))},Library.prototype.playlistFolder=function(t,n,l){return this.resource("playlist-folders",t,n,l)},Library.prototype.playlistFolders=function(t,n,l){return this.collection("playlist-folders",t,n,l)},Library.prototype.playlistFoldersRoot=function(t,n){return t=gs(gs({},t),{filter:gs(gs({},null==t?void 0:t.filter),{identity:"playlistsroot"})}),this.playlistFolders(void 0,t,n)},Library.prototype.playlistFolderChildren=function(t,n,l){var d="playlist-folders/"+t+"/children";return this.collection(d,void 0,n,l)},Library.prototype.musicVideo=function(t,n,l){return __awaiter$4(this,void 0,void 0,(function(){return __generator$4(this,(function(d){return[2,this.resource("music-videos",t,n,l)]}))}))},Library.prototype.musicVideos=function(t,n,l){return __awaiter$4(this,void 0,void 0,(function(){return __generator$4(this,(function(d){return[2,this.collection("music-videos",t,n,l)]}))}))},Library.prototype.parseResultData=function(t,n){return t?this._store.write(n):this._store.parse(n)},Library.prototype.playlist=function(t,n,l){return __awaiter$4(this,void 0,void 0,(function(){return __generator$4(this,(function(d){return n=Object.assign({include:"tracks"},n),[2,this.resource("playlists",t,n,l)]}))}))},Library.prototype.createCatalogPlaylist=function(t,n,l){return __awaiter$4(this,void 0,void 0,(function(){return __generator$4(this,(function(d){return l=gs({method:"POST"},l),[2,this.resource("playlists/"+t+"/catalog",void 0,n,l)]}))}))},Library.prototype.playlistRelationship=function(t,n,l,d){return void 0===n&&(n="tracks"),__awaiter$4(this,void 0,void 0,(function(){return __generator$4(this,(function(p){return[2,this.collection("playlists/"+t+"/"+n,void 0,l,d)]}))}))},Library.prototype.playlists=function(t,n,l){return __awaiter$4(this,void 0,void 0,(function(){var d,p=this;return __generator$4(this,(function(h){switch(h.label){case 0:return t&&t.length>0?[4,Promise.all(t.map((function(t){return p.playlist(t,n,l)})))]:[3,2];case 1:return d=h.sent(),[3,4];case 2:return[4,this.collection("playlists",t,n,gs(gs({},l),{shouldCacheResults:!1}))];case 3:d=h.sent(),h.label=4;case 4:return[2,this._serverLedger.reconcile("playlists",d,t,n,l)]}}))}))},Library.prototype.recentlyAdded=function(t,n){return __awaiter$4(this,void 0,void 0,(function(){var l,d;return __generator$4(this,(function(p){switch(p.label){case 0:return l=null==t?void 0:t.limit,[4,this.collection("recently-added",void 0,transformParameters(t,l||10),gs(gs({},n),{shouldCacheResults:!1}))];case 1:return d=p.sent(),[2,this._serverLedger.reconcile("all",d,void 0,t,n)]}}))}))},Library.prototype.search=function(t,n,l){return __awaiter$4(this,void 0,void 0,(function(){var d;return __generator$4(this,(function(p){return n=this._denormalizeLibraryTypes(n),d=Object.assign({term:t,types:"library-albums"},n),[2,this.collection("search",void 0,d,gs(gs({},l),{shouldCacheResults:!1}))]}))}))},Library.prototype.song=function(t,n,l){return __awaiter$4(this,void 0,void 0,(function(){return __generator$4(this,(function(d){return[2,this.resource("songs",t,n,l)]}))}))},Library.prototype.songRelationship=function(t,n,l,d){return __awaiter$4(this,void 0,void 0,(function(){return __generator$4(this,(function(p){return[2,this.collection("songs/"+t+"/"+n,void 0,l,d)]}))}))},Library.prototype.songs=function(t,n,l){return __awaiter$4(this,void 0,void 0,(function(){return __generator$4(this,(function(d){return[2,this.collection("songs",t,n,l)]}))}))},Library.prototype.collection=function(t,n,l,d){return __awaiter$4(this,void 0,void 0,(function(){var p;return __generator$4(this,(function(h){return!n||n.length||l||(l=transformParameters(n,100),n=void 0),p=n?Object.assign({ids:n},l):l,[2,makeRequest(this,wl+"/"+t,p,d)]}))}))},Library.prototype.resource=function(t,n,l,d){return __awaiter$4(this,void 0,void 0,(function(){var p,h,f;return __generator$4(this,(function(y){switch(y.label){case 0:return!(null==d?void 0:d.reload)&&(p=this._store.read(t,n,l))?[2,p]:(h=wl+"/"+t,n&&(h=h+"/"+n),[4,makeRequest(this,h,l,d)]);case 1:return f=__read$4.apply(void 0,[y.sent(),1]),[2,f[0]]}}))}))},Library.prototype.purgePlaylistFromCaches=function(t){this._store.delete("library-playlists",t),this.networkCache.removeItemsMatching(this.constructURL(wl+"/playlists/"+t,{}),!1)},Library.prototype.putPlaylistTracklisting=function(t,n,l){return void 0===l&&(l="PUT"),__awaiter$4(this,void 0,void 0,(function(){var d,p,h;return __generator$4(this,(function(f){switch(f.label){case 0:d=transformTrackParameters(n),p=JSON.stringify({data:d}),f.label=1;case 1:return f.trys.push([1,3,,4]),[4,this.request(wl+"/playlists/"+t+"/tracks",void 0,{body:p,method:l})];case 2:return f.sent(),[3,4];case 3:return h=f.sent(),[2,Promise.reject(Fe.responseError(h))];case 4:return[2]}}))}))},Library.prototype._denormalizeLibraryTypes=function(t,n){void 0===t&&(t={}),void 0===n&&(n="types");var l=t[n];return l?("string"==typeof l&&(l=l.split(",")),t[n]=l.map((function(t){return t.replace(/^(albums|music-videos|playlists|songs)$/,"library-$1")})),t):t},__decorate$3([ChunkedIdApi(1),__metadata$3("design:type",Function),__metadata$3("design:paramtypes",[String,Object,Object,Object]),__metadata$3("design:returntype",Promise)],Library.prototype,"collection",null),Library}(It),Rl=function(t){function Books(n,l,d,p,h,f){void 0===h&&(h={});var y=t.call(this,"https://api.books.apple.com/v1",n,gs(gs({},f),{userToken:l,storage:p}))||this;return y.storefrontId=ji.ID,d&&(y.storefrontId=d),y._store=new kl(h),y.defaultIncludePaginationMetadata=h.features&&h.features.hasOwnProperty("api-pagination-metadata"),y}return __extends$5(Books,t),Books.prototype.audioBook=function(t,n,l){return this.resource("audio-books",t,n,l)},Books.prototype.audioBooks=function(t,n,l){return this.collection("audio-books",t,n,l)},Books.prototype.collection=function(t,n,l,d){return __awaiter$4(this,void 0,void 0,(function(){var p;return __generator$4(this,(function(h){return p="catalog/"+this.storefrontId+"/"+t,n&&((l=l||{}).ids=n),[2,makeRequest(this,p,l,d)]}))}))},Books.prototype.parseResultData=function(t,n){return t?this._store.write(n):this._store.parse(n)},Books.prototype.resource=function(t,n,l,d){return __awaiter$4(this,void 0,void 0,(function(){var p,h;return __generator$4(this,(function(f){switch(f.label){case 0:return!(null==d?void 0:d.reload)&&(p=this._store.read(t,n,l))?[2,p]:[4,this.collection(t,n,l,d)];case 1:return h=__read$4.apply(void 0,[f.sent(),1]),[2,h[0]]}}))}))},__decorate$3([ChunkedIdApi(1),__metadata$3("design:type",Function),__metadata$3("design:paramtypes",[String,Object,Object,Object]),__metadata$3("design:returntype",Promise)],Books.prototype,"collection",null),Books}(It),Cl=function(t){function Podcasts(n,l,d,p,h,f){void 0===d&&(d=ji.ID),void 0===h&&(h={});var y=t.call(this,"https://amp-api.podcasts.apple.com/v1",n,gs(gs({},f),{userToken:l,storage:p}))||this;return y.storefrontId=d,y._store=new kl(h),y.defaultIncludePaginationMetadata=h.features&&h.features.hasOwnProperty("api-pagination-metadata"),y}return __extends$5(Podcasts,t),Podcasts.prototype.catalogResource=function(t,n,l,d){return this.resource(t,n,l,d)},Podcasts.prototype.catalogResources=function(t,n,l,d){return this.collection(t,n,l,d)},Podcasts.prototype.catalogResourceRelationship=function(t,n,l,d,p){return this.collection(t+"/"+n+"/"+l,void 0,d,p)},Podcasts.prototype.search=function(t,n,l){return this.collection("search",void 0,gs({term:t,types:"podcasts"},n),l)},Podcasts.prototype.artist=function(t,n,l){return this.catalogResource("artists",t,n,l)},Podcasts.prototype.artists=function(t,n,l){return this.catalogResources("artists",t,n,l)},Podcasts.prototype.artistRelationship=function(t,n,l,d){return this.catalogResourceRelationship("artists",t,n,l,d)},Podcasts.prototype.charts=function(t,n,l){return this.catalogResources("charts",void 0,gs({types:t},n),l)},Podcasts.prototype.podcast=function(t,n,l){return this.catalogResource("podcasts",t,gs({include:"episodes"},n),l)},Podcasts.prototype.podcasts=function(t,n,l){return __awaiter$4(this,void 0,void 0,(function(){return __generator$4(this,(function(d){return[2,this.catalogResources("podcasts",t,gs({include:"episodes"},n),l)]}))}))},Podcasts.prototype.podcastRelationship=function(t,n,l,d){return __awaiter$4(this,void 0,void 0,(function(){return __generator$4(this,(function(p){return[2,this.catalogResourceRelationship("podcasts",t,n,l,d)]}))}))},Podcasts.prototype.episode=function(t,n,l){return __awaiter$4(this,void 0,void 0,(function(){return __generator$4(this,(function(d){return[2,this.resource("podcast-episodes",t,n,l)]}))}))},Podcasts.prototype.episodes=function(t,n,l){return __awaiter$4(this,void 0,void 0,(function(){return __generator$4(this,(function(d){return[2,this.catalogResources("podcast-episodes",t,n,l)]}))}))},Podcasts.prototype.collection=function(t,n,l,d){return __awaiter$4(this,void 0,void 0,(function(){var p,h;return __generator$4(this,(function(f){return n?((h={})["charts"===t?"types":"ids"]=n,p=Object.assign(h,l)):p=l,[2,makeRequest(this,"catalog/"+this.storefrontId+"/"+t,p,d)]}))}))},Podcasts.prototype.parseResultData=function(t,n){return t?this._store.write(n):this._store.parse(n)},Podcasts.prototype.resource=function(t,n,l,d){return __awaiter$4(this,void 0,void 0,(function(){var p,h;return __generator$4(this,(function(f){switch(f.label){case 0:return!(null==d?void 0:d.reload)&&(p=this._store.read(t,n,l))?[2,p]:[4,this.collection(t,n,l,d)];case 1:return h=__read$4.apply(void 0,[f.sent(),1]),[2,h[0]]}}))}))},__decorate$3([ChunkedIdApi(1),__metadata$3("design:type",Function),__metadata$3("design:paramtypes",[String,Object,Object,Object]),__metadata$3("design:returntype",Promise)],Podcasts.prototype,"collection",null),Podcasts}(It),Ml=function(t){function Fitness(n,l,d,p,h,f){var y;void 0===d&&(d=ji.ID),void 0===h&&(h={});var v=t.call(this,"https://amp-api.fitness.apple.com/v1",n,gs(gs({},f),{userToken:l,storage:p}))||this;return v.storefrontId=ji.ID,v.storefrontId=d,v._store=new kl(h),v.defaultIncludePaginationMetadata=!!(null===(y=null==h?void 0:h.features)||void 0===y?void 0:y["api-pagination-metadata"]),v}return __extends$5(Fitness,t),Fitness.prototype.workout=function(t,n,l){return this.resource("workouts",t,n,l)},Fitness.prototype.contributor=function(t,n,l){return this.resource("contributors",t,n,l)},Fitness.prototype.modalities=function(t,n,l){return this.collection("modalities",t,n,l)},Fitness.prototype.modality=function(t,n,l){return this.resource("modalities",t,n,l)},Fitness.prototype.workoutProgram=function(t,n,l){return this.resource("workout-programs",t,n,l)},Fitness.prototype.collection=function(t,n,l,d){var p;return p=n?gs({ids:n},l):l,makeRequest(this,"catalog/"+this.storefrontId+"/"+t,p,d)},Fitness.prototype.parseResultData=function(t,n){return t?this._store.write(n):this._store.parse(n)},Fitness.prototype.resource=function(t,n,l,d){return __awaiter$4(this,void 0,void 0,(function(){var p,h;return __generator$4(this,(function(f){switch(f.label){case 0:return(p=this._store.read(t,n,l))?[2,p]:[4,this.collection(t,n,l,d)];case 1:return h=__read$4.apply(void 0,[f.sent(),1]),[2,h[0]]}}))}))},__decorate$3([ChunkedIdApi(1),__metadata$3("design:type",Function),__metadata$3("design:paramtypes",[String,Object,Object,Object]),__metadata$3("design:returntype",Promise)],Fitness.prototype,"collection",null),Fitness}(It),Nl=function(t){function TVLibrary(n,l,d,p,h){void 0===p&&(p={});var f=t.call(this,"https://amp-api.videos.apple.com/v1",n,gs(gs({},h),{userToken:l,storage:d}))||this;return f._store=new kl(p),f.defaultIncludePaginationMetadata=p.features&&p.features.hasOwnProperty("api-pagination-metadata"),f}return __extends$5(TVLibrary,t),TVLibrary.prototype.genres=function(t,n){return __awaiter$4(this,void 0,void 0,(function(){return __generator$4(this,(function(l){return[2,this.collection("genres",gs({types:"tv-episodes,movies"},t),n)]}))}))},TVLibrary.prototype.movies=function(t,n){return __awaiter$4(this,void 0,void 0,(function(){return __generator$4(this,(function(l){return[2,this.collection("movies",t,n)]}))}))},TVLibrary.prototype.purchases=function(t,n){return __awaiter$4(this,void 0,void 0,(function(){return __generator$4(this,(function(l){return[2,this.collection("",gs({types:"tv-episodes,movies"},t),n)]}))}))},TVLibrary.prototype.tvEpisodes=function(t,n){return __awaiter$4(this,void 0,void 0,(function(){return __generator$4(this,(function(l){return[2,this.collection("tv-episodes",t,n)]}))}))},TVLibrary.prototype.collection=function(t,n,l){return __awaiter$4(this,void 0,void 0,(function(){var d;return __generator$4(this,(function(p){switch(p.label){case 0:return p.trys.push([0,2,,3]),[4,makeRequest(this,"me/purchases/"+t,n,l)];case 1:return[2,p.sent()];case 2:if((d=p.sent()).name===Fe.CONTENT_UNAVAILABLE)return[2,(null==l?void 0:l.includePagination)?{data:[],meta:{}}:[]];throw d;case 3:return[2]}}))}))},TVLibrary.prototype.parseResultData=function(t,n){return t?this._store.write(n):this._store.parse(n)},__decorate$3([ChunkedIdApi(1),__metadata$3("design:type",Function),__metadata$3("design:paramtypes",[String,Object,Object]),__metadata$3("design:returntype",Promise)],TVLibrary.prototype,"collection",null),TVLibrary}(It),RecommendationUpdate=function(){return function(t,n,l){if(void 0===l||"function"!=typeof l.value)throw new TypeError("Only methods can be decorated with @RecommendationUpdate, but "+n+" is not a method.");return{configurable:!0,get:function(){var t=l.value;function recommendationUpdate(){for(var n=[],l=0;l<arguments.length;l++)n[l]=arguments[l];return __awaiter$4(this,void 0,void 0,(function(){var l,d,p,h,f,y,v,_,g;return __generator$4(this,(function(m){switch(m.label){case 0:return[4,t.apply(this,n)];case 1:return l=m.sent(),d=new Map,p=[],h=new Date,l&&Array.isArray(l)?(l.forEach((function(t,n){var l,f,y=t.id,v=null!==(l=t.nextUpdateDate)&&void 0!==l?l:null===(f=t.attributes)||void 0===f?void 0:f.nextUpdateDate;y&&v&&(new Date(v)<h&&(p.push(y),d.set(y,n)))})),p.length?(f=__read$4(n),f[0],y=f[1],v=f[2],_=f.slice(3),v=gs(gs({},v),{reload:!0}),g=__spread$4([p,y,v],_),[4,t.apply(this,g)]):[2,l]):[2,l];case 2:return m.sent().forEach((function(t){var n=d.get(t.id);void 0!==n&&(l[n]=t)})),[2,l]}}))}))}return Object.defineProperty(this,n,{value:recommendationUpdate,configurable:!0,writable:!0}),recommendationUpdate}}}};!function(t){t[t.Global=0]="Global",t.Lyrics="lyrics",t.Catalog="catalog",t.Personalized="me",t.Editorial="editorial",t.Engagement="engagement",t.Social="social"}(Al||(Al={})),function(t){t.songs="songs",t.albums="albums",t.playlists="playlists",t.stations="stations",t["music-videos"]="music-videos",t["library-music-videos"]="library-music-videos",t["library-playlists"]="library-playlists",t["library-songs"]="library-songs"}(Il||(Il={}));var Dl,Ll=function(t){function API(n,l,d,p,h,f,y,v){void 0===y&&(y={});var _=t.call(this,n,l,gs(gs({},v),{userToken:p,storage:f}))||this;return _.storefrontId=ji.ID,_.resourceRelatives={artists:{albums:{include:"tracks"},playlists:{include:"tracks"},songs:null}},_.defaultIncludePaginationMetadata=y.features&&y.features.hasOwnProperty("api-pagination-metadata"),_._store=new kl(y),_.useStorefrontRecommendations=y.features&&y.features.hasOwnProperty("use-storefront-recommendations"),d&&(_.storefrontId=d.toLowerCase()),p&&h&&(_.userStorefrontId=h.toLowerCase()),_._podcastsAPI=new Cl(l,p,d,f,y,gs({},v)),_.fitness=new Ml(l,p,d,f,y,gs({},v)),_.tvLibrary=new Nl(l,p,f,y,gs({},v)),_.library=new Ol(n,l,p,y,_,gs({},v)),_.books=new Rl(l,p,d,f,y,gs({},v)),_.v3=new Oc({developerToken:l,mediaUserToken:p,storefrontId:d}),_}return __extends$5(API,t),Object.defineProperty(API.prototype,"needsEquivalents",{get:function(){var t=this.userStorefrontId;return void 0!==t&&""!==t&&t!==this.storefrontId},enumerable:!0,configurable:!0}),API.prototype.activity=function(t,n,l){return __awaiter$4(this,void 0,void 0,(function(){return __generator$4(this,(function(d){return[2,this.resource(Al.Catalog,"activities",t,n,l)]}))}))},API.prototype.activities=function(t,n,l){return __awaiter$4(this,void 0,void 0,(function(){return __generator$4(this,(function(d){return[2,this.collection(Al.Catalog,"activities",t,n,l)]}))}))},API.prototype.album=function(t,n,l){return __awaiter$4(this,void 0,void 0,(function(){return __generator$4(this,(function(d){return[2,this.resource(Al.Catalog,"albums",t,n,l)]}))}))},API.prototype.albumRelationship=function(t,n,l,d){return __awaiter$4(this,void 0,void 0,(function(){return __generator$4(this,(function(p){return[2,this.collection(Al.Catalog,"albums/"+t+"/"+n,void 0,l,d)]}))}))},API.prototype.albums=function(t,n,l){return __awaiter$4(this,void 0,void 0,(function(){return __generator$4(this,(function(d){return[2,this.collection(Al.Catalog,"albums",t,n,l)]}))}))},API.prototype.appleCurator=function(t,n,l){return __awaiter$4(this,void 0,void 0,(function(){return __generator$4(this,(function(d){return[2,this.resource(Al.Catalog,"apple-curators",t,n,l)]}))}))},API.prototype.appleCurators=function(t,n,l){return __awaiter$4(this,void 0,void 0,(function(){return __generator$4(this,(function(d){return[2,this.collection(Al.Catalog,"apple-curators",t,n,l)]}))}))},API.prototype.artist=function(t,n,l){return __awaiter$4(this,void 0,void 0,(function(){return __generator$4(this,(function(d){return[2,this.resource(Al.Catalog,"artists",t,n,l)]}))}))},API.prototype.artistRelationship=function(t,n,l,d){return __awaiter$4(this,void 0,void 0,(function(){return __generator$4(this,(function(p){return[2,this.collection(Al.Catalog,"artists/"+t+"/"+n,void 0,l,d)]}))}))},API.prototype.artistView=function(t,n,l,d){return this.collection(Al.Catalog,"artists/"+t+"/view/"+n,void 0,l,d)},API.prototype.artists=function(t,n,l){return __awaiter$4(this,void 0,void 0,(function(){return __generator$4(this,(function(d){return[2,this.collection(Al.Catalog,"artists",t,n,l)]}))}))},API.prototype.audioBook=function(t,n,l){return this.books.audioBook(t,n,l)},API.prototype.audioBooks=function(t,n,l){return this.books.audioBooks(t,n,l)},API.prototype.catalogResources=function(t,n,l){void 0===n&&(n={});var d=transformDescriptorsToIdMap(t);return n=gs(gs({},n),{ids:d}),makeRequest(this,Al.Catalog+"/"+this.storefrontId,n,l)},API.prototype.changeStation=function(t,n,l){return void 0===l&&(l={}),__awaiter$4(this,void 0,void 0,(function(){return __generator$4(this,(function(d){switch(d.label){case 0:return[4,makeRequest(this,"me/stations/change-station/"+t,n,gs(gs({},l),{reload:!0,method:"POST",shouldCacheResults:!1}))];case 1:return[2,d.sent()]}}))}))},API.prototype.charts=function(t,n,l){return __awaiter$4(this,void 0,void 0,(function(){return __generator$4(this,(function(d){return[2,this.collection(Al.Catalog,"charts",t,n,gs(gs({},l),{returnRawJSONApiRecords:!0}))]}))}))},API.prototype.contents=function(t,n,l){return this.collection(Al.Catalog,"contents",t,n,l)},API.prototype.curator=function(t,n,l){return __awaiter$4(this,void 0,void 0,(function(){return __generator$4(this,(function(d){return[2,this.resource(Al.Catalog,"contents",t,n,l)]}))}))},API.prototype.curators=function(t,n,l){return __awaiter$4(this,void 0,void 0,(function(){return __generator$4(this,(function(d){return[2,this.collection(Al.Catalog,"contents",t,n,l)]}))}))},API.prototype.curatorRelationship=function(t,n,l,d){return __awaiter$4(this,void 0,void 0,(function(){return __generator$4(this,(function(p){return[2,this.collection(Al.Catalog,"curators/"+t+"/"+n,void 0,l,d)]}))}))},API.prototype.episode=function(t,n,l){return __awaiter$4(this,void 0,void 0,(function(){return __generator$4(this,(function(d){return[2,this._podcastsAPI.catalogResource("podcast-episodes",t,n,l)]}))}))},API.prototype.episodes=function(t,n,l){return __awaiter$4(this,void 0,void 0,(function(){return __generator$4(this,(function(d){return[2,this._podcastsAPI.catalogResources("podcast-episodes",t,n,l)]}))}))},API.prototype.genre=function(t,n,l){return __awaiter$4(this,void 0,void 0,(function(){return __generator$4(this,(function(d){return[2,this.resource(Al.Catalog,"genres",t,n,l)]}))}))},API.prototype.genres=function(t,n,l){return __awaiter$4(this,void 0,void 0,(function(){return __generator$4(this,(function(d){return[2,this.collection(Al.Catalog,"genres",t,n,l)]}))}))},API.prototype.grouping=function(t,n,l){return __awaiter$4(this,void 0,void 0,(function(){var d;return __generator$4(this,(function(p){return!n&&isObject(t)&&(n=t,t=void 0),d=gs(gs({},{platform:"desktop"}),n),[2,this.resource(Al.Editorial,"groupings",t,d,gs(gs({},l),{shouldCacheResults:!1}))]}))}))},API.prototype.groupings=function(t,n,l){return void 0===n&&(n={}),__awaiter$4(this,void 0,void 0,(function(){var d;return __generator$4(this,(function(p){return d=gs(gs({},{platform:"desktop"}),n),[2,this.collection(Al.Editorial,"groupings",t,d,gs(gs({},l),{shouldCacheResults:!1}))]}))}))},API.prototype.lyric=function(t,n,l){return this.resource(Al.Catalog,"songs/"+t+"/lyrics","",n,gs({reload:!0},l))},API.prototype.lyricSnippet=function(t,n,l){return this.collection(Al.Lyrics,"snippet/songs",t,n,gs(gs({},l),{returnRawJSONApiRecords:!0}))},API.prototype.historyHeavyRotation=function(t,n){return __awaiter$4(this,void 0,void 0,(function(){return __generator$4(this,(function(l){return[2,this.collection(Al.Personalized,"history/heavy-rotation",void 0,transformParameters(t,10),n)]}))}))},API.prototype.multiplex=function(t,n,l){return __awaiter$4(this,void 0,void 0,(function(){var d;return __generator$4(this,(function(p){return(d=this._store.read("multiplex",t,n))?[2,d]:(l=Object.assign({returnRawJSONApiRecords:!0},l),[2,makeRequest(this,Al.Editorial+"/"+this.storefrontId+"/multiplex/"+t,n,l)])}))}))},API.prototype.multiroom=function(t,n,l){return __awaiter$4(this,void 0,void 0,(function(){var d,p;return __generator$4(this,(function(h){switch(h.label){case 0:return(d=this._store.read("multirooms",t,n))?[2,d]:[4,this.collection(Al.Editorial,"multirooms/"+t,void 0,n,l)];case 1:return p=__read$4.apply(void 0,[h.sent(),1]),[2,p[0]]}}))}))},API.prototype.musicMovie=function(t,n,l){return this.resource(Al.Catalog,"music-movies",t,n,l)},API.prototype.musicMovies=function(t,n,l){return this.collection(Al.Catalog,"music-movies",t,n,l)},API.prototype.musicVideo=function(t,n,l){return __awaiter$4(this,void 0,void 0,(function(){return __generator$4(this,(function(d){return[2,this.resource(Al.Catalog,"music-videos",t,n,l)]}))}))},API.prototype.musicVideos=function(t,n,l){return __awaiter$4(this,void 0,void 0,(function(){return __generator$4(this,(function(d){return[2,this.collection(Al.Catalog,"music-videos",t,n,l)]}))}))},API.prototype.nextStationTracks=function(t,n,l){return void 0===l&&(l={}),__awaiter$4(this,void 0,void 0,(function(){var d;return __generator$4(this,(function(p){switch(p.label){case 0:return d={},(null==n?void 0:n.clean)&&(d.clean=n.clean,delete n.clean),(null==n?void 0:n.limit)&&(d.limit=n.limit,delete n.limit),[4,makeRequest(this,"me/stations/next-tracks/"+t,n,gs(gs({},l),{reload:!0,method:"POST",queryParameters:d,shouldCacheResults:!1}))];case 1:return[2,p.sent()]}}))}))},API.prototype.continuousStation=function(t,n,l){return void 0===l&&(l={}),__awaiter$4(this,void 0,void 0,(function(){return __generator$4(this,(function(d){switch(d.label){case 0:return[4,makeRequest(this,"me/stations/continuous",t,gs(gs({},l),{reload:!0,method:"POST",queryParameters:n,returnRawJSONApiRecords:!0,shouldCacheResults:!1}))];case 1:return[2,d.sent()]}}))}))},API.prototype.playlist=function(t,n,l){return __awaiter$4(this,void 0,void 0,(function(){return __generator$4(this,(function(d){return[2,this.resource(Al.Catalog,"playlists",t,n,l)]}))}))},API.prototype.playlistRelationship=function(t,n,l,d){return __awaiter$4(this,void 0,void 0,(function(){return __generator$4(this,(function(p){return[2,this.collection(Al.Catalog,"playlists/"+t+"/"+n,void 0,l,d)]}))}))},API.prototype.playlists=function(t,n,l){return __awaiter$4(this,void 0,void 0,(function(){return __generator$4(this,(function(d){return[2,this.collection(Al.Catalog,"playlists",t,n,l)]}))}))},API.prototype.podcast=function(t,n,l){return __awaiter$4(this,void 0,void 0,(function(){return __generator$4(this,(function(d){return[2,this._podcastsAPI.catalogResource("podcasts",t,gs({include:"episodes"},n),l)]}))}))},API.prototype.podcastRelationship=function(t,n,l,d){return __awaiter$4(this,void 0,void 0,(function(){return __generator$4(this,(function(p){return[2,this._podcastsAPI.catalogResourceRelationship("podcasts",t,n,l,d)]}))}))},API.prototype.podcasts=function(t,n,l){return __awaiter$4(this,void 0,void 0,(function(){return __generator$4(this,(function(d){return[2,this._podcastsAPI.catalogResources("podcasts",t,gs({include:"episodes"},n),l)]}))}))},API.prototype.recentPlayed=function(t,n){return __awaiter$4(this,void 0,void 0,(function(){return __generator$4(this,(function(l){return[2,this.collection(Al.Personalized,"recent/played",void 0,transformParameters(t,10),n)]}))}))},API.prototype.recentRadioStations=function(t,n){return __awaiter$4(this,void 0,void 0,(function(){return __generator$4(this,(function(l){return[2,this.collection(Al.Personalized,"recent/radio-stations",void 0,transformParameters(t,10),n)]}))}))},API.prototype.recordLabel=function(t,n,l){return this.resource(Al.Catalog,"record-labels",t,n,l)},API.prototype.recordLabels=function(t,n,l){return this.collection(Al.Catalog,"record-labels",t,n,l)},API.prototype.recordLabelView=function(t,n,l,d){return this.collection(Al.Catalog,"record-labels/"+t+"/view/"+n,void 0,l,d)},API.prototype.personalRecommendation=function(t,n,l,d){return void 0===d&&(d=!0),__awaiter$4(this,void 0,void 0,(function(){var p,h;return __generator$4(this,(function(f){switch(f.label){case 0:return[4,this.personalRecommendations(t,n,l,d)];case 1:return p=f.sent(),h=__read$4(p,1),[2,h[0]]}}))}))},API.prototype.refreshPersonalRecommendation=function(t,n,l){var d=formatTimezoneOffset();return n=gs({timezone:d},n),l=gs(gs({},l),{method:"POST",queryParameters:n}),this.resource(Al.Personalized,"recommendations",t,void 0,l)},API.prototype.personalRecommendations=function(t,n,l,d){return void 0===l&&(l={}),void 0===d&&(d=!0),__awaiter$4(this,void 0,void 0,(function(){var p,h,f=this;return __generator$4(this,(function(y){switch(y.label){case 0:return p=formatTimezoneOffset(),[4,this.collection(Al.Personalized,"recommendations",t,gs({timezone:p},n),gs(gs({},l),{shouldCacheResults:d,returnRawJSONApiRecords:!0}))];case 1:h=y.sent(),this._reindexRelationships(h,"recommendations");try{return[2,mapRequestResult(h,(function(t){return f.parseResultData(!1,t)}))]}catch(error){return[2,Promise.reject(Fe.parseError(error))]}return[2]}}))}))},API.prototype.personalRecommendationView=function(t,n,l,d){return void 0===d&&(d={}),__awaiter$4(this,void 0,void 0,(function(){return __generator$4(this,(function(p){return[2,this.collection(Al.Personalized,"recommendations/"+t+"/view/"+n,void 0,l,d)]}))}))},API.prototype.recommendations=function(t,n,l,d){return void 0===l&&(l={}),void 0===d&&(d=!0),__awaiter$4(this,void 0,void 0,(function(){var p,h,f=this;return __generator$4(this,(function(y){switch(y.label){case 0:return p=formatTimezoneOffset(),this.useStorefrontRecommendations?[4,this.collection(Al.Global,"recommendations/"+this.storefrontId,t,gs({timezone:p},n),gs(gs({},l),{shouldCacheResults:!1,returnRawJSONApiRecords:!0}))]:[2,this.personalRecommendations(t,n,l,d)];case 1:h=y.sent(),this._reindexRelationships(h,"recommendations");try{return[2,mapRequestResult(h,(function(t){return f.parseResultData(!1,t)}))]}catch(error){return[2,Promise.reject(Fe.parseError(error))]}return[2]}}))}))},API.prototype.recommendedFriends=function(t,n,l){return void 0===l&&(l={}),l=gs(gs({},l),{method:"POST",body:JSON.stringify(gs({ids:{socialProfiles:t}},l.body))}),this.collection(Al.Global,"social/recommended-friends",void 0,n,gs(gs({},l),{shouldCacheResults:!1,returnRawJSONApiRecords:!0}))},API.prototype.room=function(t,n,l){return __awaiter$4(this,void 0,void 0,(function(){var d,p,h;return __generator$4(this,(function(f){switch(f.label){case 0:return(d=this._store.read("rooms",t,n))&&d.hasAttributes("title")?[2,d]:[4,this.collection(Al.Editorial,"rooms/"+t,void 0,n,l)];case 1:return p=f.sent(),h=__read$4(p,1),[2,h[0]]}}))}))},API.prototype.roomContents=function(t,n,l){return __awaiter$4(this,void 0,void 0,(function(){return __generator$4(this,(function(d){return[2,this.collection(Al.Editorial,"rooms/"+t+"/contents",void 0,n,l)]}))}))},API.prototype.search=function(t,n,l){return __awaiter$4(this,void 0,void 0,(function(){var d;return __generator$4(this,(function(p){return d=gs({term:t},n),l=gs(gs({},l),{useRawResponse:!0}),[2,this.collection(Al.Catalog,"search",void 0,d,gs(gs({},l),{shouldCacheResults:!1}))]}))}))},API.prototype.searchHints=function(t,n,l){return __awaiter$4(this,void 0,void 0,(function(){var d,p;return __generator$4(this,(function(h){switch(h.label){case 0:return d=gs({term:t},n),[4,this.collection(Al.Catalog,"search/hints",void 0,d,gs(gs({},l),{returnRawJSONApiRecords:!0}))];case 1:return p=h.sent(),"topResults"===(null==d?void 0:d.with)&&"topResults"in p&&(p.topResults=this.parseResultData(!0,p.topResults)),[2,p]}}))}))},API.prototype.searchQuery=function(t,n){return __awaiter$4(this,void 0,void 0,(function(){return __generator$4(this,(function(l){return n=gs(gs({},n),{useRawResponse:!0}),[2,this.collection(Al.Catalog,"search/query",void 0,t,gs(gs({},n),{shouldCacheResults:!1}))]}))}))},API.prototype.searchSuggestions=function(t,n,l){var d;return __awaiter$4(this,void 0,void 0,(function(){var p,h=this;return __generator$4(this,(function(f){switch(f.label){case 0:return n=gs({term:t},n),[4,this.collection(Al.Catalog,"search/suggestions",void 0,n,gs(gs({},l),{returnRawJSONApiRecords:!0}))];case 1:return p=f.sent(),Array.isArray(null===(d=p)||void 0===d?void 0:d.suggestions)&&p.suggestions.forEach((function(t){"topResults"===t.kind&&(t.content=h.parseResultData(!0,[t.content])[0])})),[2,p]}}))}))},API.prototype.socialBadgingMap=function(t,n){return this.collection(Al.Global,"social/badging-map",void 0,t,gs(gs({},n),{returnRawJSONApiRecords:!0}))},API.prototype.socialProfile=function(t,n,l){return this.resource(Al.Social,"social-profiles",t,n,l)},API.prototype.socialProfiles=function(t,n,l){return this.collection(Al.Social,"social-profiles",t,n,l)},API.prototype.personalSocialProfile=function(t,n){return this.resource(Al.Personalized,"social-profile",void 0,t,n)},API.prototype.socialPost=function(t,n,l){return void 0===n&&(n={}),__awaiter$4(this,void 0,void 0,(function(){var d;return __generator$4(this,(function(p){switch(p.label){case 0:return t.startsWith("sa.")?n.filter={post:t}:n.ids=t,[4,this.collection(Al.Catalog,"contents","",n,l)];case 1:return d=__read$4.apply(void 0,[p.sent(),1]),[2,d[0]]}}))}))},API.prototype.socialSearch=function(t,n,l){return void 0===n&&(n={}),__awaiter$4(this,void 0,void 0,(function(){return __generator$4(this,(function(d){return n=gs(gs({},n),{term:t}),[2,this.collection(Al.Social,"search",void 0,n,l)]}))}))},API.prototype.song=function(t,n,l){return __awaiter$4(this,void 0,void 0,(function(){return __generator$4(this,(function(d){return[2,this.resource(Al.Catalog,"songs",t,n,l)]}))}))},API.prototype.songRelationship=function(t,n,l,d){return __awaiter$4(this,void 0,void 0,(function(){return __generator$4(this,(function(p){return[2,this.collection(Al.Catalog,"songs/"+t+"/"+n,void 0,l,d)]}))}))},API.prototype.songs=function(t,n,l){return __awaiter$4(this,void 0,void 0,(function(){return __generator$4(this,(function(d){return!n&&isObject(t)&&(n=t,t=void 0),[2,this.collection(Al.Catalog,"songs",t,n,l)]}))}))},API.prototype.tastePreferences=function(t,n){return __awaiter$4(this,void 0,void 0,(function(){return __generator$4(this,(function(l){return[2,this.collection(Al.Personalized,"taste/taste-preferences",void 0,t,gs(gs({},n),{shouldCacheResults:!1}))]}))}))},API.prototype.saveTastePreferences=function(t){return __awaiter$4(this,void 0,void 0,(function(){var n,l;return __generator$4(this,(function(d){switch(d.label){case 0:t=t.map((function(t){return t instanceof Ee?t.serialize().data:t})),n={method:"POST",body:JSON.stringify({data:t}),shouldCacheResults:!0},d.label=1;case 1:return d.trys.push([1,3,,4]),[4,makeRequest(this,"me/taste/taste-preferences",void 0,n)];case 2:return[2,d.sent()];case 3:return(l=d.sent()).name===Fe.CONTENT_UNAVAILABLE?[2,[]]:[2,Promise.reject(Fe.parseError(l))];case 4:return[2]}}))}))},API.prototype.tvEpisode=function(t,n,l){return this.resource(Al.Catalog,"tv-episodes",t,gs({include:"seasons"},n),l)},API.prototype.tvEpisodes=function(t,n,l){return this.collection(Al.Catalog,"tv-episodes",t,gs({include:"seasons"},n),l)},API.prototype.tvSeason=function(t,n,l){return this.resource(Al.Catalog,"tv-seasons",t,gs({include:"episodes"},n),l)},API.prototype.tvSeasons=function(t,n,l){return this.collection(Al.Catalog,"tv-seasons",t,gs({include:"episodes"},n),l)},API.prototype.tvShow=function(t,n,l){return this.resource(Al.Catalog,"tv-shows",t,n,l)},API.prototype.tvShows=function(t,n,l){return this.collection(Al.Catalog,"tv-shows",t,n,l)},API.prototype.uploadedAudio=function(t,n,l){return __awaiter$4(this,void 0,void 0,(function(){return __generator$4(this,(function(d){return n=Object.assign({include:"curator,artists"},n),[2,this.resource(Al.Catalog,"uploaded-audios",t,n,l)]}))}))},API.prototype.uploadedAudios=function(t,n,l){return __awaiter$4(this,void 0,void 0,(function(){return __generator$4(this,(function(d){return n=Object.assign({include:"curator,artists"},n),[2,this.collection(Al.Catalog,"uploaded-audios",t,n,l)]}))}))},API.prototype.uploadedVideo=function(t,n,l){return __awaiter$4(this,void 0,void 0,(function(){return __generator$4(this,(function(d){return n=Object.assign({include:"curator,artists"},n),[2,this.resource(Al.Catalog,"uploaded-videos",t,n,l)]}))}))},API.prototype.uploadedVideos=function(t,n,l){return __awaiter$4(this,void 0,void 0,(function(){return __generator$4(this,(function(d){return n=Object.assign({include:"curator,artists"},n),[2,this.collection(Al.Catalog,"uploaded-videos",t,n,l)]}))}))},API.prototype.upsellMarketingItems=function(t,n){return this.collection(Al.Engagement,"upsell/marketing-items",void 0,t,n)},API.prototype.station=function(t,n,l){return __awaiter$4(this,void 0,void 0,(function(){return __generator$4(this,(function(d){return[2,this.resource(Al.Catalog,"stations",t,n,l)]}))}))},API.prototype.stations=function(t,n,l){return __awaiter$4(this,void 0,void 0,(function(){return __generator$4(this,(function(d){return!n&&isObject(t)&&(n=t,t=void 0),[2,this.collection(Al.Catalog,"stations",t,n,l)]}))}))},API.prototype.storefront=function(t,n,l){return __awaiter$4(this,void 0,void 0,(function(){return __generator$4(this,(function(d){return[2,this.resource(Al.Global,"storefronts",t,n,l)]}))}))},API.prototype.storefronts=function(t,n,l){return __awaiter$4(this,void 0,void 0,(function(){return __generator$4(this,(function(d){return[2,this.collection(Al.Global,"storefronts",t,n,l)]}))}))},API.prototype.musicSummary=function(t,n,l){return __awaiter$4(this,void 0,void 0,(function(){return __generator$4(this,(function(d){return[2,this.resource(Al.Personalized,"music-summaries",t,n,l)]}))}))},API.prototype.musicSummarySearch=function(t,n){return void 0===t&&(t={}),__awaiter$4(this,void 0,void 0,(function(){return __generator$4(this,(function(l){return[2,this.collection(Al.Personalized,"music-summaries/search",void 0,t,n)]}))}))},API.prototype.addToLibrary=function(t){return __awaiter$4(this,void 0,void 0,(function(){return __generator$4(this,(function(n){return this.developerToken&&this.userToken&&this.library?[2,this.library.add(t)]:[2,Promise.reject("Invalid tokens")]}))}))},API.prototype.rating=function(t,n,l){return __awaiter$4(this,void 0,void 0,(function(){var d;return __generator$4(this,(function(p){switch(p.label){case 0:return[4,this.ratings(t,n,l)];case 1:return d=__read$4.apply(void 0,[p.sent(),1]),[2,d[0]]}}))}))},API.prototype.ratings=function(t,n,l){if(!this.developerToken||!this.userToken)return Promise.reject("Invalid tokens");var d=__read$4(Object.keys(t),1)[0],p=t[d],h=Array.isArray(p);if(h&&0===p.length)return Promise.resolve([]);var f="me/ratings/"+formatRatingsContentType(d,h?p[0]:p);return h?n=gs(gs({},n),{ids:p.map(normalizeAdamId)}):f=f+"/"+normalizeAdamId(p),makeRequest(this,f,n,gs({shouldCacheResults:!1,reload:!0,includePagination:!1},l))},API.prototype.putRating=function(t,n,l){return __awaiter$4(this,void 0,void 0,(function(){var d,p,h,f,y,v,_;return __generator$4(this,(function(g){switch(g.label){case 0:return this.developerToken&&this.userToken?(d=__read$4(Object.keys(t),1),p=d[0],h=t[p],f=formatRatingsContentType(p,h),y={method:"PUT",body:JSON.stringify({type:"rating",attributes:{value:n}}),includePagination:!1},[4,makeRequest(this,"me/ratings/"+f+"/"+normalizeAdamId(h),l,Object.assign({shouldCacheResults:!1},y))]):[2,Promise.reject("Invalid tokens")];case 1:return v=g.sent(),_=__read$4(v,1),[2,_[0]]}}))}))},API.prototype.deleteRating=function(t,n){return __awaiter$4(this,void 0,void 0,(function(){var l,d,p,h,f=this;return __generator$4(this,(function(y){switch(y.label){case 0:return this.developerToken&&this.userToken?(l=__read$4(Object.keys(t),1),d=l[0],p=t[d],h=formatRatingsContentType(d,p),Array.isArray(p)?[2,Promise.all(p.map((function(t){var l;return f.deleteRating(((l={})[d]=t,l),n)}))).then((function(){}))]:[4,makeRequest(this,"me/ratings/"+h+"/"+p,n,{method:"DELETE",shouldCacheResults:!1,returnRawJSONApiRecords:!0})]):[2,Promise.reject("Invalid tokens")];case 1:y.sent();try{this._store.delete(h,p)}catch(error){return[2,Promise.reject(Fe.parseError(error))]}return[2]}}))}))},API.prototype.equivalent=function(t,n){return __awaiter$4(this,void 0,void 0,(function(){var l,d;return __generator$4(this,(function(p){switch(l="catalog/"+this.userStorefrontId+"/"+t,d={},t){case"albums":case"songs":d={"filter[equivalents]":n};break;case"artists":case"playlists":l=l+"/"+n;break;default:return[2,Promise.reject(new Fe(Fe.INVALID_ARGUMENTS,"Invalid equivalent type"))]}return[2,this.resource(Al.Global,l,"",d)]}))}))},API.prototype.collection=function(t,n,l,d,p){return __awaiter$4(this,void 0,void 0,(function(){var h,f,y,v,_;return __generator$4(this,(function(g){switch(y=null==p?void 0:p.shouldCacheResults,h=l?gs(((_={})["charts"===n?"types":"ids"]=l,_),d):d,t){case Al.Catalog:case Al.Editorial:case Al.Engagement:case Al.Social:case Al.Lyrics:v=this.storefrontId,f=t+"/"+v+"/"+n;break;case Al.Global:f=n;break;case Al.Personalized:f=t+"/"+n,y=!1}return[2,makeRequest(this,f,h,gs(gs({},p),{shouldCacheResults:y}))]}))}))},API.prototype.parseResultData=function(t,n){return t?this._store.write(n):this._store.parse(n)},API.prototype.resource=function(t,n,l,d,p){return __awaiter$4(this,void 0,void 0,(function(){var h,f;return __generator$4(this,(function(y){switch(y.label){case 0:return!(null==p?void 0:p.reload)&&(h=this._store.read(n,l,d))?[2,h]:[4,this.collection(t,n,l,d,p)];case 1:return f=__read$4.apply(void 0,[y.sent(),1]),[2,f[0]]}}))}))},API.prototype._reindexRelationships=function(t,n){("data"in t?t.data:t).forEach((function(t){t.hasOwnProperty("relationships")&&t.relationships.hasOwnProperty(n)&&t.relationships[n].hasOwnProperty("data")&&Array.isArray(t.relationships[n].data)&&t.relationships[n].data.forEach((function(t,n){t.id=t.id+"-"+n}))}))},__decorate$3([RecommendationUpdate(),__metadata$3("design:type",Function),__metadata$3("design:paramtypes",[Object,Object,Object,Object]),__metadata$3("design:returntype",Promise)],API.prototype,"personalRecommendations",null),__decorate$3([RecommendationUpdate(),__metadata$3("design:type",Function),__metadata$3("design:paramtypes",[Object,Object,Object,Object]),__metadata$3("design:returntype",Promise)],API.prototype,"recommendations",null),__decorate$3([ChunkedIdApi(2),__metadata$3("design:type",Function),__metadata$3("design:paramtypes",[Object,String,Object,Object,Object]),__metadata$3("design:returntype",Promise)],API.prototype,"collection",null),API}(It),xl={album:{isPlural:!1,apiMethod:"album",relationshipMethod:{method:"albumRelationship",relationship:"tracks"}},albums:{isPlural:!0,apiMethod:"albums"},audioBook:{isPlural:!1,apiMethod:"audioBook"},audioBooks:{isPlural:!0,apiMethod:"audioBooks"},episode:{isPlural:!1,apiMethod:"episode"},episodes:{isPlural:!0,apiMethod:"episodes"},musicVideo:{isPlural:!1,apiMethod:"musicVideo"},musicVideos:{isPlural:!0,apiMethod:"musicVideos"},musicMovie:{isPlural:!1,apiMethod:"musicMovie"},musicMovies:{isPlural:!0,apiMethod:"musicMovies"},podcast:{isPlural:!1,apiMethod:"podcast"},podcasts:{isPlural:!0,apiMethod:"podcasts"},playlist:{isPlural:!1,apiMethod:"playlist",relationshipMethod:{method:"playlistRelationship",relationship:"tracks"}},playlists:{isPlural:!0,apiMethod:"playlists"},song:{isPlural:!1,apiMethod:"song"},songs:{isPlural:!0,apiMethod:"songs"},tvEpisode:{isPlural:!1,apiMethod:"tvEpisode"},tvEpisodes:{isPlural:!0,apiMethod:"tvEpisodes"},uploadedAudio:{isPlural:!1,apiMethod:"uploadedAudio"},uploadedAudios:{isPlural:!0,apiMethod:"uploadedAudios"},uploadedVideo:{isPlural:!1,apiMethod:"uploadedVideo"},uploadedVideos:{isPlural:!0,apiMethod:"uploadedVideos"}},Ul=function(){function MediaAPIService(t){var n=this;if(this._dispatcher=t,!ns.urls.mediaApi)throw new Error("bag.urls.mediaApi is not configured");this.url=ns.urls.mediaApi,this.namedQueueOptions=xl,this._dispatcher.subscribe(Ve.apiStorefrontChanged,(function(t,l){var d=l.storefrontId;return __awaiter(n,void 0,void 0,(function(){return __generator(this,(function(t){switch(t.label){case 0:return[4,this._updateStorefrontId(d)];case 1:return t.sent(),[2]}}))}))}))}return Object.defineProperty(MediaAPIService.prototype,"api",{get:function(){if(void 0===this._api)throw new Fe(Fe.CONFIGURATION_ERROR,"The API cannot be accessed before it is configured.");return this._api},enumerable:!0,configurable:!0}),Object.defineProperty(MediaAPIService.prototype,"storefrontId",{get:function(){return this.store&&this.store.storefrontId},enumerable:!0,configurable:!0}),MediaAPIService.prototype.configure=function(t){return __awaiter(this,void 0,void 0,(function(){var n=this;return __generator(this,(function(l){return void 0===t.store?[2]:(this.store=t.store,[An.userTokenDidChange,An.storefrontIdentifierDidChange].forEach((function(t){n.store.storekit.addEventListener(t,(function(){return n.resetAPI()}))})),this._initializeAPI(t),[2,this])}))}))},MediaAPIService.prototype.clear=function(){this.api&&this.api.clearNetworkCache&&this.api.clearNetworkCache()},MediaAPIService.prototype.getAPIForItem=function(t){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(n){switch(n.label){case 0:return ce(t)?[4,this.store.authorize()]:[3,2];case 1:return n.sent(),[2,this.api.library||this.api];case 2:return[2,this.api]}}))}))},MediaAPIService.prototype.resetAPI=function(){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(t){return this.clear(),this._initializeAPI(),[2]}))}))},MediaAPIService.prototype._initializeAPI=function(t){if(void 0===(null==t?void 0:t.api)){var n=t&&t.store||this.store;if(void 0!==n){var l=ns.features["api-session-storage"]?sessionStorage:void 0,d=t&&t.storefrontId||n.storefrontId,p=new Ll(this.url,n.developerToken,d,n.storekit.userToken,n.storekit.storefrontCountryCode,l,ns,t&&t.apiOptions&&t.apiOptions.sessionOptions);this._api=p.v3,this._api=p}}else this._api=t.api},MediaAPIService.prototype._updateStorefrontId=function(t){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(n){switch(n.label){case 0:return this.api&&t===this.api.storefrontId?[2]:[4,this.configure({dispatcher:this._dispatcher,store:this.store,storefrontId:t})];case 1:return n.sent(),[2]}}))}))},MediaAPIService}(),extendStatics$6=function(t,n){return(extendStatics$6=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,n){t.__proto__=n}||function(t,n){for(var l in n)n.hasOwnProperty(l)&&(t[l]=n[l])})(t,n)};function __extends$6(t,n){function __(){this.constructor=t}extendStatics$6(t,n),t.prototype=null===n?Object.create(n):(__.prototype=n.prototype,new __)}var __assign$6=function(){return(__assign$6=Object.assign||function(t){for(var n,l=1,d=arguments.length;l<d;l++)for(var p in n=arguments[l])Object.prototype.hasOwnProperty.call(n,p)&&(t[p]=n[p]);return t}).apply(this,arguments)};function __awaiter$5(t,n,l,d){return new(l||(l=Promise))((function(p,h){function fulfilled(t){try{step(d.next(t))}catch(e){h(e)}}function rejected(t){try{step(d.throw(t))}catch(e){h(e)}}function step(t){t.done?p(t.value):new l((function(n){n(t.value)})).then(fulfilled,rejected)}step((d=d.apply(t,n||[])).next())}))}function __generator$5(t,n){var l,d,p,h,f={label:0,sent:function(){if(1&p[0])throw p[1];return p[1]},trys:[],ops:[]};return h={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(h[Symbol.iterator]=function(){return this}),h;function verb(h){return function(y){return function(h){if(l)throw new TypeError("Generator is already executing.");for(;f;)try{if(l=1,d&&(p=2&h[0]?d.return:h[0]?d.throw||((p=d.return)&&p.call(d),0):d.next)&&!(p=p.call(d,h[1])).done)return p;switch(d=0,p&&(h=[2&h[0],p.value]),h[0]){case 0:case 1:p=h;break;case 4:return f.label++,{value:h[1],done:!1};case 5:f.label++,d=h[1],h=[0];continue;case 7:h=f.ops.pop(),f.trys.pop();continue;default:if(!(p=f.trys,(p=p.length>0&&p[p.length-1])||6!==h[0]&&2!==h[0])){f=0;continue}if(3===h[0]&&(!p||h[1]>p[0]&&h[1]<p[3])){f.label=h[1];break}if(6===h[0]&&f.label<p[1]){f.label=p[1],p=h;break}if(p&&f.label<p[2]){f.label=p[2],f.ops.push(h);break}p[2]&&f.ops.pop(),f.trys.pop();continue}h=n.call(t,f)}catch(e){h=[6,e],d=0}finally{l=p=0}if(5&h[0])throw h[1];return{value:h[0]?h[1]:void 0,done:!0}}([h,y])}}}function __read$5(t,n){var l="function"==typeof Symbol&&t[Symbol.iterator];if(!l)return t;var d,p,h=l.call(t),f=[];try{for(;(void 0===n||n-- >0)&&!(d=h.next()).done;)f.push(d.value)}catch(error){p={error:error}}finally{try{d&&!d.done&&(l=h.return)&&l.call(h)}finally{if(p)throw p.error}}return f}function __spread$5(){for(var t=[],n=0;n<arguments.length;n++)t=t.concat(__read$5(arguments[n]));return t}var Bl=new De;function isRecordValid(t){var n=void 0!==t.cachingPolicy,l=n&&"cache"in t.cachingPolicy&&!t.cachingPolicy.cache,d=n&&void 0!==t._mjs.expiration&&Date.now()>t._mjs.expiration,p=t._mjs.invalid;return!(l||d||p)}var jl,Fl,Kl=["browseWebLanding","contentEpisodes","episodeItunesSeasons","getPostPlayShelf","getShowDetailById","showEpisodeNextepisode","showItunesSeasons","viewShowEpisodes","watchlistContinueWatching"],Vl=["v2/browse/watchNow","v2/browse/movies","v2/browse/tv","v2/browse/kids","v2/browse/sports","v2/browse/person/{personId}","v2/browse/collection/{collectionId}","v2/browse/channel/{brandId}","v2/browse/room/{roomId}","v2/browse/genre/{genreId}","v3/shows/{showId}","v3/movies/{movieId}","v3/episodes/{episodeId}"],$l=["Episode","Movie","Show"],Yl=function(t){function UTSStore(n){var l=t.call(this,n)||this;return l._canvasPathToID={},l._allowPersonalizedCache=!1,l._allowPersonalizedCache=n.allowPersonalizedCache,l}return __extends$6(UTSStore,t),UTSStore.prototype.isCanvas=function(t){return Vl.includes(t)},UTSStore.isNotCached=function(t){return Kl.includes(t)||/search/i.test(t)},UTSStore.prototype.updateRecordMetadata=function(t,n,l){var d,p=null===(d=null==t?void 0:t._mjs)||void 0===d?void 0:d.sourcePaths,h=p?p.includes(n)?p:p.concat([n]):[n];t._mjs.sourcePaths=h,this.isCanvas(l)&&(Bl.debug("adding id to _browseCanvases",n,t.id),this._canvasPathToID[n]=__assign$6({id:t.id},this._canvasPathToID[n]))},UTSStore.prototype.getCachedRecord=function(t){var n,l=t.args,d=t.methodName,p=t.path,h=t.pathTemplate,f=t.queryParams,y=t.skipDataStoreCache;Bl.debug("uts: "+d+" getCachedRecord",t);var v=this.isCanvas(h),_="skip"in f;if(!(UTSStore.isNotCached(d)||_||y)){var g=l[0]&&"object"==typeof l[0]?l[0].id||l[0].showId||l[0].showOrSeasonId||l[0].personId:l[0];if(v&&this._canvasPathToID[p]&&(g=this._canvasPathToID[p].id),Bl.debug("uts: "+d+" getCachedRecord - id used to query data store:",g),g){var m=__read$5(this.query((function(t){return t.id===g})),1)[0];Bl.debug("uts: "+d+" getCachedRecord - query result:",m);var b=m&&m.nextToken||0,P=null!==(n=f.nextToken)&&void 0!==n?n:-1;if(UTSStore.hasPath(m,p)&&P<parseInt(b,10)){if(isRecordValid(m))return m;Bl.debug("uts: "+d+" getCachedRecord - Removing invalid record",m.type,m.id),v?this.removeCanvasAndShelves(m):this.remove(m.type,m.id)}}}},UTSStore.prototype.replaceShelf=function(t){this.populateDataRecords(t,this._records,{})},UTSStore.prototype.removeCanvasAndShelves=function(t){var n=this;t&&t.shelves&&t.shelves.length>0&&t.shelves.forEach((function(t){n.remove(t.type,t.id)})),this.remove(t.type,t.id)},UTSStore.prototype.invalidateWithEvent=function(t,n){Bl.debug("uts: invalidateWithEvent",t),this._invalidateCanvasAndShelvesForEvent(t),this._invalidateProductRecords(t,n)},UTSStore.prototype._invalidateProductRecords=function(t,n){var l=this;n&&ensureArray(n).forEach((function(t){var n=__read$5(l.query((function(n){return n.id===t.id})),1)[0];n&&($l.includes(n.type)?(Bl.debug("uts: filtering sourcePaths for record:",n),UTSStore._removePersonalizedPaths(n),n.show&&(Bl.debug("uts: filtering sourcePaths for show record:",n.show),UTSStore._removePersonalizedPaths(n.show))):n._mjs.invalid=!0)}))},UTSStore.prototype._invalidateCanvasAndShelvesForEvent=function(t){var n=this;Object.values(this._canvasPathToID).forEach((function(l){if(l&&l.id){var d=n.peek("Canvas",l.id);UTSStore._hasInvalidationEvent(d,t)?d._mjs.invalid=!0:d&&d.shelves&&d.shelves.length>0&&d.shelves.forEach((function(n){UTSStore._hasInvalidationEvent(n,t)&&(n._mjs.invalid=!0)}))}}))},UTSStore._hasInvalidationEvent=function(t,n){var l,d,p;return null!==(p=null===(d=null===(l=null==t?void 0:t.cachingPolicy)||void 0===l?void 0:l.invalidationEvents)||void 0===d?void 0:d.includes(n))&&void 0!==p&&p},UTSStore._removePersonalizedPaths=function(t){var n,l,d=this;t._mjs.sourcePaths=null===(l=null===(n=t._mjs)||void 0===n?void 0:n.sourcePaths)||void 0===l?void 0:l.filter((function(t){return!d.isPersonalizedPath(t)}))},UTSStore.hasPath=function(t,n){var l,d;return(null!==(d=null===(l=null==t?void 0:t._mjs)||void 0===l?void 0:l.sourcePaths)&&void 0!==d?d:[]).includes(n)},UTSStore.isPersonalizedPath=function(t){return t.endsWith("personalized")||/v\d\/view\/show\/.+\/(episodes|playables)/.test(t)},UTSStore.prototype.makeRecord=function(t){var n=this,l=t.args,d=t.path,p=t.pathTemplate,h=t.response,f=t.isPersonalized,y=t.methodName;if(h){if(UTSStore.isNotCached(y)||d.endsWith("personalized")&&!this._allowPersonalizedCache)return this.populateDataRecords(h,{});f&&h.data&&h.data.content&&(h.data.content.cachingPolicy={cache:!0,maxAge:900});var v={},_=null==l?void 0:l[0];_&&(_.hasOwnProperty("skip")&&_.skip>0||_.hasOwnProperty("nextToken")&&_.nextToken)&&(v.extendRelationships=!0);var g=this.save(h,v);return ensureArray(g).forEach((function(t){return n.updateRecordMetadata(t,d,p)})),g}},UTSStore}(we),Hl=function(){function UTSRequest(t,n,l){this.methodName=t,this.args=l;var d="object"==typeof l[0]?__assign$6({},l[0]):__spread$5(l);this.pathTemplate=n.url.replace(/(?:.+)\/uts\/?/i,"");var p=function(t,n){var l=t,d=t.match(/{[^}]+}/g)||[],p=[];return d.forEach((function(t,d){var h=t.replace(/{|}/g,"");l=l.replace(t,encodeURIComponent(Array.isArray(n)?n[d]:n[h])),p.push(h)})),{formattedPath:l,pathKeys:p}}(this.pathTemplate,d),h=p.formattedPath,f=p.pathKeys;this.path=h,this.pathKeys=f,this.queryParams=Array.isArray(d)?{}:d,this.pathKeys.forEach((function(t){return delete d[t]}));var y=!1;"reload"in this.queryParams&&(y=this.queryParams.reload,delete this.queryParams.reload),"returnRawResponse"in this.queryParams&&(this.returnRawResponse=this.queryParams.returnRawResponse,delete this.queryParams.returnRawResponse),this.skipDataStoreCache=y,this.isPersonalized=Yl.isPersonalizedPath(this.path);var v=UTSRequest.getRouteMethod(t);this.fetchOptions={contentType:"POST"===v?Tt.FORM:Tt.JSON,method:v,useRawResponse:!0,reload:y||this.isPersonalized||Yl.isNotCached(t)}}return Object.defineProperty(UTSRequest.prototype,"response",{get:function(){return this._response},set:function(t){t&&t.data&&(t.data.methodName=this.methodName),this._response=t},enumerable:!0,configurable:!0}),UTSRequest.getRouteMethod=function(t){return t.startsWith("post")||t.startsWith("add")?"POST":t.startsWith("remove")||t.startsWith("delete")?"DELETE":"GET"},UTSRequest}();function basic(t){var n={id:t.id,type:t.type||"Shelf",attributes:{},relationships:{}};return n.attributes=__assign$6({},t),n}function canvas(t){var n,l={id:t.canvas.id,type:t.canvas.type,attributes:__assign$6({},t.canvas),relationships:{}};return t.canvas.shelves&&!(null==(n=t.canvas.shelves)?void 0:n.some((function(t){return void 0!==t.markerType})))&&(l.relationships.shelves={data:t.canvas.shelves.map((function(t){return t.type="Shelf",t}))},delete t.canvas.shelves),l.attributes=__assign$6({},t.canvas),delete t.canvas,t.person&&(l.relationships.person={data:t.person},delete t.person),t.genre&&(l.relationships.genre={data:t.genre},delete t.genre),l.attributes=__assign$6(__assign$6({},l.attributes),t),l}function collection(t){return Object.keys(t).reduce((function(n,l){return"id"!==l&&"type"!==l&&(n.relationships[l]={data:t[l]}),n}),{id:t.id,type:t.type,attributes:{},relationships:{}})}!function(t){t.show="show"}(jl||(jl={})),function(t){t.bundles="bundles",t.episodes="episodes",t.movies="movies",t.seasons="seasons"}(Fl||(Fl={}));var Wl=__spread$5(Object.values(jl),Object.values(Fl));function product(t){return Object.keys(t).reduce((function(n,l){return"content"===l?(n.id=t.content.id,n.type=t.content.type,n.attributes=__assign$6(__assign$6({},n.attributes),t[l])):"playables"===l?n.attributes[l]=t[l]:"episodes"!==l||Array.isArray(t[l])?"seasons"!==l||Array.isArray(t[l])?Wl.includes(l)?n.relationships[l]={data:t[l]}:n.attributes[l]=t[l]:n.relationships[l]={data:__assign$6({id:t.content.id+".seasons",type:"Collection"},t[l])}:n.relationships[l]={data:__assign$6({id:"episodes."+t.content.id,type:"Episodes"},t[l])},n}),{attributes:{},relationships:{}})}function sportingEvent(t){if(t.content){var n=t.content.relatedSportingEvents||[];return delete t.content.relatedSportingEvents,{id:t.content.id,type:t.content.type,attributes:__assign$6({},t.content),relationships:{channels:{data:t.channels||[]},relatedSportingEvents:{data:n}}}}return basic(t)}function watchlist(t){var n=t.items;delete t.items;var l=t.channels;return{id:"watchlist",type:"Watchlist",attributes:__assign$6({},t),relationships:{items:{data:n},channels:{data:l}}}}function transform$a(t){var n,l="unknown",d=t.methodName;return delete t.methodName,"watchlistContinueWatching"===d?l="Watchlist":"showItunesSeasons"===d?(t.content={id:"itunesSeasons",type:"itunesSeasons"},l="Product"):"contentEpisodes"===d?(t.content={id:"contentEpisodes",type:"contentEpisodes"},l="Product"):t.type?l=t.type:t.canvas?(t.canvas.type=null!==(n=t.canvas.type)&&void 0!==n?n:"Canvas",l=t.canvas.type):t.content?l="SportingEvent"===t.content.type?t.content.type:"Product":t.showId&&(t.content={id:t.showId,type:"Show"},l="Product"),function(t){switch(t){case"Canvas":return canvas;case"Product":return product;case"SportingEvent":return sportingEvent;case"Watchlist":return watchlist;case"Collection":return collection;default:return basic}}(l)(t)}var zl,Gl={shows:{method:"GET",url:"https://tv.apple.com/uts/v3/shows/{showId}",requiredParamsType:"Default"},movies:{method:"GET",url:"https://tv.apple.com/uts/v3/movies/{movieId}",requiredParamsType:"Default"},episodes:{method:"GET",url:"https://tv.apple.com/uts/v3/episodes/{episodeId}",requiredParamsType:"Default"}},ql={caller:"wta",sfh:"143441,33",v:"40"};!function(t){t.PLAY="PLAY",t.UPNEXT_ADD_REMOVE="UPNEXT_ADD_REMOVE"}(zl||(zl={}));var Ql,Jl=function(t){function API(n,l){var d,p;void 0===n&&(n="https://uts-api.itunes.apple.com/uts");var h=t.call(this,n,l.sessionOptions)||this;return h._isV3Config=!1,h.fetchOptions={},h.v3={},h.version="2.2124.8",delete l.sessionOptions,l.debug&&(Bl.enabled=!0,Bl.level="number"==typeof l.logLevel?l.logLevel:1,delete l.debug),l.developerToken&&(h.developerToken=new bt(l.developerToken),h.headers.set("Authorization","Bearer "+h.developerToken.token),h.userToken=l.userToken,h.userToken&&h.headers.set("Media-User-Token",h.userToken),delete l.developerToken,delete l.userToken),h._dataStoreEnabled=!!l.dataStoreEnabled,delete l.dataStoreEnabled,h._store=new Yl({mapping:transform$a,allowPersonalizedCache:!!(null===(d=null==l?void 0:l.features)||void 0===d?void 0:d.includes("uts-personalized-cache"))}),h._isV3Config=!!(null===(p=null==l?void 0:l.features)||void 0===p?void 0:p.includes("uts-config-v3")),null==l||delete l.features,h.initializedOptions=__assign$6(__assign$6({},ql),l),h}return __extends$6(API,t),API.configure=function(t){return void 0===t&&(t={}),__awaiter$5(this,void 0,void 0,(function(){var n,l;return __generator$5(this,(function(d){switch(d.label){case 0:return Bl.debug("Configuring with options: ",t),n=t.hostname||t.baseUrl,delete t.hostname,delete t.baseUrl,(l=new this(n,t)).fetchOptions=l._fetchOptions,delete t.sessionOptions,[4,l._updateAPIConfiguration(t)];case 1:return d.sent(),Object.keys(l.routes).forEach((function(t){l[t]=l._generateServerRoute(t,l.routes[t])})),Object.keys(Gl).forEach((function(t){l.v3[t]=l._generateServerRoute(t,Gl[t])})),[2,l]}}))}))},Object.defineProperty(API.prototype,"config",{get:function(){return this._config},enumerable:!0,configurable:!0}),Object.defineProperty(API.prototype,"routes",{get:function(){var t,n,l,d,p,h;return null!==(h=null!==(l=null===(n=null===(t=this.config)||void 0===t?void 0:t.endpoints)||void 0===n?void 0:n.serverRoutes)&&void 0!==l?l:null===(p=null===(d=this.config)||void 0===d?void 0:d.applicationProps)||void 0===p?void 0:p.routes)&&void 0!==h?h:{}},enumerable:!0,configurable:!0}),API.prototype.getRequiredParams=function(t){var n,l,d,p,h;return void 0===t&&(t="Default"),null!==(h=null!==(l=null===(n=this.config)||void 0===n?void 0:n.requiredRequestKeyValuePairs)&&void 0!==l?l:null===(p=null===(d=this.config)||void 0===d?void 0:d.applicationProps)||void 0===p?void 0:p.requiredParamsMap[t])&&void 0!==h?h:{}},API.prototype.reconfigure=function(t){return __awaiter$5(this,void 0,void 0,(function(){return __generator$5(this,(function(n){return Bl.debug("uts: reconfigure with options:",t),"userToken"in t&&(this.userToken=t.userToken,t.userToken?this.headers.set("Media-User-Token",this.userToken):(Bl.debug("uts: removing MUT header and clearing config"),this.headers.delete("Media-User-Token"),this._config=void 0),delete t.userToken),this._dataStoreEnabled&&this._store.clear(),this.clearNetworkCache(),this.initializedOptions=__assign$6(__assign$6({},this.initializedOptions),t),[2,this._updateAPIConfiguration()]}))}))},API.prototype.reconfigureRatings=function(t){return void 0===t&&(t={}),__awaiter$5(this,void 0,void 0,(function(){return __generator$5(this,(function(n){return t.tvr||delete this.initializedOptions.tvr,t.mr||delete this.initializedOptions.mr,[2,this.reconfigure(t)]}))}))},API.prototype.invalidate=function(t,n){return __awaiter$5(this,void 0,void 0,(function(){return __generator$5(this,(function(l){return this._dataStoreEnabled?this._store.invalidateWithEvent(t,n):this.clearNetworkCache(),[2]}))}))},API.prototype.decorate=function(t){return __awaiter$5(this,void 0,void 0,(function(){var n,l,d;return __generator$5(this,(function(p){switch(p.label){case 0:n=__assign$6({ids:t},this.getRequiredParams()),l=__assign$6(__assign$6({},this.fetchOptions),{useRawResponse:!0}),Bl.debug("Fetch decorate endpointParams: "+n+", fetchOptions: "+this.fetchOptions+", endpointOptions: "+l),p.label=1;case 1:return p.trys.push([1,3,,4]),[4,this._makeUTSRequest("v2/activity/playables/decorate",n,l)];case 2:return d=p.sent(),[3,4];case 3:return p.sent(),d=void 0,[3,4];case 4:return[2,d]}}))}))},API.prototype.getNpPayloadContent=function(t,n,l){return{context:{user:{id:n,keyspace:"cid"},userAgent:navigator.userAgent,appleStoreFront:this.initializedOptions.sfh,source:"Client_Device",cadence:"Contract",bundleId:l,millisecondsSinceEvent:0},event:{vodEvent:t}}},API.prototype.playActivity=function(t,n,l){return __awaiter$5(this,void 0,void 0,(function(){var d;return __generator$5(this,(function(p){switch(p.label){case 0:return d={headers:{Authorization:"Bearer "+this.developerToken.token,"Media-User-Token":this.userToken},method:"POST",body:JSON.stringify(this.getNpPayloadContent(t,n,l))},[4,fetch("/api/np/play/json",d)];case 1:return[2,p.sent()]}}))}))},API.prototype._generateServerRoute=function(t,n){var l=this;if(n&&n.url&&!n.needsMescal)return function(){for(var d=[],p=0;p<arguments.length;p++)d[p]=arguments[p];return __awaiter$5(l,void 0,void 0,(function(){var l,p,h,f,y,v,_,g,m,b,P,T,S,k,A,I;return __generator$5(this,(function(E){switch(E.label){case 0:return l=new Hl(t,n,d),p=l.path,h=l.pathTemplate,f=l.queryParams,y=l.fetchOptions,v=l.methodName,_=l.returnRawResponse,g=__assign$6(__assign$6({},this.getRequiredParams(n.requiredParamsType)),f),!this._dataStoreEnabled||_?[2,this._makeUTSRequest(p,g,y)]:(m=this._store.getCachedRecord(l))?"Canvas"!==m.type?[3,2]:[4,this._handleInvalidShelves(m,l)]:[3,3];case 1:E.sent(),E.label=2;case 2:return Bl.debug("uts: "+v+" - returning cached record",m),[2,m];case 3:return Bl.debug("uts: "+v+" - no record found in cache, making request"),b=l,[4,this._makeUTSRequest(p,g,y)];case 4:return b.response=E.sent(),(P=null===(I=null===(A=l.response)||void 0===A?void 0:A.data)||void 0===I?void 0:I.canvas)&&(T=__read$5(this._store.query((function(t){return t.id===P.id})),1),(S=T[0])&&!Yl.hasPath(S,p))?(Bl.debug("uts: Duplicate canvas found"),this._store.updateRecordMetadata(S,p,h),[2,S]):(k=this._store.makeRecord(l),Bl.debug("uts: "+v+" - returning new or updated record",k),[2,k])}}))}))}},API.prototype._makeUTSRequest=function(t,n,l){return __awaiter$5(this,void 0,void 0,(function(){var d,p,h,f;return __generator$5(this,(function(y){switch(y.label){case 0:d=__assign$6({},n),p=__assign$6(__assign$6({},this.fetchOptions),l),y.label=1;case 1:return y.trys.push([1,6,,7]),t=this.resolvePathVersion(t),[4,this.request(t,d,p)];case 2:return h=y.sent(),this._needsConfigurationRefresh(h)?(this.clearNetworkCache(),[4,this._updateAPIConfiguration()]):[3,5];case 3:return y.sent(),[4,this.request(t,d,p)];case 4:h=y.sent(),y.label=5;case 5:return[2,h];case 6:return f=y.sent(),[2,Promise.reject(f)];case 7:return[2]}}))}))},API.prototype.resolvePathVersion=function(t){return this.url.endsWith("v2")?t.replace(/v\d\//,""):t},API.prototype._needsConfigurationRefresh=function(t){var n=t.utsk,l=this.getRequiredParams().utsk;return!!n&&n!==l},API.prototype._updateAPIConfiguration=function(t){return void 0===t&&(t=this.getRequiredParams()),__awaiter$5(this,void 0,void 0,(function(){var n,l;return __generator$5(this,(function(d){switch(d.label){case 0:return Bl.debug("UTS: Fetching new config with options",t),n={},t.utsFeatureFlags&&(n.featureFlags=t.utsFeatureFlags,delete t.utsFeatureFlags),l=this,[4,this.request(this.resolvePathVersion(this._isV3Config?"v3/configurations":"v2/init/config"),n,__assign$6(__assign$6({},this.fetchOptions),{method:"POST",queryParameters:__assign$6(__assign$6(__assign$6({},this.initializedOptions),t),{ts:Date.now()}),contentType:Tt.JSON}))];case 1:return l._config=d.sent(),[2]}}))}))},API.prototype._handleInvalidShelves=function(t,n){return __awaiter$5(this,void 0,void 0,(function(){var l,d=this;return __generator$5(this,(function(p){switch(p.label){case 0:return this._dataStoreEnabled&&t&&t.shelves&&t.shelves.some(isDataRecord)?(l=function(t){return __awaiter$5(d,void 0,void 0,(function(){var l,d;return __generator$5(this,(function(p){switch(p.label){case 0:return Bl.debug("uts: _handleInvalidShelves - fetching and replacing shelf with id:",t.id),l={},t.url&&(l=parseQueryParams(t.url)),[4,this._makeUTSRequest("v2/browse/collection/"+t.id,__assign$6(__assign$6(__assign$6({},this.getRequiredParams()),n.queryParams),l),n.fetchOptions)];case 1:return d=p.sent(),this._store.replaceShelf(d),[2]}}))}))},[4,Promise.all(t.shelves.filter((function(t){return!isRecordValid(t)})).map(l))]):[2];case 1:return p.sent(),[2]}}))}))},API}(At),Xl={show:{isPlural:!1,apiMethod:"viewProduct"},episode:{isPlural:!1,apiMethod:"viewProduct"},product:{isPlural:!1,apiMethod:"viewProduct"},movie:{isPlural:!1,apiMethod:"viewProduct"}},Zl=function(){function UTSAPIService(){this.url=ns.urls.utsBase,this.namedQueueOptions=Xl,this.defaults={caller:"web",dataStoreEnabled:!0,pfm:"web",v:"40"},pe||window.localStorage.utsBaseURLOverride&&(this.url=window.localStorage.utsBaseURLOverride),void 0!==this.url&&(this.defaults.baseUrl=this.url)}return UTSAPIService.prototype.clear=function(){},UTSAPIService.prototype.configure=function(t){return __awaiter(this,void 0,void 0,(function(){var n,l;return __generator(this,(function(d){switch(d.label){case 0:return n=void 0!==t.apiOptions?t.apiOptions:{},t.store&&(n.developerToken=t.store.developerToken,t.store.musicUserToken&&(n.userToken=t.store.musicUserToken),t.store.precache&&(t.apiOptions={underlyingStorage:t.store.precache})),l=this,[4,Jl.configure(__assign(__assign({},this.defaults),n))];case 1:return l.api=d.sent(),[2,this]}}))}))},UTSAPIService.prototype.getAPIForItem=function(t){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(t){return[2,this.api]}))}))},UTSAPIService}(),augmentUrlQueryParameters=function(t){return addQueryParamsToURL(t,{xtrick:!0,webbrowser:!0})},addPlayableToItem=function(t,n,l){var d,p,h,f;t.type=null!==(d=n.type)&&void 0!==d?d:l,t.attributes=null!==(p=t.attributes)&&void 0!==p?p:{},t.attributes.title=null!==(f=null!==(h=t.attributes.title)&&void 0!==h?h:t.title)&&void 0!==f?f:n.title,delete t.title,function(t,n){var l,d,p,h,f=null!==(p=null!==(d=null===(l=n.assets)||void 0===l?void 0:l.hlsUrl)&&void 0!==d?d:n.hlsUrl)&&void 0!==p?p:null===(h=n.clipAssets)||void 0===h?void 0:h[0].url;t.previews=f?[{url:augmentUrlQueryParameters(f)}]:[]}(t.attributes,n),function(t,n){var l=n.assets;l&&(l.fpsKeyServerUrl&&(t.keyServerQueryParameters=l.fpsKeyServerQueryParameters,t.keyURLs={"hls-key-cert-url":l.fpsCertificateUrl,"hls-key-server-url":l.fpsKeyServerUrl,"widevine-cert-url":l.wideVineCertificateUrl}),t.assetURL=augmentUrlQueryParameters(l.hlsUrl))}(t,n),t.id||(t.id=generateUUID()),t.playables=[n]},createMediaItem=function(t){var n,l=JSON.stringify(t),d=JSON.parse(l),p=getDefaultPlayable(d);return d.attributes=__assign(__assign({},null!==(n=d.attributes)&&void 0!==n?n:{}),d),addPlayableToItem(d,p),new _i(d)},ed=/^http(?:s)?\:\/\/(?:itunes|(embed\.)?(music|podcasts|tv))\.apple\.com/i,td=["allow-forms","allow-popups","allow-same-origin","allow-scripts","allow-storage-access-by-user-activation","allow-top-navigation-by-user-activation"],rd=["autoplay *","encrypted-media *","fullscreen *"];var id=Fe.errors,nd={mediaApi:{configureFn:function(t,n){return void 0===n&&(n=!1),__awaiter(void 0,void 0,void 0,(function(){return __generator(this,(function(l){if(Dl&&!n){if(void 0===t.storefrontId||t.storefrontId===Dl.storefrontId)return[2,Dl];Dl.clear()}return[2,(Dl=new Ul(t.dispatcher)).configure(t)]}))}))},apiType:t.SupportedAPIs.MEDIA,allowDefault:!1},utsApi:{configureFn:function(t,n){return void 0===n&&(n=!1),__awaiter(void 0,void 0,void 0,(function(){return __generator(this,(function(l){switch(l.label){case 0:return Ql&&!n?[2,Ql]:(Ql=new Zl,void 0!==t.api?[3,2]:[4,Ql.configure(t)]);case 1:return l.sent(),[3,3];case 2:Ql.api=t.api,l.label=3;case 3:return[2,Ql]}}))}))},apiType:t.SupportedAPIs.UTS,allowDefault:!0}},createAPIConfiguration=function(t,n){var l,d,p,h,f,y,v,_,g,m=nd[t],b=m.configureFn,P=m.apiType,T=m.allowDefault,S=__assign({},n.apiOptions);delete S.utsApi,delete S.mediaApi;var k={apiType:P,configureFn:b,options:{}};if(null===(d=null===(l=n.apiOptions)||void 0===l?void 0:l[t])||void 0===d?void 0:d.api)k.options.api=n.apiOptions[t].api;else{var A=T?S:{};k.options.apiOptions=null!==(g=null!==(_=null!==(f=null===(h=null===(p=n.apiOptions)||void 0===p?void 0:p[t])||void 0===h?void 0:h.configureOptions)&&void 0!==f?f:null===(v=null===(y=n.apiOptions)||void 0===y?void 0:y[t])||void 0===v?void 0:v.apiOptions)&&void 0!==_?_:A)&&void 0!==g?g:{}}return k},od=function(t){function MediaKitInstance(){return null!==t&&t.apply(this,arguments)||this}return __extends(MediaKitInstance,t),MediaKitInstance.prototype.bingePlay=function(){var t;return __awaiter(this,void 0,void 0,(function(){var n;return __generator(this,(function(l){return(n=null===(t=this.queue)||void 0===t?void 0:t.nextPlayableItem)&&(n.bingeWatching=!0),[2,this.play()]}))}))},MediaKitInstance}(ml);t.Events=An,t.MKError=Fe,t.MediaKitInstance=od,t.PlayActivityEndReasonType=uc,t.VideoTypes={movie:!0,musicVideo:!0,musicMovie:!0,trailer:!0,tvEpisode:!0,uploadedVideo:!0,"uploaded-videos":!0,"music-videos":!0,"music-movies":!0,"tv-episodes":!0,Episode:!0,Movie:!0,Show:!0,Vod:!0,EditorialVideoClip:!0,RealityVideo:!0},t.configure=function(t){return __awaiter(this,void 0,void 0,(function(){var n=this;return __generator(this,(function(l){switch(l.label){case 0:return t.playActivityAPI=[new hc,new fc],t.realm=2,void 0!==t.rtcOptions&&t.playActivityAPI.push(new yl(t.rtcOptions)),[4,configure$1(t,od,(function(l){return __awaiter(n,void 0,void 0,(function(){var n,d;return __generator(this,(function(p){switch(p.label){case 0:return n=[createAPIConfiguration("utsApi",t)],(null===(d=t.apiOptions)||void 0===d?void 0:d.mediaApi)&&n.push(createAPIConfiguration("mediaApi",t)),[4,l.configure(n)];case 1:return p.sent(),[2]}}))}))}))];case 1:return[2,l.sent()]}}))}))},t.createMediaItem=createMediaItem,t.createMediaItemFromPlayable=function(t,n){if(void 0===n&&(n="Show"),Array.isArray(t.playables))return createMediaItem(t);var l=JSON.stringify(t),d=JSON.parse(l),p={id:d.id};return addPlayableToItem(p,d,n),new _i(p)},t.enableMultipleInstances=function(){Pl=!0},t.errors=id,t.formatArtworkURL=formatArtworkURL,t.formatMediaTime=function(t,n){void 0===n&&(n=":");var l=formattedSeconds(t),d=l.hours,p=l.minutes;t=Math.floor(t%3600%60);var h=[];return d?(h.push(""+d),h.push(p<10?"0"+p:""+p)):h.push(""+p),h.push(t<10?"0"+t:""+t),h.join(n)},t.formattedMediaURL=formattedMediaURL,t.formattedMilliseconds=function(t){return formattedSeconds(t/1e3)},t.formattedSeconds=formattedSeconds,t.generateEmbedCode=function(t,n){var l,d;if(void 0===n&&(n={height:"450",width:"660"}),!ed.test(t))throw new Error("Invalid content url");var p=null!==(l=n.height)&&void 0!==l?l:"450",h=null!==(d=n.width)&&void 0!==d?d:"660",f=formattedMediaURL(t),y=f.kind,v=f.isUTS;"song"===y?p="150":"episode"===y?p="175":"post"===y&&(p=""+Math.round(.5625*parseInt(h,10))),p=(""+p).replace(/(\d+)px/i,"$1");var _="width:100%;"+((h=(""+h).replace(/^(\d+)(?!px)%?$/i,"$1px"))?"max-width:"+h:"")+";overflow:hidden;background:transparent;",g="https://embed.music.apple.com";["podcast","episode"].includes(y)&&!v&&(g="https://embed.podcasts.apple.com"),["movie","episode","show"].includes(y)&&v&&(g="https://embed.tv.apple.com");var m=window.localStorage.getItem("mk-generate-swizzle")||g;return"<iframe "+['allow="'+rd.join("; ")+'"','frameborder="0"',p?'height="'+p+'"':"",'style="'+_+'"','sandbox="'+td.join(" ")+'"','src="'+t.replace(ed,m)+'"'].join(" ")+"></iframe>"},t.getHlsJsCdnConfig=getHlsJsCdnConfig,t.getInstance=function(t){if(0!==Tl.length)return void 0===t?Tl[Tl.length-1]:Tl.find((function(n){return n.id===t}))},t.getInstances=function(){return Tl},t.getPlayerType=getPlayerType,Object.defineProperty(t,"__esModule",{value:!0})}));
